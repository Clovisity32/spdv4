<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Pathway Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .icon-sm { width: 18px; height: 18px; display: inline-block; vertical-align: middle; }
        .icon-md { width: 20px; height: 20px; display: inline-block; vertical-align: middle; }
        .icon-lg { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }

        /* Custom Message Box */
        #customMessageBox {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #customMessageBox.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            height: 24px; /* Fixed height for alignment */
        }
        .bar-label {
            width: 150px; /* Adjust as needed */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
            font-size: 0.875rem; /* text-sm */
            color: #cbd5e1; /* slate-300 */
        }
        .bar {
            height: 100%;
            background-image: linear-gradient(to right, #22d3ee, #10b981);
            border-radius: 0.25rem; /* rounded-sm */
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding-right: 5px;
            color: white;
            font-size: 0.75rem; /* text-xs */
            line-height: 24px; /* Match height */
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content;
            max-width: 250px;
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the element */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            border: 1px solid #334155; /* slate-700 */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
 
</head>
<body class="bg-gradient-to-br from-slate-900 to-sky-900 min-h-screen text-gray-100">

    <div id="customMessageBox" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-slate-700">
            <h3 id="messageBoxTitle" class="text-lg font-semibold text-cyan-400 mb-3">Notification</h3>
            <p id="messageBoxText" class="text-slate-300 mb-6"></p>
            <button id="messageBoxOkButton" class="w-full p-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg transition duration-150">
                OK
            </button>
        </div>
    </div>

    <div class="p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 via-cyan-400 to-sky-500">
                Student Pathway Dashboard
            </h1>
            <p class="text-sky-300 mt-2 text-lg">
                Explore your post-secondary options based on your subject grades.
            </p>
        </header>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M21 22L17.592 18.592C19.089 16.839 20 14.745 20 12.5C20 7.258 15.742 3 10.5 3S1 7.258 1 12.5C1 17.742 5.258 22 10.5 22C12.745 22 14.839 21.089 16.592 19.592L20 23L21 22ZM10.5 20C6.364 20 3 16.636 3 12.5C3 8.364 6.364 5 10.5 5C14.636 5 18 8.364 18 12.5C18 16.636 14.636 20 10.5 20Z"></path><path d="M11.5 8H9.5V12H11.5V8Z"></path><path d="M11.5 14H9.5V16H11.5V14Z"></path></svg> Enter Your Subjects & Grades
            </h2>
            
            <div class="grid md:grid-cols-5 gap-4 mb-4 items-end">
                <div>
                    <label for="school" class="block text-sm font-medium text-sky-300 mb-1">School</label>
                    <select id="school" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        <option value="Yuhua Secondary School">Yuhua Secondary School</option>
                        <option value="School A">School A</option>
                    </select>
                </div>
                <div>
                    <label for="subject" class="block text-sm font-medium text-sky-300 mb-1">Subject</label>
                    <select id="subject" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        <option value="">Select Subject</option>
                    </select>
                </div>
                <div>
                    <label for="level" class="block text-sm font-medium text-sky-300 mb-1">Level</label>
                    <select id="level" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="grade" class="block text-sm font-medium text-sky-300 mb-1">Grade</label>
                    <select id="grade" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="bonus" class="block text-sm font-medium text-sky-300 mb-1 tooltip">
                        Bonus Points<sup><small>i</small></sup>
                        <span class="tooltiptext">Bonus points are awarded for CCA bonus points capped at 2 points for all pathways other than for JC/MI. For JC/MI, maximum bonus points are 5.</span>
                    </label>
                    <input type="number" id="bonus" value="0" min="0" max="5" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100" />
                </div>
                <button id="addUpdateSubjectBtn" class="w-full p-3 bg-gradient-to-r from-emerald-500 to-cyan-600 hover:from-emerald-600 hover:to-cyan-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out flex items-center justify-center text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2"><path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM17 13H13V17H11V13H7V11H11V7H13V11H17V13Z"></path></svg> <span id="addUpdateBtnText">Add Subject</span>
                </button>
            </div>

            <div id="studentSubjectsTableContainer" class="mt-8 hidden">
                <h3 class="text-xl font-semibold mb-3 text-sky-400">Your Subjects:</h3>
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Grade</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-sky-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentSubjectsTableBody" class="bg-slate-800 divide-y divide-slate-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="improvementSuggestionsSection" class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700 hidden">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M3 17H5V19H3V17ZM7 5H9V19H7V5ZM11 13H13V19H11V13ZM15 9H17V19H15V9ZM19 12H21V19H19V12Z"></path></svg> Improvement Suggestions
            </h2>
            <div id="improvementSuggestionsContainer" class="min-h-[100px]">
                </div>
            <div id="improvementPlaceholder" class="text-center py-8 text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">Add subjects to see improvement suggestions.</p>
            </div>
        </section>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M12 2C17.523 2 22 6.477 22 12C22 17.523 17.523 22 12 22C6.477 22 2 17.523 2 12C2 6.477 6.477 2 12 2ZM12 4C7.582 4 4 7.582 4 12C4 16.418 7.582 20 12 20C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4ZM12 11C11.448 11 11 11.448 11 12C11 12.552 11.448 13 12 13C12.552 13 13 12.552 13 11.448 12.552 11 12 11ZM12 6C9.791 6 8 7.791 8 10H10C10 8.896 10.896 8 12 8C13.104 8 14 8.896 14 10C14 12 11 11.75 11 15H13C13 12.75 16 12.5 16 10C16 7.791 14.209 6 12 6Z"></path></svg> Pathway Eligibility
            </h2>
            <div id="eligibilityResultsContainer" class="grid md:grid-cols-2 lg:col-span-3 gap-6">
                <div id="eligibilityPlaceholder" class="text-center py-8 text-slate-400 md:col-span-2 lg:col-span-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-sky-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM11 7H13V11H11V7ZM11 13H13V17H11V13Z"></path></svg> <p class="text-xl">Please add subjects to see your eligible pathways.</p>
                </div>
            </div>
        </section>

        <footer class="text-center mt-12 text-sm text-slate-500">
            <p>&copy; <span id="currentYear"></span> Student Pathway Dashboard. For informational purposes only.</p>
            <p>Always verify eligibility criteria with official sources.</p>
            <p class="mt-1">Based on Full SBB Post-Sec Options w.e.f. 2027 S4/5 Cohort (Affecting: 2025 S1 & S2 Full SBB) document.</p>
        </footer>
    </div>

    <script>
        (function() { // Start IIFE
            // --- Constants and Configuration ---
            const G3_GRADES_OPTIONS = ["A1", "A2", "B3", "B4", "C5", "C6", "D7", "E8", "F9"];
            const G2_GRADES_OPTIONS = ["1", "2", "3", "4", "5", "6"];
            const G1_GRADES_OPTIONS = ["A", "B", "C", "D", "E"];
            
            // Numeric mapping for general calculations (lower is better)
            const G3_TO_NUMERIC_RAW = { A1: 1, A2: 2, B3: 3, B4: 4, C5: 5, C6: 6, D7: 7, E8: 8, F9: 9 };
            const G2_TO_NUMERIC_RAW = { "1": 1, "2": 2, "3": 3, "4": 4, "5": 5, "6": 6 };
            // ITE Aggregate Score mapping for G1 grades (lower is better)
            const G1_TO_NUMERIC_RAW_ITE = { A: 1, B: 2, C: 3, D: 4, E: 5 };

            // Grade conversions
            const G3_TO_G2_CONVERSION_MAP = {
                A1: "1", A2: "1", B3: "1",
                B4: "2", C5: "2", C6: "2",
                D7: "3",
                E8: "4",
                F9: "5"
            };
            
            const G3_TO_G1_EQUIV_MAP = {
                A1: "A", A2: "A", B3: "A", B4: "A", C5: "A", C6: "A", D7: "A",
                E8: "B",
                F9: "C"
            };

            const G2_TO_G1_EQUIV_MAP = {
                "1": "A", "2": "A", "3": "A",
                "4": "B",
                "5": "C",
                "6": "D"
            };

            const GRADE_LEVELS = ["G3", "G2", "G1"];

            const ALL_SUBJECTS_LIST = [
                { id: "AM", name: "Additional Mathematics", category: "MATH_PURE" },
                { id: "ART", name: "Art", category: "ART_MUSIC" },
                { id: "BIO", name: "Biology", category: "SCIENCE_PURE" },
                { id: "BIOTECH", name: "Biotechnology", category: "BIOTECH" },
                { id: "BS", name: "Business Studies", category: "BUSINESS_SUBJECTS" },
                { id: "C3DA", name: "Creative 3D Animation", category: "TECH_SUBJECTS" },
                { id: "CHEM", name: "Chemistry", category: "SCIENCE_PURE" },
                { id: "CHI", name: "Chinese", category: "MT_LANG" }, // Added specific language
                { id: "COMB_HUM", name: "Combined Humanities", category: "HUMANITIES_COMBINED" },
                { id: "COMB_SCI", name: "Combined Science", category: "SCIENCE_COMBINED" },
                { id: "COMMERCE", name: "Commerce", category: "BUSINESS_SUBJECTS" },
                { id: "COMP", name: "Computing / Computer Studies", category: "TECH_SUBJECTS" },
                { id: "DT", name: "Design & Technology", category: "TECH_SUBJECTS" },
                { id: "ECON", name: "Economics", category: "BUSINESS_SUBJECTS" },
                { id: "EBS", name: "Elements of Business skills", category: "BUSINESS_SUBJECTS" },
                { id: "EL", name: "English Language", category: "EL" },
                { id: "ESS", name: "Exercise & Sports Science", category: "EXERCISE_SPORTS" },
                { id: "FOE", name: "Electronics / Fundamentals of Electronics", category: "TECH_SUBJECTS" },
                { id: "GEOG", name: "Geography", category: "HUMANITIES_PURE" },
                { id: "HA", name: "Higher Art", category: "ART_MUSIC" },
                { id: "HCHI", name: "Higher Chinese", category: "HMT_LANG" }, // Added specific language
                { id: "HIST", name: "History", category: "HUMANITIES_PURE" },
                { id: "HM", name: "Higher Music", category: "ART_MUSIC" },
                { id: "HMAL", name: "Higher Malay", category: "HMT_LANG" }, // Added specific language
                { id: "HMT", name: "Higher Mother Tongue", category: "HMT" },
                { id: "HTAM", name: "Higher Tamil", category: "HMT_LANG" }, // Added specific language
                { id: "IED", name: "Intro to Enterprise Development", category: "BUSINESS_SUBJECTS" },
                { id: "IOT_APP", name: "IoT Applications", category: "TECH_SUBJECTS" },
                { id: "LIT_ENG", name: "Literature in English", category: "HUMANITIES_PURE" },
                { id: "LIT_CHI", name: "Literature in Chinese", category: "HUMANITIES_PURE" },
                { id: "LIT_MAL", name: "Literature in Malay", category: "HUMANITIES_PURE" },
                { id: "LIT_TAM", name: "Literature in Tamil", category: "HUMANITIES_PURE" },
                { id: "MAL", name: "Malay", category: "MT_LANG" }, // Added specific language
                { id: "MATH", name: "Mathematics", category: "MATH_PURE" }, 
                { id: "MECH_DESIGN_AUTO", name: "Mechanical Design & Automation", category: "TECH_SUBJECTS" },
                { id: "MOB_ROBOTICS", name: "Mobile Robotics", category: "TECH_SUBJECTS" },
                { id: "MOB_WEB_APP", name: "Mobile Web Applications", category: "TECH_SUBJECTS" },
                { id: "MS", name: "Media Studies (English/Chinese)", category: "MEDIA_COMM" },
                { id: "MS_CHI", name: "Media Studies (Chinese)", category: "MEDIA_COMM" },
                { id: "MS_ENG", name: "Media Studies (English)", category: "MEDIA_COMM" },
                { id: "MT", name: "Mother Tongue", category: "MT" }, // Generic MT
                { id: "MUSIC", name: "Music", category: "ART_MUSIC" },
                { id: "NFS", name: "Nutrition and Food Science", category: "TECH_SUBJECTS" },
                { id: "OTHER", name: "Other Subject", category: "OTHER" },
                { id: "PHY", name: "Physics", category: "SCIENCE_PURE" },
                { id: "POA", name: "Principles of Accounts", category: "BUSINESS_SUBJECTS" },
                { id: "SMART_ELEC_TECH", name: "Smart Electrical Technology", category: "TECH_SUBJECTS" },
                { id: "DS", name: "Design Studies", category: "TECH_SUBJECTS" },
                // Adding specific humanities subjects for clarity
                { id: "HUM_SS_LIT_ENG", name: "Humanities (Social Studies, Literature in English)", category: "HUMANITIES_COMBINED" },
                { id: "HUM_SS_LIT_CHI", name: "Humanities (Social Studies, Literature in Chinese)", category: "HUMANITIES_COMBINED" },
                { id: "HUM_SS_LIT_MAL", name: "Humanities (Social Studies, Literature in Malay)", category: "HUMANITIES_COMBINED" },
                { id: "HUM_SS_LIT_TAM", name: "Humanities (Social Studies, Literature in Tamil)", category: "HUMANITIES_COMBINED" },
                { id: "HUM_SS_HIST", name: "Humanities (Social Studies, History)", category: "HUMANITIES_COMBINED" },
                { id: "HUM_SS_GEOG", name: "Humanities (Social Studies, Geography)", category: "HUMANITIES_COMBINED" },
            ].sort((a, b) => a.name.localeCompare(b.name)); // Sort subjects alphabetically

            const SUBJECT_CATEGORIES_DEF = {
                EL: ["EL"],
                HMT: ["HMT", "HMT_LANG"], // Include specific HMT languages
                MT: ["MT", "MT_LANG"], // Include specific MT languages
                MT_ALL: ["MT", "HMT", "MT_LANG", "HMT_LANG"], 

                HUMANITIES_PURE: ["HUMANITIES_PURE"],
                HUMANITIES_COMBINED: ["HUMANITIES_COMBINED"],
                HUM: ["HUMANITIES_PURE", "HUMANITIES_COMBINED"], 

                MATH_PURE: ["MATH_PURE"],
                SCIENCE_PURE: ["SCIENCE_PURE"],
                SCIENCE_COMBINED: ["SCIENCE_COMBINED"],
                MATH_SCIENCE: ["MATH_PURE", "SCIENCE_PURE", "SCIENCE_COMBINED"], 
                HUM_MATH_SCIENCE: ["HUMANITIES_PURE", "HUMANITIES_COMBINED", "MATH_PURE", "SCIENCE_PURE", "SCIENCE_COMBINED"], 
                
                SCIENCE_IN_LIEU: ["SCIENCE_PURE", "SCIENCE_COMBINED", "MOB_ROBOTICS", "SMART_ELEC_TECH", "MECH_DESIGN_AUTO", "IOT_APP", "MOB_WEB_APP", "DT", "NFS", "COMP"], 

                TECH_SUBJECTS: ["TECH_SUBJECTS"],
                BUSINESS_SUBJECTS: ["BUSINESS_SUBJECTS"],
                ART_MUSIC: ["ART_MUSIC"],
                MEDIA_COMM: ["MEDIA_COMM"],
                LANGUAGE_ELECTIVES: ["MT", "HMT", "MT_LANG", "HMT_LANG"], 
                EXERCISE_SPORTS: ["EXERCISE_SPORTS"],
                BIOTECH: ["BIOTECH"],
                OTHER: ["OTHER"],

                ANY_BEST: [] 
            };

            SUBJECT_CATEGORIES_DEF.ANY_BEST = ALL_SUBJECTS_LIST.map(s => s.category).filter((value, index, self) => self.indexOf(value) === index);

            const getUniqueCategoriesFromSubjectIds = (subjectIds) => {
                const categories = new Set();
                subjectIds.forEach(id => {
                    const subject = ALL_SUBJECTS_LIST.find(s => s.id === id);
                    if (subject && subject.category) {
                        categories.add(subject.category);
                    }
                });
                return Array.from(categories);
            };

            // Updated ELR2B2_A_R1_SUBJECT_IDS based on user's precise list
            const ELR2B2_A_R1_SUBJECT_IDS = [
                "ART", "BS", "COMB_HUM", "ECON", "GEOG", "HA", "HM", "HIST",
                "HUM_SS_LIT_ENG", "HUM_SS_LIT_CHI", "HUM_SS_LIT_MAL", "HUM_SS_LIT_TAM",
                "HUM_SS_HIST", "HUM_SS_GEOG", "IED", "LIT_ENG", "LIT_CHI", "LIT_MAL",
                "LIT_TAM", "MS_ENG", "MS_CHI", "MUSIC"
            ];
            // Updated ELR2B2_A_R2_SUBJECT_IDS_FULL based on user's precise list, including specific languages
            const ELR2B2_A_R2_SUBJECT_IDS_FULL = [
                "AM", "ART", "BS", "CHI", "COMB_HUM", "C3DA", "DT", "DS", "ECON", "MATH", "GEOG", "HA", "HCHI", "HIST", "HM", "HMAL", "HTAM", "IED", "LIT_CHI", "LIT_ENG", "LIT_MAL", "LIT_TAM", "MAL", "MS_CHI", "MS_ENG", "MT", "MUSIC", "NFS", "POA", "PHY", "BIO", "CHEM", "COMB_SCI", "TAM"
            ];
            const ELR2B2_B_R1_SUBJECT_IDS = ["AM", "MATH"];
            // MODIFIED: Added MT and HMT to ELR2B2_B_R2_SUBJECT_IDS_FULL
            const ELR2B2_B_R2_SUBJECT_IDS_FULL = ["ART", "BS", "COMB_HUM", "ECON", "GEOG", "HA", "HM", "HIST", "IED", "LIT_CHI", "LIT_ENG", "LIT_MAL", "LIT_TAM", "MS_CHI", "MS_ENG", "MUSIC", "POA", "CHI", "MAL", "TAM", "HCHI", "HMAL", "HTAM", "MT", "HMT"];
            const ELR2B2_C_R1_SUBJECT_IDS = ["AM", "MATH"];
            const ELR2B2_C_R2_SUBJECT_IDS_FULL = ["BIO", "BIOTECH", "CHEM", "COMB_SCI", "COMP", "C3DA", "DT", "FOE", "ESS", "NFS", "PHY"];
            const ELR2B2_D_R1_SUBJECT_IDS = ["AM", "MATH"];
            // MODIFIED: Added MT and HMT to ELR2B2_D_R2_SUBJECT_IDS_FULL
            const ELR2B2_D_R2_SUBJECT_IDS_FULL = ["ART", "BIO", "BIOTECH", "CHEM", "COMB_SCI", "COMP", "C3DA", "DT", "DS", "FOE", "HA", "MS_CHI", "MS_ENG", "NFS", "PHY", "CHI", "MAL", "TAM", "HCHI", "HMAL", "HTAM", "MT", "HMT"];

            const ELR2B2_A_R1_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_A_R1_SUBJECT_IDS);
            const ELR2B2_A_R2_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_A_R2_SUBJECT_IDS_FULL);
            const ELR2B2_B_R1_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_B_R1_SUBJECT_IDS);
            const ELR2B2_B_R2_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_B_R2_SUBJECT_IDS_FULL);
            const ELR2B2_C_R1_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_C_R1_SUBJECT_IDS);
            const ELR2B2_C_R2_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_C_R2_SUBJECT_IDS_FULL);
            const ELR2B2_D_R1_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_D_R1_SUBJECT_IDS);
            const ELR2B2_D_R2_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_D_R2_SUBJECT_IDS_FULL);


            const PATHWAYS = [
                { id: "jc", name: "Junior College (JC)", group: "JC/MI", calcType: "L1R4_G3", requirements: { grossL1R4: 16 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: "E8" },{ type: "MT", level: "G3", grade: "D7" },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM_MATH_SCIENCE, R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "" },
                { id: "mi", name: "Millennia Institute (MI)", group: "JC/MI", calcType: "L1R4_G3", requirements: { grossL1R4: 20 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: "E8" },{ type: "MT", level: "G3", grade: "D7" },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM_MATH_SCIENCE, R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "" },

                { id: "poly_yr1_elr2b2_a", name: "Polytechnic Year 1 (ELR2B2-A)", tooltipText: "Humanities, Media & Communications", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: ELR2B2_A_R1_CATEGORIES, R2_cat_ids: ELR2B2_A_R2_CATEGORIES, B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },
                { id: "poly_yr1_elr2b2_b", name: "Polytechnic Year 1 (ELR2B2-B)", tooltipText: "Business & Management", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: ELR2B2_B_R1_CATEGORIES, R2_cat_ids: ELR2B2_B_R2_CATEGORIES, B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },
                { id: "poly_yr1_elr2b2_c_general", name: "Polytechnic Year 1 (ELR2B2-C)", tooltipText: "Applied/Health Sc, Engrg, Info & Digital Tech, Built Environment, Nursing", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: ELR2B2_C_R1_CATEGORIES, R2_cat_ids: ELR2B2_C_R2_CATEGORIES, B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },
                { id: "poly_yr1_elr2b2_d", name: "Polytechnic Year 1 (ELR2B2-D)", tooltipText: "Design, Built Environment", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: ELR2B2_D_R1_CATEGORIES, R2_cat_ids: ELR2B2_D_R2_CATEGORIES, B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },

                { 
                    id: "pfp_science_tech", 
                    name: "Polytechnic Foundation Programme (PFP) - Science, Design, Engrg & Technology, Nursing Cluster", 
                    group: "PFP", 
                    calcType: "ELMAB3_G2", 
                    requirements: { grossELMAB3: 12 }, 
                    mer: { 
                        el_g2: "3", 
                        math_am_g2: "3", 
                        relevant_subj_g2: "3", 
                        relevant_subj_ids: ["DT", "NFS", "COMB_SCI"], 
                        other_two_subj_g2: "4" 
                    }, 
                    description: "" 
                },
                { 
                    id: "pfp_hum_art_biz", 
                    name: "Polytechnic Foundation Programme (PFP) - Humanities, Art, Media, Business, Early Childhood, Tamil Studies Cluster.", 
                    group: "PFP", 
                    calcType: "ELMAB3_G2", 
                    requirements: { grossELMAB3: 12 }, 
                    mer: { 
                        el_g2: "3", 
                        math_am_g2: "3", 
                        relevant_subj_g2: "3", 
                        relevant_subj_ids: ["ART", "POA", "GEOG", "HIST", "LIT_ENG", "ECON", "COMB_HUM"], 
                        other_two_subj_g2: "4" 
                    }, 
                    description: "" 
                },

                { id: "ite_hnitec_yr2_applied_eng_ict", name: "ITE Year 2 of 3-Yr Higher Nitec - Applied Science, Engineering, Info-Comms Tech", group: "ITE Year 2 Higher Nitec", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 19 }, mer: { el_g2: "4", math_am_g2: "4", any_three_other_subj_g2: "5" }, description: "" },
                { id: "ite_hnitec_yr2_biz_hosp", name: "ITE Year 2 of 3-Yr Higher Nitec - Business & Services, Hospitality", group: "ITE Year 2 Higher Nitec", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 19 }, mer: { el_g2: "3", math_am_g2: "4", any_three_other_subj_g2: "5" }, description: "" },

                { id: "ite_hnitec_yr1_health_sci_1", name: "MER (Pass Math or Science)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, req_g1g2_other_count: 2, allow_science_in_lieu: true, min_total_subjects: 4, pre_requisite_subject_ids: ["MATH_OR_SCIENCE"] }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_health_sci_2", name: "MER (Pass EL & Math)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.MATH_PURE), req_g1g2_other_count: 1, min_total_subjects: 4, pre_requisite_subject_ids: ["EL", "MATH"] }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_biz_services_1", name: "MER (Pass EL)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.EL, req_g1g2_other_count: 2, min_total_subjects: 4, pre_requisite_subject_ids: ["EL"] }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_biz_services_2", name: "MER (Complete SEC)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Completed", requirements: {min_total_subjects: 4}, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_engineering_1", name: "MER (Pass Math)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_PURE, req_g1g2_other_count: 2, min_total_subjects: 4, pre_requisite_subject_ids: ["MATH"] }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_hospitality_1", name: "MER (Pass 2G3)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "2_G3_ONLY", req_g3_count: 2, req_g3_grade: 8, min_total_subjects: 4, allow_science_in_lieu: false }, mer: {}, tooltipText: "Pass refers to Grade 1-8 for G3 Subject.", description: "" },
            ];

            // --- State Variables ---
            let studentSubjects = [];
            let bonusPoints = 0;
            let editingIndex = null; 
            let selectedSchool = "Yuhua Secondary School"; 

            // --- DOM Elements ---
            const schoolSelect = document.getElementById('school'); 
            const subjectSelect = document.getElementById('subject');
            const levelSelect = document.getElementById('level');
            const gradeSelect = document.getElementById('grade');
            const bonusInput = document.getElementById('bonus');
            const addUpdateSubjectBtn = document.getElementById('addUpdateSubjectBtn');
            const studentSubjectsTableBody = document.getElementById('studentSubjectsTableBody');
            const studentSubjectsTableContainer = document.getElementById('studentSubjectsTableContainer');
            const eligibilityResultsContainer = document.getElementById('eligibilityResultsContainer');
            const eligibilityPlaceholder = document.getElementById('eligibilityPlaceholder');
            const improvementSuggestionsSection = document.getElementById('improvementSuggestionsSection');
            const improvementSuggestionsContainer = document.getElementById('improvementSuggestionsContainer');
            const improvementPlaceholder = document.getElementById('improvementPlaceholder');
            const currentYearSpan = document.getElementById('currentYear');
            const customMessageBox = document.getElementById('customMessageBox');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxOkButton = document.getElementById('messageBoxOkButton');

            const SCHOOL_A_SUBJECT_IDS = ALL_SUBJECTS_LIST.map(s => s.id); 
            const SCHOOL_A_LEVEL_RESTRICTIONS = { "AM": ["G3"], "BIO": ["G3"], "CHEM": ["G3"], "MUSIC": ["G3"], "PHY": ["G3"], "MOB_ROBOTICS": ["G1"], "DT": ["G2", "G3"], "NFS": ["G2", "G3"], "EBS": ["G1"], "DS": ["G3"], "LIT_CHI": ["G3"], "LIT_MAL": ["G3"], "LIT_TAM": ["G3"], "MS_CHI": ["G3"], "MS_ENG": ["G3"] };
            const YUHUA_SECONDARY_SCHOOL_SUBJECT_IDS = [ "AM", "ART", "BIO", "CHEM", "COMB_HUM", "COMB_SCI", "COMP", "DT", "EBS", "EL", "MATH", "MOB_ROBOTICS", "MUSIC", "NFS", "PHY", "POA", "MT", "HMT" ];
            const YUHUA_SECONDARY_SCHOOL_LEVEL_RESTRICTIONS = { "AM": ["G3"], "BIO": ["G3"], "CHEM": ["G3"], "MUSIC": ["G3"], "PHY": ["G3"], "MOB_ROBOTICS": ["G1"], "DT": ["G2", "G3"], "NFS": ["G2", "G3"], "EBS": ["G1"] };


            // --- Utility Functions ---
            const getNumericGrade = (grade, level) => {
                if (level === "G3") return G3_TO_NUMERIC_RAW[grade] || Infinity;
                if (level === "G2") return G2_TO_NUMERIC_RAW[grade] || Infinity;
                if (level === "G1") return G1_TO_NUMERIC_RAW_ITE[grade] || Infinity;
                return Infinity;
            };
            
            const convertG3toG2 = (g3Grade) => G3_TO_G2_CONVERSION_MAP[g3Grade] || "6"; 
            const getSubjectById = (id) => ALL_SUBJECTS_LIST.find(s => s.id === id);
            const getSubjectNamesFromIds = (subjectIdsArray) => subjectIdsArray.map(id => getSubjectById(id)?.name || id).sort().join(', ');

            const getStudentSubjectG2Grade = (studentSubject) => {
                if (studentSubject.level === "G2") return studentSubject.grade;
                if (studentSubject.level === "G3") return convertG3toG2(studentSubject.grade);
                return "6"; 
            };

            const getG1Equivalent = (subject) => {
                let g1EquivGrade = null;
                let numericG1EquivGrade = Infinity;
                let numericOriginalGrade = getNumericGrade(subject.grade, subject.level); // Add this line

                if (subject.level === "G1") {
                    g1EquivGrade = subject.grade;
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[subject.grade] || Infinity; 
                } else if (subject.level === "G2") {
                    g1EquivGrade = G2_TO_G1_EQUIV_MAP[subject.grade] || "D"; 
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[g1EquivGrade] || Infinity;
                } else if (subject.level === "G3") {
                    g1EquivGrade = G3_TO_G1_EQUIV_MAP[subject.grade] || "C"; 
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[g1EquivGrade] || Infinity;
                }
                return { ...subject, g1EquivGrade, numericG1EquivGrade, numericOriginalGrade }; // Include numericOriginalGrade
            };

            const calculateBest4G1Equivalent = (currentStudentSubjects, forcedIncludeSubjects = []) => {
                // 1. Filter for subjects that are "passes" in their original G3, G2, or G1 level.
                const passingOriginalSubjects = currentStudentSubjects.filter(s => {
                    if (s.level === "G3") {
                        return getNumericGrade(s.grade, "G3") <= G3_TO_NUMERIC_RAW["D7"]; // D7 or better for G3 pass
                    } else if (s.level === "G2") {
                        return getNumericGrade(s.grade, "G2") <= G2_TO_NUMERIC_RAW["5"]; // 5 or better for G2 pass
                    } else if (s.level === "G1") {
                        return G1_GRADES_OPTIONS.includes(s.grade) && getNumericGrade(s.grade, "G1") <= G1_TO_NUMERIC_RAW_ITE["D"]; // A-D for G1 pass
                    }
                    return false; // Not a recognized level or not a pass
                }).map(s => ({ ...s, numericOriginalGrade: getNumericGrade(s.grade, s.level) })); // Add numericOriginalGrade here

                let final4Subjects = [];
                const usedIds = new Set();

                // Add forced subjects first (these are already assumed to be passing and relevant for their role)
                forcedIncludeSubjects.forEach(forcedSubj => {
                    const foundStudentSubj = passingOriginalSubjects.find(s => s.subjectId === forcedSubj.subjectId);
                    if (foundStudentSubj && !usedIds.has(foundStudentSubj.subjectId)) {
                        // Convert to G1 equivalent *after* selecting the original subject
                        final4Subjects.push({...getG1Equivalent(foundStudentSubj), role: forcedSubj.role});
                        usedIds.add(foundStudentSubj.subjectId);
                    }
                });

                // Fill remaining slots with best other subjects from the *passing original* pool
                const remainingSlots = 4 - final4Subjects.length;
                if (remainingSlots > 0) {
                    const otherBestSubjects = passingOriginalSubjects
                        .filter(s => !usedIds.has(s.subjectId))
                        .sort((a, b) => a.numericOriginalGrade - b.numericOriginalGrade) // Sort by original numeric grade
                        .slice(0, remainingSlots);

                    otherBestSubjects.forEach((s, index) => {
                        // Convert to G1 equivalent *after* selecting the original subject
                        let role = `B${final4Subjects.filter(fs => fs.role && fs.role.startsWith('B')).length + index + 1}`;
                        final4Subjects.push({...getG1Equivalent(s), role: role });
                        usedIds.add(s.subjectId);
                    });
                }

                final4Subjects = final4Subjects.slice(0, 4); // Ensure only 4 subjects are kept

                const totalScore = final4Subjects.length === 4 ? final4Subjects.reduce((sum, s) => sum + s.numericG1EquivGrade, 0) : Infinity;

                // Re-assign B roles sequentially for non-forced subjects if needed for consistency
                let bCounter = 1;
                final4Subjects.forEach(s => {
                    if (!s.role || s.role.startsWith('B')) {
                        let isForcedRole = forcedIncludeSubjects.some(fs => fs.subjectId === s.subjectId && fs.role && !fs.role.startsWith('B'));
                        if (!isForcedRole) {
                            s.role = `B${bCounter++}`;
                        }
                    }
                });

                return { score: totalScore, subjects: final4Subjects };
            };

            const getSubjectGradeForMer = (subjectId, requiredLevel, currentStudentSubjects) => {
                const subject = currentStudentSubjects.find(s => s.subjectId === subjectId);
                if (!subject) return Infinity;
                if (requiredLevel === "G3" && subject.level === "G3") return getNumericGrade(subject.grade, "G3");
                if (requiredLevel === "G2") return getNumericGrade(getStudentSubjectG2Grade(subject), "G2");
                if (requiredLevel === "G1") return getNumericGrade(getG1Equivalent(subject).g1EquivGrade, "G1");
                return Infinity;
            };

            const getSubjectGradeDisplay = (subjectId, grade, level) => `${getSubjectById(subjectId)?.name || subjectId}: ${grade} (${level})`;

            const getNextBetterGrade = (currentGrade, level) => {
                let gradesList = [], currentGradeIndex = -1;
                if (level === "G3") { gradesList = G3_GRADES_OPTIONS; currentGradeIndex = gradesList.indexOf(currentGrade); } 
                else if (level === "G2") { gradesList = G2_GRADES_OPTIONS; currentGradeIndex = gradesList.indexOf(currentGrade); } 
                else if (level === "G1") { gradesList = G1_GRADES_OPTIONS; currentGradeIndex = gradesList.indexOf(currentGrade); }
                return (currentGradeIndex === -1 || currentGradeIndex === 0) ? null : gradesList[currentGradeIndex - 1];
            };

            // --- Calculation Functions ---
            const calculateL1R4 = (currentStudentSubjects, config, currentBonusPoints = 0) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));

                let l1Subj, r1Subj, r2Subj, r3Subj, r4Subj;
                let usedSubjectIds = new Set();
                let subjectsUsedWithRoles = [];

                const findBestSubject = (categoryNamesArray, currentUsedIds, role) => {
                    let bestCandidate = null;
                    for (const subj of g3Subjects) {
                        // Ensure subj.category is not undefined before calling .includes()
                        if (subj.category && !currentUsedIds.has(subj.subjectId) && categoryNamesArray.includes(subj.category)) {
                            if (!bestCandidate || subj.numericGrade < bestCandidate.numericGrade) {
                                bestCandidate = subj;
                            }
                        }
                    }
                    if (bestCandidate) {
                        currentUsedIds.add(bestCandidate.subjectId);
                        return { ...bestCandidate, role: role };
                    }
                    return null;
                };

                l1Subj = findBestSubject(config.L1, usedSubjectIds, 'L1');
                if (!l1Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing L1 (EL/HMT G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(l1Subj);

                r1Subj = findBestSubject(config.R1_cat_ids, usedSubjectIds, 'R1');
                if (!r1Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R1 (Humanities G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r1Subj);

                r2Subj = findBestSubject(config.R2_cat_ids, usedSubjectIds, 'R2');
                if (!r2Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R2 (Math/Science G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r2Subj);

                r3Subj = findBestSubject(config.R3_cat_ids, usedSubjectIds, 'R3');
                if (!r3Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R3 (Hum/Math/Sci G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r3Subj);
                
                r4Subj = findBestSubject(config.R4_cat_ids, usedSubjectIds, 'R4');
                if (!r4Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R4 (Any other G3, not enough distinct subjects)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r4Subj);

                const grossScore = l1Subj.numericGrade + r1Subj.numericGrade + r2Subj.numericGrade + r3Subj.numericGrade + r4Subj.numericGrade;
                const netScore = grossScore - currentBonusPoints;
                
                return { grossScore: grossScore, netScore: netScore, subjectsUsed: subjectsUsedWithRoles, details: `EL(G3 ${l1Subj.grade}), R1(${getSubjectById(r1Subj.subjectId)?.name} G3 ${r1Subj.grade}), R2(${getSubjectById(r2Subj.subjectId)?.name} G3 ${r2Subj.grade}), R3(${getSubjectById(r3Subj.subjectId)?.name} G3 ${r3Subj.grade}), R4(${getSubjectById(r4Subj.subjectId)?.name} G3 ${r4Subj.grade})`};
            };

            const calculateELMAB3_G2 = (currentStudentSubjects, currentBonusPoints = 0, pathwayId = null) => {
                // Add numericOriginalGrade to all subjects for consistent sorting
                const allSubjectsWithOriginalNumericGrade = currentStudentSubjects.map(s => ({
                    ...s,
                    numericOriginalGrade: getNumericGrade(s.grade, s.level),
                    category: getSubjectById(s.subjectId)?.category
                })).filter(s => { // Filter for passing grades based on original level
                    if (s.level === "G3") return getNumericGrade(s.grade, "G3") <= G3_TO_NUMERIC_RAW["D7"];
                    if (s.level === "G2") return getNumericGrade(s.grade, "G2") <= G2_TO_NUMERIC_RAW["5"];
                    if (s.level === "G1") return getNumericGrade(s.grade, "G1") <= G1_TO_NUMERIC_RAW_ITE["D"];
                    return false;
                });

                let subjectsUsedWithRoles = [];
                let scoreDetailsParts = [];
                let usedSubjectIds = new Set();

                // 1. Find EL based on original grade, then get G2 equivalent
                const elCandidates = allSubjectsWithOriginalNumericGrade
                    .filter(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId))
                    .sort((a, b) => a.numericOriginalGrade - b.numericOriginalGrade);
                const el = elCandidates.length > 0 ? elCandidates[0] : null;
                if (!el) return { grossScore: Infinity, netScore: Infinity, details: "Missing English (G2 equiv. pass)", subjectsUsed: [] };
                subjectsUsedWithRoles.push({ ...el, role: 'EL' });
                scoreDetailsParts.push(`EL(G2 ${getStudentSubjectG2Grade(el)})`);
                usedSubjectIds.add(el.subjectId);

                // 2. Find MA (Math/Add Math) based on original grade, then get G2 equivalent
                const maCandidates = allSubjectsWithOriginalNumericGrade
                    .filter(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(s.category) && !usedSubjectIds.has(s.subjectId))
                    .sort((a, b) => a.numericOriginalGrade - b.numericOriginalGrade);
                const ma = maCandidates.length > 0 ? maCandidates[0] : null;
                if (!ma) return { grossScore: Infinity, netScore: Infinity, details: "Missing Maths (G2 equiv. pass)", subjectsUsed: [] };
                subjectsUsedWithRoles.push({ ...ma, role: 'MA' });
                scoreDetailsParts.push(`MA(G2 ${getStudentSubjectG2Grade(ma)})`);
                usedSubjectIds.add(ma.subjectId);

                let relevantSubject = null;
                let otherSubjects = [];

                const pathwayConfig = PATHWAYS.find(p => p.id === pathwayId);

                if (pathwayConfig && pathwayConfig.group === "PFP") {
                    // Find the best relevant subject for PFP based on original grade, then get G2 equivalent
                    const relevantSubjCandidates = allSubjectsWithOriginalNumericGrade
                        .filter(s => pathwayConfig.mer.relevant_subj_ids.includes(s.subjectId) && !usedSubjectIds.has(s.subjectId))
                        .sort((a, b) => a.numericOriginalGrade - b.numericOriginalGrade); // Sort by original grade
                    relevantSubject = relevantSubjCandidates.length > 0 ? relevantSubjCandidates[0] : null;

                    if (!relevantSubject) {
                        return { grossScore: Infinity, netScore: Infinity, details: `Missing required relevant subject for PFP (${getSubjectNamesFromIds(pathwayConfig.mer.relevant_subj_ids)})`, subjectsUsed: [] };
                    }
                    subjectsUsedWithRoles.push({ ...relevantSubject, role: 'B1' });
                    scoreDetailsParts.push(`B1(${getSubjectById(relevantSubject.subjectId)?.name} ${relevantSubject.level} ${relevantSubject.grade} (G2 equiv ${getStudentSubjectG2Grade(relevantSubject)}))`);
                    usedSubjectIds.add(relevantSubject.subjectId);

                    // Find the best 2 other subjects based on original grade, then get G2 equivalent
                    otherSubjects = allSubjectsWithOriginalNumericGrade
                        .filter(s => !usedSubjectIds.has(s.subjectId))
                        .sort((a, b) => a.numericOriginalGrade - b.numericOriginalGrade) // Sort by original grade
                        .slice(0, 2);

                    if (otherSubjects.length < 2) {
                        return { grossScore: Infinity, netScore: Infinity, details: `Need 2 other subjects (G2 equiv. pass) for PFP, found ${otherSubjects.length}`, subjectsUsed: [] };
                    }
                    otherSubjects.forEach((s, index) => {
                        subjectsUsedWithRoles.push({ ...s, role: `B${index + 2}` });
                        scoreDetailsParts.push(`B${index + 2}(${getSubjectById(s.subjectId)?.name} ${s.level} ${s.grade} (G2 equiv ${getStudentSubjectG2Grade(s)}))`);
                    });

                } else { // For ITE Year 2 Higher Nitec (also uses ELMAB3_G2 calcType)
                    // Find the best 3 other subjects based on original grade, then get G2 equivalent
                    otherSubjects = allSubjectsWithOriginalNumericGrade
                        .filter(s => !usedSubjectIds.has(s.subjectId))
                        .sort((a, b) => a.numericOriginalGrade - b.numericOriginalGrade) // Sort by original grade
                        .slice(0, 3);

                    if (otherSubjects.length < 3) {
                        return { grossScore: Infinity, netScore: Infinity, details: `Need 3 other subjects (G2 equiv. pass), found ${otherSubjects.length}`, subjectsUsed: [] };
                    }
                    otherSubjects.forEach((s, index) => {
                        subjectsUsedWithRoles.push({ ...s, role: `B${index + 1}` });
                        scoreDetailsParts.push(`B${index + 1}(${getSubjectById(s.subjectId)?.name} ${s.level} ${s.grade} (G2 equiv ${getStudentSubjectG2Grade(s)}))`);
                    });
                }

                const grossScore = getNumericGrade(getStudentSubjectG2Grade(el), "G2") + getNumericGrade(getStudentSubjectG2Grade(ma), "G2") + (relevantSubject ? getNumericGrade(getStudentSubjectG2Grade(relevantSubject), "G2") : 0) + otherSubjects.reduce((sum, s) => sum + getNumericGrade(getStudentSubjectG2Grade(s), "G2"), 0);
                const netScore = grossScore - currentBonusPoints;

                return { grossScore: grossScore, netScore: netScore, subjectsUsed: subjectsUsedWithRoles, details: scoreDetailsParts.join(", ") };
            };

            const calculateELR2B2_G3_Mixed = (currentStudentSubjects, config, currentBonusPoints = 0) => {
                const g3SubjectsForCalc = currentStudentSubjects
                    .filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));

                // Pool of all subjects with their original numeric grade, for B2 selection based on original score
                const allSubjectsWithOriginalNumericGradeForB2 = currentStudentSubjects
                    .map(s => ({
                        ...s,
                        numericOriginalGrade: getNumericGrade(s.grade, s.level),
                        category: getSubjectById(s.subjectId)?.category
                    }))
                    .filter(s => s.numericOriginalGrade !== Infinity); // Ensure it's a valid grade

                let usedSubjectIds = new Set();
                let scoreDetailsParts = [];
                let subjectsUsedWithRoles = []; 

                // Helper function to find the best subject based on criteria (category or specific IDs)
                const findBestSubjectInPool = (pool, criteria, currentUsedIds, role, gradeField = 'numericGrade', filterByIds = false) => { 
                    let bestCandidate = null;
                    const sortedPool = [...pool].sort((a, b) => a[gradeField] - b[gradeField]);

                    for (const subj of sortedPool) { 
                        if (!currentUsedIds.has(subj.subjectId)) {
                            let matchesCriteria = false;
                            if (filterByIds) {
                                matchesCriteria = criteria.includes(subj.subjectId);
                            } else {
                                // Ensure subj.category is defined before using it in includes()
                                if (subj.category) {
                                    matchesCriteria = criteria.some(cat => 
                                        SUBJECT_CATEGORIES_DEF[cat] 
                                            ? SUBJECT_CATEGORIES_DEF[cat].includes(subj.category) 
                                            : subj.category === cat
                                    );
                                }
                            }

                            if (matchesCriteria) {
                                bestCandidate = subj; 
                                break; 
                            }
                        }
                    }
                    return bestCandidate; 
                };
                
                const isPolyElr2b2A = config.ELR2B2_A_R1_SUBJECT_IDS && config.ELR2B2_A_R1_SUBJECT_IDS === ELR2B2_A_R1_SUBJECT_IDS; 

                const el_g3_candidate = findBestSubjectInPool(g3SubjectsForCalc, config.EL, usedSubjectIds, 'EL', 'numericGrade');
                if (el_g3_candidate) {
                    usedSubjectIds.add(el_g3_candidate.subjectId);
                    subjectsUsedWithRoles.push({ ...el_g3_candidate, role: 'EL' });
                    scoreDetailsParts.push(`EL(G3 ${el_g3_candidate.grade})`);
                } else {
                    subjectsUsedWithRoles.push({ subjectId: 'N/A', level: 'N/A', grade: 'N/A', role: 'EL' }); // Placeholder for missing subject
                    scoreDetailsParts.push(`EL(Missing)`);
                }

                const r1_g3_candidate = findBestSubjectInPool(
                    g3SubjectsForCalc,
                    isPolyElr2b2A ? ELR2B2_A_R1_SUBJECT_IDS : config.R1_cat_ids,
                    usedSubjectIds,
                    'R1', 
                    'numericGrade',
                    isPolyElr2b2A 
                );
                if (r1_g3_candidate) {
                    usedSubjectIds.add(r1_g3_candidate.subjectId);
                    subjectsUsedWithRoles.push({ ...r1_g3_candidate, role: 'R1' });
                    scoreDetailsParts.push(`R1(${getSubjectById(r1_g3_candidate.subjectId)?.name} G3 ${r1_g3_candidate.grade})`);
                } else {
                    subjectsUsedWithRoles.push({ subjectId: 'N/A', level: 'N/A', grade: 'N/A', role: 'R1' }); // Placeholder for missing subject
                    scoreDetailsParts.push(`R1(Missing)`);
                }

                const r2_g3_candidate = findBestSubjectInPool(
                    g3SubjectsForCalc,
                    isPolyElr2b2A ? ELR2B2_A_R2_SUBJECT_IDS_FULL : config.R2_cat_ids,
                    usedSubjectIds,
                    'R2', 
                    'numericGrade',
                    isPolyElr2b2A 
                );
                if (r2_g3_candidate) {
                    usedSubjectIds.add(r2_g3_candidate.subjectId);
                    subjectsUsedWithRoles.push({ ...r2_g3_candidate, role: 'R2' });
                    scoreDetailsParts.push(`R2(${getSubjectById(r2_g3_candidate.subjectId)?.name} G3 ${r2_g3_candidate.grade})`);
                } else {
                    subjectsUsedWithRoles.push({ subjectId: 'N/A', level: 'N/A', grade: 'N/A', role: 'R2' }); // Placeholder for missing subject
                    scoreDetailsParts.push(`R2(Missing)`);
                }

                const b1_g3_candidate = findBestSubjectInPool(g3SubjectsForCalc, config.B_cat_ids, usedSubjectIds, 'B1', 'numericGrade');
                if (b1_g3_candidate) {
                    usedSubjectIds.add(b1_g3_candidate.subjectId);
                    subjectsUsedWithRoles.push({ ...b1_g3_candidate, role: 'B1' });
                    scoreDetailsParts.push(`B1(${getSubjectById(b1_g3_candidate.subjectId)?.name} G3 ${b1_g3_candidate.grade})`);
                } else {
                    subjectsUsedWithRoles.push({ subjectId: 'N/A', level: 'N/A', grade: 'N/A', role: 'B1' }); // Placeholder for missing subject
                    scoreDetailsParts.push(`B1(Missing)`);
                }

                // MODIFIED LOGIC FOR B2 SELECTION:
                // 1. Find the best subject from the remaining pool based on its ORIGINAL numeric grade.
                const b2_candidate_original = findBestSubjectInPool(allSubjectsWithOriginalNumericGradeForB2, config.B_cat_ids, usedSubjectIds, 'B2', 'numericOriginalGrade');

                let b2_g2_equiv_candidate = null;
                if (b2_candidate_original) {
                    // 2. Convert the best found subject's grade to G2 equivalent.
                    const g2Grade = getStudentSubjectG2Grade(b2_candidate_original);
                    b2_g2_equiv_candidate = {
                        ...b2_candidate_original,
                        g2Grade: g2Grade,
                        numericG2Equiv: getNumericGrade(g2Grade, "G2")
                    };
                    usedSubjectIds.add(b2_g2_equiv_candidate.subjectId); // Mark as used
                    subjectsUsedWithRoles.push({ ...b2_g2_equiv_candidate, role: 'B2' });
                    scoreDetailsParts.push(`B2(${getSubjectById(b2_g2_equiv_candidate.subjectId)?.name} ${b2_g2_equiv_candidate.level} ${b2_g2_equiv_candidate.grade} (G2 equiv ${b2_g2_equiv_candidate.g2Grade}))`);
                } else {
                    subjectsUsedWithRoles.push({ subjectId: 'N/A', level: 'N/A', grade: 'N/A', role: 'B2' }); // Placeholder for missing subject
                    scoreDetailsParts.push(`B2(Missing)`);
                }
                
                let grossScore = Infinity;
                if (el_g3_candidate && r1_g3_candidate && r2_g3_candidate && b1_g3_candidate && b2_g2_equiv_candidate) {
                    grossScore = el_g3_candidate.numericGrade + r1_g3_candidate.numericGrade + r2_g3_candidate.numericGrade + b1_g3_candidate.numericGrade + b2_g2_equiv_candidate.numericG2Equiv;
                }
                const netScore = grossScore === Infinity ? Infinity : grossScore - currentBonusPoints;
                
                return { grossScore: grossScore, netScore: netScore, subjectsUsed: subjectsUsedWithRoles, details: scoreDetailsParts.join(", ") };
            };

            const calculate5thYearSecondary = (currentStudentSubjects, currentBonusPoints = 0) => {
                const subjectsForCalc = currentStudentSubjects.map(s => ({
                    ...s, g2Grade: getStudentSubjectG2Grade(s), numericG2Grade: getNumericGrade(getStudentSubjectG2Grade(s), "G2"), category: getSubjectById(s.subjectId)?.category
                })).filter(s => G2_GRADES_OPTIONS.includes(s.g2Grade) && s.numericG2Grade <= 5); 

                if (subjectsForCalc.length < 5) return { grossScore: Infinity, netScore: Infinity, details: "Need at least 5 subjects with G2 Grade 5 or better.", subjectsUsed: [] };
                
                const el = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId));
                const ma = subjectsForCalc.Calc.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(s.category));
                let elmab3Score = Infinity, elb3Score = Infinity, mab3Score = Infinity;
                let details = [], subjectsUsedForBestScore = [];

                if (el && ma) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId && s.subjectId !== ma.subjectId).sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        elmab3Score = el.numericG2Grade + ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`ELMAB3: ${elmab3Score}`);
                        subjectsUsedForBestScore.push({ score: elmab3Score, subjects: [ {...el, role: 'EL'}, {...ma, role: 'MA'}, {...b3[0], role: 'B1'}, {...b3[1], role: 'B2'}, {...b3[2], role: 'B3'} ] });
                    }
                }
                if (el) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId).sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        elb3Score = el.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`ELB3: ${elb3Score}`);
                        subjectsUsedForBestScore.push({ score: elb3Score, subjects: [ {...el, role: 'EL'}, {...b3[0], role: 'B1'}, {...b3[1], role: 'B2'}, {...b3[2], role: 'B3'} ] });
                    }
                }
                if (ma) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== ma.subjectId).sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        mab3Score = ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`MAB3: ${mab3Score}`);
                        subjectsUsedForBestScore.push({ score: mab3Score, subjects: [ {...ma, role: 'MA'}, {...b3[0], role: 'B1'}, {...b3[1], role: 'B2'}, {...b3[2], role: 'B3'} ] });
                    }
                }
                
                const scoreMet = (elmab3Score <= 21) || (elb3Score <= 14) || (mab3Score <= 14);
                const finalScore = Math.min(elmab3Score, elb3Score, mab3Score);
                let actualSubjectsUsed = [];
                if (subjectsUsedForBestScore.length > 0) {
                    subjectsUsedForBestScore.sort((a, b) => a.score - b.score);
                    if (subjectsUsedForBestScore[0].score !== Infinity) actualSubjectsUsed = subjectsUsedForBestScore[0].subjects;
                    else actualSubjectsUsed = subjectsForCalc.sort((a,b) => a.numericG2Grade - b.numericG2Grade).slice(0, 5).map((s, idx) => ({...s, role: `B${idx+1}`}));
                } else {
                    actualSubjectsUsed = subjectsForCalc.sort((a,b) => a.numericG2Grade - b.numericG2Grade).slice(0, 5).map((s, idx) => ({...s, role: `B${idx+1}`}));
                }
                return { grossScore: finalScore, netScore: finalScore - currentBonusPoints, details: details.join("; "), scoreMet: scoreMet, subjectsUsed: actualSubjectsUsed };
            };

            const calculateArtsInstitutions = (currentStudentSubjects) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level) }));
                const el = g3Subjects.find(s => s.subjectId === "EL");
                const elCheck = el && getNumericGrade(el.grade, "G3") <= G3_TO_NUMERIC_RAW["C6"]; 
                const otherG3Subjects = g3Subjects.filter(s => s.subjectId !== "EL").sort((a, b) => a.numericGrade - b.numericGrade);

                if (!elCheck || otherG3Subjects.length < 4) return { grossScore: Infinity, netScore: Infinity, details: "Missing EL (G3 C6 or better), or not enough other G3 subjects.", subjectsUsed: [] };
                
                const best4Others = otherG3Subjects.slice(0, 4).map((s, index) => ({ ...s, role: `B${index + 1}` }));
                const totalScore = best4Others.reduce((sum, s) => sum + s.numericGrade, 0);
                return { grossScore: totalScore, netScore: totalScore, subjectsUsed: [{...el, role: 'EL'}, ...best4Others], details: `Best 4 G3 (excl. EL): ${totalScore}` };
            };


            const calculateITEHnitecSpecific = (currentStudentSubjects, requirements, currentBonusPoints = 0) => {
                let metCriteria = true; 
                let details = []; 
                let aggregateScore = Infinity;
                let subjectsForAggregate = [];
                const usedForAggregateIds = new Set(); 
            
                // Filter for subjects that are "passes" in their original G3, G2, or G1 level.
                const passingOriginalSubjects = currentStudentSubjects.filter(s => {
                    if (s.level === "G3") {
                        return getNumericGrade(s.grade, "G3") <= G3_TO_NUMERIC_RAW["D7"]; // D7 or better for G3 pass
                    } else if (s.level === "G2") {
                        return getNumericGrade(s.grade, "G2") <= G2_TO_NUMERIC_RAW["5"]; // 5 or better for G2 pass
                    } else if (s.level === "G1") {
                        return G1_GRADES_OPTIONS.includes(s.grade) && getNumericGrade(s.grade, "G1") <= G1_TO_NUMERIC_RAW_ITE["D"]; // A-D for G1 pass
                    }
                    return false; // Not a recognized level or not a pass
                }).map(s => ({ ...s, numericOriginalGrade: getNumericGrade(s.grade, s.level) })); // Add numericOriginalGrade here
            
                const totalSubjectsCheck = currentStudentSubjects.length >= requirements.min_total_subjects;
                details.push({ merId: 'min_total_subjects', text: `Minimum of ${requirements.min_total_subjects} subjects total (found ${currentStudentSubjects.length})`, met: totalSubjectsCheck });
                if (!totalSubjectsCheck) metCriteria = false;
            
                if (requirements.type === "3_G1G2_ONLY") {
                    let elPass, mathPass, mainSubjectPass;
                    let elCheck = false, mathCheck = false, mainSubjectCheck = false;
                    let otherPassesRequired = requirements.req_g1g2_other_count;
                    let usedForMerPrereqIds = new Set();
            
                    if (requirements.req_g1g2_main_cats.includes(SUBJECT_CATEGORIES_DEF.EL[0]) &&
                        requirements.req_g1g2_main_cats.includes(SUBJECT_CATEGORIES_DEF.MATH_PURE[0])) {
                        elPass = passingOriginalSubjects.find(s => getSubjectById(s.subjectId)?.category === SUBJECT_CATEGORIES_DEF.EL[0]);
                        elCheck = !!elPass;
                        details.push({ merId: 'el_g1g2_pass', text: `English (G1/G2 pass)`, met: elCheck });
                        if (!elCheck) metCriteria = false; else if (elPass) usedForMerPrereqIds.add(elPass.subjectId);
            
                        mathPass = passingOriginalSubjects.find(s => 
                            SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(getSubjectById(s.subjectId)?.category) &&
                            (!elPass || s.subjectId !== elPass.subjectId) 
                        );
                        mathCheck = !!mathPass;
                        details.push({ merId: 'math_g1g2_pass', text: `Mathematics (G1/G2 pass)`, met: mathCheck });
                        if (!mathCheck) metCriteria = false; else if (mathPass) usedForMerPrereqIds.add(mathPass.subjectId);
                    } else { 
                        const filteredMainSubjects = passingOriginalSubjects.filter(s => {
                            const subjectCategory = getSubjectById(s.subjectId)?.category;
                            const isMainCat = requirements.req_g1g2_main_cats.some(cat => SUBJECT_CATEGORIES_DEF[cat] ? SUBJECT_CATEGORIES_DEF[cat].includes(subjectCategory) : subjectCategory === cat);
                            const isScienceInLieu = requirements.allow_science_in_lieu && SUBJECT_CATEGORIES_DEF.SCIENCE_IN_LIEU.includes(subjectCategory);
                            return isMainCat || isScienceInLieu;
                        }).sort((a,b) => a.numericOriginalGrade - b.numericOriginalGrade);
                        
                        mainSubjectPass = filteredMainSubjects.length > 0 ? filteredMainSubjects[0] : null;
                        mainSubjectCheck = !!mainSubjectPass;
                        let mainSubjectDisplayText = "1 G1/G2 pass in required category";
                        let mainSubjectMerId = 'main_g1g2_pass';
                        if (requirements.req_g1g2_main_cats.length === 1 && requirements.req_g1g2_main_cats[0] === SUBJECT_CATEGORIES_DEF.EL[0]) { mainSubjectDisplayText = "English (G1/G2 pass)"; mainSubjectMerId = 'el_g1g2_pass'; }
                        else if (requirements.req_g1g2_main_cats.length === 1 && requirements.req_g1g2_main_cats[0] === SUBJECT_CATEGORIES_DEF.MATH_PURE[0]) { mainSubjectDisplayText = "Mathematics (G1/G2 pass)"; mainSubjectMerId = 'math_g1g2_pass'; }
                        else if (JSON.stringify(requirements.req_g1g2_main_cats.sort()) === JSON.stringify(SUBJECT_CATEGORIES_DEF.MATH_SCIENCE.sort())) { mainSubjectDisplayText = "Math or Science (G1/G2 pass)"; mainSubjectMerId = 'math_or_science_g1g2_pass';}
                        details.push({ merId: mainSubjectMerId, text: mainSubjectDisplayText, met: mainSubjectCheck });
                        if (!mainSubjectCheck) metCriteria = false; else if (mainSubjectPass) usedForMerPrereqIds.add(mainSubjectPass.subjectId);
                    }
                    const remainingPassingOriginalSubjects = passingOriginalSubjects.filter(s => !usedForMerPrereqIds.has(s.subjectId));
                    const actualOtherCountCheck = remainingPassingOriginalSubjects.length >= otherPassesRequired;
                    details.push({ merId: 'other_g1g2_passes', text: `${otherPassesRequired} other distinct G1/G2 pass(es)`, met: actualOtherCountCheck });
                    if (!actualOtherCountCheck) metCriteria = false; 
                } else if (requirements.type === "2_G3_ONLY") {
                    const g3Passes = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade) && getNumericGrade(s.grade, "G3") <= requirements.req_g3_grade);
                    const g3CountCheck = g3Passes.length >= requirements.req_g3_count;
                    details.push({ merId: 'g3_passes_count', text: `${requirements.req_g3_count} G3 passes (Grade ${G3_GRADES_OPTIONS[requirements.req_g3_grade -1]} or better)`, met: g3CountCheck });
                    if (!g3CountCheck) metCriteria = false;
                }

                if (requirements.type === "3_G1G2_ONLY" && requirements.pre_requisite_subject_ids) {
                    requirements.pre_requisite_subject_ids.forEach(prereqId => {
                        let foundPrereqSub = null;
                        let roleForPrereq = '';
                        if (prereqId === "EL") {
                            foundPrereqSub = passingOriginalSubjects.find(s => getSubjectById(s.subjectId)?.category === SUBJECT_CATEGORIES_DEF.EL[0] && !usedForAggregateIds.has(s.subjectId));
                            roleForPrereq = 'EL (Prereq)';
                        } else if (prereqId === "MATH") {
                            foundPrereqSub = passingOriginalSubjects.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(getSubjectById(s.subjectId)?.category) && !usedForAggregateIds.has(s.subjectId));
                            roleForPrereq = 'Math (Prereq)';
                        } else if (prereqId === "MATH_OR_SCIENCE") {
                            foundPrereqSub = passingOriginalSubjects.filter(s => {
                                const cat = getSubjectById(s.subjectId)?.category;
                                return (SUBJECT_CATEGORIES_DEF.MATH_SCIENCE.includes(cat) || (requirements.allow_science_in_lieu && SUBJECT_CATEGORIES_DEF.SCIENCE_IN_LIEU.includes(cat))) && !usedForAggregateIds.has(s.subjectId);
                            }).sort((a,b) => a.numericOriginalGrade - b.numericOriginalGrade)[0];
                            roleForPrereq = 'M/S (Prereq)';
                        }
                        if (foundPrereqSub) {
                            subjectsForAggregate.push({...getG1Equivalent(foundPrereqSub), role: roleForPrereq});
                            usedForAggregateIds.add(foundPrereqSub.subjectId);
                        }
                    });

                    const remainingSlots = 4 - subjectsForAggregate.length;
                    if (remainingSlots > 0) {
                        const otherBestSubjects = passingOriginalSubjects
                            .filter(s => !usedForAggregateIds.has(s.subjectId))
                            .sort((a, b) => a.numericOriginalGrade - b.numericOriginalGrade)
                            .slice(0, remainingSlots);
                        otherBestSubjects.forEach(s => {
                            subjectsForAggregate.push({...getG1Equivalent(s), role: `B${subjectsForAggregate.filter(sub => sub.role && sub.role.startsWith('B')).length + 1}`}); 
                            usedForAggregateIds.add(s.subjectId);
                        });
                    }
                    subjectsForAggregate = subjectsForAggregate.slice(0, 4);
                } else { 
                    const best4Calc = calculateBest4G1Equivalent(currentStudentSubjects); 
                    subjectsForAggregate = best4Calc.subjects;
                }
            
                if(subjectsForAggregate.length === 4) { // Aggregate only if exactly 4 subjects are found
                    aggregateScore = subjectsForAggregate.reduce((sum, s) => sum + s.numericG1EquivGrade, 0);
                } else {
                    aggregateScore = Infinity; 
                }
            
                details.push({ merId: 'aggregate_note', text: "Check the aggregate point for specific course.", met: false, isPlainBullet: true });
            
                return {
                    grossScore: aggregateScore, 
                    netScore: aggregateScore === Infinity ? Infinity : aggregateScore - currentBonusPoints,
                    details: details, 
                    scoreMet: metCriteria, 
                    subjectsUsed: subjectsForAggregate, 
                };
            };
            
            const calculateITEHnitecCompleted = (currentStudentSubjects, pathwayRequirements, currentBonusPoints = 0) => { 
                let metCriteria = false;
                let details = []; 
                let best4Score = Infinity;
                let best4Subjects = [];
            
                // Filter for subjects that are "passes" in their original G3, G2, or G1 level.
                const passingOriginalSubjects = currentStudentSubjects.filter(s => {
                    if (s.level === "G3") {
                        return getNumericGrade(s.grade, "G3") <= G3_TO_NUMERIC_RAW["D7"]; // D7 or better for G3 pass
                    } else if (s.level === "G2") {
                        return getNumericGrade(s.grade, "G2") <= G2_TO_NUMERIC_RAW["5"]; // 5 or better for G2 pass
                    } else if (s.level === "G1") {
                        return G1_GRADES_OPTIONS.includes(s.grade) && getNumericGrade(s.grade, "G1") <= G1_TO_NUMERIC_RAW_ITE["D"]; // A-D for G1 pass
                    }
                    return false; // Not a recognized level or not a pass
                }).map(s => ({ ...s, numericOriginalGrade: getNumericGrade(s.grade, s.level) })); // Add numericOriginalGrade here
            
                if (pathwayRequirements && pathwayRequirements.min_total_subjects && currentStudentSubjects.length >= pathwayRequirements.min_total_subjects) { 
                    metCriteria = true;
                    details.push({ merId: 'sec_completion', text: `Completed Singapore-Cambridge Secondary Education Certificate (at least ${pathwayRequirements.min_total_subjects} subjects).`, met: true });
                } else {
                    metCriteria = false;
                    details.push({ merId: 'sec_completion', text: `Requires completion of Singapore-Cambridge Secondary Education Certificate (with at least ${pathwayRequirements?.min_total_subjects || 'N/A'} subjects, found ${currentStudentSubjects.length}).`, met: false });
                }
            
                // Calculate best 4 from passing original subjects
                const best4Calc = calculateBest4G1Equivalent(currentStudentSubjects);
                best4Score = best4Calc.score;
                best4Subjects = best4Calc.subjects;
            
                details.push({ merId: 'aggregate_note', text: "Check the aggregate point for specific course.", met: false, isPlainBullet: true });
            
                return {
                    grossScore: best4Score, 
                    netScore: best4Score === Infinity ? Infinity : best4Score - currentBonusPoints,
                    details: details, 
                    scoreMet: metCriteria, 
                    subjectsUsed: best4Subjects, 
                };
            };

            const checkMerRequirements = (pathway, currentStudentSubjects, bonusPoints, subjectsUsedForScoreCalculation) => {
                let merDetails = [];
                let overallMerMet = true; 
                const studentSubjectsMap = new Map(currentStudentSubjects.map(s => [s.subjectId, s])); 
            
                if (pathway.calcType === "L1R4_G3") {
                    const scoreCheck = pathway.grossScore <= pathway.requirements.grossL1R4;
                    merDetails.push({ merId: 'l1r4_gross_score', text: `L1R4 (G3 subjects)  ${pathway.requirements.grossL1R4} (Your Gross: ${pathway.grossScore})`, met: scoreCheck });
                    if (!scoreCheck) overallMerMet = false;
                } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                    const scoreCheck = pathway.netScore <= pathway.requirements.netELR2B2;
                    merDetails.push({ merId: 'elr2b2_net_score', text: `ELR2B2 (Net)  ${pathway.requirements.netELR2B2} (Your Net: ${pathway.netScore})`, met: scoreCheck });
                    if (!scoreCheck) overallMerMet = false;
            
                    let tempUsedSubjectsForMERDisplay = new Set(); 
                    const el = studentSubjectsMap.get("EL");
                    // MODIFIED: Removed the specific grade check for English. Now only checks if EL exists.
                    const elCheck = !!el && el.level === "G3"; // Only check if English (EL) subject exists and is G3 level
                    merDetails.push({ merId: 'el_mer_poly', text: `English (G3): ${el ? getSubjectGradeDisplay(el.subjectId, el.grade, el.level) : 'N/A'} (Required G3)`, met: elCheck });
                    if (!elCheck) overallMerMet = false;
                    if (elCheck) tempUsedSubjectsForMERDisplay.add(el.subjectId);
            
                    const elr2b2_subjects = subjectsUsedForScoreCalculation; 
                    
                    const r1_found = elr2b2_subjects.find(s => s.role === 'R1');
                    let r1CategoryText = `1 Relevant subject (G3) (R1 Category)`;
                    let r1SubjectIdsForTooltip = [];
                    if (pathway.id === "poly_yr1_elr2b2_a") r1SubjectIdsForTooltip = ELR2B2_A_R1_SUBJECT_IDS;
                    else if (pathway.id === "poly_yr1_elr2b2_b") r1SubjectIdsForTooltip = ELR2B2_B_R1_SUBJECT_IDS;
                    else if (pathway.id === "poly_yr1_elr2b2_c_general") r1SubjectIdsForTooltip = ELR2B2_C_R1_SUBJECT_IDS;
                    else if (pathway.id === "poly_yr1_elr2b2_d") r1SubjectIdsForTooltip = ELR2B2_D_R1_SUBJECT_IDS;
                    r1CategoryText = `<span class="tooltip">${r1CategoryText}<sup><small>i</small></sup><span class="tooltiptext">${getSubjectNamesFromIds(r1SubjectIdsForTooltip)}</span></span>`;
                    merDetails.push({ merId: 'r1_mer_poly', text: `${r1CategoryText}: ${r1_found ? getSubjectGradeDisplay(r1_found.subjectId, r1_found.grade, r1_found.level) : 'Not Found'}`, met: !!r1_found });
                    if (!r1_found) overallMerMet = false;

                    const r2_found = elr2b2_subjects.find(s => s.role === 'R2');
                    let r2CategoryText = `1 Relevant subject (G3) (R2 Category)`;
                    let r2SubjectIdsForTooltip = [];
                     if (pathway.id === "poly_yr1_elr2b2_a") r2SubjectIdsForTooltip = ELR2B2_A_R2_SUBJECT_IDS_FULL;
                    else if (pathway.id === "poly_yr1_elr2b2_b") r2SubjectIdsForTooltip = ELR2B2_B_R2_SUBJECT_IDS_FULL;
                    else if (pathway.id === "poly_yr1_elr2b2_c_general") r2SubjectIdsForTooltip = ELR2B2_C_R2_SUBJECT_IDS_FULL;
                    else if (pathway.id === "poly_yr1_elr2b2_d") r2SubjectIdsForTooltip = ELR2B2_D_R2_SUBJECT_IDS_FULL;
                    r2CategoryText = `<span class="tooltip">${r2CategoryText}<sup><small>i</small></sup><span class="tooltiptext">${getSubjectNamesFromIds(r2SubjectIdsForTooltip)}</span></span>`;
                    // MODIFIED: Added r2CategoryText to the merDetails push for R2 subject
                    merDetails.push({ merId: 'r2_mer_poly', text: `${r2CategoryText}: ${r2_found ? getSubjectGradeDisplay(r2_found.subjectId, r2_found.grade, r2_found.level) : 'Not Found'}`, met: !!r2_found });
                    if (!r2_found) overallMerMet = false;

                    const b1_found = elr2b2_subjects.find(s => s.role === 'B1');
                    merDetails.push({ merId: 'b1_mer_poly', text: `One B subject (G3): ${b1_found ? getSubjectGradeDisplay(b1_found.subjectId, b1_found.grade, b1_found.level) : 'Not Found'}`, met: !!b1_found });
                    if (!b1_found) overallMerMet = false;

                    const b2_found = elr2b2_subjects.find(s => s.role === 'B2');
                    merDetails.push({ merId: 'b2_mer_poly', text: `One B subject (G2 equivalent): ${b2_found ? `${getSubjectById(b2_found.subjectId)?.name} ${b2_found.level} ${b2_found.grade} (G2 equiv ${getStudentSubjectG2Grade(b2_found)})` : 'Not Found'}`, met: !!b2_found });
                    if (!b2_found) overallMerMet = false;
            
                    merDetails.push({ merId: 'course_finder_note', text: `Please confirm course-specific minimum entry requirements using <a href="https://www.moe.gov.sg/coursefinder" target="_blank" class="text-cyan-400 hover:underline">MOE CourseFinder</a>.`, met: false, isPlainBullet: true });
            
                } else if (pathway.calcType === "ELMAB3_G2") { 
                    const scoreCheck = pathway.grossScore <= pathway.requirements.grossELMAB3;
                    merDetails.push({ merId: 'elmab3_gross_score', text: `ELMAB3 (Gross)  ${pathway.requirements.grossELMAB3} (Your Gross: ${pathway.grossScore === Infinity ? 'N/A' : pathway.grossScore})`, met: scoreCheck });
                    if (!scoreCheck) overallMerMet = false;
            
                    const el = studentSubjectsMap.get("EL"); 
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");
            
                    const elCheck = pathway.mer && pathway.mer.el_g2 && el && getNumericGrade(getStudentSubjectG2Grade(el), "G2") <= getNumericGrade(pathway.mer.el_g2, "G2");
                    merDetails.push({ merId: 'el_mer', text: `English (G2 equiv): ${el ? getStudentSubjectG2Grade(el) : 'N/A'} (Required G2  ${pathway.mer?.el_g2 || 'N/A'})`, met: !!elCheck });
                    if (!elCheck) overallMerMet = false;
                    
                    let usedForPFPMer = new Set(); 
                    if (elCheck && el) usedForPFPMer.add(el.subjectId);

                    let mathGradeForMer = Infinity, amGradeForMer = Infinity;
                    let mathSubjForMer = null, amSubjForMer = null;
                    if (math) { mathGradeForMer = getNumericGrade(getStudentSubjectG2Grade(math), "G2"); mathSubjForMer = math; }
                    if (am) { amGradeForMer = getNumericGrade(getStudentSubjectG2Grade(am), "G2"); amSubjForMer = am; }
                    let effectiveMathGradeForMer = Math.min(mathGradeForMer, amGradeForMer);
                    let mathDisplayForMer = 'N/A', mathSubjUsedForMer = null;
                    if (effectiveMathGradeForMer !== Infinity) {
                        if (effectiveMathGradeForMer === mathGradeForMer && mathSubjForMer) { mathDisplayForMer = getStudentSubjectG2Grade(mathSubjForMer); mathSubjUsedForMer = mathSubjForMer; }
                        else if (effectiveMathGradeForMer === amGradeForMer && amSubjForMer) { mathDisplayForMer = getStudentSubjectG2Grade(amSubjForMer); mathSubjUsedForMer = amSubjForMer; }
                    }
                    const mathCheck = pathway.mer && pathway.mer.math_am_g2 && mathSubjUsedForMer && effectiveMathGradeForMer <= getNumericGrade(pathway.mer.math_am_g2, "G2");
                    merDetails.push({ merId: 'math_am_mer', text: `Math/Add Math (G2 equiv): ${mathDisplayForMer} (Required G2  ${pathway.mer?.math_am_g2 || 'N/A'})`, met: !!mathCheck });
                    if (!mathCheck) overallMerMet = false;
                    if (mathCheck && mathSubjUsedForMer) usedForPFPMer.add(mathSubjUsedForMer.subjectId);

                    if (pathway.group === "PFP") {
                        let relevantSubjFound = false, relevantSubjDisplay = 'N/A';
                        const relevantSubjCandidates = currentStudentSubjects.filter(subj => 
                            pathway.mer.relevant_subj_ids.includes(subj.subjectId) && !usedForPFPMer.has(subj.subjectId) &&
                            getNumericGrade(subj.grade, subj.level) <= G3_TO_NUMERIC_RAW["D7"] // Ensure original grade is a pass (D7 or better)
                        ).sort((a,b) => getNumericGrade(a.grade, a.level) - getNumericGrade(b.grade, b.level)); // Sort by original grade
                        
                        if (relevantSubjCandidates.length > 0) {
                            const bestRelevantSubj = relevantSubjCandidates[0];
                            if (getNumericGrade(getStudentSubjectG2Grade(bestRelevantSubj), "G2") <= getNumericGrade(pathway.mer.relevant_subj_g2, "G2")) {
                                relevantSubjFound = true;
                                relevantSubjDisplay = `${getSubjectById(bestRelevantSubj.subjectId)?.name} ${bestRelevantSubj.level} ${bestRelevantSubj.grade} (G2 equiv ${getStudentSubjectG2Grade(bestRelevantSubj)})`;
                                usedForPFPMer.add(bestRelevantSubj.subjectId); 
                            }
                        }
                        const relevantSubjNames = pathway.mer.relevant_subj_ids.map(id => getSubjectById(id)?.name).join(', ');
                        merDetails.push({ merId: 'relevant_subj_mer', text: `1 subject (G2 equiv) from (${relevantSubjNames})  ${pathway.mer.relevant_subj_g2}: ${relevantSubjDisplay}`, met: relevantSubjFound });
                        if (!relevantSubjFound) overallMerMet = false;

                        const otherTwoSubjects = currentStudentSubjects.filter(subj => 
                            !usedForPFPMer.has(subj.subjectId) && 
                            getNumericGrade(subj.grade, subj.level) <= G3_TO_NUMERIC_RAW["D7"] // Ensure original grade is a pass (D7 or better)
                        ).sort((a,b) => getNumericGrade(a.grade, a.level) - getNumericGrade(b.grade, b.level)); // Sort by original grade
                        
                        const passingOtherTwo = otherTwoSubjects.filter(subj => getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(pathway.mer.other_two_subj_g2, "G2"));
                        const otherTwoSubjCheck = otherTwoSubjects.length >= 2 && passingOtherTwo.length >= 2; // Check both count and passing grade
                        merDetails.push({ merId: 'other_two_subj_mer', text: `2 other subjects (G2 equiv)  ${pathway.mer.other_two_subj_g2}: Need 2, found ${passingOtherTwo.length}`, met: otherTwoSubjCheck });
                        if (!otherTwoSubjCheck) overallMerMet = false;
                    } else if (pathway.group === "ITE Year 2 Higher Nitec") { 
                        const otherSubjectsCount = currentStudentSubjects.filter(subj => 
                            !usedForPFPMer.has(subj.subjectId) && 
                            getNumericGrade(subj.grade, subj.level) <= G3_TO_NUMERIC_RAW["D7"] && // Ensure original grade is a pass
                            pathway.mer && pathway.mer.any_three_other_subj_g2 && getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(pathway.mer.any_three_other_subj_g2, "G2")
                        ).length;
                        const otherThreeSubjCheck = otherSubjectsCount >= 3;
                        merDetails.push({ merId: 'other_three_subj_mer', text: `3 other subjects (G2 equiv): Need 3, found ${otherSubjectsCount} at G2  ${pathway.mer?.any_three_other_subj_g2 || 'N/A'}`, met: otherThreeSubjCheck });
                        if (!otherThreeSubjCheck) overallMerMet = false;
                    }
                }
            
                if (pathway.group === "JC/MI") {
                    const el = studentSubjectsMap.get("EL");
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");
                    let mtOptionMet = false, mtMetDetail = null;
            
                    const elCheck = el && el.level === "G3" && getNumericGrade(el.grade, "G3") <= pathway.mer.el_g3;
                    merDetails.push({ merId: 'el_mer_jcmi', text: `English: ${el ? getSubjectGradeDisplay(el.subjectId, el.grade, el.level) : 'N/A'} (Required G3  ${G3_GRADES_OPTIONS[pathway.mer.el_g3 - 1]})`, met: !!elCheck });
                    if (!elCheck) overallMerMet = false;
            
                    let mathGrade = getSubjectGradeForMer("MATH", "G3", currentStudentSubjects); 
                    let amGrade = getSubjectGradeForMer("AM", "G3", currentStudentSubjects); 
                    let effectiveMathGrade = Math.min(mathGrade, amGrade);
                    let mathDisplay = 'N/A';
                    if (effectiveMathGrade !== Infinity) {
                        if (effectiveMathGrade === mathGrade && math) mathDisplay = getSubjectGradeDisplay("MATH", math.grade, "G3");
                        else if (effectiveMathGrade === amGrade && am) mathDisplay = getSubjectGradeDisplay("AM", am.grade, "G3");
                    }
                    const mathCheck = effectiveMathGrade <= pathway.mer.math_am_g3;
                    merDetails.push({ merId: 'math_am_mer_jcmi', text: `Math/Add Math: ${mathDisplay} (Required G3  ${G3_GRADES_OPTIONS[pathway.mer.math_am_g3 - 1]})`, met: mathCheck });
                    if (!mathCheck) overallMerMet = false;
            
                    for (const option of pathway.mer.mt_options) {
                        const mtSubjCandidate = currentStudentSubjects.find(s => { 
                            const subjectInfo = getSubjectById(s.subjectId);
                            // Check if the subject's category is directly the option type or included in the option type's defined categories
                            return subjectInfo && (subjectInfo.category === option.type || (SUBJECT_CATEGORIES_DEF[option.type] && SUBJECT_CATEGORIES_DEF[option.type].includes(subjectInfo.category)));
                        });
                        if (mtSubjCandidate) {
                            let gradeToCompare = null, numericOptionGrade;
                            if (option.level === "G3") numericOptionGrade = getNumericGrade(option.grade, "G3");
                            else if (option.level === "G2") numericOptionGrade = getNumericGrade(option.grade, "G2");
                            else if (option.level === "G1") numericOptionGrade = getNumericGrade(option.grade, "G1"); 
                            if (mtSubjCandidate.level === option.level) {
                                if (option.level === "G3") gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G3");
                                else if (option.level === "G2") gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G2");
                                else if (option.level === "G1") gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G1");
                            }
                            if (gradeToCompare !== null && gradeToCompare <= numericOptionGrade) {
                                mtOptionMet = true;
                                mtMetDetail = { text: `${getSubjectById(mtSubjCandidate.subjectId)?.name} (${mtSubjCandidate.level} ${mtSubjCandidate.grade}) (Met ${option.level} ${option.grade} requirement)`, met: true };
                                break; 
                            }
                        }
                    }
                    if (mtOptionMet && mtMetDetail) { 
                        merDetails.push({ merId: 'mt_mer_jcmi', text: mtMetDetail.text, met: true });
                    } else {
                        overallMerMet = false;
                        merDetails.push({ merId: 'mt_mer_jcmi', text: `Mother Tongue: No option met. Options: ${pathway.mer.mt_options.map(opt => `${opt.type} ${opt.level} ${opt.grade}`).join(' or ')}`, met: false });
                    }
                    merDetails.push({ merId: 'stream_mer_note', text: `Check the minimum subject grade requirements for specific streams.`, met: false, isPlainBullet: true });
                }
            
                const uniqueMerDetails = [];
                const seenMerIds = new Set(); 
                merDetails.forEach(detail => {
                    if (detail.merId === 'mt_mer_jcmi' && detail.met === true) { 
                        if (!seenMerIds.has('mt_mer_jcmi_met')) { uniqueMerDetails.push(detail); seenMerIds.add('mt_mer_jcmi_met'); }
                    } else if (detail.merId && !seenMerIds.has(detail.merId)) {
                        uniqueMerDetails.push(detail); seenMerIds.add(detail.merId);
                    } else if (!detail.merId && !seenMerIds.has(detail.text)) { 
                        uniqueMerDetails.push(detail); seenMerIds.add(detail.text);
                    }
                });
                return { merMet: overallMerMet, merDetails: uniqueMerDetails };
            };


            const calculateAllPathwaysStatus = (subjects) => {
                const allPathwaysStatus = [];
                let qualifiesForJCMIPoly = false; 
                const jcMiPolyPathways = PATHWAYS.filter(p => p.group === "JC/MI" || p.group === "Polytechnic Year 1");
                jcMiPolyPathways.forEach(pathwatemp => {
                    let pathway = JSON.parse(JSON.stringify(pathwatemp)); // Deep copy to avoid modifying original PATHWAYS object
                    let result = { grossScore: Infinity, netScore: Infinity, details: "N/A", subjectsUsed: [] };
                    let scoreMet = false;
                    
                    if (pathway.calcType === "L1R4_G3") { result = calculateL1R4(subjects, pathway.l1r4_config, bonusPoints); scoreMet = result.grossScore <= pathway.requirements.grossL1R4; } 
                    else if (pathway.calcType === "ELR2B2_G3_Mixed") { 
                        // Pass ELR2B2_A_R1_SUBJECT_IDS to the config for specific filtering
                        pathway.elr2b2_config.ELR2B2_A_R1_SUBJECT_IDS = ELR2B2_A_R1_SUBJECT_IDS; 
                        result = calculateELR2B2_G3_Mixed(subjects, pathway.elr2b2_config, bonusPoints); 
                        scoreMet = result.netScore <= pathway.requirements.netELR2B2; 
                    }
                    pathway.grossScore = result.grossScore; pathway.netScore = result.netScore; pathway.subjectsUsed = result.subjectsUsed; 
                    const merCheck = checkMerRequirements(pathway, subjects, bonusPoints, result.subjectsUsed);
                    if (scoreMet && merCheck.merMet) qualifiesForJCMIPoly = true;
                });

                PATHWAYS.forEach(originalPathway => {
                    let pathway = JSON.parse(JSON.stringify(originalPathway)); 
                    let result = { grossScore: Infinity, netScore: Infinity, details: "N/A", subjectsUsed: [] };
                    let scoreMet = false;
                    let merCheckResult = { merMet: true, merDetails: [] }; 

                    if (pathway.calcType === "L1R4_G3") { 
                        // Corrected arguments for calculateL1R4
                        result = calculateL1R4(subjects, pathway.l1r4_config, bonusPoints); 
                        scoreMet = result.grossScore <= pathway.requirements.grossL1R4; 
                    } 
                    else if (pathway.calcType === "ELMAB3_G2") { result = calculateELMAB3_G2(subjects, bonusPoints, pathway.id); scoreMet = result.grossScore <= pathway.requirements.grossELMAB3; } 
                    else if (pathway.calcType === "ELR2B2_G3_Mixed") { 
                        // Pass ELR2B2_A_R1_SUBJECT_IDS to the config for specific filtering for ELR2B2-A
                        if (pathway.id === "poly_yr1_elr2b2_a") {
                            pathway.elr2b2_config.ELR2B2_A_R1_SUBJECT_IDS = ELR2B2_A_R1_SUBJECT_IDS;
                            pathway.elr2b2_config.ELR2B2_A_R2_SUBJECT_IDS_FULL = ELR2B2_A_R2_SUBJECT_IDS_FULL;
                        }
                        result = calculateELR2B2_G3_Mixed(subjects, pathway.elr2b2_config, bonusPoints); 
                        scoreMet = result.netScore <= pathway.requirements.netELR2B2; 
                    } 
                    else if (pathway.calcType === "ITE_Hnitec_Specific") {
                        const iteSpecificResult = calculateITEHnitecSpecific(subjects, pathway.requirements, bonusPoints);
                        result = iteSpecificResult; 
                        scoreMet = iteSpecificResult.scoreMet; 
                        merCheckResult = { merMet: iteSpecificResult.scoreMet, merDetails: iteSpecificResult.details };
                    } else if (pathway.calcType === "ITE_Hnitec_Completed") {
                         const iteCompletedResult = calculateITEHnitecCompleted(subjects, pathway.requirements, bonusPoints); 
                        result = iteCompletedResult; 
                        scoreMet = iteCompletedResult.scoreMet; 
                        merCheckResult = { merMet: iteCompletedResult.scoreMet, merDetails: iteCompletedResult.details };
                    } else if (pathway.calcType === "Pending") {
                        scoreMet = false; merCheckResult.merMet = false;
                        merCheckResult.merDetails.push({ merId: 'pending_update', text: "This section is pending update.", met: false });
                    }
                    
                    pathway.grossScore = result.grossScore; pathway.netScore = result.netScore; pathway.subjectsUsed = result.subjectsUsed; 
                    if (pathway.calcType !== "ITE_Hnitec_Specific" && pathway.calcType !== "ITE_Hnitec_Completed") {
                       merCheckResult = checkMerRequirements(pathway, subjects, bonusPoints, result.subjectsUsed);
                    }

                    allPathwaysStatus.push({ ...pathway, grossScore: result.grossScore, netScore: result.netScore, scoreDetails: result.details, merCheck: merCheckResult, isEligible: scoreMet && merCheckResult.merMet, subjectsUsed: result.subjectsUsed });
                });
                return allPathwaysStatus;
            };
            
            function checkEligibility() {
                if (studentSubjects.length < 1) {
                    renderEligibilityResults(PATHWAYS.map(p => ({ ...p, grossScore: Infinity, netScore: Infinity, scoreDetails: "Add subjects to see eligibility.", scoreMet: false, merCheck: { merMet: false, merDetails: [{ merId: 'add_subjects_placeholder', text: "Add at least one subject to see eligibility for some pathways.", met: false }] }, subjectsUsed: [] })));
                    return;
                }
                const allPathwaysStatus = calculateAllPathwaysStatus(studentSubjects);
                renderEligibilityResults(allPathwaysStatus); 
            }

            function generateImprovementSuggestions() {
                improvementSuggestionsContainer.innerHTML = '';
                if (studentSubjects.length === 0) {
                    improvementSuggestionsSection.classList.add('hidden');
                    improvementPlaceholder.classList.remove('hidden');
                    improvementPlaceholder.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">Add subjects to see improvement suggestions.</p>`;
                    return;
                }
                improvementSuggestionsSection.classList.remove('hidden');
                const currentAllPathwaysStatus = calculateAllPathwaysStatus(studentSubjects);
                const currentEligiblePathwayNames = new Set(currentAllPathwaysStatus.filter(p => p.isEligible).map(p => p.name));
                const suggestions = [];
                studentSubjects.forEach((subject, index) => {
                    const originalGrade = subject.grade; const originalLevel = subject.level;
                    const nextBetterGrade = getNextBetterGrade(originalGrade, originalLevel);
                    if (nextBetterGrade) {
                        const tempSubjects = studentSubjects.map((s, i) => i === index ? { ...s, grade: nextBetterGrade } : { ...s });
                        const newAllPathwaysStatus = calculateAllPathwaysStatus(tempSubjects);
                        const newEligiblePathwayNames = new Set(newAllPathwaysStatus.filter(p => p.isEligible).map(p => p.name));
                        const newlyEligiblePathways = [];
                        newEligiblePathwayNames.forEach(name => { if (!currentEligiblePathwayNames.has(name)) newlyEligiblePathways.push(name); });
                        const merImprovements = [];
                        newAllPathwaysStatus.forEach(newPathway => {
                            const currentPathway = currentAllPathwaysStatus.find(p => p.id === newPathway.id);
                            if (currentPathway) {
                                newPathway.merCheck.merDetails.forEach(newDetail => {
                                    const currentDetail = currentPathway.merCheck.merDetails.find(d => d.merId === newDetail.merId || d.text === newDetail.text); 
                                    if (currentDetail && !currentDetail.met && newDetail.met && !newDetail.isPlainBullet) merImprovements.push({ pathwayName: newPathway.name, merText: newDetail.text });
                                });
                            }
                        });
                        if (newlyEligiblePathways.length > 0) suggestions.push({ subjectName: getSubjectById(subject.subjectId)?.name || subject.subjectId, originalGrade, originalLevel, improvedGrade: nextBetterGrade, improvedLevel: originalLevel, pathwaysUnlockedCount: newlyEligiblePathways.length, unlockedPathwayNames: newlyEligiblePathways.sort(), merImprovements });
                    }
                });
                if (suggestions.length === 0) {
                    improvementPlaceholder.classList.remove('hidden');
                    improvementPlaceholder.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">You're doing great! No immediate single grade improvements unlock new pathways or significantly improve MERs based on current data.</p>`;
                } else {
                    improvementPlaceholder.classList.add('hidden');
                    renderImprovementSuggestions(suggestions);
                }
            }

            function renderImprovementSuggestions(suggestions) {
                improvementSuggestionsContainer.innerHTML = ''; 
                // MODIFIED: Removed the maxSuggestions limit to display all suggestions.
                const sortedSuggestions = suggestions.sort((a, b) => {
                    if (b.pathwaysUnlockedCount !== a.pathwaysUnlockedCount) return b.pathwaysUnlockedCount - a.pathwaysUnlockedCount;
                    return b.merImprovements.length - a.merImprovements.length;
                });
                sortedSuggestions.forEach(suggestion => { // Iterate through all sorted suggestions
                    const suggestionCard = document.createElement('div');
                    suggestionCard.className = 'bg-slate-700 p-4 rounded-lg shadow-md mb-4 border border-slate-600';
                    const pathwayNamesList = suggestion.unlockedPathwayNames.map(name => `<li class="text-slate-300">${name}</li>`).join('');
                    // Removed the merImprovementList rendering
                    let benefitsHtml = '';
                    if (suggestion.unlockedPathwayNames.length > 0) benefitsHtml += `<p class="text-slate-300 text-sm mb-1">Unlock <strong>${suggestion.pathwaysUnlockedCount}</strong> additional pathway(s):</p><ul class="list-disc list-inside text-sm ml-4 space-y-1 mb-2">${pathwayNamesList}</ul>`;
                    // Removed the condition for merImprovements
                    suggestionCard.innerHTML = `<h4 class="text-lg font-semibold text-emerald-300 mb-2">Improve ${suggestion.subjectName}</h4><p class="text-slate-300 text-sm mb-2">If you improve your <strong>${suggestion.subjectName}</strong> grade from <span class="font-bold text-cyan-300">${suggestion.originalGrade} (${suggestion.originalLevel})</span> to <span class="font-bold text-cyan-300">${suggestion.improvedGrade} (${suggestion.improvedLevel})</span>, you could:</p>${benefitsHtml}`;
                    improvementSuggestionsContainer.appendChild(suggestionCard);
                });
                if (improvementSuggestionsContainer.innerHTML === '') {
                    improvementPlaceholder.classList.remove('hidden');
                    improvementPlaceholder.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">You're doing great! No immediate single grade improvements unlock new pathways or significantly improve MERs based on current data.</p>`;
                } else {
                    improvementPlaceholder.classList.add('hidden');
                }
            }

            function showMessage(message, title = "Notification") { messageBoxTitle.textContent = title; messageBoxText.textContent = message; customMessageBox.classList.remove('hidden'); }
            messageBoxOkButton.addEventListener('click', () => customMessageBox.classList.add('hidden'));

            const populateSubjectDropdown = () => {
                subjectSelect.innerHTML = '<option value="">Select Subject</option>'; 
                let subjectsToDisplay = [], currentSchoolSubjectIds = [];
                if (selectedSchool === "Yuhua Secondary School") currentSchoolSubjectIds = YUHUA_SECONDARY_SCHOOL_SUBJECT_IDS;
                else if (selectedSchool === "School A") currentSchoolSubjectIds = SCHOOL_A_SUBJECT_IDS;
                else currentSchoolSubjectIds = ALL_SUBJECTS_LIST.map(s => s.id); 
                subjectsToDisplay = ALL_SUBJECTS_LIST.filter(subject => currentSchoolSubjectIds.includes(subject.id));
                subjectsToDisplay.forEach(subject => { const option = document.createElement('option'); option.value = subject.id; option.textContent = subject.name; subjectSelect.appendChild(option); });
                subjectSelect.value = (editingIndex !== null && studentSubjects[editingIndex]) ? studentSubjects[editingIndex].subjectId : "";
                populateLevelDropdown(levelSelect.value, subjectSelect.value); 
            };

            const populateLevelDropdown = (currentLevel = '', selectedSubjectId = '') => {
                levelSelect.innerHTML = ''; 
                const selectedSubject = getSubjectById(selectedSubjectId);
                let applicableLevels = []; 
                if (selectedSubject) {
                    let currentLevelRestrictions = {};
                    if (selectedSchool === "Yuhua Secondary School") currentLevelRestrictions = YUHUA_SECONDARY_SCHOOL_LEVEL_RESTRICTIONS;
                    else if (selectedSchool === "School A") currentLevelRestrictions = SCHOOL_A_LEVEL_RESTRICTIONS;
                    if (currentLevelRestrictions[selectedSubject.id]) applicableLevels = currentLevelRestrictions[selectedSubject.id];
                    else applicableLevels = [...GRADE_LEVELS]; 
                } else {
                    const defaultOption = document.createElement('option'); defaultOption.value = ''; defaultOption.textContent = 'Select Level'; defaultOption.disabled = true; defaultOption.selected = true; levelSelect.appendChild(defaultOption);
                    populateGradeDropdown(''); return;
                }
                if (applicableLevels.length === 0) {
                    const noLevelOption = document.createElement('option'); noLevelOption.value = ''; noLevelOption.textContent = 'No levels available'; noLevelOption.disabled = true; noLevelOption.selected = true; levelSelect.appendChild(noLevelOption);
                    populateGradeDropdown(''); return;
                }
                if (selectedSubjectId === "DT" || selectedSubjectId === "NFS") applicableLevels.sort((a, b) => (a === "G3" && b === "G2") ? -1 : ((a === "G2" && b === "G3") ? 1 : 0));
                applicableLevels.forEach(level => { const option = document.createElement('option'); option.value = level; option.textContent = level; levelSelect.appendChild(option); });
                if (applicableLevels.includes(currentLevel)) levelSelect.value = currentLevel;
                else if (applicableLevels.includes('G3')) levelSelect.value = 'G3';
                else if (applicableLevels.length > 0) levelSelect.value = applicableLevels[0]; 
                else levelSelect.value = '';
                populateGradeDropdown(levelSelect.value);
            };

            function populateGradeDropdown(level) {
                gradeSelect.innerHTML = '<option value="">Select Grade</option>';
                let grades = [];
                if (level === 'G3') grades = G3_GRADES_OPTIONS; else if (level === 'G2') grades = G2_GRADES_OPTIONS; else if (level === 'G1') grades = G1_GRADES_OPTIONS;
                grades.forEach(g => { const option = document.createElement('option'); option.value = g; option.textContent = g; gradeSelect.appendChild(option); });
                if (grades.length > 0 && gradeSelect.options.length > 1) gradeSelect.value = grades[0]; else if (grades.length === 0) gradeSelect.value = "";
                gradeSelect.disabled = grades.length === 0;
            }

            const populateRowGradeDropdown = (selectElement, level, selectedGrade) => {
                selectElement.innerHTML = ''; let grades = [];
                if (level === 'G3') grades = G3_GRADES_OPTIONS; else if (level === 'G2') grades = G2_GRADES_OPTIONS; else if (level === 'G1') grades = G1_GRADES_OPTIONS;
                grades.forEach(g => { const option = document.createElement('option'); option.value = g; option.textContent = g; if (g === selectedGrade) option.selected = true; selectElement.appendChild(option); });
                selectElement.disabled = grades.length === 0;
            };

            function renderStudentSubjectsTable() {
                studentSubjectsTableBody.innerHTML = '';
                if (studentSubjects.length === 0) { studentSubjectsTableContainer.classList.add('hidden'); return; }
                studentSubjectsTableContainer.classList.remove('hidden');
                studentSubjects.forEach((s, index) => {
                    const row = studentSubjectsTableBody.insertRow(); row.className = 'hover:bg-slate-700/50 transition-colors';
                    row.insertCell().outerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">${getSubjectById(s.subjectId)?.name || s.subjectId}</td>`;
                    const levelCell = row.insertCell(); levelCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                    const levelSelectEl = document.createElement('select'); levelSelectEl.className = "w-full px-3 py-2 min-w-[70px] bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                    let applicableLevelsForRow = []; const subjectInfoForRow = getSubjectById(s.subjectId);
                    if (subjectInfoForRow) {
                        let currentLevelRestrictions = {};
                        if (selectedSchool === "Yuhua Secondary School") currentLevelRestrictions = YUHUA_SECONDARY_SCHOOL_LEVEL_RESTRICTIONS;
                        else if (selectedSchool === "School A") currentLevelRestrictions = SCHOOL_A_LEVEL_RESTRICTIONS;
                        if (currentLevelRestrictions[subjectInfoForRow.id]) applicableLevelsForRow = currentLevelRestrictions[subjectInfoForRow.id];
                        else applicableLevelsForRow = [...GRADE_LEVELS];
                    } else applicableLevelsForRow = [...GRADE_LEVELS];
                    applicableLevelsForRow.forEach(levelOption => { const option = document.createElement('option'); option.value = levelOption; option.textContent = levelOption; if (levelOption === s.level) option.selected = true; levelSelectEl.appendChild(option); });
                    levelSelectEl.onchange = (e) => {
                        const newLevel = e.target.value; studentSubjects[index].level = newLevel;
                        let defaultNewGrade = "";
                        if (newLevel === 'G3' && G3_GRADES_OPTIONS.length > 0) defaultNewGrade = G3_GRADES_OPTIONS[0];
                        else if (newLevel === 'G2' && G2_GRADES_OPTIONS.length > 0) defaultNewGrade = G2_GRADES_OPTIONS[0];
                        else if (newLevel === 'G1' && G1_GRADES_OPTIONS.length > 0) defaultNewGrade = G1_GRADES_OPTIONS[0];
                        studentSubjects[index].grade = defaultNewGrade;
                        const gradeSelectEl = row.querySelector('.grade-select'); 
                        populateRowGradeDropdown(gradeSelectEl, newLevel, defaultNewGrade);
                        updateAllCalculationsAndRender();
                    };
                    levelCell.appendChild(levelSelectEl);
                    const gradeCell = row.insertCell(); gradeCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                    const gradeSelectEl = document.createElement('select'); gradeSelectEl.className = "grade-select w-full px-3 py-2 min-w-[70px] bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                    populateRowGradeDropdown(gradeSelectEl, s.level, s.grade);
                    gradeSelectEl.onchange = (e) => { studentSubjects[index].grade = e.target.value; updateAllCalculationsAndRender(); };
                    gradeCell.appendChild(gradeSelectEl);
                    const actionsCell = row.insertCell(); actionsCell.className = "px-6 py-4 whitespace-nowrap text-sm font-medium text-right";
                    actionsCell.innerHTML = `<button onclick="handleDeleteSubjectWrapper(${index})" class="text-red-400 hover:text-red-300 transition-colors" aria-label="Delete subject"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm"><path d="M6 7H18V20C18 20.552 17.552 21 17 21H7C6.448 21 6 20.552 6 20V7Z"></path><path d="M19 4H15V3C15 2.448 14.552 2 14 2H10C9.448 2 9 2.448 9 3V4H5V6H19V4Z"></path></svg></button>`;
                });
            }
            
            function renderEligibilityResults(eligibilityResults) {
                eligibilityResultsContainer.innerHTML = '';
                if (studentSubjects.length === 0) { eligibilityPlaceholder.classList.add('hidden'); eligibilityResultsContainer.appendChild(eligibilityPlaceholder); return; }
                eligibilityPlaceholder.classList.add('hidden'); 
                const groupedPathways = { "JC/MI": [], "Polytechnic Year 1": [], "PFP": [], "ITE Year 2 Higher Nitec": [], "ITE Year 1 Higher Nitec": [] };
                eligibilityResults.forEach(p => {
                    if (groupedPathways[p.group]) groupedPathways[p.group].push(p);
                    else { if (!groupedPathways["Other Pathways"]) groupedPathways["Other Pathways"] = []; groupedPathways["Other Pathways"].push(p); }
                });
                for (const group in groupedPathways) {
                    if (groupedPathways[group].length > 0) {
                        const groupSection = document.createElement('div'); groupSection.className = 'col-span-full mb-6';
                        const allNotEligibleInGroup = groupedPathways[group].every(p => !p.isEligible);
                        let groupHeaderHtml = `<h3 class="text-xl font-semibold text-sky-300 mb-4 border-b border-slate-700 pb-2">${group}</h3>`;
                        if (group === "JC/MI") groupHeaderHtml += `<ul class="list-disc list-inside text-sm text-slate-400 mb-4"><li><strong>Eligibility</strong>: Gross Aggregate (L1R4) & <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li><li><strong>Posting</strong>: <span class="tooltip">Net Aggregate (L1R4)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of L1R4 minus bonus points.</span></span></li></ul>`;
                        else if (group === "Polytechnic Year 1") groupHeaderHtml += `<ul class="list-disc list-inside text-sm text-slate-400 mb-4"><li><strong>Eligibility</strong>: <span class="tooltip">Net Aggregate (ELR2B2)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of ELR2B2 minus bonus points.</span></span> & <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li><li><strong>Posting</strong>: <span class="tooltip">Net Aggregate (ELR2B2)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of ELR2B2 minus bonus points.</span></span></li></ul>`;
                        else if (group === "PFP") groupHeaderHtml += `<ul class="list-disc list-inside text-sm text-slate-400 mb-4"><li><strong>Eligibility</strong>: <span class="tooltip">Gross Aggregate (ELMAB3)<sup><small>i</small></sup><span class="tooltiptext">Gross Aggregate is the sum of ELMAB3.</span></span> & <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li><li><strong>Posting</strong>: <span class="tooltip">Net Aggregate (ELMAB3)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of ELMAB3 minus bonus points.</span></span></li></ul>`;
                        else if (group === "ITE Year 2 Higher Nitec") groupHeaderHtml += `<ul class="list-disc list-inside text-sm text-slate-400 mb-4"><li><strong>Eligibility</strong>: Gross Aggregate (ELMAB3) & <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li><li><strong>Posting</strong>: <span class="tooltip">Net Aggregate (ELMAB3)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of ELMAB3 minus bonus points.</span></span></li></ul>`;
                        else if (group === "ITE Year 1 Higher Nitec") groupHeaderHtml += `<ul class="list-disc list-inside text-sm text-slate-400 mb-4"><li><strong>Eligibility</strong>: <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li><li><strong>Posting</strong>: <span class="tooltip">Aggregate score<sup><small>i</small></sup><span class="tooltiptext">Aggregate score is the sum of 4 G1 subjects (including Pre-requisite subjects if applicable) minus bonus points.</span></span></li></ul>`;
                        groupSection.innerHTML = groupHeaderHtml;
                        const cardsContainer = document.createElement('div'); cardsContainer.className = 'grid md:grid-cols-2 lg:col-span-3 gap-6';
                        groupedPathways[group].forEach(pathway => {
                            const card = document.createElement('div'); const isEligible = pathway.isEligible;
                            card.className = `p-5 rounded-lg shadow-lg border ${isEligible ? 'bg-emerald-800/30 border-emerald-600' : 'bg-red-800/30 border-red-600'} transition-all hover:shadow-xl hover:scale-[1.02]`;
                            let scoreText = '';
                            if (pathway.grossScore !== Infinity || pathway.netScore !== Infinity) {
                                if (pathway.group === "ITE Year 1 Higher Nitec") scoreText = `<p class="text-xs text-slate-400 mb-1">Aggregate score for posting: <strong>${pathway.netScore === Infinity ? 'N/A' : pathway.netScore}</strong></p>`;
                                else { scoreText = `<p class="text-xs text-slate-400 mb-1">Gross Aggregate: <strong>${pathway.grossScore === Infinity ? 'N/A' : pathway.grossScore}</strong></p><p class="text-xs text-slate-400 mb-1">Net Aggregate: <strong>${pathway.netScore === Infinity ? 'N/A' : pathway.netScore}</strong></p>`; }
                            } else scoreText = `<p class="text-xs text-slate-400 mb-1">Score: N/A (Missing prerequisite subjects or grades)</p>`;
                            const requirementsList = pathway.merCheck.merDetails.map(detail => {
                                // MODIFIED: Changed icon color for plain bullets to red
                                if (detail.isPlainBullet) return `<li class="mb-0.5 text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg> ${detail.text}</li>`;
                                const icon = detail.met ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-emerald-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>`;
                                return `<li class="mb-0.5 text-slate-400">${icon} ${detail.text.replace(/MER/, '<span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span>')}</li>`;
                            }).join('');
                            const descriptionItemHtml = pathway.description ? `<li class="mt-2 pt-2 text-slate-400 italic">${pathway.description}</li>` : '';
                            let pathwayNameDisplay = pathway.name;
                            if (pathway.tooltipText) pathwayNameDisplay = `<span class="tooltip">${pathway.name}<sup><small>i</small></sup><span class="tooltiptext">${pathway.tooltipText}</span></span>`;
                            else if (pathway.group === "ITE Year 1 Higher Nitec" && pathway.id !== "ite_hnitec_yr1_biz_services_2") pathwayNameDisplay = `<span class="tooltip">${pathway.name}<sup><small>i</small></sup><span class="tooltiptext">Pass refers to Grade A-D for G1 Subject or Grade 1-5 for G2 Subject.</span></span>`;
                            
                            const subjectsUsedHtml = pathway.subjectsUsed && pathway.subjectsUsed.length > 0
                                ? `<h5 class="text-sm font-semibold text-sky-300 mt-3 mb-1">Subjects considered for calculation:</h5><ul class="list-disc list-inside mt-1 pl-2 text-slate-300 space-y-1">${pathway.subjectsUsed.map(s => {
                                    const subjectName = getSubjectById(s.subjectId)?.name || s.subjectId;
                                    let mappedGradeInfo = '';
                                    if (pathway.calcType === 'ELMAB3_G2' && s.level === 'G3' && G3_TO_G2_CONVERSION_MAP[s.grade]) mappedGradeInfo = `(G3 ${s.grade} -> G2 ${convertG3toG2(s.grade)})`;
                                    else if (pathway.calcType === 'ELR2B2_G3_Mixed' && s.role === 'B2' && (s.level === 'G3' || s.level === 'G1')) mappedGradeInfo = `(${s.level} ${s.grade} -> G2 ${s.g2Grade})`;
                                    else if ((pathway.calcType === 'ITE_Hnitec_Specific' || pathway.calcType === 'ITE_Hnitec_Completed') && s.g1EquivGrade && s.g1EquivGrade !== s.grade) mappedGradeInfo = `(${s.level} ${s.grade} -> G1 ${s.g1EquivGrade})`;
                                    return `<li><strong>${s.role || 'Subject'}</strong>: <strong>${subjectName}</strong> ${s.level} ${s.grade} ${mappedGradeInfo}</li>`;
                                }).join('')}</ul>`
                                : `<h5 class="text-sm font-semibold text-sky-300 mt-3 mb-1">Subjects considered for calculation:</h5><p class="text-slate-300 text-sm pl-2">No subjects met criteria or not applicable.</p>`;

                            card.innerHTML = `<h3 class="text-xl font-semibold mb-2 flex items-center">${isEligible ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-emerald-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>'} ${pathwayNameDisplay}</h3><p class="text-sm mb-1 font-medium ${isEligible ? 'text-emerald-300' : 'text-red-300'}">Status: ${isEligible ? 'Eligible <span class="tooltip">(subject to MER)<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span>' : 'Not Eligible'}</p>${scoreText}<details class="text-xs mt-2"><summary class="cursor-pointer text-sky-400 hover:text-sky-300">Details & Reasons</summary><div class="mt-2"><h5 class="text-sm font-semibold text-sky-300 mb-1">Requirements:</h5><ul class="list-disc list-inside mt-1 pl-2 text-slate-300 space-y-1">${requirementsList}${descriptionItemHtml}</ul></div>${subjectsUsedHtml}</details>`;
                            cardsContainer.appendChild(card);
                        });
                        if (allNotEligibleInGroup && groupSection.children.length <= 1) { 
                            const detailsWrapper = document.createElement('details'); detailsWrapper.className = 'col-span-full'; 
                            detailsWrapper.innerHTML = `<summary class="cursor-pointer text-lg font-semibold text-red-400 hover:text-red-300"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 inline-block"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg> ${group} - Not Eligible for any pathway in this group (Click to Expand for details)</summary>`;
                            detailsWrapper.appendChild(cardsContainer); 
                            groupSection.appendChild(detailsWrapper);
                        } else groupSection.appendChild(cardsContainer);
                        eligibilityResultsContainer.appendChild(groupSection);
                    }
                }
            }

            function handleAddOrUpdateSubject() {
                const currentSubjectVal = subjectSelect.value, currentLevelVal = levelSelect.value, currentGradeVal = gradeSelect.value;
                if (!currentSubjectVal || !currentLevelVal || !currentGradeVal) { showMessage("Please select subject, level, and grade."); return; }
                if (studentSubjects.some(s => s.subjectId === currentSubjectVal)) { showMessage("Duplicate Subject", "This subject has already been added. Please edit the existing entry or choose a different subject."); return; }
                studentSubjects.push({ subjectId: currentSubjectVal, level: currentLevelVal, grade: currentGradeVal });
                subjectSelect.value = ''; populateLevelDropdown('', ''); populateGradeDropdown('');
                updateAllCalculationsAndRender();
            }

            window.handleDeleteSubjectWrapper = (index) => {
                messageBoxTitle.textContent = "Confirm Deletion"; messageBoxText.textContent = "Are you sure you want to delete this subject?"; customMessageBox.classList.remove('hidden');
                messageBoxOkButton.onclick = () => { customMessageBox.classList.add('hidden'); studentSubjects.splice(index, 1); updateAllCalculationsAndRender(); messageBoxOkButton.onclick = () => customMessageBox.classList.add('hidden'); };
            };
            
            function updateAllCalculationsAndRender() {
                bonusPoints = parseInt(bonusInput.value) || 0;
                if (bonusPoints < 0) bonusPoints = 0; if (bonusPoints > 5) bonusPoints = 5; 
                bonusInput.value = bonusPoints; 
                checkEligibility(); renderStudentSubjectsTable(); generateImprovementSuggestions();
            }

            document.addEventListener('DOMContentLoaded', () => {
                currentYearSpan.textContent = new Date().getFullYear();
                selectedSchool = schoolSelect.value; populateSubjectDropdown();
                schoolSelect.addEventListener('change', (e) => { selectedSchool = e.target.value; populateSubjectDropdown(); });
                subjectSelect.addEventListener('change', (e) => populateLevelDropdown(levelSelect.value, e.target.value));
                levelSelect.addEventListener('change', (e) => populateGradeDropdown(e.target.value));
                addUpdateSubjectBtn.addEventListener('click', handleAddOrUpdateSubject);
                bonusInput.addEventListener('change', updateAllCalculationsAndRender);
                bonusInput.addEventListener('keyup', (e) => { if ((e.key >= '0' && e.key <= '9') || ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) setTimeout(updateAllCalculationsAndRender, 0); });
                updateAllCalculationsAndRender(); 
            });
        })();
    </script>
</body>
</html>
