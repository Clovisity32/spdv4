<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Pathway Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .icon-sm { width: 18px; height: 18px; display: inline-block; vertical-align: middle; }
        .icon-md { width: 20px; height: 20px; display: inline-block; vertical-align: middle; }
        .icon-lg { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }

        /* Custom Message Box */
        #customMessageBox {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #customMessageBox.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            height: 24px; /* Fixed height for alignment */
        }
        .bar-label {
            width: 150px; /* Adjust as needed */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
            font-size: 0.875rem; /* text-sm */
            color: #cbd5e1; /* slate-300 */
        }
        .bar {
            height: 100%;
            background-image: linear-gradient(to right, #22d3ee, #10b981);
            border-radius: 0.25rem; /* rounded-sm */
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding-right: 5px;
            color: white;
            font-size: 0.75rem; /* text-xs */
            line-height: 24px; /* Match height */
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content;
            max-width: 250px;
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the element */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            border: 1px solid #334155; /* slate-700 */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-sky-900 min-h-screen text-gray-100">

    <div id="customMessageBox" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-slate-700">
            <h3 id="messageBoxTitle" class="text-lg font-semibold text-cyan-400 mb-3">Notification</h3>
            <p id="messageBoxText" class="text-slate-300 mb-6"></p>
            <button id="messageBoxOkButton" class="w-full p-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg transition duration-150">
                OK
            </button>
        </div>
    </div>

    <div class="p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 via-cyan-400 to-sky-500">
                Student Pathway Dashboard
            </h1>
            <p class="text-sky-300 mt-2 text-lg">
                Explore your post-secondary options based on your subject grades.
            </p>
        </header>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M21 22L17.592 18.592C19.089 16.839 20 14.745 20 12.5C20 7.258 15.742 3 10.5 3S1 7.258 1 12.5C1 17.742 5.258 22 10.5 22C12.745 22 14.839 21.089 16.592 19.592L20 23L21 22ZM10.5 20C6.364 20 3 16.636 3 12.5C3 8.364 6.364 5 10.5 5C14.636 5 18 8.364 18 12.5C18 16.636 14.636 20 10.5 20Z"></path><path d="M11.5 8H9.5V12H11.5V8Z"></path><path d="M11.5 14H9.5V16H11.5V14Z"></path></svg> Enter Your Subjects & Grades
            </h2>
            
            <div class="grid md:grid-cols-5 gap-4 mb-4 items-end">
                <div>
                    <label for="school" class="block text-sm font-medium text-sky-300 mb-1">School</label>
                    <select id="school" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        <option value="Yuhua Secondary School">Yuhua Secondary School</option>
                        <option value="School A">School A</option>
                    </select>
                </div>
                <div>
                    <label for="subject" class="block text-sm font-medium text-sky-300 mb-1">Subject</label>
                    <select id="subject" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        <option value="">Select Subject</option>
                    </select>
                </div>
                <div>
                    <label for="level" class="block text-sm font-medium text-sky-300 mb-1">Level</label>
                    <select id="level" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="grade" class="block text-sm font-medium text-sky-300 mb-1">Grade</label>
                    <select id="grade" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="bonus" class="block text-sm font-medium text-sky-300 mb-1 tooltip">
                        Bonus Points<sup><small>i</small></sup>
                        <span class="tooltiptext">Bonus points are awarded for CCA bonus points capped at 2 points for all pathways other than for JC/MI. For JC/MI, maximum bonus points are 5.</span>
                    </label>
                    <input type="number" id="bonus" value="0" min="0" max="5" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100" />
                </div>
                <button id="addUpdateSubjectBtn" class="w-full p-3 bg-gradient-to-r from-emerald-500 to-cyan-600 hover:from-emerald-600 hover:to-cyan-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out flex items-center justify-center text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2"><path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM17 13H13V17H11V13H7V11H11V7H13V11H17V13Z"></path></svg> <span id="addUpdateBtnText">Add Subject</span>
                </button>
            </div>

            <div id="studentSubjectsTableContainer" class="mt-8 hidden">
                <h3 class="text-xl font-semibold mb-3 text-sky-400">Your Subjects:</h3>
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Grade</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-sky-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentSubjectsTableBody" class="bg-slate-800 divide-y divide-slate-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="improvementSuggestionsSection" class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700 hidden">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M3 17H5V19H3V17ZM7 5H9V19H7V5ZM11 13H13V19H11V13ZM15 9H17V19H15V9ZM19 12H21V19H19V12Z"></path></svg> Improvement Suggestions
            </h2>
            <div id="improvementSuggestionsContainer">
                </div>
            <div id="improvementPlaceholder" class="text-center py-8 text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">Add subjects to see improvement suggestions or you're doing great!</p>
            </div>
        </section>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M12 2C17.523 2 22 6.477 22 12C22 17.523 17.523 22 12 22C6.477 22 2 17.523 2 12C2 6.477 6.477 2 12 2ZM12 4C7.582 4 4 7.582 4 12C4 16.418 7.582 20 12 20C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4ZM12 11C11.448 11 11 11.448 11 12C11 12.552 11.448 13 12 13C12.552 13 13 12.552 13 11.448 12.552 11 12 11ZM12 6C9.791 6 8 7.791 8 10H10C10 8.896 10.896 8 12 8C13.104 8 14 8.896 14 10C14 12 11 11.75 11 15H13C13 12.75 16 12.5 16 10C16 7.791 14.209 6 12 6Z"></path></svg> Pathway Eligibility
            </h2>
            <div id="eligibilityResultsContainer" class="grid md:grid-cols-2 lg:col-span-3 gap-6">
                <div id="eligibilityPlaceholder" class="text-center py-8 text-slate-400 md:col-span-2 lg:col-span-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-sky-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM11 7H13V11H11V7ZM11 13H13V17H11V13Z"></path></svg> <p class="text-xl">Please add subjects to see your eligible pathways.</p>
                </div>
            </div>
        </section>

        <footer class="text-center mt-12 text-sm text-slate-500">
            <p>&copy; <span id="currentYear"></span> Student Pathway Dashboard. For informational purposes only.</p>
            <p>Always verify eligibility criteria with official sources.</p>
            <p class="mt-1">Based on Full SBB Post-Sec Options w.e.f. 2027 S4/5 Cohort (Affecting: 2025 S1 & S2 Full SBB) document.</p>
        </footer>
    </div>

    <script>
        (function() { // Start IIFE
            // --- Constants and Configuration ---
            const G3_GRADES_OPTIONS = ["A1", "A2", "B3", "B4", "C5", "C6", "D7", "E8", "F9"];
            const G2_GRADES_OPTIONS = ["1", "2", "3", "4", "5", "6"];
            const G1_GRADES_OPTIONS = ["A", "B", "C", "D", "E"];
            
            // Numeric mapping for general calculations (lower is better)
            const G3_TO_NUMERIC_RAW = { A1: 1, A2: 2, B3: 3, B4: 4, C5: 5, C6: 6, D7: 7, E8: 8, F9: 9 };
            const G2_TO_NUMERIC_RAW = { "1": 1, "2": 2, "3": 3, "4": 4, "5": 5, "6": 6 };
            // ITE Aggregate Score mapping for G1 grades (lower is better)
            const G1_TO_NUMERIC_RAW_ITE = { A: 1, B: 2, C: 3, D: 4, E: 5 };

            // Grade conversions
            const G3_TO_G2_CONVERSION_MAP = {
                A1: "1", A2: "1", B3: "1",
                B4: "2", C5: "2", C6: "2",
                D7: "3",
                E8: "4",
                F9: "5"
            };
            
            const G3_TO_G1_EQUIV_MAP = {
                A1: "A", A2: "A", B3: "A", B4: "A", C5: "A", C6: "A", D7: "A",
                E8: "B",
                F9: "C"
            };

            const G2_TO_G1_EQUIV_MAP = {
                "1": "A", "2": "A", "3": "A",
                "4": "B",
                "5": "C",
                "6": "D"
            };

            const GRADE_LEVELS = ["G3", "G2", "G1"];

            const ALL_SUBJECTS_LIST = [
                { id: "AM", name: "Additional Mathematics", category: "MATH_PURE" },
                { id: "ART", name: "Art", category: "ART_MUSIC" },
                { id: "BIO", name: "Biology", category: "SCIENCE_PURE" },
                { id: "BIOTECH", name: "Biotechnology", category: "BIOTECH" },
                { id: "BS", name: "Business Studies", category: "BUSINESS_SUBJECTS" },
                { id: "C3DA", name: "Creative 3D Animation", category: "TECH_SUBJECTS" },
                { id: "CHEM", name: "Chemistry", category: "SCIENCE_PURE" },
                { id: "COMB_HUM", name: "Combined Humanities", category: "HUMANITIES_COMBINED" },
                { id: "COMB_SCI", name: "Combined Science", category: "SCIENCE_COMBINED" },
                { id: "COMMERCE", name: "Commerce", category: "BUSINESS_SUBJECTS" },
                { id: "COMP", name: "Computing / Computer Studies", category: "TECH_SUBJECTS" },
                { id: "DT", name: "Design & Technology", category: "TECH_SUBJECTS" },
                { id: "ECON", name: "Economics", category: "BUSINESS_SUBJECTS" },
                { id: "EBS", name: "Elements of Business skills", category: "BUSINESS_SUBJECTS" },
                { id: "EL", name: "English Language", category: "EL" },
                { id: "ESS", name: "Exercise & Sports Science", category: "EXERCISE_SPORTS" },
                { id: "FOE", name: "Electronics / Fundamentals of Electronics", category: "TECH_SUBJECTS" },
                { id: "GEOG", name: "Geography", category: "HUMANITIES_PURE" },
                { id: "HA", name: "Higher Art", category: "ART_MUSIC" },
                { id: "HIST", name: "History", category: "HUMANITIES_PURE" },
                { id: "HM", name: "Higher Music", category: "ART_MUSIC" },
                { id: "HMT", name: "Higher Mother Tongue", category: "HMT" },
                { id: "IED", name: "Intro to Enterprise Development", category: "BUSINESS_SUBJECTS" },
                { id: "IOT_APP", name: "IoT Applications", category: "TECH_SUBJECTS" },
                { id: "LIT_ENG", name: "Literature in English", category: "HUMANITIES_PURE" },
                { id: "LIT_CHI", name: "Literature in Chinese", category: "HUMANITIES_PURE" },
                { id: "LIT_MAL", name: "Literature in Malay", category: "HUMANITIES_PURE" },
                { id: "LIT_TAM", name: "Literature in Tamil", category: "HUMANITIES_PURE" },
                { id: "MATH", name: "Elementary Mathematics", category: "MATH_PURE" },
                { id: "MECH_DESIGN_AUTO", name: "Mechanical Design & Automation", category: "TECH_SUBJECTS" },
                { id: "MOB_ROBOTICS", name: "Mobile Robotics", category: "TECH_SUBJECTS" },
                { id: "MOB_WEB_APP", name: "Mobile Web Applications", category: "TECH_SUBJECTS" },
                { id: "MS", name: "Media Studies (English/Chinese)", category: "MEDIA_COMM" },
                { id: "MS_CHI", name: "Media Studies (Chinese)", category: "MEDIA_COMM" },
                { id: "MS_ENG", name: "Media Studies (English)", category: "MEDIA_COMM" },
                { id: "MT", name: "Mother Tongue", category: "MT" },
                { id: "MUSIC", name: "Music", category: "ART_MUSIC" },
                { id: "NFS", name: "Nutrition and Food Science", category: "TECH_SUBJECTS" },
                { id: "OTHER", name: "Other Subject", category: "OTHER" },
                { id: "PHY", name: "Physics", category: "SCIENCE_PURE" },
                { id: "POA", name: "Principles of Accounts", category: "BUSINESS_SUBJECTS" },
                { id: "SMART_ELEC_TECH", name: "Smart Electrical Technology", category: "TECH_SUBJECTS" },
                { id: "DS", name: "Design Studies", category: "TECH_SUBJECTS" },
            ].sort((a, b) => a.name.localeCompare(b.name)); // Sort subjects alphabetically

            const SUBJECT_CATEGORIES_DEF = {
                EL: ["EL"],
                HMT: ["HMT"], // Category for Higher Mother Tongue subjects
                MT: ["MT"], // Category for regular Mother Tongue subjects
                MT_ALL: ["MT", "HMT"], // Combines all Mother Tongue types for checks that need any MT

                HUMANITIES_PURE: ["HUMANITIES_PURE"],
                HUMANITIES_COMBINED: ["HUMANITIES_COMBINED"],
                HUM: ["HUMANITIES_PURE", "HUMANITIES_COMBINED"], // General Humanities

                MATH_PURE: ["MATH_PURE"],
                SCIENCE_PURE: ["SCIENCE_PURE"],
                SCIENCE_COMBINED: ["SCIENCE_COMBINED"],
                MATH_SCIENCE: ["MATH_PURE", "SCIENCE_PURE", "SCIENCE_COMBINED"], // General Math/Science
                HUM_MATH_SCIENCE: ["HUMANITIES_PURE", "HUMANITIES_COMBINED", "MATH_PURE", "SCIENCE_PURE", "SCIENCE_COMBINED"], // General Hum/Math/Science
                
                // New category for Science in lieu subjects
                SCIENCE_IN_LIEU: ["SCIENCE_PURE", "SCIENCE_COMBINED", "MOB_ROBOTICS", "SMART_ELEC_TECH", "MECH_DESIGN_AUTO", "IOT_APP", "MOB_WEB_APP"],

                TECH_SUBJECTS: ["TECH_SUBJECTS"],
                BUSINESS_SUBJECTS: ["BUSINESS_SUBJECTS"],
                ART_MUSIC: ["ART_MUSIC"],
                MEDIA_COMM: ["MEDIA_COMM"],
                LANGUAGE_ELECTIVES: ["MT", "HMT"], // Language electives can be any MT/HMT
                EXERCISE_SPORTS: ["EXERCISE_SPORTS"],
                BIOTECH: ["BIOTECH"],
                OTHER: ["OTHER"],

                ANY_BEST: [] // Populated dynamically
            };

            SUBJECT_CATEGORIES_DEF.ANY_BEST = ALL_SUBJECTS_LIST.map(s => s.category).filter((value, index, self) => self.indexOf(value) === index);

            // Helper function to get unique categories from a list of subject IDs
            const getUniqueCategoriesFromSubjectIds = (subjectIds) => {
                const categories = new Set();
                subjectIds.forEach(id => {
                    const subject = ALL_SUBJECTS_LIST.find(s => s.id === id);
                    if (subject && subject.category) {
                        categories.add(subject.category);
                    }
                });
                return Array.from(categories);
            };

            // Define Subject IDs for ELR2B2 R1 and R2 components as per user's request
            // ELR2B2-A
            const ELR2B2_A_R1_SUBJECT_IDS = ["ART", "BS", "COMB_HUM", "ECON", "GEOG", "HA", "HM", "HIST", "IED", "LIT_CHI", "LIT_ENG", "LIT_MAL", "LIT_TAM", "MS_CHI", "MS_ENG", "MUSIC"];
            const ELR2B2_A_R2_SUBJECT_IDS_FULL = ["AM", "ART", "BS", "COMB_HUM", "C3DA", "DT", "DS", "ECON", "MATH", "GEOG", "HA", "HMT", "HM", "HIST", "IED", "LIT_CHI", "LIT_ENG", "LIT_MAL", "LIT_TAM", "MS_CHI", "MS_ENG", "MT", "MUSIC", "NFS", "POA"];

            // ELR2B2-B
            const ELR2B2_B_R1_SUBJECT_IDS = ["AM", "MATH"];
            const ELR2B2_B_R2_SUBJECT_IDS_FULL = ["ART", "BS", "COMB_HUM", "ECON", "GEOG", "HA", "HM", "HIST", "IED", "LIT_CHI", "LIT_ENG", "LIT_MAL", "LIT_TAM", "MS_CHI", "MS_ENG", "MUSIC", "POA"];

            // ELR2B2-C
            const ELR2B2_C_R1_SUBJECT_IDS = ["AM", "MATH"];
            const ELR2B2_C_R2_SUBJECT_IDS_FULL = ["BIO", "BIOTECH", "CHEM", "COMB_SCI", "COMP", "C3DA", "DT", "FOE", "ESS", "NFS", "PHY"];

            // ELR2B2-D
            const ELR2B2_D_R1_SUBJECT_IDS = ["AM", "MATH"];
            const ELR2B2_D_R2_SUBJECT_IDS_FULL = ["ART", "BIO", "BIOTECH", "CHEM", "COMB_SCI", "COMP", "C3DA", "DT", "DS", "FOE", "HA", "MS_CHI", "MS_ENG", "NFS", "PHY"];

            // Convert subject IDs to unique categories and apply R1 exclusion for R2
            const ELR2B2_A_R1_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_A_R1_SUBJECT_IDS);
            const ELR2B2_A_R2_CATEGORIES_FULL = getUniqueCategoriesFromSubjectIds(ELR2B2_A_R2_SUBJECT_IDS_FULL);
            const ELR2B2_A_R2_CATEGORIES = ELR2B2_A_R2_CATEGORIES_FULL.filter(cat => !ELR2B2_A_R1_CATEGORIES.includes(cat));

            const ELR2B2_B_R1_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_B_R1_SUBJECT_IDS);
            const ELR2B2_B_R2_CATEGORIES_FULL = getUniqueCategoriesFromSubjectIds(ELR2B2_B_R2_SUBJECT_IDS_FULL);
            const ELR2B2_B_R2_CATEGORIES = ELR2B2_B_R2_CATEGORIES_FULL.filter(cat => !ELR2B2_B_R1_CATEGORIES.includes(cat));

            const ELR2B2_C_R1_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_C_R1_SUBJECT_IDS);
            const ELR2B2_C_R2_CATEGORIES_FULL = getUniqueCategoriesFromSubjectIds(ELR2B2_C_R2_SUBJECT_IDS_FULL);
            const ELR2B2_C_R2_CATEGORIES = ELR2B2_C_R2_CATEGORIES_FULL.filter(cat => !ELR2B2_C_R1_CATEGORIES.includes(cat));

            const ELR2B2_D_R1_CATEGORIES = getUniqueCategoriesFromSubjectIds(ELR2B2_D_R1_SUBJECT_IDS);
            const ELR2B2_D_R2_CATEGORIES_FULL = getUniqueCategoriesFromSubjectIds(ELR2B2_D_R2_SUBJECT_IDS_FULL);
            const ELR2B2_D_R2_CATEGORIES = ELR2B2_D_R2_CATEGORIES_FULL.filter(cat => !ELR2B2_D_R1_CATEGORIES.includes(cat));


            const PATHWAYS = [
                { id: "jc", name: "Junior College (JC)", group: "JC/MI", calcType: "L1R4_G3", requirements: { grossL1R4: 16 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: "E8" },{ type: "MT", level: "G3", grade: "D7" },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM_MATH_SCIENCE, R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "" },
                { id: "mi", name: "Millennia Institute (MI)", group: "JC/MI", calcType: "L1R4_G3", requirements: { grossL1R4: 20 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: "E8" },{ type: "MT", level: "G3", grade: "D7" },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM_MATH_SCIENCE, R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "" },

                { id: "poly_yr1_elr2b2_a", name: "Polytechnic Year 1 (ELR2B2-A)", tooltipText: "Humanities, Media & Communications", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: ELR2B2_A_R1_CATEGORIES, R2_cat_ids: ELR2B2_A_R2_CATEGORIES, B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },
                { id: "poly_yr1_elr2b2_b", name: "Polytechnic Year 1 (ELR2B2-B)", tooltipText: "Business & Management", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: ELR2B2_B_R1_CATEGORIES, R2_cat_ids: ELR2B2_B_R2_CATEGORIES, B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },
                { id: "poly_yr1_elr2b2_c_general", name: "Polytechnic Year 1 (ELR2B2-C)", tooltipText: "Applied/Health Sc, Engrg, Info & Digital Tech, Built Environment, Nursing", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: ELR2B2_C_R1_CATEGORIES, R2_cat_ids: ELR2B2_C_R2_CATEGORIES, B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },
                { id: "poly_yr1_elr2b2_d", name: "Polytechnic Year 1 (ELR2B2-D)", tooltipText: "Design, Built Environment", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: ELR2B2_D_R1_CATEGORIES, R2_cat_ids: ELR2B2_D_R2_CATEGORIES, B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },

                // PFP Pathways updated based on user's request
                { 
                    id: "pfp_science_tech", 
                    name: "Polytechnic Foundation Programme (PFP) - Science, Design, Engrg & Technology, Nursing Cluster", 
                    group: "PFP", 
                    calcType: "ELMAB3_G2", 
                    requirements: { grossELMAB3: 12 }, 
                    mer: { 
                        el_g2: "3", 
                        math_am_g2: "3", 
                        relevant_subj_g2: "3", 
                        relevant_subj_ids: ["DT", "NFS", "COMB_SCI"], // Specific subject IDs
                        other_two_subj_g2: "4" // Changed from other_three_subj_g2
                    }, 
                    description: "" 
                },
                { 
                    id: "pfp_hum_art_biz", 
                    name: "Polytechnic Foundation Programme (PFP) - Humanities, Art, Media, Business, Early Childhood, Tamil Studies Cluster.", 
                    group: "PFP", 
                    calcType: "ELMAB3_G2", 
                    requirements: { grossELMAB3: 12 }, 
                    mer: { 
                        el_g2: "3", 
                        math_am_g2: "3", 
                        relevant_subj_g2: "3", 
                        relevant_subj_ids: ["ART", "POA", "GEOG", "HIST", "LIT_ENG", "ECON", "COMB_HUM"], // Specific subject IDs
                        other_two_subj_g2: "4" // Changed from other_three_subj_g2
                    }, 
                    description: "" 
                },

                { id: "ite_hnitec_yr2_applied_eng_ict", name: "ITE Year 2 of 3-Yr Higher Nitec - Applied Science, Engineering, Info-Comms Tech", group: "ITE Year 2 Higher Nitec", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 19 }, mer: { el_g2: "4", math_am_g2: "4", any_three_other_subj_g2: "5" }, description: "" },
                { id: "ite_hnitec_yr2_biz_hosp", name: "ITE Year 2 of 3-Yr Higher Nitec - Business & Services, Hospitality", group: "ITE Year 2 Higher Nitec", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 19 }, mer: { el_g2: "3", math_am_g2: "4", any_three_other_subj_g2: "5" }, description: "" },

                // ITE Year 1 Higher Nitec Specific Pathways
                { id: "ite_hnitec_yr1_health_sci_1", name: "MER (Pass Math or Science)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, req_g1g2_other_count: 2, allow_science_in_lieu: true, min_total_subjects: 4 }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_health_sci_2", name: "MER (Pass EL & Math)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.MATH_PURE), req_g1g2_other_count: 1, min_total_subjects: 4 }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_biz_services_1", name: "MER (Pass EL)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.EL, req_g1g2_other_count: 2, min_total_subjects: 4 }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_biz_services_2", name: "MER (Complete SEC)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Completed", requirements: {}, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_engineering_1", name: "MER (Pass Math)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_PURE, req_g1g2_other_count: 2, min_total_subjects: 4 }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_hospitality_1", name: "MER (Pass 2G3)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "2_G3_ONLY", req_g3_count: 2, req_g3_grade: 8, min_total_subjects: 4, allow_science_in_lieu: false }, mer: {}, tooltipText: "Pass refers to Grade 1-8 for G3 Subject.", description: "" },
            ];

            // --- State Variables ---
            let studentSubjects = [];
            let bonusPoints = 0;
            let editingIndex = null; // null for add mode, index for edit mode
            let selectedSchool = "Yuhua Secondary School"; // Default school

            // --- DOM Elements ---
            const schoolSelect = document.getElementById('school'); // New school select
            const subjectSelect = document.getElementById('subject');
            const levelSelect = document.getElementById('level');
            const gradeSelect = document.getElementById('grade');
            const bonusInput = document.getElementById('bonus');
            const addUpdateSubjectBtn = document.getElementById('addUpdateSubjectBtn');
            const addUpdateBtnText = addUpdateSubjectBtn.querySelector('span'); // For changing text
            const addUpdateBtnIcon = addUpdateSubjectBtn.querySelector('svg'); // For changing icon
            const studentSubjectsTableBody = document.getElementById('studentSubjectsTableBody');
            const studentSubjectsTableContainer = document.getElementById('studentSubjectsTableContainer');
            const eligibilityResultsContainer = document.getElementById('eligibilityResultsContainer');
            const eligibilityPlaceholder = document.getElementById('eligibilityPlaceholder');
            const improvementSuggestionsSection = document.getElementById('improvementSuggestionsSection');
            const improvementSuggestionsContainer = document.getElementById('improvementSuggestionsContainer');
            const improvementPlaceholder = document.getElementById('improvementPlaceholder');
            const currentYearSpan = document.getElementById('currentYear');

            const customMessageBox = document.getElementById('customMessageBox');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxOkButton = document.getElementById('messageBoxOkButton');

            // School A specific subject IDs and their level restrictions
            const SCHOOL_A_SUBJECT_IDS = ALL_SUBJECTS_LIST.map(s => s.id); // All subjects for School A

            const SCHOOL_A_LEVEL_RESTRICTIONS = {
                "AM": ["G3"],
                "BIO": ["G3"],
                "CHEM": ["G3"],
                "MUSIC": ["G3"],
                "PHY": ["G3"],
                "MOB_ROBOTICS": ["G1"],
                "DT": ["G2", "G3"],
                "NFS": ["G2", "G3"],
                "EBS": ["G1"],
                "DS": ["G3"], // Assuming G3 level for new subjects
                "LIT_CHI": ["G3"],
                "LIT_MAL": ["G3"],
                "LIT_TAM": ["G3"],
                "MS_CHI": ["G3"],
                "MS_ENG": ["G3"]
            };

            // Yuhua Secondary School specific subject IDs and their level restrictions
            const YUHUA_SECONDARY_SCHOOL_SUBJECT_IDS = [
                "AM", "ART", "BIO", "CHEM", "COMB_HUM", "COMB_SCI", "COMP", "DT", "EBS", "EL", "MATH", "MOB_ROBOTICS", "MUSIC", "NFS", "PHY", "POA", "MT", "HMT"
            ];

            const YUHUA_SECONDARY_SCHOOL_LEVEL_RESTRICTIONS = {
                "AM": ["G3"],
                "BIO": ["G3"],
                "CHEM": ["G3"],
                "MUSIC": ["G3"], // This will cover Music/Higher Music
                "PHY": ["G3"],
                "MOB_ROBOTICS": ["G1"],
                "DT": ["G2", "G3"],
                "NFS": ["G2", "G3"],
                "EBS": ["G1"] // New restriction for Elements of Business skills
            };


            // --- Utility Functions ---
            const getNumericGrade = (grade, level) => {
                if (level === "G3") return G3_TO_NUMERIC_RAW[grade] || Infinity;
                if (level === "G2") return G2_TO_NUMERIC_RAW[grade] || Infinity;
                // For G1, return the ITE Aggregate Score
                if (level === "G1") return G1_TO_NUMERIC_RAW_ITE[grade] || Infinity;
                return Infinity;
            };
            
            const convertG3toG2 = (g3Grade) => G3_TO_G2_CONVERSION_MAP[g3Grade] || "6"; // Default to 6 if not mapped
            const getSubjectById = (id) => ALL_SUBJECTS_LIST.find(s => s.id === id);

            // New helper function to get subject names from an array of subject IDs
            const getSubjectNamesFromIds = (subjectIdsArray) => {
                return subjectIdsArray.map(id => getSubjectById(id)?.name || id).sort().join(', ');
            };

            const getStudentSubjectG2Grade = (studentSubject) => {
                if (studentSubject.level === "G2") return studentSubject.grade;
                if (studentSubject.level === "G3") return convertG3toG2(studentSubject.grade);
                return "6"; // If G1 or unknown, return "6" for G2 equivalent (lowest passing grade)
            };

            const getG1Equivalent = (subject) => {
                let g1EquivGrade = null;
                let numericG1EquivGrade = Infinity;

                if (subject.level === "G1") {
                    g1EquivGrade = subject.grade;
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[subject.grade] || Infinity; 
                } else if (subject.level === "G2") {
                    g1EquivGrade = G2_TO_G1_EQUIV_MAP[subject.grade] || "D"; // Default to D if not mapped
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[g1EquivGrade] || Infinity;
                } else if (subject.level === "G3") {
                    g1EquivGrade = G3_TO_G1_EQUIV_MAP[subject.grade] || "C"; // Default to C if not mapped
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[g1EquivGrade] || Infinity;
                }
                return { ...subject, g1EquivGrade, numericG1EquivGrade };
            };

            // New helper function to calculate the best 4 subjects' G1 equivalent score
            const calculateBest4G1Equivalent = (currentStudentSubjects) => {
                const g1EquivalentSubjects = currentStudentSubjects.map(s => getG1Equivalent(s));
                
                // Filter out subjects that are 'U' or couldn't be converted to a valid G1 numeric grade
                const validG1Subjects = g1EquivalentSubjects.filter(s => 
                    s.numericG1EquivGrade !== Infinity && G1_GRADES_OPTIONS.includes(s.g1EquivGrade)
                );

                // Sort subjects by their G1 equivalent numeric grade (lower is better)
                const sortedSubjects = validG1Subjects.sort((a, b) => a.numericG1EquivGrade - b.numericG1EquivGrade);

                // Select the top 4 best-scoring subjects and assign roles
                const best4SubjectsWithRoles = sortedSubjects.slice(0, 4).map((s, index) => ({
                    ...s,
                    role: `B${index + 1}` // Assign roles like B1, B2, B3, B4
                }));

                // Sum their G1 equivalent numeric grades
                const totalScore = best4SubjectsWithRoles.reduce((sum, s) => sum + s.numericG1EquivGrade, 0);

                return { score: totalScore, subjects: best4SubjectsWithRoles };
            };

            // Modified to accept currentStudentSubjects
            const getSubjectGradeForMer = (subjectId, requiredLevel, currentStudentSubjects) => {
                const subject = currentStudentSubjects.find(s => s.subjectId === subjectId);
                if (!subject) return Infinity;
                if (requiredLevel === "G3" && subject.level === "G3") return getNumericGrade(subject.grade, "G3");
                if (requiredLevel === "G2") return getNumericGrade(getStudentSubjectG2Grade(subject), "G2");
                if (requiredLevel === "G1") {
                    return getNumericGrade(getG1Equivalent(subject).g1EquivGrade, "G1"); // Use G1_TO_NUMERIC_RAW_ITE
                }
                return Infinity;
            };

            const getSubjectGradeDisplay = (subjectId, grade, level) => {
                const subjectName = getSubjectById(subjectId)?.name || subjectId;
                return `${subjectName}: ${grade} (${level})`;
            };

            // Helper function to get the next better grade
            const getNextBetterGrade = (currentGrade, level) => {
                let gradesList = [];
                let currentGradeIndex = -1;

                if (level === "G3") {
                    gradesList = G3_GRADES_OPTIONS;
                    currentGradeIndex = gradesList.indexOf(currentGrade);
                } else if (level === "G2") {
                    gradesList = G2_GRADES_OPTIONS;
                    currentGradeIndex = gradesList.indexOf(currentGrade);
                } else if (level === "G1") {
                    gradesList = G1_GRADES_OPTIONS;
                    currentGradeIndex = gradesList.indexOf(currentGrade);
                }

                if (currentGradeIndex === -1 || currentGradeIndex === 0) {
                    return null; // Already at best grade or grade not found
                }
                return gradesList[currentGradeIndex - 1];
            };

            // --- Calculation Functions ---
            const calculateL1R4 = (currentStudentSubjects, config, currentBonusPoints = 0) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));

                let l1Subj, r1Subj, r2Subj, r3Subj, r4Subj;
                let usedSubjectIds = new Set();
                let subjectsUsedWithRoles = [];

                const findBestSubject = (categoryNamesArray, currentUsedIds, role) => {
                    let bestCandidate = null;
                    for (const subj of g3Subjects) {
                        if (!currentUsedIds.has(subj.subjectId) && categoryNamesArray.includes(subj.category)) {
                            if (!bestCandidate || subj.numericGrade < bestCandidate.numericGrade) {
                                bestCandidate = subj;
                            }
                        }
                    }
                    if (bestCandidate) {
                        currentUsedIds.add(bestCandidate.subjectId);
                        return { ...bestCandidate, role: role };
                    }
                    return null;
                };

                // L1: English or Higher Mother Tongue
                l1Subj = findBestSubject(config.L1, usedSubjectIds, 'L1');
                if (!l1Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing L1 (EL/HMT G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(l1Subj);

                // R1: Best-scoring subject from Humanities
                r1Subj = findBestSubject(config.R1_cat_ids, usedSubjectIds, 'R1');
                if (!r1Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R1 (Humanities G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r1Subj);

                // R2: Best-scoring subject from Mathematics or Science
                r2Subj = findBestSubject(config.R2_cat_ids, usedSubjectIds, 'R2');
                if (!r2Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R2 (Math/Science G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r2Subj);

                // R3: Best-scoring subject from Humanities, Mathematics, or Science
                r3Subj = findBestSubject(config.R3_cat_ids, usedSubjectIds, 'R3');
                if (!r3Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R3 (Hum/Math/Sci G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r3Subj);
                
                // R4: Any best-scoring subject except Religious Knowledge (not in our list, so any best remaining)
                r4Subj = findBestSubject(config.R4_cat_ids, usedSubjectIds, 'R4');
                if (!r4Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R4 (Any other G3, not enough distinct subjects)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r4Subj);

                const grossScore = l1Subj.numericGrade + r1Subj.numericGrade + r2Subj.numericGrade + r3Subj.numericGrade + r4Subj.numericGrade;
                const netScore = grossScore - currentBonusPoints;
                
                return { grossScore: grossScore, netScore: netScore, subjectsUsed: subjectsUsedWithRoles, details: `EL(G3 ${l1Subj.grade}), R1(${getSubjectById(r1Subj.subjectId)?.name} G3 ${r1Subj.grade}), R2(${getSubjectById(r2Subj.subjectId)?.name} G3 ${r2Subj.grade}), R3(${getSubjectById(r3Subj.subjectId)?.name} G3 ${r3Subj.grade}), R4(${getSubjectById(r4Subj.subjectId)?.name} G3 ${r4Subj.grade})`};
            };

            const calculateELMAB3_G2 = (currentStudentSubjects, currentBonusPoints = 0) => {
                // Prepare subjects with G2 equivalent grades and numeric scores, filtering out invalid grades
                const subjectsForCalc = currentStudentSubjects.map(s => ({
                    ...s,
                    g2Grade: getStudentSubjectG2Grade(s),
                    numericG2Grade: getNumericGrade(getStudentSubjectG2Grade(s), "G2"),
                    category: getSubjectById(s.subjectId)?.category
                })).filter(s => G2_GRADES_OPTIONS.includes(s.g2Grade) && s.numericG2Grade <= 5); // Only include valid G2 equivalent grades that are a pass (1-5)

                let subjectsUsedWithRoles = [];
                let scoreDetailsParts = [];

                // 1. Find the best English Language (EL) subject
                const elCandidates = subjectsForCalc
                    .filter(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId)) // Changed from s.category to s.subjectId for EL
                    .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                
                const el = elCandidates.length > 0 ? elCandidates[0] : null;

                if (!el) {
                    return { grossScore: Infinity, netScore: Infinity, details: "Missing English (G2 equiv. pass)", subjectsUsed: [] };
                }
                subjectsUsedWithRoles.push({ ...el, role: 'EL' });
                scoreDetailsParts.push(`EL(G2 ${el.g2Grade})`);

                // 2. Find the best Mathematics (MA) or Additional Mathematics (AM) subject, distinct from EL
                const maCandidates = subjectsForCalc
                    .filter(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(s.category) && s.subjectId !== el.subjectId)
                    .sort((a, b) => a.numericG2Grade - b.numericG2Grade);

                const ma = maCandidates.length > 0 ? maCandidates[0] : null;

                if (!ma) {
                    return { grossScore: Infinity, netScore: Infinity, details: "Missing Maths (G2 equiv. pass)", subjectsUsed: [] };
                }
                subjectsUsedWithRoles.push({ ...ma, role: 'MA' });
                scoreDetailsParts.push(`MA(G2 ${ma.g2Grade})`);

                // 3. Find the best 3 other distinct subjects
                const others = subjectsForCalc
                    .filter(s => s.subjectId !== el.subjectId && s.subjectId !== ma.subjectId)
                    .sort((a, b) => a.numericG2Grade - b.numericG2Grade);

                if (others.length < 3) {
                    return { grossScore: Infinity, netScore: Infinity, details: `Need 3 other subjects (G2 equiv. pass), found ${others.length}`, subjectsUsed: [] };
                }

                const b3 = others.slice(0, 3);
                b3.forEach((s, index) => {
                    subjectsUsedWithRoles.push({ ...s, role: `B${index + 1}` });
                    scoreDetailsParts.push(`B${index + 1}(${getSubjectById(s.subjectId)?.name} ${s.level} ${s.grade} (G2 equiv ${s.g2Grade}))`);
                });

                // Calculate gross score
                const grossScore = el.numericG2Grade + ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                const netScore = grossScore - currentBonusPoints;
                
                return { grossScore: grossScore, netScore: netScore, subjectsUsed: subjectsUsedWithRoles, details: scoreDetailsParts.join(", ") };
            };

            const calculateELR2B2_G3_Mixed = (currentStudentSubjects, config, currentBonusPoints = 0) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));
                
                let usedSubjectIds = new Set();
                let scoreDetailsParts = [];
                let subjectsUsedWithRoles = [];

                // Helper function to find the best available subject from a pool
                function findBestSubjectFromPool(pool, currentUsedIds, categoryIds = SUBJECT_CATEGORIES_DEF.ANY_BEST, role = '') {
                    let bestCandidate = null;
                    for (const subj of pool) {
                        // Ensure categoryIds is an array and check if the subject's category is included
                        if (!currentUsedIds.has(subj.subjectId) && Array.isArray(categoryIds) && categoryIds.includes(subj.category)) {
                            if (!bestCandidate || subj.numericGrade < bestCandidate.numericGrade) {
                                bestCandidate = subj;
                            }
                        }
                    }
                    if (bestCandidate) {
                        currentUsedIds.add(bestCandidate.subjectId);
                        return { ...bestCandidate, role: role };
                    }
                    return null;
                }

                // 1. Find EL (English Language) - Must be G3
                const el_g3 = findBestSubjectFromPool(g3Subjects, usedSubjectIds, config.EL, 'EL');
                if (!el_g3) {
                    console.log("ELR2B2: Missing English (G3)");
                    return { grossScore: Infinity, netScore: Infinity, details: "Missing English (G3)", subjectsUsed: [] };
                }
                subjectsUsedWithRoles.push(el_g3);
                scoreDetailsParts.push(`EL(G3 ${el_g3.grade})`);

                // 2. Find R1 (Relevant Subject 1) - Must be G3
                const r1Candidate = findBestSubjectFromPool(g3Subjects, usedSubjectIds, config.R1_cat_ids, 'R1');
                if (!r1Candidate) {
                    console.log("ELR2B2: Missing R1 (Relevant G3 subject)");
                    return { grossScore: Infinity, netScore: Infinity, details: "Missing R1 (Relevant G3 subject)", subjectsUsed: [] };
                }
                subjectsUsedWithRoles.push(r1Candidate);
                scoreDetailsParts.push(`R1(${getSubjectById(r1Candidate.subjectId)?.name} G3 ${r1Candidate.grade})`);

                // 3. Find R2 (Relevant Subject 2) - Must be G3
                const r2Candidate = findBestSubjectFromPool(g3Subjects, usedSubjectIds, config.R2_cat_ids, 'R2');
                if (!r2Candidate) {
                    console.log("ELR2B2: Missing R2 (Relevant G3 subject)");
                    return { grossScore: Infinity, netScore: Infinity, details: "Missing R2 (Relevant G3 subject)", subjectsUsed: [] };
                }
                subjectsUsedWithRoles.push(r2Candidate);
                scoreDetailsParts.push(`R2(${getSubjectById(r2Candidate.subjectId)?.name} G3 ${r2Candidate.grade})`);

                // --- B1 and B2 logic: One B subject G3, one B subject G2 equivalent ---
                let b1Subj = null; 
                let b2Subj = null;
                let minCombinedBScore = Infinity;

                // Filter subjects that are not yet used for EL, R1, R2, and are eligible for B component
                const potentialBSubjects = currentStudentSubjects.filter(s => 
                    !usedSubjectIds.has(s.subjectId) && config.B_cat_ids.includes(getSubjectById(s.subjectId)?.category)
                );

                // Prepare candidates for B1 (must be G3)
                const candidatesForB1 = potentialBSubjects
                    .filter(s => s.level === 'G3' && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, 'G3') }));

                // Prepare candidates for B2 (can be G1, G2, or G3 converted to G2 equivalent)
                const candidatesForB2 = potentialBSubjects
                    .map(s => ({
                        ...s,
                        g2Grade: getStudentSubjectG2Grade(s), // Get G2 equivalent grade string
                        numericG2Equiv: getNumericGrade(getStudentSubjectG2Grade(s), 'G2') // Get numeric G2 equivalent
                    }))
                    .filter(s => G2_GRADES_OPTIONS.includes(s.g2Grade)); // Ensure valid G2 equivalent grade was obtained

                // Find the best distinct pair for B1 (G3) and B2 (G2 equivalent)
                for (const candB1 of candidatesForB1) {
                    for (const candB2 of candidatesForB2) {
                        // Ensure B1 and B2 are distinct subjects
                        if (candB1.subjectId !== candB2.subjectId) {
                            const currentCombinedScore = candB1.numericGrade + candB2.numericG2Equiv;
                            if (currentCombinedScore < minCombinedBScore) {
                                minCombinedBScore = currentCombinedScore;
                                b1Subj = { ...candB1, role: 'B1' };
                                b2Subj = { ...candB2, role: 'B2' };
                            }
                        }
                    }
                }

                if (!b1Subj || !b2Subj) {
                    console.log("ELR2B2: Not enough distinct subjects for B1 (G3) and B2 (G2 equivalent).");
                    return { grossScore: Infinity, netScore: Infinity, details: "Not enough distinct subjects for B1 (G3) and B2 (G2 equivalent).", subjectsUsed: [] };
                }

                // Push selected B1 and B2 to subjectsUsedWithRoles
                subjectsUsedWithRoles.push(b1Subj);
                scoreDetailsParts.push(`B1(${getSubjectById(b1Subj.subjectId)?.name} G3 ${b1Subj.grade})`);

                subjectsUsedWithRoles.push(b2Subj);
                scoreDetailsParts.push(`B2(${getSubjectById(b2Subj.subjectId)?.name} ${b2Subj.level} ${b2Subj.grade} (G2 equiv ${b2Subj.g2Grade}))`);

                // Calculate gross score
                let grossScore = 0;
                grossScore += el_g3.numericGrade;
                grossScore += r1Candidate.numericGrade;
                grossScore += r2Candidate.numericGrade;
                grossScore += b1Subj.numericGrade; // Use G3 numeric grade for B1
                grossScore += b2Subj.numericG2Equiv; // Use G2 equivalent numeric grade for B2

                const netScore = grossScore - currentBonusPoints;
                console.log(`ELR2B2 Calculated: Gross=${grossScore}, Net=${netScore}, Subjects=${subjectsUsedWithRoles.map(s => s.subjectId + '(' + s.role + ')').join(', ')}, Details=${scoreDetailsParts.join(", ")}`);

                
                return { grossScore: grossScore, netScore: netScore, subjectsUsed: subjectsUsedWithRoles, details: scoreDetailsParts.join(", ") };
            };

            const calculate5thYearSecondary = (currentStudentSubjects, currentBonusPoints = 0) => {
                const subjectsForCalc = currentStudentSubjects.map(s => ({
                    ...s, g2Grade: getStudentSubjectG2Grade(s), numericG2Grade: getNumericGrade(getStudentSubjectG2Grade(s), "G2"), category: getSubjectById(s.subjectId)?.category
                })).filter(s => G2_GRADES_OPTIONS.includes(s.g2Grade) && s.numericG2Grade <= 5); // G2 Grade 5 or better

                if (subjectsForCalc.length < 5) {
                    return { grossScore: Infinity, netScore: Infinity, details: "Need at least 5 subjects with G2 Grade 5 or better.", subjectsUsed: [] };
                }

                const el = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId));
                const ma = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(s.category));

                let elmab3Score = Infinity;
                let elb3Score = Infinity;
                let mab3Score = Infinity;
                let details = [];
                let subjectsUsedForBestScore = [];

                if (el && ma) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId && s.subjectId !== ma.subjectId)
                        .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        elmab3Score = el.numericG2Grade + ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`ELMAB3: ${elmab3Score} (EL: ${el.g2Grade}, MA: ${ma.g2Grade}, B1: ${b3[0].g2Grade}, B2: ${b3[1].g2Grade}, B3: ${b3[2].g2Grade})`);
                        // Store subjects for this score for later comparison
                        subjectsUsedForBestScore.push({ score: elmab3Score, subjects: [
                            {...el, role: 'EL'}, {...ma, role: 'MA'}, 
                            {...b3[0], role: 'B1'}, {...b3[1], role: 'B2'}, {...b3[2], role: 'B3'}
                        ] });
                    }
                }

                if (el) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId)
                        .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        elb3Score = el.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`ELB3: ${elb3Score} (EL: ${el.g2Grade}, B1: ${b3[0].g2Grade}, B2: ${b3[1].g2Grade}, B3: ${b3[2].g2Grade})`);
                        subjectsUsedForBestScore.push({ score: elb3Score, subjects: [
                            {...el, role: 'EL'}, 
                            {...b3[0], role: 'B1'}, {...b3[1], role: 'B2'}, {...b3[2], role: 'B3'}
                        ] });
                    }
                }

                if (ma) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== ma.subjectId)
                        .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        mab3Score = ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`MAB3: ${mab3Score} (MA: ${ma.g2Grade}, B1: ${b3[0].g2Grade}, B2: ${b3[1].g2Grade}, B3: ${b3[2].g2Grade})`);
                        subjectsUsedForBestScore.push({ score: mab3Score, subjects: [
                            {...ma, role: 'MA'}, 
                            {...b3[0], role: 'B1'}, {...b3[1], role: 'B2'}, {...b3[2], role: 'B3'}
                        ] });
                    }
                }
                
                const scoreMet = (elmab3Score <= 21) || (elb3Score <= 14) || (mab3Score <= 14);
                const finalScore = Math.min(elmab3Score, elb3Score, mab3Score);

                let actualSubjectsUsed = [];
                if (subjectsUsedForBestScore.length > 0) {
                    subjectsUsedForBestScore.sort((a, b) => a.score - b.score);
                    actualSubjectsUsed = subjectsUsedForBestScore[0].subjects;
                } else {
                    // Fallback: if no specific ELMAB3/ELB3/MAB3 combo is met, just take the best 5 G2-equivalent subjects
                    actualSubjectsUsed = subjectsForCalc.sort((a,b) => a.numericG2Grade - b.numericG2Grade).slice(0, 5).map((s, idx) => ({...s, role: `B${idx+1}`}));
                }


                return { grossScore: finalScore, netScore: finalScore - currentBonusPoints, details: details.join("; "), scoreMet: scoreMet, subjectsUsed: actualSubjectsUsed };
            };

            const calculateArtsInstitutions = (currentStudentSubjects) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level) }));

                const el = g3Subjects.find(s => s.subjectId === "EL");
                // The required grade for EL in Arts Institutions is C6 or better (numeric 6)
                const elCheck = el && getNumericGrade(el.grade, "G3") <= G3_TO_NUMERIC_RAW["C6"]; 

                const otherG3Subjects = g3Subjects.filter(s => s.subjectId !== "EL")
                    .sort((a, b) => a.numericGrade - b.numericGrade);

                if (!el || getNumericGrade(el.grade, "G3") > G3_TO_NUMERIC_RAW["C6"] || otherG3Subjects.length < 4) {
                    return { grossScore: Infinity, netScore: Infinity, details: "Missing English Language (G3) C6 or better, or not enough other G3 subjects.", subjectsUsed: [] };
                }

                const best4Others = otherG3Subjects.slice(0, 4).map((s, index) => ({
                    ...s,
                    role: `B${index + 1}` // Assign roles like B1, B2, B3, B4
                }));
                const totalScore = best4Others.reduce((sum, s) => sum + s.numericGrade, 0);

                return { grossScore: totalScore, netScore: totalScore, subjectsUsed: [{...el, role: 'EL'}, ...best4Others], details: `Best 4 G3 (excl. EL): ${totalScore}` };
            };

            const calculateITEHnitecSpecific = (currentStudentSubjects, requirements, currentBonusPoints = 0) => {
                let metCriteria = true; // Initialize to true, will be set to false if any requirement fails
                let details = [];
                let best4Score = Infinity;
                let best4Subjects = [];
            
                const g1g2Passes = currentStudentSubjects.filter(s => {
                    let isPass = false;
                    if (s.level === "G1") isPass = ['A', 'B', 'C', 'D'].includes(s.grade);
                    else if (s.level === "G2") isPass = ['1', '2', '3', '4', '5'].includes(s.grade);
                    else if (s.level === "G3") {
                        const g1Equiv = G3_TO_G1_EQUIV_MAP[s.grade];
                        isPass = g1Equiv && ['A', 'B', 'C', 'D'].includes(g1Equiv);
                    }
                    return isPass;
                }).map(s => getG1Equivalent(s));

                console.log("ITE Hnitec Specific: g1g2Passes (passing G1/G2 equivalent subjects):", g1g2Passes.map(s => `${s.subjectId} (${s.level} ${s.grade} -> G1 ${s.g1EquivGrade})`));
            
                const totalSubjectsCheck = currentStudentSubjects.length >= requirements.min_total_subjects;
                details.push({ merId: 'min_total_subjects', text: `Minimum of ${requirements.min_total_subjects} subjects total (found ${currentStudentSubjects.length})`, met: totalSubjectsCheck });
                if (!totalSubjectsCheck) metCriteria = false;
            
                if (requirements.type === "3_G1G2_ONLY") {
                    let elPass, mathPass, mainSubjectPass;
                    let elCheck = false, mathCheck = false, mainSubjectCheck = false;
                    let otherPassesRequired = requirements.req_g1g2_other_count;
                    let usedForPrereqIds = new Set();
            
                    if (requirements.req_g1g2_main_cats.includes(SUBJECT_CATEGORIES_DEF.EL[0]) &&
                        requirements.req_g1g2_main_cats.includes(SUBJECT_CATEGORIES_DEF.MATH_PURE[0])) {
                        // EL & Math pathway
                        elPass = g1g2Passes.find(s => getSubjectById(s.subjectId)?.category === SUBJECT_CATEGORIES_DEF.EL[0]);
                        mathPass = g1g2Passes.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(getSubjectById(s.subjectId)?.category));
            
                        console.log(`  EL Pass candidate:`, elPass ? `${elPass.subjectId} (G1 equiv ${elPass.g1EquivGrade})` : 'None');
                        console.log(`  Math Pass candidate:`, mathPass ? `${mathPass.subjectId} (G1 equiv ${mathPass.g1EquivGrade})` : 'None');

                        elCheck = !!elPass;
                        details.push({ merId: 'el_g1g2_pass', text: `English (G1/G2 pass)`, met: elCheck });
                        if (!elCheck) metCriteria = false; // Corrected: use metCriteria
                        else usedForPrereqIds.add(elPass.subjectId);
            
                        mathCheck = !!mathPass;
                        details.push({ merId: 'math_g1g2_pass', text: `Mathematics (G1/G2 pass)`, met: mathCheck });
                        if (!mathCheck) metCriteria = false; // Corrected: use metCriteria
                        else if (elPass && mathPass.subjectId !== elPass.subjectId) usedForPrereqIds.add(mathPass.subjectId);
                        else if (!elPass && mathPass) usedForPrereqIds.add(mathPass.subjectId);
                    } else {
                        // Single main category pathway
                        const potentialMainSubjects = g1g2Passes.filter(s => {
                            const subjectCategory = getSubjectById(s.subjectId)?.category;
                            const isMainCat = requirements.req_g1g2_main_cats.includes(subjectCategory);
                            const isScienceInLieu = requirements.allow_science_in_lieu && SUBJECT_CATEGORIES_DEF.SCIENCE_IN_LIEU.includes(subjectCategory);
                            return isMainCat || isScienceInLieu;
                        }).sort((a,b) => a.numericG1EquivGrade - b.numericG1EquivGrade);
                        
                        mainSubjectPass = potentialMainSubjects.length > 0 ? potentialMainSubjects[0] : null;
                        mainSubjectCheck = !!mainSubjectPass;
            
                        let mainSubjectDisplayText = "1 G1/G2 pass in required category";
                        let mainSubjectMerId = 'main_g1g2_pass';
                        if (requirements.req_g1g2_main_cats.length === 1 && requirements.req_g1g2_main_cats[0] === SUBJECT_CATEGORIES_DEF.EL[0]) {
                           mainSubjectDisplayText = "English (G1/G2 pass)";
                           mainSubjectMerId = 'el_g1g2_pass';
                       } else if (requirements.req_g1g2_main_cats.length === 1 && requirements.req_g1g2_main_cats[0] === SUBJECT_CATEGORIES_DEF.MATH_PURE[0]) {
                           mainSubjectDisplayText = "Mathematics (G1/G2 pass)";
                           mainSubjectMerId = 'math_g1g2_pass';
                       } else if (JSON.stringify(requirements.req_g1g2_main_cats.sort()) === JSON.stringify(SUBJECT_CATEGORIES_DEF.MATH_SCIENCE.sort())) {
                            mainSubjectDisplayText = "Math or Science (G1/G2 pass)";
                            mainSubjectMerId = 'math_or_science_g1g2_pass';
                       }
                        details.push({ merId: mainSubjectMerId, text: mainSubjectDisplayText, met: mainSubjectCheck });
                        if (!mainSubjectCheck) metCriteria = false; // Corrected: use metCriteria
                        else if (mainSubjectPass) usedForPrereqIds.add(mainSubjectPass.subjectId);
                    }
            
                    // Independent check for other passes, considering subjects already used for prerequisites
                    const remainingG1G2PassesForOther = g1g2Passes.filter(s => !usedForPrereqIds.has(s.subjectId));
                    const actualOtherCountCheck = remainingG1G2PassesForOther.length >= otherPassesRequired;
                    details.push({ merId: 'other_g1g2_passes', text: `${otherPassesRequired} other distinct G1/G2 pass(es)`, met: actualOtherCountCheck });
                    if (!actualOtherCountCheck) {
                        metCriteria = false; 
                    }
            
                } else if (requirements.type === "2_G3_ONLY") {
                    const g3Passes = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade) && getNumericGrade(s.grade, "G3") <= requirements.req_g3_grade);
                    const g3CountCheck = g3Passes.length >= requirements.req_g3_count;
                    details.push({ merId: 'g3_passes_count', text: `${requirements.req_g3_count} G3 passes (1-${requirements.req_g3_grade})`, met: g3CountCheck });
                    if (!g3CountCheck) metCriteria = false;
                }
            
                const calculatedBest4 = calculateBest4G1Equivalent(currentStudentSubjects);
                best4Score = calculatedBest4.score;
                best4Subjects = calculatedBest4.subjects;
            
                details.push({ merId: 'aggregate_note', text: "Check the aggregate point for specific course.", met: false, isPlainBullet: true });
            
                return {
                    grossScore: best4Score,
                    netScore: best4Score - currentBonusPoints,
                    details: details,
                    scoreMet: metCriteria,
                    subjectsUsed: best4Subjects,
                };
            };
            
            const calculateITEHnitecCompleted = (currentStudentSubjects, currentBonusPoints = 0) => {
                let metCriteria = false;
                let details = []; 
                let best4Score = Infinity;
                let best4Subjects = [];
            
                const hasAnyValidGrade = currentStudentSubjects.some(s => {
                    if (s.level === "G3") return G3_GRADES_OPTIONS.includes(s.grade);
                    if (s.level === "G2") return G2_GRADES_OPTIONS.includes(s.grade);
                    if (s.level === "G1") return G1_GRADES_OPTIONS.includes(s.grade);
                    return false;
                });
            
                if (hasAnyValidGrade && currentStudentSubjects.length >= 4) { 
                    metCriteria = true;
                    details.push({ merId: 'sec_completion', text: "Completed Singapore-Cambridge Secondary Education Certificate.", met: true });
                } else {
                    metCriteria = false;
                    details.push({ merId: 'sec_completion', text: `Requires completion of Singapore-Cambridge Secondary Education Certificate (with at least 4 subjects, found ${currentStudentSubjects.length}).`, met: false });
                }
            
                const calculatedBest4 = calculateBest4G1Equivalent(currentStudentSubjects);
                best4Score = calculatedBest4.score;
                best4Subjects = calculatedBest4.subjects;
            
                details.push({ merId: 'aggregate_note', text: "Check the aggregate point for specific course.", met: false, isPlainBullet: true });
            
                return {
                    grossScore: best4Score, 
                    netScore: best4Score - currentBonusPoints,
                    details: details, 
                    scoreMet: metCriteria, 
                    subjectsUsed: best4Subjects, 
                };
            };


            // Modified to accept currentStudentSubjects
            const checkMerRequirements = (pathway, currentStudentSubjects, bonusPoints, subjectsUsedForScoreCalculation) => {
                let merDetails = [];
                let overallMerMet = true; 
                const studentSubjectsMap = new Map(currentStudentSubjects.map(s => [s.subjectId, s])); // Create map from passed subjects
                const usedSubjectIdsForAggregate = new Set(subjectsUsedForScoreCalculation.map(s => s.subjectId));
            
                if (pathway.calcType === "L1R4_G3") {
                    const scoreCheck = pathway.grossScore <= pathway.requirements.grossL1R4;
                    merDetails.push({
                        merId: 'l1r4_gross_score',
                        text: `L1R4 (G3 subjects)  ${pathway.requirements.grossL1R4} (Your Gross: ${pathway.grossScore})`,
                        met: scoreCheck
                    });
                    if (!scoreCheck) overallMerMet = false;
                } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                    const scoreCheck = pathway.netScore <= pathway.requirements.netELR2B2;
                    merDetails.push({
                        merId: 'elr2b2_net_score',
                        text: `ELR2B2 (Net)  ${pathway.requirements.netELR2B2} (Your Net: ${pathway.netScore})`,
                        met: scoreCheck
                    });
                    if (!scoreCheck) overallMerMet = false;
            
                    let tempUsedSubjectsForMERDisplay = new Set(); 
                    const el = studentSubjectsMap.get("EL");
                    const elCheck = el && el.level === "G3" && getNumericGrade(el.grade, "G3") <= G3_TO_NUMERIC_RAW["C6"];
                    merDetails.push({ merId: 'el_mer', text: `English (G3): ${el ? getSubjectGradeDisplay(el.subjectId, el.grade, el.level) : 'N/A'} (Required G3  C6)`, met: elCheck });
                    if (!elCheck) overallMerMet = false;
                    if (elCheck) tempUsedSubjectsForMERDisplay.add(el.subjectId);
            
                    let r1Found = false;
                    let r1SubjectDisplay = 'N/A';
                    let r1TooltipContent = '';
                    let r1CategoryText = `1 Relevant subject (G3) (R1 Category)`;
                    let r1SubjectIdsForTooltip = [];
                    if (pathway.id === "poly_yr1_elr2b2_a") r1SubjectIdsForTooltip = ELR2B2_A_R1_SUBJECT_IDS;
                    else if (pathway.id === "poly_yr1_elr2b2_b") r1SubjectIdsForTooltip = ELR2B2_B_R1_SUBJECT_IDS;
                    else if (pathway.id === "poly_yr1_elr2b2_c_general") r1SubjectIdsForTooltip = ELR2B2_C_R1_SUBJECT_IDS;
                    else if (pathway.id === "poly_yr1_elr2b2_d") r1SubjectIdsForTooltip = ELR2B2_D_R1_SUBJECT_IDS;
                    r1TooltipContent = getSubjectNamesFromIds(r1SubjectIdsForTooltip);
                    r1CategoryText = `<span class="tooltip">${r1CategoryText}<sup><small>i</small></sup><span class="tooltiptext">${r1TooltipContent}</span></span>`;
                    for (const subj of currentStudentSubjects) { // Use currentStudentSubjects
                        const subjectInfo = getSubjectById(subj.subjectId);
                        if (subjectInfo && subj.level === "G3" && G3_GRADES_OPTIONS.includes(subj.grade) && pathway.elr2b2_config.R1_cat_ids.includes(subjectInfo.category) && !tempUsedSubjectsForMERDisplay.has(subj.subjectId)) {
                            r1Found = true;
                            r1SubjectDisplay = getSubjectGradeDisplay(subj.subjectId, subj.grade, subj.level);
                            tempUsedSubjectsForMERDisplay.add(subj.subjectId);
                            break;
                        }
                    }
                    merDetails.push({ merId: 'r1_mer', text: `${r1CategoryText}: ${r1SubjectDisplay}`, met: r1Found });
                    if (!r1Found) overallMerMet = false;
            
                    let r2Found = false;
                    let r2SubjectDisplay = 'N/A';
                    let r2TooltipContent = '';
                    let r2CategoryText = `1 Relevant subject (G3) (R2 Category)`;
                    let r2SubjectIdsForTooltip = [];
                    if (pathway.id === "poly_yr1_elr2b2_a") r2SubjectIdsForTooltip = ELR2B2_A_R2_SUBJECT_IDS_FULL;
                    else if (pathway.id === "poly_yr1_elr2b2_b") r2SubjectIdsForTooltip = ELR2B2_B_R2_SUBJECT_IDS_FULL;
                    else if (pathway.id === "poly_yr1_elr2b2_c_general") r2SubjectIdsForTooltip = ELR2B2_C_R2_SUBJECT_IDS_FULL;
                    else if (pathway.id === "poly_yr1_elr2b2_d") r2SubjectIdsForTooltip = ELR2B2_D_R2_SUBJECT_IDS_FULL;
                    r2TooltipContent = getSubjectNamesFromIds(r2SubjectIdsForTooltip);
                    r2CategoryText = `<span class="tooltip">${r2CategoryText}<sup><small>i</small></sup><span class="tooltiptext">${r2TooltipContent}</span></span>`;
                    for (const subj of currentStudentSubjects) { // Use currentStudentSubjects
                        const subjectInfo = getSubjectById(subj.subjectId);
                        if (subjectInfo && subj.level === "G3" && G3_GRADES_OPTIONS.includes(subj.grade) && pathway.elr2b2_config.R2_cat_ids.includes(subjectInfo.category) && !tempUsedSubjectsForMERDisplay.has(subj.subjectId)) {
                            r2Found = true;
                            r2SubjectDisplay = getSubjectGradeDisplay(subj.subjectId, subj.grade, subj.level);
                            tempUsedSubjectsForMERDisplay.add(subj.subjectId);
                            break;
                        }
                    }
                    merDetails.push({ merId: 'r2_mer', text: `${r2CategoryText}: ${r2SubjectDisplay}`, met: r2Found });
                    if (!r2Found) overallMerMet = false;
            
                    let b1Found = false;
                    let b1SubjectDisplay = 'N/A';
                    for (const subj of currentStudentSubjects) { // Use currentStudentSubjects
                        const subjectInfo = getSubjectById(subj.subjectId);
                        if (subjectInfo && subj.level === "G3" && G3_GRADES_OPTIONS.includes(subj.grade) && pathway.elr2b2_config.B_cat_ids.includes(subjectInfo.category) && !tempUsedSubjectsForMERDisplay.has(subj.subjectId)) {
                            b1Found = true;
                            b1SubjectDisplay = getSubjectGradeDisplay(subj.subjectId, subj.grade, subj.level);
                            tempUsedSubjectsForMERDisplay.add(subj.subjectId);
                            break;
                        }
                    }
                    merDetails.push({ merId: 'b1_mer', text: `One B subject (G3): ${b1SubjectDisplay}`, met: b1Found });
                    if (!b1Found) overallMerMet = false;
            
                    let b2Found = false;
                    let b2SubjectDisplay = 'N/A';
                    for (const subj of currentStudentSubjects) { // Use currentStudentSubjects
                        const subjectInfo = getSubjectById(subj.subjectId);
                        const g2EquivGrade = getStudentSubjectG2Grade(subj);
                        if (subjectInfo && G2_GRADES_OPTIONS.includes(g2EquivGrade) && pathway.elr2b2_config.B_cat_ids.includes(subjectInfo.category) && !tempUsedSubjectsForMERDisplay.has(subj.subjectId)) {
                            b2Found = true;
                            b2SubjectDisplay = `${getSubjectById(subj.subjectId)?.name} ${subj.level} ${subj.grade} (G2 equiv ${g2EquivGrade})`;
                            tempUsedSubjectsForMERDisplay.add(subj.subjectId);
                            break;
                        }
                    }
                    merDetails.push({ merId: 'b2_mer', text: `One B subject (G2 equivalent): ${b2SubjectDisplay}`, met: b2Found });
                    if (!b2Found) overallMerMet = false;
            
                    merDetails.push({ merId: 'course_finder_note', text: `Please confirm course-specific minimum entry requirements using <a href="https://www.moe.gov.sg/coursefinder" target="_blank" class="text-cyan-400 hover:underline">MOE CourseFinder</a>.`, met: false, isPlainBullet: true });
            
                } else if (pathway.calcType === "ELMAB3_G2") {
                    const scoreCheck = pathway.grossScore <= pathway.requirements.grossELMAB3;
                    merDetails.push({
                        merId: 'elmab3_gross_score',
                        text: `ELMAB3 (Gross)  ${pathway.requirements.grossELMAB3} (Your Gross: ${pathway.grossScore})`,
                        met: scoreCheck
                    });
                    if (!scoreCheck) overallMerMet = false;
            
                    const el = studentSubjectsMap.get("EL");
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");
            
                    const elCheck = el && pathway.mer && pathway.mer.el_g2 && getNumericGrade(getStudentSubjectG2Grade(el), "G2") <= getNumericGrade(pathway.mer.el_g2, "G2");
                    merDetails.push({ merId: 'el_mer', text: `English (G2 equiv): ${el ? getStudentSubjectG2Grade(el) : 'N/A'} (Required G2  ${pathway.mer && pathway.mer.el_g2 ? pathway.mer.el_g2 : 'N/A'})`, met: elCheck });
                    if (!elCheck) overallMerMet = false;
                    let usedForPFP = new Set(); // Track subjects used for PFP MER
                    if (elCheck) usedForPFP.add(el.subjectId);

                    let mathGrade = getSubjectGradeForMer("MATH", "G2", currentStudentSubjects); // Pass currentStudentSubjects
                    let amGrade = getSubjectGradeForMer("AM", "G2", currentStudentSubjects); // Pass currentStudentSubjects
                    let effectiveMathGrade = Math.min(mathGrade, amGrade);
                    let mathDisplay = (effectiveMathGrade === mathGrade && math) ? getStudentSubjectG2Grade(math) : ((effectiveMathGrade === amGrade && am) ? getStudentSubjectG2Grade(am) : 'N/A');
                    const mathCheck = pathway.mer && pathway.mer.math_am_g2 && effectiveMathGrade <= getNumericGrade(pathway.mer.math_am_g2, "G2");
                    merDetails.push({ merId: 'math_am_mer', text: `Math/Add Math (G2 equiv): ${mathDisplay} (Required G2  ${pathway.mer && pathway.mer.math_am_g2 ? pathway.mer.math_am_g2 : 'N/A'})`, met: mathCheck });
                    if (!mathCheck) overallMerMet = false;
                    if (mathCheck) {
                        if (effectiveMathGrade === mathGrade && math) usedForPFP.add(math.subjectId);
                        else if (effectiveMathGrade === amGrade && am) usedForPFP.add(am.subjectId);
                    }

                    // PFP Specific MER check for relevant subject and other two subjects
                    if (pathway.group === "PFP") {
                        let relevantSubjFound = false;
                        let relevantSubjDisplay = 'N/A';
                        let relevantSubjIdUsed = null;
                        
                        const relevantSubjCandidates = currentStudentSubjects.filter(subj => // Use currentStudentSubjects
                            pathway.mer.relevant_subj_ids.includes(subj.subjectId) &&
                            !usedForPFP.has(subj.subjectId) &&
                            G2_GRADES_OPTIONS.includes(getStudentSubjectG2Grade(subj)) &&
                            getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(pathway.mer.relevant_subj_g2, "G2")
                        ).sort((a,b) => getNumericGrade(getStudentSubjectG2Grade(a), "G2") - getNumericGrade(getStudentSubjectG2Grade(b), "G2"));

                        if (relevantSubjCandidates.length > 0) {
                            relevantSubjFound = true;
                            const bestRelevantSubj = relevantSubjCandidates[0];
                            relevantSubjDisplay = `${getSubjectById(bestRelevantSubj.subjectId)?.name} ${bestRelevantSubj.level} ${bestRelevantSubj.grade} (G2 equiv ${getStudentSubjectG2Grade(bestRelevantSubj)})`;
                            relevantSubjIdUsed = bestRelevantSubj.subjectId;
                            usedForPFP.add(relevantSubjIdUsed);
                        }
                        
                        const relevantSubjNames = pathway.mer.relevant_subj_ids.map(id => getSubjectById(id)?.name).join(', ');
                        merDetails.push({ merId: 'relevant_subj_mer', text: `1 subject (G2 equiv) from (${relevantSubjNames})  ${pathway.mer.relevant_subj_g2}: ${relevantSubjDisplay}`, met: relevantSubjFound });
                        if (!relevantSubjFound) overallMerMet = false;

                        const otherTwoSubjects = currentStudentSubjects.filter(subj => // Use currentStudentSubjects
                            !usedForPFP.has(subj.subjectId) &&
                            G2_GRADES_OPTIONS.includes(getStudentSubjectG2Grade(subj)) &&
                            getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(pathway.mer.other_two_subj_g2, "G2")
                        ).sort((a,b) => getNumericGrade(getStudentSubjectG2Grade(a), "G2") - getNumericGrade(getStudentSubjectG2Grade(b), "G2"));

                        const otherTwoSubjCheck = otherTwoSubjects.length >= 2;
                        merDetails.push({ merId: 'other_two_subj_mer', text: `2 other subjects (G2 equiv)  ${pathway.mer.other_two_subj_g2}: Need 2, found ${otherTwoSubjects.length}`, met: otherTwoSubjCheck });
                        if (!otherTwoSubjCheck) overallMerMet = false;

                    } else if (pathway.group === "ITE Year 2 Higher Nitec") { // Existing ITE Year 2 Higher Nitec logic
                        const otherSubjectsCount = currentStudentSubjects.filter(subj => // Use currentStudentSubjects
                            subj.subjectId !== (el?.subjectId || '') && 
                            subj.subjectId !== (math?.subjectId || '') && 
                            subj.subjectId !== (am?.subjectId || '') && 
                            G2_GRADES_OPTIONS.includes(getStudentSubjectG2Grade(subj)) &&
                            pathway.mer && pathway.mer.any_three_other_subj_g2 && getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(pathway.mer.any_three_other_subj_g2, "G2")
                        ).length;
                        const otherThreeSubjCheck = otherSubjectsCount >= 3;
                        merDetails.push({ merId: 'other_three_subj_mer', text: `3 other subjects (G2 equiv): Need 3, found ${otherSubjectsCount} at G2  ${pathway.mer && pathway.mer.any_three_other_subj_g2 ? pathway.mer.any_three_other_subj_g2 : 'N/A'}`, met: otherThreeSubjCheck });
                        if (!otherThreeSubjCheck) overallMerMet = false;
                    }
                }
            
                if (pathway.group === "JC/MI") {
                    const el = studentSubjectsMap.get("EL");
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");
                    let mtOptionMet = false;
                    let mtMetDetail = null;
            
                    const elCheck = el && getNumericGrade(el.grade, "G3") <= pathway.mer.el_g3;
                    merDetails.push({ merId: 'el_mer', text: `English: ${el ? getSubjectGradeDisplay(el.subjectId, el.grade, el.level) : 'N/A'} (Required G3  ${G3_GRADES_OPTIONS[pathway.mer.el_g3 - 1]})`, met: elCheck });
                    if (!elCheck) overallMerMet = false;
            
                    let mathGrade = getSubjectGradeForMer("MATH", "G3", currentStudentSubjects); // Pass currentStudentSubjects
                    let amGrade = getSubjectGradeForMer("AM", "G3", currentStudentSubjects); // Pass currentStudentSubjects
                    let effectiveMathGrade = Math.min(mathGrade, amGrade);
                    let mathDisplay = (effectiveMathGrade === mathGrade && math) ? getSubjectGradeDisplay("MATH", math.grade, "G3") : ((effectiveMathGrade === amGrade && am) ? getSubjectGradeDisplay("AM", am.grade, "G3") : 'N/A');
                    const mathCheck = effectiveMathGrade <= pathway.mer.math_am_g3;
                    merDetails.push({ merId: 'math_am_mer', text: `Math/Add Math: ${mathDisplay} (Required G3  ${G3_GRADES_OPTIONS[pathway.mer.math_am_g3 - 1]})`, met: mathCheck });
                    if (!mathCheck) overallMerMet = false;
            
                    for (const option of pathway.mer.mt_options) {
                        const mtSubjCandidate = currentStudentSubjects.find(s => { // Use currentStudentSubjects
                            const subjectInfo = getSubjectById(s.subjectId);
                            return subjectInfo && subjectInfo.category === option.type;
                        });
            
                        if (mtSubjCandidate) {
                            let gradeToCompare = null;
                            let numericOptionGrade;
            
                            if (option.level === "G3") numericOptionGrade = getNumericGrade(option.grade, "G3");
                            else if (option.level === "G2") numericOptionGrade = getNumericGrade(option.grade, "G2");
                            else if (option.level === "G1") numericOptionGrade = getNumericGrade(option.grade, "G1");
            
                            if (mtSubjCandidate.level === option.level) {
                                if (option.level === "G3") gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G3");
                                else if (option.level === "G2") gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G2");
                                else if (option.level === "G1") gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G1");
                            }
                            
                            if (gradeToCompare !== null && gradeToCompare <= numericOptionGrade) {
                                mtOptionMet = true;
                                mtMetDetail = { text: `${getSubjectById(mtSubjCandidate.subjectId)?.name} (${mtSubjCandidate.level} ${mtSubjCandidate.grade}) (Met ${option.level} ${option.grade} requirement)`, met: true };
                                break;
                            }
                        }
                    }
                    if (mtOptionMet) {
                        merDetails.push({ merId: 'mt_mer', text: mtMetDetail.text, met: true });
                    } else {
                        overallMerMet = false;
                        merDetails.push({ merId: 'mt_mer', text: `Mother Tongue: No option met.`, met: false });
                    }
                    merDetails.push({ merId: 'stream_mer_note', text: `Check the minimum subject grade requirements for specific streams.`, met: false, isPlainBullet: true });
                }
            
                const uniqueMerDetails = [];
                const seenMerIds = new Set(); // Use merId for uniqueness
                merDetails.forEach(detail => {
                    // Special handling for Mother Tongue to avoid duplicates if multiple options meet.
                    // If an MT option is met, we only want one "Mother Tongue" entry.
                    if (detail.merId === 'mt_mer' && detail.met === true) {
                        if (!seenMerIds.has('mt_mer_met')) { // Use a specific ID for met MT
                            uniqueMerDetails.push(detail);
                            seenMerIds.add('mt_mer_met');
                        }
                    } else if (detail.merId && !seenMerIds.has(detail.merId)) {
                        uniqueMerDetails.push(detail);
                        seenMerIds.add(detail.merId);
                    } else if (!detail.merId && !seenMerIds.has(detail.text)) { // Fallback for items without merId (should be only plain bullets now)
                        uniqueMerDetails.push(detail);
                        seenMerIds.add(detail.text);
                    }
                });
            
                console.log(`checkMerRequirements Final for ${pathway.name}: overallMerMet=${overallMerMet}, merDetails=`, uniqueMerDetails);
                return { merMet: overallMerMet, merDetails: uniqueMerDetails };
            };

            /**
             * Calculates the full eligibility status for all pathways.
             * @param {Array<Object>} subjects - The list of student subjects.
             * @returns {Array<Object>} An array of pathway status objects.
             */
            const calculateAllPathwaysStatus = (subjects) => {
                const allPathwaysStatus = [];
                // studentSubjectsMap is now created inside checkMerRequirements
                // const studentSubjectsMap = new Map(subjects.map(s => [s.subjectId, s]));

                let qualifiesForJCMIPoly = false;
                const jcMiPolyPathways = PATHWAYS.filter(p => p.group === "JC/MI" || p.group === "Polytechnic Year 1");

                // First pass to determine if student qualifies for any JC/MI/Poly Year 1 pathway
                // This is needed for the "5th Year Secondary - Subgroup 2" pathway logic
                jcMiPolyPathways.forEach(pathway => { 
                    let result = { grossScore: Infinity, netScore: Infinity, details: "N/A", subjectsUsed: [] };
                    let scoreMet = false;
                    let tempPathway = {...pathway}; // Clone for temporary score assignment
                    if (tempPathway.requirements) tempPathway.requirements = { ...tempPathway.requirements };
                    if (tempPathway.mer) tempPathway.mer = { ...tempPathway.mer };
                    if (tempPathway.l1r4_config) tempPathway.l1r4_config = { ...tempPathway.l1r4_config };
                    if (tempPathway.elr2b2_config) tempPathway.elr2b2_config = { ...tempPathway.elr2b2_config };


                    if (tempPathway.calcType === "L1R4_G3") {
                        result = calculateL1R4(subjects, tempPathway.l1r4_config, bonusPoints);
                        scoreMet = result.grossScore <= tempPathway.requirements.grossL1R4;
                    } else if (tempPathway.calcType === "ELR2B2_G3_Mixed") {
                        result = calculateELR2B2_G3_Mixed(subjects, tempPathway.elr2b2_config, bonusPoints);
                        scoreMet = result.netScore <= tempPathway.requirements.netELR2B2;
                    }
                    // Temporarily assign scores and subjects used to pathway object for MER check
                    tempPathway.grossScore = result.grossScore;
                    tempPathway.netScore = result.netScore;
                    tempPathway.subjectsUsed = result.subjectsUsed; 

                    // Pass `subjects` as currentStudentSubjects
                    const merCheck = checkMerRequirements(tempPathway, subjects, bonusPoints, result.subjectsUsed);
                    if (scoreMet && merCheck.merMet) {
                        qualifiesForJCMIPoly = true;
                    }
                });


                // Second pass to calculate and store status for all pathways
                PATHWAYS.forEach(originalPathway => {
                    // Clone the pathway object to avoid modifying the original PATHWAYS constant
                    let pathway = { ...originalPathway }; 
                    // Ensure nested objects like requirements, mer, config are also cloned if they might be modified
                    if (pathway.requirements) pathway.requirements = { ...pathway.requirements };
                    if (pathway.mer) pathway.mer = { ...pathway.mer };
                    if (pathway.l1r4_config) pathway.l1r4_config = { ...pathway.l1r4_config };
                    if (pathway.elr2b2_config) pathway.elr2b2_config = { ...pathway.elr2b2_config };


                    let result = { grossScore: Infinity, netScore: Infinity, details: "N/A", subjectsUsed: [] };
                    let scoreMet = false;
                    let merCheckResult = { merMet: true, merDetails: [] }; // Default, will be updated

                    if (pathway.id === "fifth_year_sec_subgroup2") {
                        const g3Count = subjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade)).length;
                        const hasThreeOrMoreG3 = g3Count >= 3;
                        scoreMet = hasThreeOrMoreG3 && !qualifiesForJCMIPoly;
                        merCheckResult.merDetails.push({ merId: 'g3_count', text: `Has ${g3Count} G3 passes. (Required 3 or more G3 passes)`, met: hasThreeOrMoreG3 });
                        merCheckResult.merDetails.push({ merId: 'jc_poly_eligibility', text: qualifiesForJCMIPoly ? "Qualifies for JC/MI/Poly Year 1 (Not Eligible for this option)" : "Does NOT qualify for JC/MI/Poly Year 1 (Eligible for this option)", met: !qualifiesForJCMIPoly });
                        if (!hasThreeOrMoreG3 || qualifiesForJCMIPoly) merCheckResult.merMet = false; 
                    } else {
                        if (pathway.calcType === "L1R4_G3") {
                            result = calculateL1R4(subjects, pathway.l1r4_config, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossL1R4;
                        } else if (pathway.calcType === "ELMAB3_G2") {
                            result = calculateELMAB3_G2(subjects, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossELMAB3;
                        } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                            result = calculateELR2B2_G3_Mixed(subjects, pathway.elr2b2_config, bonusPoints);
                            scoreMet = result.netScore <= pathway.requirements.netELR2B2;
                        } else if (pathway.calcType === "5th_Year_Sec_G2") {
                            const fifthYearResult = calculate5thYearSecondary(subjects, bonusPoints);
                            result = fifthYearResult;
                            const g3Count = subjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade)).length;
                            const hasTwoOrFewerG3 = g3Count <= 2;
                            scoreMet = fifthYearResult.scoreMet && hasTwoOrFewerG3;
                            merCheckResult.merDetails.push({ merId: 'g3_count', text: `G3 Passes: ${g3Count} (Required 2 or fewer for Option 1)`, met: hasTwoOrFewerG3 });
                            if (!hasTwoOrFewerG3) merCheckResult.merMet = false; 
                        } else if (pathway.calcType === "Arts_Institutions_G3") {
                            result = calculateArtsInstitutions(subjects);
                            scoreMet = result.grossScore !== Infinity;
                        } else if (pathway.calcType === "ITE_Hnitec_Specific") {
                            const iteSpecificResult = calculateITEHnitecSpecific(subjects, pathway.requirements, bonusPoints);
                            result = iteSpecificResult; 
                            scoreMet = iteSpecificResult.scoreMet;
                            merCheckResult = { merMet: iteSpecificResult.scoreMet, merDetails: iteSpecificResult.details };
                        } else if (pathway.calcType === "ITE_Hnitec_Completed") {
                             const iteCompletedResult = calculateITEHnitecCompleted(subjects, bonusPoints);
                            result = iteCompletedResult; 
                            scoreMet = iteCompletedResult.scoreMet;
                            merCheckResult = { merMet: iteCompletedResult.scoreMet, merDetails: iteCompletedResult.details };
                        } else if (pathway.calcType === "Pending") {
                            scoreMet = false;
                            merCheckResult.merMet = false;
                            merCheckResult.merDetails.push({ merId: 'pending_update', text: "This section is pending update and no pathways are currently available for eligibility check.", met: false });
                        }
                        
                        pathway.grossScore = result.grossScore;
                        pathway.netScore = result.netScore;
                        pathway.subjectsUsed = result.subjectsUsed; 

                        if (pathway.calcType !== "ITE_Hnitec_Specific" && pathway.calcType !== "ITE_Hnitec_Completed") {
                           // Pass `subjects` as currentStudentSubjects
                           merCheckResult = checkMerRequirements(pathway, subjects, bonusPoints, result.subjectsUsed);
                        }
                    }

                    allPathwaysStatus.push({
                        ...pathway, 
                        grossScore: result.grossScore,
                        netScore: result.netScore,
                        scoreDetails: result.details,
                        merCheck: merCheckResult, 
                        isEligible: scoreMet && merCheckResult.merMet,
                        subjectsUsed: result.subjectsUsed,
                    });
                });

                return allPathwaysStatus;
            };
            
            function checkEligibility() {
                if (studentSubjects.length < 1) {
                    renderEligibilityResults(PATHWAYS.map(p => ({
                        ...p,
                        grossScore: Infinity,
                        netScore: Infinity,
                        scoreDetails: "Add subjects to see eligibility.",
                        scoreMet: false,
                        merCheck: { merMet: false, merDetails: [{ merId: 'add_subjects_placeholder', text: "Add at least one subject to see eligibility for some pathways.", met: false }] },
                        subjectsUsed: []
                    })));
                    return;
                }

                // Get the complete status for all pathways
                const allPathwaysStatus = calculateAllPathwaysStatus(studentSubjects);
                
                renderEligibilityResults(allPathwaysStatus); // Render all pathways, not just eligible ones
            }

            function generateImprovementSuggestions() {
                improvementSuggestionsContainer.innerHTML = '';
                if (studentSubjects.length === 0) {
                    improvementSuggestionsSection.classList.add('hidden');
                    improvementPlaceholder.classList.remove('hidden');
                    improvementPlaceholder.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">Add subjects to see improvement suggestions.</p>`;
                    return;
                }

                improvementSuggestionsSection.classList.remove('hidden');
                
                const currentAllPathwaysStatus = calculateAllPathwaysStatus(studentSubjects);
                const currentEligiblePathwayNames = new Set(
                    currentAllPathwaysStatus.filter(p => p.isEligible).map(p => p.name)
                );

                const suggestions = [];

                studentSubjects.forEach((subject, index) => {
                    const originalGrade = subject.grade;
                    const originalLevel = subject.level;
                    const nextBetterGrade = getNextBetterGrade(originalGrade, originalLevel);

                    if (nextBetterGrade) {
                        // Create a temporary copy of studentSubjects for simulation
                        const tempSubjects = studentSubjects.map((s, i) => 
                            i === index ? { ...s, grade: nextBetterGrade } : { ...s }
                        );
                        
                        const newAllPathwaysStatus = calculateAllPathwaysStatus(tempSubjects);
                        const newEligiblePathwayNames = new Set(
                            newAllPathwaysStatus.filter(p => p.isEligible).map(p => p.name)
                        );

                        const newlyEligiblePathways = [];
                        newEligiblePathwayNames.forEach(name => {
                            if (!currentEligiblePathwayNames.has(name)) {
                                newlyEligiblePathways.push(name);
                            }
                        });

                        const merImprovements = [];
                        newAllPathwaysStatus.forEach(newPathway => {
                            const currentPathway = currentAllPathwaysStatus.find(p => p.id === newPathway.id);
                            if (currentPathway) {
                                // Log pathway eligibility change
                                if (currentPathway.isEligible !== newPathway.isEligible) {
                                    console.log(`PATHWAY ELIGIBILITY CHANGE for ${newPathway.name}: From ${currentPathway.isEligible} to ${newPathway.isEligible}`);
                                }

                                newPathway.merCheck.merDetails.forEach(newDetail => {
                                    const currentDetail = currentPathway.merCheck.merDetails.find(d => d.merId === newDetail.merId || d.text === newDetail.text);
                                    if (currentDetail) {
                                        // Log MER detail status change
                                        if (currentDetail.met !== newDetail.met) {
                                            console.log(`  MER STATUS CHANGE for ${newPathway.name} - ${newDetail.merId || newDetail.text}: From ${currentDetail.met} to ${newDetail.met}`);
                                        }
                                        if (!currentDetail.met && newDetail.met && !newDetail.isPlainBullet) {
                                            merImprovements.push({
                                                pathwayName: newPathway.name,
                                                merText: newDetail.text
                                            });
                                        }
                                    }
                                });
                            }
                        });
                        
                        // Log the final state of suggestions for this subject
                        if (newlyEligiblePathways.length > 0 || merImprovements.length > 0) {
                            console.log(`SUGGESTION GENERATED for ${getSubjectById(subject.subjectId)?.name}: Newly Eligible Pathways: ${newlyEligiblePathways.join(', ')}, MER Improvements:`, merImprovements);
                        } else {
                            console.log(`NO SUGGESTION for ${getSubjectById(subject.subjectId)?.name}: No new pathways or MER improvements.`);
                        }
                        
                        if (newlyEligiblePathways.length > 0 || merImprovements.length > 0) {
                            suggestions.push({
                                subjectName: getSubjectById(subject.subjectId)?.name || subject.subjectId,
                                originalGrade: originalGrade,
                                originalLevel: originalLevel,
                                improvedGrade: nextBetterGrade,
                                improvedLevel: originalLevel, // Level remains the same for one grade improvement
                                pathwaysUnlockedCount: newlyEligiblePathways.length,
                                unlockedPathwayNames: newlyEligiblePathways.sort(), // Sort names alphabetically
                                merImprovements: merImprovements
                            });
                        }
                    }
                });


                if (suggestions.length === 0) {
                    improvementPlaceholder.classList.remove('hidden');
                    improvementPlaceholder.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">You're doing great! No immediate single grade improvements unlock new pathways based on current data, or all possible pathways are already met.</p>`;
                    improvementSuggestionsContainer.innerHTML = ''; // Clear any previous suggestions
                } else {
                    improvementPlaceholder.classList.add('hidden');
                    renderImprovementSuggestions(suggestions);
                }
            }

            function renderImprovementSuggestions(suggestions) {
                improvementSuggestionsContainer.innerHTML = ''; // Clear previous suggestions
                // improvementPlaceholder.classList.add('hidden'); // Hide placeholder if there are suggestions

                const maxSuggestions = 3; 
                const sortedSuggestions = suggestions.sort((a, b) => b.pathwaysUnlockedCount - a.pathwaysUnlockedCount);

                sortedSuggestions.slice(0, maxSuggestions).forEach(suggestion => {
                    const suggestionCard = document.createElement('div');
                    suggestionCard.className = 'bg-slate-700 p-4 rounded-lg shadow-md mb-4 border border-slate-600';
                    
                    const pathwayNamesList = suggestion.unlockedPathwayNames.map(name => 
                        `<li class="text-slate-300">${name}</li>`
                    ).join('');

                    suggestionCard.innerHTML = `
                        <h4 class="text-lg font-semibold text-emerald-300 mb-2">Improve ${suggestion.subjectName}</h4>
                        <p class="text-slate-300 text-sm mb-2">
                            If you improve your <strong>${suggestion.subjectName}</strong> grade from 
                            <span class="font-bold text-cyan-300">${suggestion.originalGrade} (${suggestion.originalLevel})</span> to 
                            <span class="font-bold text-cyan-300">${suggestion.improvedGrade} (${suggestion.improvedLevel})</span>, 
                            you could:
                        </p>
                        ${suggestion.unlockedPathwayNames.length > 0 ? `
                            <p class="text-slate-300 text-sm mb-1">Unlock <strong>${suggestion.pathwaysUnlockedCount}</strong> additional pathway(s):</p>
                            <ul class="list-disc list-inside text-sm ml-4 space-y-1">
                                ${pathwayNamesList}
                            </ul>
                        ` : ''}
                    `;
                    improvementSuggestionsContainer.appendChild(suggestionCard);
                });
                 // If after slicing, there are no suggestions to render (e.g. if suggestions array was empty initially)
                if (improvementSuggestionsContainer.innerHTML === '') {
                    improvementPlaceholder.classList.remove('hidden');
                     improvementPlaceholder.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">You're doing great! No immediate single grade improvements unlock new pathways based on current data, or all possible pathways are already met.</p>`;
                } else {
                    improvementPlaceholder.classList.add('hidden');
                }
            }


            // --- Event Handlers and UI Population/Rendering Functions ---
            function showMessage(message, title = "Notification") {
                messageBoxTitle.textContent = title;
                messageBoxText.textContent = message;
                customMessageBox.classList.remove('hidden');
            }
            
            messageBoxOkButton.addEventListener('click', () => {
                customMessageBox.classList.add('hidden');
            });

            const populateSubjectDropdown = () => {
                subjectSelect.innerHTML = '<option value="">Select Subject</option>'; // Clear existing options

                let subjectsToDisplay = [];
                let currentSchoolSubjectIds = [];
                if (selectedSchool === "Yuhua Secondary School") {
                    currentSchoolSubjectIds = YUHUA_SECONDARY_SCHOOL_SUBJECT_IDS;
                } else if (selectedSchool === "School A") {
                    currentSchoolSubjectIds = SCHOOL_A_SUBJECT_IDS;
                } else {
                    currentSchoolSubjectIds = ALL_SUBJECTS_LIST.map(s => s.id); // Default to all if no specific school selected or matched
                }
                
                subjectsToDisplay = ALL_SUBJECTS_LIST.filter(subject => currentSchoolSubjectIds.includes(subject.id));

                subjectsToDisplay.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
                // After populating subjects, try to retain selection or set default
                if (studentSubjects.length > 0 && editingIndex !== null) {
                    subjectSelect.value = studentSubjects[editingIndex].id;
                } else {
                    subjectSelect.value = ""; // No subject selected by default
                }
                populateLevelDropdown(levelSelect.value, subjectSelect.value); // Also update levels
            };

            // Corrected populateLevelDropdown to only handle subject levels
            const populateLevelDropdown = (currentLevel = '', selectedSubjectId = '') => {
                levelSelect.innerHTML = ''; // Clear existing options
                const selectedSubject = getSubjectById(selectedSubjectId);

                let applicableLevels = []; // Start with no applicable levels

                // If a subject is selected, determine its applicable levels
                if (selectedSubject) {
                    let currentLevelRestrictions = {};
                    if (selectedSchool === "Yuhua Secondary School") {
                        currentLevelRestrictions = YUHUA_SECONDARY_SCHOOL_LEVEL_RESTRICTIONS;
                    } else if (selectedSchool === "School A") {
                        currentLevelRestrictions = SCHOOL_A_LEVEL_RESTRICTIONS;
                    }

                    if (currentLevelRestrictions[selectedSubject.id]) {
                        applicableLevels = currentLevelRestrictions[selectedSubject.id];
                    } else {
                        // If no specific restriction for the subject, assume all levels are possible
                        applicableLevels = [...GRADE_LEVELS]; // GRADE_LEVELS is ["G3", "G2", "G1"]
                    }
                } else {
                    // If no subject is selected, add a default disabled option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select Level';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    levelSelect.appendChild(defaultOption);
                    populateGradeDropdown(''); // No grades if no levels
                    return;
                }

                if (applicableLevels.length === 0) {
                    const noLevelOption = document.createElement('option');
                    noLevelOption.value = '';
                    noLevelOption.textContent = 'No levels available';
                    noLevelOption.disabled = true;
                    noLevelOption.selected = true;
                    levelSelect.appendChild(noLevelOption);
                    populateGradeDropdown(''); // No grades if no levels
                    return;
                }

                // Custom sorting for DT and NFS to prioritize G3 over G2
                if (selectedSubjectId === "DT" || selectedSubjectId === "NFS") {
                    applicableLevels.sort((a, b) => {
                        if (a === "G3" && b === "G2") return -1;
                        if (a === "G2" && b === "G3") return 1;
                        return 0;
                    });
                }

                applicableLevels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = level;
                    levelSelect.appendChild(option);
                });

                // Attempt to re-select the current level if it's still applicable
                if (applicableLevels.includes(currentLevel)) {
                    levelSelect.value = currentLevel;
                } else if (applicableLevels.includes('G3')) { // Prioritize G3 if available
                    levelSelect.value = 'G3';
                } else if (applicableLevels.length > 0) {
                    levelSelect.value = applicableLevels[0]; // Fallback to the first available level
                } else {
                    levelSelect.value = '';
                }
                populateGradeDropdown(levelSelect.value);
            };


            function populateGradeDropdown(level) {
                gradeSelect.innerHTML = '<option value="">Select Grade</option>';
                let grades = [];
                if (level === 'G3') grades = G3_GRADES_OPTIONS;
                else if (level === 'G2') grades = G2_GRADES_OPTIONS;
                else if (level === 'G1') grades = G1_GRADES_OPTIONS;

                grades.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    gradeSelect.appendChild(option);
                });
                if (grades.length > 0) gradeSelect.value = grades[0];
                gradeSelect.disabled = grades.length === 0;
            }

            const populateRowGradeDropdown = (selectElement, level, selectedGrade) => {
                selectElement.innerHTML = '';
                let grades = [];
                if (level === 'G3') grades = G3_GRADES_OPTIONS;
                else if (level === 'G2') grades = G2_GRADES_OPTIONS;
                else if (level === 'G1') grades = G1_GRADES_OPTIONS;

                grades.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    if (g === selectedGrade) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
                selectElement.disabled = grades.length === 0;
            };


            function renderStudentSubjectsTable() {
                studentSubjectsTableBody.innerHTML = '';
                if (studentSubjects.length === 0) {
                    studentSubjectsTableContainer.classList.add('hidden');
                    return;
                }
                studentSubjectsTableContainer.classList.remove('hidden');

                studentSubjects.forEach((s, index) => {
                    const row = studentSubjectsTableBody.insertRow();
                    row.className = 'hover:bg-slate-700/50 transition-colors';
                    
                    row.insertCell().outerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">${getSubjectById(s.subjectId)?.name || s.subjectId}</td>`;
                    
                    const levelCell = row.insertCell();
                    levelCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                    const levelSelectEl = document.createElement('select');
                    levelSelectEl.className = "w-full px-3 py-2 min-w-[70px] bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                    GRADE_LEVELS.forEach(levelOption => {
                        const option = document.createElement('option');
                        option.value = levelOption;
                        option.textContent = levelOption;
                        if (levelOption === s.level) {
                            option.selected = true;
                        }
                        levelSelectEl.appendChild(option);
                    });
                    levelSelectEl.onchange = (e) => {
                        const newLevel = e.target.value;
                        studentSubjects[index].level = newLevel;

                        let defaultNewGrade = "";
                        // Ensure the default new grade is valid for the new level
                        if (newLevel === 'G3' && G3_GRADES_OPTIONS.length > 0) defaultNewGrade = G3_GRADES_OPTIONS[0];
                        else if (newLevel === 'G2' && G2_GRADES_OPTIONS.length > 0) defaultNewGrade = G2_GRADES_OPTIONS[0];
                        else if (newLevel === 'G1' && G1_GRADES_OPTIONS.length > 0) defaultNewGrade = G1_GRADES_OPTIONS[0];
                        
                        studentSubjects[index].grade = defaultNewGrade;

                        const gradeSelectEl = row.querySelector('.grade-select');
                        populateRowGradeDropdown(gradeSelectEl, newLevel, defaultNewGrade);
                        
                        updateAllCalculationsAndRender();
                    };
                    levelCell.appendChild(levelSelectEl);

                    const gradeCell = row.insertCell();
                    gradeCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                    const gradeSelectEl = document.createElement('select');
                    gradeSelectEl.className = "grade-select w-full px-3 py-2 min-w-[70px] bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                    populateRowGradeDropdown(gradeSelectEl, s.level, s.grade);
                    gradeSelectEl.onchange = (e) => {
                        studentSubjects[index].grade = e.target.value;
                        updateAllCalculationsAndRender();
                    };
                    gradeCell.appendChild(gradeSelectEl);
                    
                    const actionsCell = row.insertCell();
                    actionsCell.className = "px-6 py-4 whitespace-nowrap text-sm font-medium text-right";
                    actionsCell.innerHTML = `
                        <button onclick="handleDeleteSubjectWrapper(${index})" class="text-red-400 hover:text-red-300 transition-colors" aria-label="Delete subject">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm"><path d="M6 7H18V20C18 20.552 17.552 21 17 21H7C6.448 21 6 20.552 6 20V7Z"></path><path d="M19 4H15V3C15 2.448 14.552 2 14 2H10C9.448 2 9 2.448 9 3V4H5V6H19V4Z"></path></svg>
                        </button>
                    `;
                });
            }
            
            function renderEligibilityResults(eligibilityResults) {
                eligibilityResultsContainer.innerHTML = '';
                if (studentSubjects.length === 0) {
                    eligibilityPlaceholder.classList.remove('hidden'); // Show if no subjects
                    eligibilityResultsContainer.innerHTML = '';
                    eligibilityResultsContainer.appendChild(eligibilityPlaceholder);
                    return;
                }
                eligibilityPlaceholder.classList.add('hidden'); // Hide if subjects exist

                const groupedPathways = {
                    "JC/MI": [],
                    "Polytechnic Year 1": [],
                    "PFP": [],
                    "ITE Year 2 Higher Nitec": [],
                    "ITE Year 1 Higher Nitec": [],
                };

                eligibilityResults.forEach(p => {
                    if (groupedPathways[p.group]) {
                        groupedPathways[p.group].push(p);
                    }
                });

                for (const group in groupedPathways) {
                    if (groupedPathways[group].length > 0) {
                        const groupSection = document.createElement('div');
                        groupSection.className = 'col-span-full mb-6';
                        
                        const allNotEligibleInGroup = groupedPathways[group].every(p => !p.isEligible);
                        
                        let groupHeaderHtml = `<h3 class="text-xl font-semibold text-sky-300 mb-4 border-b border-slate-700 pb-2">${group}</h3>`;
                        
                        if (group === "JC/MI") {
                            groupHeaderHtml += `
                                <ul class="list-disc list-inside text-sm text-slate-400 mb-4">
                                    <li><strong>Eligibility</strong>: Gross Aggregate (L1R4) & <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li>
                                    <li><strong>Posting</strong>: <span class="tooltip">Net Aggregate (L1R4)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of L1R4 minus bonus points.</span></span></li>
                                </ul>
                            `;
                        } else if (group === "Polytechnic Year 1") {
                            groupHeaderHtml += `
                                <ul class="list-disc list-inside text-sm text-slate-400 mb-4">
                                    <li><strong>Eligibility</strong>: <span class="tooltip">Net Aggregate (ELR2B2)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of ELR2B2 minus bonus points.</span></span> & <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li>
                                    <li><strong>Posting</strong>: <span class="tooltip">Net Aggregate (ELR2B2)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of ELR2B2 minus bonus points.</span></span></li>
                                </ul>
                            `;
                        } else if (group === "PFP") { // Added PFP specific header text
                            groupHeaderHtml += `
                                <ul class="list-disc list-inside text-sm text-slate-400 mb-4">
                                    <li><strong>Eligibility</strong>: <span class="tooltip">Gross Aggregate (ELMAB3)<sup><small>i</small></sup><span class="tooltiptext">Gross Aggregate is the sum of ELMAB3.</span></span> & <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li>
                                    <li><strong>Posting</strong>: <span class="tooltip">Net Aggregate (ELMAB3)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of ELMAB3 minus bonus points.</span></span></li>
                                </ul>
                            `;
                        } else if (group === "ITE Year 2 Higher Nitec") {
                            groupHeaderHtml += `
                                <ul class="list-disc list-inside text-sm text-slate-400 mb-4">
                                    <li><strong>Eligibility</strong>: Gross Aggregate (ELMAB3) & <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li>
                                    <li><strong>Posting</strong>: <span class="tooltip">Net Aggregate (ELMAB3)<sup><small>i</small></sup><span class="tooltiptext">Net Aggregate is the sum of ELMAB3 minus bonus points.</span></span></li>
                                </ul>
                            `;
                        } else if (group === "ITE Year 1 Higher Nitec") {
                            groupHeaderHtml += `
                                <ul class="list-disc list-inside text-sm text-slate-400 mb-4">
                                    <li><strong>Eligibility</strong>: <span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span></li>
                                    <li><strong>Posting</strong>: <span class="tooltip">Aggregate score<sup><small>i</small></sup><span class="tooltiptext">Aggregate score is the sum of 4 G1 subjects (including Pre-requisite subjects) minus bonus points.</span></span></li>
                                </ul>
                            `;
                        }

                        groupSection.innerHTML = groupHeaderHtml;
                        
                        const cardsContainer = document.createElement('div');
                        cardsContainer.className = 'grid md:grid-cols-2 lg:col-span-3 gap-6';

                        groupedPathways[group].forEach(pathway => {
                            const card = document.createElement('div');
                            const isEligible = pathway.isEligible;
                            card.className = `p-5 rounded-lg shadow-lg border ${isEligible ? 'bg-emerald-800/30 border-emerald-600' : 'bg-red-800/30 border-red-600'} transition-all hover:shadow-xl hover:scale-[1.02]`;
                            
                            let scoreText = '';
                            
                            // Display Scores based on pathway group
                            if (pathway.id === "ite_hnitec_yr1_biz_services_2") { // Specific case for MER (Complete SEC)
                                scoreText = `<p class="text-xs text-slate-400 mb-1">Aggregate score for posting: <strong>${pathway.netScore === Infinity ? 'N/A' : pathway.netScore}</strong></p>`;
                            } else if (pathway.grossScore !== Infinity) {
                                if (pathway.group === "ITE Year 1 Higher Nitec") {
                                     scoreText = `<p class="text-xs text-slate-400 mb-1">Aggregate score for posting: <strong>${pathway.netScore === Infinity ? 'N/A' : pathway.netScore}</strong></p>`;
                                } else {
                                    scoreText = `<p class="text-xs text-slate-400 mb-1">Gross Aggregate: <strong>${pathway.grossScore}</strong></p>`;
                                    scoreText += `<p class="text-xs text-slate-400 mb-1">Net Aggregate: <strong>${pathway.netScore}</strong></p>`;
                                }
                            } else {
                                scoreText = `<p class="text-xs text-slate-400 mb-1">Score: N/A (Missing prerequisite subjects or grades)</p>`;
                            }

                            const requirementsList = pathway.merCheck.merDetails.map(detail => {
                                // For Poly Year 1 MOE CourseFinder link, use red cross icon
                                if (pathway.group === "Polytechnic Year 1" && detail.text.includes("MOE CourseFinder")) {
                                    return `<li class="mb-0.5 text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg> ${detail.text}</li>`;
                                }
                                // For ITE Year 1, render "Check the aggregate point" as a red cross icon
                                if (pathway.group === "ITE Year 1 Higher Nitec" && detail.isPlainBullet) {
                                    return `<li class="mb-0.5 text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg> ${detail.text}</li>`;
                                }
                                const icon = detail.met
                                    ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-emerald-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>`
                                    : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>`;
                                
                                // Specific handling for JC/MI "Check the minimum subject grade requirements for specific streams."
                                if (pathway.group === "JC/MI" && detail.isPlainBullet) {
                                    return `<li class="mb-0.5 text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg> ${detail.text}</li>`;
                                }

                                return `<li class="mb-0.5 text-slate-400">${icon} ${detail.text.replace(/MER/, '<span class="tooltip">MER<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span>')}</li>`;
                            }).join('');

                            const descriptionItemHtml = pathway.description ? `<li class="mt-2 pt-2 text-slate-400 italic">${pathway.description}</li>` : '';

                            let pathwayNameDisplay = pathway.name;
                            if (pathway.tooltipText) { // This covers Poly and the one ITE with specific tooltipText
                                pathwayNameDisplay = `<span class="tooltip">${pathway.name}<sup><small>i</small></sup><span class="tooltiptext">${pathway.tooltipText}</span></span>`;
                            } else if (pathway.group === "ITE Year 1 Higher Nitec" && pathway.id !== "ite_hnitec_yr1_biz_services_2") {
                                // Original tooltip for other ITE Year 1 pathways
                                pathwayNameDisplay = `<span class="tooltip">${pathway.name}<sup><small>i</small></sup><span class="tooltiptext">Pass refers to Grade A-D for G1 Subject or Grade 1-5 for G2 Subject.</span></span>`;
                            }


                            const subjectsUsedHtml = pathway.subjectsUsed && pathway.subjectsUsed.length > 0
                                ? `<h5 class="text-sm font-semibold text-sky-300 mt-3 mb-1">Subjects considered for calculation:</h5><ul class="list-disc list-inside mt-1 pl-2 text-slate-300 space-y-1">${(function() {
                                    let hasTaggedMathScience = false;
                                    let hasTaggedEL = false;
                                    let hasTaggedMath = false; // For specific Math requirement

                                    return pathway.subjectsUsed.map(s => {
                                        const subjectName = getSubjectById(s.subjectId)?.name || s.subjectId;
                                        let mappedGradeInfo = '';
                                        
                                        if (pathway.calcType === 'ELMAB3_G2' && s.level === 'G3' && G3_TO_G2_CONVERSION_MAP[s.grade]) {
                                            mappedGradeInfo = `(G3 ${s.grade} -> G2 ${convertG3toG2(s.grade)})`;
                                        } else if (pathway.calcType === 'ELR2B2_G3_Mixed' && s.role === 'B2' && s.level === 'G3') { // New condition for B2 in Poly Year 1
                                            mappedGradeInfo = `(G3 ${s.grade} -> G2 ${convertG3toG2(s.grade)})`;
                                        } else if (pathway.calcType === 'ITE_Hnitec_Specific' || pathway.calcType === 'ITE_Hnitec_Completed') {
                                            const g1Equiv = getG1Equivalent(s);
                                            if (g1Equiv.g1EquivGrade && g1Equiv.g1EquivGrade !== s.grade) { // Only show if different
                                                mappedGradeInfo = `(${s.level} ${s.grade} -> G1 ${g1Equiv.g1EquivGrade})`;
                                            }
                                        }


                                        let roleDisplay = s.role;
                                        // Add category for B1/B2/B3/B4 in ITE Year 1 pathways, only if it's the main required category
                                        if (pathway.group === "ITE Year 1 Higher Nitec" && (s.role === 'B1' || s.role === 'B2' || s.role === 'B3' || s.role === 'B4')) {
                                            const subjectCategory = getSubjectById(s.subjectId)?.category;
                                            let categoryLabel = '';

                                            // Logic to ensure only ONE subject gets the category tag for ITE Year 1
                                            if (pathway.id === "ite_hnitec_yr1_health_sci_1") { // MER (Pass Math or Science)
                                                if (SUBJECT_CATEGORIES_DEF.MATH_SCIENCE.includes(subjectCategory) && !hasTaggedMathScience) {
                                                    categoryLabel = 'Math or Science';
                                                    hasTaggedMathScience = true;
                                                }
                                            } else if (pathway.id === "ite_hnitec_yr1_health_sci_2") { // MER (Pass EL & Math)
                                                if (SUBJECT_CATEGORIES_DEF.EL.includes(subjectCategory) && !hasTaggedEL) {
                                                    categoryLabel = 'English';
                                                    hasTaggedEL = true;
                                                } else if (SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(subjectCategory) && !hasTaggedMath) {
                                                    categoryLabel = 'Mathematics';
                                                    hasTaggedMath = true;
                                                }
                                            } else if (pathway.id === "ite_hnitec_yr1_biz_services_1") { // MER (Pass EL)
                                                if (SUBJECT_CATEGORIES_DEF.EL.includes(subjectCategory) && !hasTaggedEL) {
                                                    categoryLabel = 'English';
                                                    hasTaggedEL = true;
                                                }
                                            } else if (pathway.id === "ite_hnitec_yr1_engineering_1") { // MER (Pass Math)
                                                if (SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(subjectCategory) && !hasTaggedMath) {
                                                    categoryLabel = 'Mathematics';
                                                    hasTaggedMath = true;
                                                }
                                            }
                                            
                                            if (categoryLabel) {
                                                roleDisplay = `${s.role} (${categoryLabel})`;
                                            }
                                        }
                                        
                                        return `<li><strong>${roleDisplay}</strong>: <strong>${subjectName}</strong> ${s.level} ${s.grade} ${mappedGradeInfo}</li>`;
                                    });
                                })().join('')}</ul>`
                                : `<h5 class="text-sm font-semibold text-sky-300 mt-3 mb-1">Subjects considered for calculation:</h5><p class="text-slate-300 text-sm pl-2">No subjects met the specific criteria for this calculation.</p>`;

                            card.innerHTML = `
                                <h3 class="text-xl font-semibold mb-2 flex items-center">
                                    ${isEligible ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-emerald-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>'}
                                    ${pathwayNameDisplay}
                                </h3>
                                <p class="text-sm mb-1 font-medium ${isEligible ? 'text-emerald-300' : 'text-red-300'}">
                                    Status: ${isEligible ? 'Eligible <span class="tooltip">(subject to MER)<sup><small>i</small></sup><span class="tooltiptext">MER refers to the Minimum Entry Requirements.</span></span>' : 'Not Eligible'}
                                </p>
                                ${scoreText}
                                <details class="text-xs mt-2">
                                    <summary class="cursor-pointer text-sky-400 hover:text-sky-300">Details & Reasons</summary>
                                    <div class="mt-2">
                                        <h5 class="text-sm font-semibold text-sky-300 mb-1">Requirements:</h5>
                                        <ul class="list-disc list-inside mt-1 pl-2 text-slate-300 space-y-1">
                                            ${requirementsList}
                                            ${descriptionItemHtml}
                                        </ul>
                                    </div>
                                    ${subjectsUsedHtml}
                                </details>
                            `;
                            cardsContainer.appendChild(card);
                        });

                        if (allNotEligibleInGroup) {
                            const detailsWrapper = document.createElement('details');
                            detailsWrapper.className = 'col-span-full';
                            detailsWrapper.innerHTML = `
                                <summary class="cursor-pointer text-lg font-semibold text-red-400 hover:text-red-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 inline-block"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>
                                    ${group} - Not Eligible (Click to Expand)
                                </summary>
                            `;
                            detailsWrapper.appendChild(cardsContainer);
                            groupSection.appendChild(detailsWrapper);
                        } else {
                            groupSection.appendChild(cardsContainer);
                        }
                        eligibilityResultsContainer.appendChild(groupSection);
                    }
                }
            }


            // --- Event Handlers ---
            function handleAddOrUpdateSubject() {
                const currentSubjectVal = subjectSelect.value;
                const currentLevelVal = levelSelect.value;
                const currentGradeVal = gradeSelect.value;

                if (!currentSubjectVal || !currentLevelVal || !currentGradeVal) {
                    showMessage("Please select subject, level, and grade.");
                    return;
                }

                const isDuplicate = studentSubjects.some(s => s.subjectId === currentSubjectVal);
                if (isDuplicate) {
                    showMessage("Duplicate Subject", "This subject has already been added. Please edit the existing entry in the table below or choose a different subject.");
                    return;
                }
                studentSubjects.push({ subjectId: currentSubjectVal, level: currentLevelVal, grade: currentGradeVal });
                
                subjectSelect.value = ''; // Reset subject dropdown
                // Reset level dropdown to its default state (e.g., "Select Level" or first available)
                populateLevelDropdown('', ''); // This will reset based on no subject selected
                // Reset grade dropdown accordingly
                populateGradeDropdown(levelSelect.value);


                updateAllCalculationsAndRender();
            }

            window.handleDeleteSubjectWrapper = (index) => {
                // Using a custom message box instead of confirm()
                messageBoxTitle.textContent = "Confirm Deletion";
                messageBoxText.textContent = "Are you sure you want to delete this subject?";
                customMessageBox.classList.remove('hidden');
            
                messageBoxOkButton.onclick = () => {
                    customMessageBox.classList.add('hidden');
                    studentSubjects.splice(index, 1);
                    updateAllCalculationsAndRender();
                    // Reset the OK button's action to default close
                    messageBoxOkButton.onclick = () => customMessageBox.classList.add('hidden'); 
                };
            };
            
            function updateAllCalculationsAndRender() {
                bonusPoints = parseInt(bonusInput.value) || 0;
                if (bonusPoints < 0) bonusPoints = 0;
                if (bonusPoints > 5) bonusPoints = 5;
                bonusInput.value = bonusPoints;

                checkEligibility();
                renderStudentSubjectsTable();
                generateImprovementSuggestions();
            }

            // --- Initial Setup ---
            document.addEventListener('DOMContentLoaded', () => {
                currentYearSpan.textContent = new Date().getFullYear();
                
                // Initial population based on default school
                selectedSchool = schoolSelect.value;
                populateSubjectDropdown();
                populateLevelDropdown(levelSelect.value, subjectSelect.value); // Pass initial subject and school

                // Event listeners for school and subject changes
                schoolSelect.addEventListener('change', (e) => {
                    selectedSchool = e.target.value;
                    populateSubjectDropdown(); // Re-populate subjects based on new school
                    populateLevelDropdown(levelSelect.value, subjectSelect.value); // Re-populate levels based on selected subject and new school
                });
                subjectSelect.addEventListener('change', (e) => {
                    populateLevelDropdown(levelSelect.value, e.target.value); // Re-populate levels based on selected subject
                });
                levelSelect.addEventListener('change', (e) => populateGradeDropdown(e.target.value));
                
                addUpdateSubjectBtn.addEventListener('click', handleAddOrUpdateSubject);
                bonusInput.addEventListener('change', updateAllCalculationsAndRender);
                bonusInput.addEventListener('keyup', (e) => {
                    // Allow numbers, backspace, delete. More robust validation might be needed.
                    if ((e.key >= '0' && e.key <= '9') || e.key === 'Backspace' || e.key === 'Delete' || e.key === 'ArrowLeft' || e.key === 'ArrowRight' || e.key === 'Tab') {
                         // Small delay to ensure input value is updated before recalculating
                        setTimeout(updateAllCalculationsAndRender, 0);
                    }
                });
                
                updateAllCalculationsAndRender(); // Initial call to render everything correctly
            });

        })();
    </script>
</body>
</html>
