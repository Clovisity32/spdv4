<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Pathway Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* For Lucide icons via CDN (alternative to npm) */
        /* We will use inline SVGs or simple text for icons to avoid external dependencies beyond Tailwind if possible */
        .icon-sm { width: 18px; height: 18px; display: inline-block; vertical-align: middle; }
        .icon-md { width: 20px; height: 20px; display: inline-block; vertical-align: middle; }
        .icon-lg { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }

        /* Custom Message Box */
        #customMessageBox {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #customMessageBox.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            height: 24px; /* Fixed height for alignment */
        }
        .bar-label {
            width: 150px; /* Adjust as needed */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
            font-size: 0.875rem; /* text-sm */
            color: #cbd5e1; /* slate-300 */
        }
        .bar {
            height: 100%;
            background-image: linear-gradient(to right, #22d3ee, #10b981);
            border-radius: 0.25rem; /* rounded-sm */
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding-right: 5px;
            color: white;
            font-size: 0.75rem; /* text-xs */
            line-height: 24px; /* Match height */
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content;
            max-width: 250px;
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the element */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            border: 1px solid #334155; /* slate-700 */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-sky-900 min-h-screen text-gray-100">

    <div id="customMessageBox" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-slate-700">
            <h3 id="messageBoxTitle" class="text-lg font-semibold text-cyan-400 mb-3">Notification</h3>
            <p id="messageBoxText" class="text-slate-300 mb-6"></p>
            <button id="messageBoxOkButton" class="w-full p-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg transition duration-150">
                OK
            </button>
        </div>
    </div>

    <div class="p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 via-cyan-400 to-sky-500">
                Student Pathway Dashboard
            </h1>
            <p class="text-sky-300 mt-2 text-lg">
                Explore your post-secondary options based on your subject grades.
            </p>
        </header>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M21 22L17.592 18.592C19.089 16.839 20 14.745 20 12.5C20 7.258 15.742 3 10.5 3S1 7.258 1 12.5C1 17.742 5.258 22 10.5 22C12.745 22 14.839 21.089 16.592 19.592L20 23L21 22ZM10.5 20C6.364 20 3 16.636 3 12.5C3 8.364 6.364 5 10.5 5C14.636 5 18 8.364 18 12.5C18 16.636 14.636 20 10.5 20Z"></path><path d="M11.5 8H9.5V12H11.5V8Z"></path><path d="M11.5 14H9.5V16H11.5V14Z"></path></svg> Enter Your Subjects & Grades
            </h2>
            
            <div class="grid md:grid-cols-5 gap-4 mb-4 items-end">
                <div>
                    <label for="school" class="block text-sm font-medium text-sky-300 mb-1">School</label>
                    <select id="school" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        <option value="Yuhua Secondary School">Yuhua Secondary School</option>
                        <option value="School A">School A</option>
                    </select>
                </div>
                <div>
                    <label for="subject" class="block text-sm font-medium text-sky-300 mb-1">Subject</label>
                    <select id="subject" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        <option value="">Select Subject</option>
                    </select>
                </div>
                <div>
                    <label for="level" class="block text-sm font-medium text-sky-300 mb-1">Level</label>
                    <select id="level" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="grade" class="block text-sm font-medium text-sky-300 mb-1">Grade</label>
                    <select id="grade" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="bonus" class="block text-sm font-medium text-sky-300 mb-1 tooltip">
                        Bonus Points
                        <span class="tooltiptext">Bonus points are awarded for CCA bonus points capped at 2 points for all pathways other than for JC/MI. For JC/MI, maximum bonus points are 5.</span>
                    </label>
                    <input type="number" id="bonus" value="0" min="0" max="5" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100" />
                </div>
                <button id="addUpdateSubjectBtn" class="w-full p-3 bg-gradient-to-r from-emerald-500 to-cyan-600 hover:from-emerald-600 hover:to-cyan-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out flex items-center justify-center text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2"><path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM17 13H13V17H11V13H7V11H11V7H13V11H17V13Z"></path></svg> <span id="addUpdateBtnText">Add Subject</span>
                </button>
            </div>

            <div id="studentSubjectsTableContainer" class="mt-8 hidden">
                <h3 class="text-xl font-semibold mb-3 text-sky-400">Your Subjects:</h3>
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Grade</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-sky-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentSubjectsTableBody" class="bg-slate-800 divide-y divide-slate-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M12 2C17.523 2 22 6.477 22 12C22 17.523 17.523 22 12 22C6.477 22 2 17.523 2 12C2 6.477 6.477 2 12 2ZM12 4C7.582 4 4 7.582 4 12C4 16.418 7.582 20 12 20C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4ZM12 11C11.448 11 11 11.448 11 12C11 12.552 11.448 13 12 13C12.552 13 13 12.552 13 12C13 11.448 12.552 11 12 11ZM12 6C9.791 6 8 7.791 8 10H10C10 8.896 10.896 8 12 8C13.104 8 14 8.896 14 10C14 12 11 11.75 11 15H13C13 12.75 16 12.5 16 10C16 7.791 14.209 6 12 6Z"></path></svg> Pathway Eligibility
            </h2>
            <div id="eligibilityResultsContainer" class="grid md:grid-cols-2 lg:col-span-3 gap-6">
                <div id="eligibilityPlaceholder" class="text-center py-8 text-slate-400 md:col-span-2 lg:col-span-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-sky-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM11 7H13V11H11V7ZM11 13H13V17H11V13Z"></path></svg> <p class="text-xl">Please add subjects to see your eligible pathways.</p>
                </div>
            </div>
        </section>

        <section id="improvementSuggestionsSection" class="p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700 hidden">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M3 17H5V19H3V17ZM7 5H9V19H7V5ZM11 13H13V19H11V13ZM15 9H17V19H15V9ZM19 12H21V19H19V12Z"></path></svg> Improvement Suggestions
            </h2>
            <div id="improvementSuggestionsContainer">
                </div>
            <div id="improvementPlaceholder" class="text-center py-8 text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">Add subjects to see improvement suggestions or you're doing great!</p>
            </div>
        </section>

        <footer class="text-center mt-12 text-sm text-slate-500">
            <p>&copy; <span id="currentYear"></span> Student Pathway Dashboard. For informational purposes only.</p>
            <p>Always verify eligibility criteria with official sources.</p>
            <p class="mt-1">Based on Full SBB Post-Sec Options w.e.f. 2027 S4/5 Cohort (Affecting: 2025 S1 & S2 Full SBB) document.</p>
        </footer>
    </div>

    <script>
        (function() { // Start IIFE
            // --- Constants and Configuration ---
            const G3_GRADES_OPTIONS = ["A1", "A2", "B3", "B4", "C5", "C6", "D7", "E8", "F9"];
            const G2_GRADES_OPTIONS = ["1", "2", "3", "4", "5", "6"];
            const G1_GRADES_OPTIONS = ["A", "B", "C", "D", "E"];
            
            // Numeric mapping for general calculations (lower is better)
            const G3_TO_NUMERIC_RAW = { A1: 1, A2: 2, B3: 3, B4: 4, C5: 5, C6: 6, D7: 7, E8: 8, F9: 9 };
            const G2_TO_NUMERIC_RAW = { "1": 1, "2": 2, "3": 3, "4": 4, "5": 5, "6": 6 };
            // ITE Aggregate Score mapping for G1 grades (lower is better)
            const G1_TO_NUMERIC_RAW_ITE = { A: 1, B: 2, C: 3, D: 4, E: 5 };

            // Grade conversions
            const G3_TO_G2_CONVERSION_MAP = {
                A1: "1", A2: "1", B3: "1",
                B4: "2", C5: "2", C6: "2",
                D7: "3",
                E8: "4",
                F9: "5"
            };
            
            const G3_TO_G1_EQUIV_MAP = {
                A1: "A", A2: "A", B3: "A", B4: "A", C5: "A", C6: "A", D7: "A",
                E8: "B",
                F9: "C"
            };

            const G2_TO_G1_EQUIV_MAP = {
                "1": "A", "2": "A", "3": "A",
                "4": "B",
                "5": "C",
                "6": "D"
            };

            const GRADE_LEVELS = ["G3", "G2", "G1"];

            const ALL_SUBJECTS_LIST = [
                { id: "AM", name: "Additional Mathematics", category: "MATH_PURE" },
                { id: "ART", name: "Art", category: "ART_MUSIC" },
                { id: "BIO", name: "Biology", category: "SCIENCE_PURE" },
                { id: "BIOTECH", name: "Biotechnology", category: "BIOTECH" },
                { id: "BS", name: "Business Studies", category: "BUSINESS_SUBJECTS" },
                { id: "C3DA", name: "Creative 3D Animation", category: "TECH_SUBJECTS" },
                { id: "CHEM", name: "Chemistry", category: "SCIENCE_PURE" },
                { id: "COMB_HUM", name: "Combined Humanities", category: "HUMANITIES_COMBINED" },
                { id: "COMB_SCI", name: "Combined Science", category: "SCIENCE_COMBINED" },
                { id: "COMMERCE", name: "Commerce", category: "BUSINESS_SUBJECTS" },
                { id: "COMP", name: "Computing / Computer Studies", category: "TECH_SUBJECTS" },
                { id: "DT", name: "Design & Technology", category: "TECH_SUBJECTS" },
                { id: "ECON", name: "Economics", category: "BUSINESS_SUBJECTS" },
                { id: "EBS", name: "Elements of Business skills", category: "BUSINESS_SUBJECTS" }, // New subject
                { id: "EL", name: "English Language", category: "EL" },
                { id: "ESS", name: "Exercise & Sports Science", category: "EXERCISE_SPORTS" },
                { id: "FOE", name: "Electronics / Fundamentals of Electronics", category: "TECH_SUBJECTS" },
                { id: "GEOG", name: "Geography", category: "HUMANITIES_PURE" },
                { id: "HA", name: "Higher Art", category: "ART_MUSIC" },
                { id: "HIST", name: "History", category: "HUMANITIES_PURE" },
                { id: "HM", name: "Higher Music", category: "ART_MUSIC" },
                { id: "HMT", name: "Higher Mother Tongue", category: "HMT" }, // Consolidated Higher Mother Tongue
                { id: "IED", name: "Intro to Enterprise Development", category: "BUSINESS_SUBJECTS" },
                { id: "IOT_APP", name: "IoT Applications", category: "TECH_SUBJECTS" },
                { id: "LIT_ENG", name: "Literature in English", category: "HUMANITIES_PURE" },
                { id: "MATH", name: "Elementary Mathematics", category: "MATH_PURE" },
                { id: "MECH_DESIGN_AUTO", name: "Mechanical Design & Automation", category: "TECH_SUBJECTS" },
                { id: "MOB_ROBOTICS", name: "Mobile Robotics", category: "TECH_SUBJECTS" },
                { id: "MOB_WEB_APP", name: "Mobile Web Applications", category: "TECH_SUBJECTS" },
                { id: "MS", name: "Media Studies (English/Chinese)", category: "MEDIA_COMM" },
                { id: "MT", name: "Mother Tongue", category: "MT" }, // Consolidated Mother Tongue
                { id: "MUSIC", name: "Music/Higher Music", category: "ART_MUSIC" }, // Changed name
                { id: "NFS", name: "Nutrition and Food Science", category: "TECH_SUBJECTS" },
                { id: "OTHER", name: "Other Subject", category: "OTHER" },
                { id: "PHY", name: "Physics", category: "SCIENCE_PURE" },
                { id: "POA", name: "Principles of Accounts", category: "BUSINESS_SUBJECTS" },
                { id: "SMART_ELEC_TECH", name: "Smart Electrical Technology", category: "TECH_SUBJECTS" },
            ].sort((a, b) => a.name.localeCompare(b.name)); // Sort subjects alphabetically

            const SUBJECT_CATEGORIES_DEF = {
                EL: ["EL"],
                HMT: ["HMT"], // Category for Higher Mother Tongue subjects
                MT: ["MT"], // Category for regular Mother Tongue subjects
                MT_ALL: ["MT", "HMT"], // Combines all Mother Tongue types for checks that need any MT

                HUMANITIES_PURE: ["HUMANITIES_PURE"],
                HUMANITIES_COMBINED: ["HUMANITIES_COMBINED"],
                HUM: ["HUMANITIES_PURE", "HUMANITIES_COMBINED"], // General Humanities

                MATH_PURE: ["MATH_PURE"],
                SCIENCE_PURE: ["SCIENCE_PURE"],
                SCIENCE_COMBINED: ["SCIENCE_COMBINED"],
                MATH_SCIENCE: ["MATH_PURE", "SCIENCE_PURE", "SCIENCE_COMBINED"], // General Math/Science
                HUM_MATH_SCIENCE: ["HUMANITIES_PURE", "HUMANITIES_COMBINED", "MATH_PURE", "SCIENCE_PURE", "SCIENCE_COMBINED"], // General Hum/Math/Science
                
                // New category for Science in lieu subjects
                SCIENCE_IN_LIEU: ["SCIENCE_PURE", "SCIENCE_COMBINED", "MOB_ROBOTICS", "SMART_ELEC_TECH", "MECH_DESIGN_AUTO", "IOT_APP", "MOB_WEB_APP"],

                TECH_SUBJECTS: ["TECH_SUBJECTS"],
                BUSINESS_SUBJECTS: ["BUSINESS_SUBJECTS"],
                ART_MUSIC: ["ART_MUSIC"],
                MEDIA_COMM: ["MEDIA_COMM"],
                LANGUAGE_ELECTIVES: ["MT", "HMT"], // Language electives can be any MT/HMT
                EXERCISE_SPORTS: ["EXERCISE_SPORTS"],
                BIOTECH: ["BIOTECH"],
                OTHER: ["OTHER"],

                ANY_BEST: [] // Populated dynamically
            };

            SUBJECT_CATEGORIES_DEF.ANY_BEST = ALL_SUBJECTS_LIST.map(s => s.category).filter((value, index, self) => self.indexOf(value) === index);


            const PATHWAYS = [
                { id: "jc", name: "Junior College (JC)", group: "JC/MI", calcType: "L1R4_G3", requirements: { grossL1R4: 16 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: "E8" },{ type: "MT", level: "G3", grade: "D7" },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM_MATH_SCIENCE, R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "Check the minimum subject grade requirements for specific streams." },
                { id: "mi", name: "Millennia Institute (MI)", group: "JC/MI", calcType: "L1R4_G3", requirements: { grossL1R4: 20 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: "E8" },{ type: "MT", level: "G3", grade: "D7" },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM_MATH_SCIENCE, R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "Check the minimum subject grade requirements for specific streams." },

                { id: "poly_yr1_elr2b2_a", name: "Polytechnic Year 1 (ELR2B2-A)", tooltipText: "Humanities, Media & Communications", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: SUBJECT_CATEGORIES_DEF.ART_MUSIC.concat(SUBJECT_CATEGORIES_DEF.BUSINESS_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_COMBINED).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_PURE).concat(SUBJECT_CATEGORIES_DEF.MEDIA_COMM), R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_PURE.concat(SUBJECT_CATEGORIES_DEF.ART_MUSIC).concat(SUBJECT_CATEGORIES_DEF.BUSINESS_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_COMBINED).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_PURE).concat(SUBJECT_CATEGORIES_DEF.MEDIA_COMM).concat(SUBJECT_CATEGORIES_DEF.TECH_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.SCIENCE_COMBINED).concat(SUBJECT_CATEGORIES_DEF.LANGUAGE_ELECTIVES), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },
                { id: "poly_yr1_elr2b2_b", name: "Polytechnic Year 1 (ELR2B2-B)", tooltipText: "Business & Management", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_PURE, R2_cat_ids: SUBJECT_CATEGORIES_DEF.ART_MUSIC.concat(SUBJECT_CATEGORIES_DEF.BUSINESS_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_COMBINED).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_PURE).concat(SUBJECT_CATEGORIES_DEF.MEDIA_COMM), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },
                { id: "poly_yr1_elr2b2_c_general", name: "Polytechnic Year 1 (ELR2B2-C)", tooltipText: "Applied/Health Sc, Engrg, Info & Digital Tech, Built Environment, Nursing", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_PURE, R2_cat_ids: SUBJECT_CATEGORIES_DEF.SCIENCE_PURE.concat(SUBJECT_CATEGORIES_DEF.SCIENCE_COMBINED).concat(SUBJECT_CATEGORIES_DEF.TECH_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.EXERCISE_SPORTS).concat(SUBJECT_CATEGORIES_DEF.BIOTECH), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },
                { id: "poly_yr1_elr2b2_d", name: "Polytechnic Year 1 (ELR2B2-D)", tooltipText: "Design, Built Environment", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_PURE, R2_cat_ids: SUBJECT_CATEGORIES_DEF.ART_MUSIC.concat(SUBJECT_CATEGORIES_DEF.SCIENCE_PURE).concat(SUBJECT_CATEGORIES_DEF.SCIENCE_COMBINED).concat(SUBJECT_CATEGORIES_DEF.TECH_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.MEDIA_COMM).concat(SUBJECT_CATEGORIES_DEF.BIOTECH), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "" },

                { id: "pfp_science_tech", name: "Polytechnic Foundation Programme (PFP) - Science Cluster", group: "PFP", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 12 }, mer: { el_g2: "3", math_am_g2: "3", relevant_subj_g2: "3", relevant_subj_ids: SUBJECT_CATEGORIES_DEF.TECH_SUBJECTS.concat(SUBJECT_CATEGORIES_DEF.SCIENCE_COMBINED), other_two_subj_g2: "4" }, description: "" },
                { id: "pfp_hum_art_biz", name: "Polytechnic Foundation Programme (PFP) - Humanities, Art, Media, Business Cluster", group: "PFP", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 12 }, mer: { el_g2: "3", math_am_g2: "3", relevant_subj_g2: "3", relevant_subj_ids: SUBJECT_CATEGORIES_DEF.ART_MUSIC.concat(SUBJECT_CATEGORIES_DEF.BUSINESS_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_COMBINED).concat(SUBJECT_CATEGORIES_DEF.HUM), other_two_subj_g2: "4" }, description: "" },

                { id: "ite_hnitec_yr2_applied_eng_ict", name: "ITE Year 2 of 3-Yr Higher Nitec - Applied Science, Engineering, Info-Comms Tech", group: "ITE Year 2 Higher Nitec", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 19 }, mer: { el_g2: "4", math_am_g2: "4", any_three_other_subj_g2: "5" }, description: "" },
                { id: "ite_hnitec_yr2_biz_hosp", name: "ITE Year 2 of 3-Yr Higher Nitec - Business & Services, Hospitality", group: "ITE Year 2 Higher Nitec", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 19 }, mer: { el_g2: "3", math_am_g2: "4", any_three_other_subj_g2: "5" }, description: "" },

                // ITE Year 1 Higher Nitec Specific Pathways
                { id: "ite_hnitec_yr1_health_sci_1", name: "MER (Pass Math or Science)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, req_g1g2_other_count: 2, allow_science_in_lieu: true, min_total_subjects: 4 }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_health_sci_2", name: "MER (Pass EL & Math)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.MATH_PURE), req_g1g2_other_count: 1, min_total_subjects: 4 }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_biz_services_1", name: "MER (Pass EL)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.EL, req_g1g2_other_count: 2, min_total_subjects: 4 }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_biz_services_2", name: "MER (Complete SEC)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Completed", requirements: {}, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_engineering_1", name: "MER (Pass Math)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_ONLY", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_PURE, req_g1g2_other_count: 2, min_total_subjects: 4 }, mer: {}, description: "" },
                { id: "ite_hnitec_yr1_hospitality_1", name: "MER (Pass 2G3)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "2_G3_ONLY", req_g3_count: 2, req_g3_grade: 8, min_total_subjects: 4, allow_science_in_lieu: false }, mer: {}, description: "" },


                { id: "fifth_year_sec_pending", name: "Pending Update", group: "5th Year Secondary", calcType: "Pending", requirements: {}, mer: {}, description: "This section is pending update." },
                
                { id: "arts_institutions_pending", name: "Pending Update", group: "Arts & Foundation Programmes", calcType: "Pending", requirements: {}, mer: {}, description: "This section is pending update." },
            ];

            // --- State Variables ---
            let studentSubjects = [];
            let bonusPoints = 0;
            let editingIndex = null; // null for add mode, index for edit mode
            let selectedSchool = "Yuhua Secondary School"; // Default school

            // --- DOM Elements ---
            const schoolSelect = document.getElementById('school'); // New school select
            const subjectSelect = document.getElementById('subject');
            const levelSelect = document.getElementById('level');
            const gradeSelect = document.getElementById('grade');
            const bonusInput = document.getElementById('bonus');
            const addUpdateSubjectBtn = document.getElementById('addUpdateSubjectBtn');
            const addUpdateBtnText = addUpdateSubjectBtn.querySelector('span'); // For changing text
            const addUpdateBtnIcon = addUpdateSubjectBtn.querySelector('svg'); // For changing icon
            const studentSubjectsTableBody = document.getElementById('studentSubjectsTableBody');
            const studentSubjectsTableContainer = document.getElementById('studentSubjectsTableContainer');
            const eligibilityResultsContainer = document.getElementById('eligibilityResultsContainer');
            const eligibilityPlaceholder = document.getElementById('eligibilityPlaceholder');
            const improvementSuggestionsSection = document.getElementById('improvementSuggestionsSection');
            const improvementSuggestionsContainer = document.getElementById('improvementSuggestionsContainer');
            const improvementPlaceholder = document.getElementById('improvementPlaceholder');
            const currentYearSpan = document.getElementById('currentYear');

            const customMessageBox = document.getElementById('customMessageBox');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxOkButton = document.getElementById('messageBoxOkButton');

            // School B specific subject IDs and their level restrictions
            const YUHUA_SECONDARY_SCHOOL_SUBJECT_IDS = [
                "AM", "ART", "BIO", "CHEM", "COMB_HUM", "COMB_SCI", "COMP", "DT", "EBS", "EL", "MATH", "MOB_ROBOTICS", "MUSIC", "NFS", "PHY", "POA", "MT", "HMT"
            ];

            const YUHUA_SECONDARY_SCHOOL_LEVEL_RESTRICTIONS = {
                "AM": ["G3"],
                "BIO": ["G3"],
                "CHEM": ["G3"],
                "MUSIC": ["G3"], // This will cover Music/Higher Music
                "PHY": ["G3"],
                "MOB_ROBOTICS": ["G1"],
                "DT": ["G2", "G3"],
                "NFS": ["G2", "G3"],
                "EBS": ["G1"] // New restriction for Elements of Business skills
            };


            // --- Utility Functions ---
            const getNumericGrade = (grade, level) => {
                if (level === "G3") return G3_TO_NUMERIC_RAW[grade] || Infinity;
                if (level === "G2") return G2_TO_NUMERIC_RAW[grade] || Infinity;
                // For G1, return the ITE Aggregate Score
                if (level === "G1") return G1_TO_NUMERIC_RAW_ITE[grade] || Infinity;
                return Infinity;
            };
            
            const convertG3toG2 = (g3Grade) => G3_TO_G2_CONVERSION_MAP[g3Grade] || "6"; // Default to 6 if not mapped
            const getSubjectById = (id) => ALL_SUBJECTS_LIST.find(s => s.id === id);

            const getStudentSubjectG2Grade = (studentSubject) => {
                if (studentSubject.level === "G2") return studentSubject.grade;
                if (studentSubject.level === "G3") return convertG3toG2(studentSubject.grade);
                return "6"; // If G1 or unknown, return "6" for G2 equivalent (lowest passing grade)
            };

            const getG1Equivalent = (subject) => {
                let g1EquivGrade = null;
                let numericG1EquivGrade = Infinity;

                if (subject.level === "G1") {
                    g1EquivGrade = subject.grade;
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[subject.grade] || Infinity; 
                } else if (subject.level === "G2") {
                    g1EquivGrade = G2_TO_G1_EQUIV_MAP[subject.grade] || "D"; // Default to D if not mapped
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[g1EquivGrade] || Infinity;
                } else if (subject.level === "G3") {
                    g1EquivGrade = G3_TO_G1_EQUIV_MAP[subject.grade] || "C"; // Default to C if not mapped
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[g1EquivGrade] || Infinity;
                }
                return { ...subject, g1EquivGrade, numericG1EquivGrade };
            };

            // New helper function to calculate the best 4 subjects' G1 equivalent score
            const calculateBest4G1Equivalent = (currentStudentSubjects) => {
                const g1EquivalentSubjects = currentStudentSubjects.map(s => getG1Equivalent(s));
                
                // Filter out subjects that are 'U' or couldn't be converted to a valid G1 numeric grade
                const validG1Subjects = g1EquivalentSubjects.filter(s => 
                    s.numericG1EquivGrade !== Infinity && G1_GRADES_OPTIONS.includes(s.g1EquivGrade)
                );

                // Sort subjects by their G1 equivalent numeric grade (lower is better)
                const sortedSubjects = validG1Subjects.sort((a, b) => a.numericG1EquivGrade - b.numericG1EquivGrade);

                // Select the top 4 best-scoring subjects and assign roles
                const best4SubjectsWithRoles = sortedSubjects.slice(0, 4).map((s, index) => ({
                    ...s,
                    role: `B${index + 1}` // Assign roles like B1, B2, B3, B4
                }));

                // Sum their G1 equivalent numeric grades
                const totalScore = best4SubjectsWithRoles.reduce((sum, s) => sum + s.numericG1EquivGrade, 0);

                return { score: totalScore, subjects: best4SubjectsWithRoles };
            };

            const getSubjectGradeForMer = (subjectId, requiredLevel) => {
                const subject = studentSubjects.find(s => s.subjectId === subjectId);
                if (!subject) return Infinity;
                if (requiredLevel === "G3" && subject.level === "G3") return getNumericGrade(subject.grade, "G3");
                if (requiredLevel === "G2") return getNumericGrade(getStudentSubjectG2Grade(subject), "G2");
                if (requiredLevel === "G1") {
                    return getNumericGrade(getG1Equivalent(subject).g1EquivGrade, "G1"); // Use G1_TO_NUMERIC_RAW_ITE
                }
                return Infinity;
            };

            const getSubjectGradeDisplay = (subjectId, grade, level) => {
                const subjectName = getSubjectById(subjectId)?.name || subjectId;
                return `${subjectName}: ${grade} (${level})`;
            };
            
            // --- Calculation Functions ---
            const calculateL1R4 = (currentStudentSubjects, config, currentBonusPoints = 0) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));

                let l1Subj, r1Subj, r2Subj, r3Subj, r4Subj;
                let usedSubjectIds = new Set();
                let subjectsUsedWithRoles = [];

                const findBestSubject = (categoryNamesArray, currentUsedIds, role) => {
                    let bestCandidate = null;
                    for (const subj of g3Subjects) {
                        if (!currentUsedIds.has(subj.subjectId) && categoryNamesArray.includes(subj.category)) {
                            if (!bestCandidate || subj.numericGrade < bestCandidate.numericGrade) {
                                bestCandidate = subj;
                            }
                        }
                    }
                    if (bestCandidate) {
                        currentUsedIds.add(bestCandidate.subjectId);
                        return { ...bestCandidate, role: role };
                    }
                    return null;
                };

                // L1: English or Higher Mother Tongue
                l1Subj = findBestSubject(config.L1, usedSubjectIds, 'L1');
                if (!l1Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing L1 (EL/HMT G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(l1Subj);

                // R1: Best-scoring subject from Humanities
                r1Subj = findBestSubject(config.R1_cat_ids, usedSubjectIds, 'R1');
                if (!r1Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R1 (Humanities G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r1Subj);

                // R2: Best-scoring subject from Mathematics or Science
                r2Subj = findBestSubject(config.R2_cat_ids, usedSubjectIds, 'R2');
                if (!r2Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R2 (Math/Science G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r2Subj);

                // R3: Best-scoring subject from Humanities, Mathematics, or Science
                r3Subj = findBestSubject(config.R3_cat_ids, usedSubjectIds, 'R3');
                if (!r3Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R3 (Hum/Math/Sci G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r3Subj);
                
                // R4: Any best-scoring subject except Religious Knowledge (not in our list, so any best remaining)
                r4Subj = findBestSubject(config.R4_cat_ids, usedSubjectIds, 'R4');
                if (!r4Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R4 (Any other G3, not enough distinct subjects)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r4Subj);

                const grossScore = l1Subj.numericGrade + r1Subj.numericGrade + r2Subj.numericGrade + r3Subj.numericGrade + r4Subj.numericGrade;
                const netScore = grossScore - currentBonusPoints;
                
                return { grossScore, netScore, subjectsUsed: subjectsUsedWithRoles, details: `EL(G3 ${l1Subj.grade}), R1(${getSubjectById(r1Subj.subjectId)?.name} G3 ${r1Subj.grade}), R2(${getSubjectById(r2Subj.subjectId)?.name} G3 ${r2Subj.grade}), R3(${getSubjectById(r3Subj.subjectId)?.name} G3 ${r3Subj.grade}), R4(${getSubjectById(r4Subj.subjectId)?.name} G3 ${r4Subj.grade})`};
            };

            const calculateELMAB3_G2 = (currentStudentSubjects, currentBonusPoints = 0) => {
                const subjectsForCalc = currentStudentSubjects.map(s => ({
                    ...s, g2Grade: getStudentSubjectG2Grade(s), numericG2Grade: getNumericGrade(getStudentSubjectG2Grade(s), "G2"), category: getSubjectById(s.subjectId)?.category
                })).filter(s => G2_GRADES_OPTIONS.includes(s.g2Grade)); // Only include valid G2 equivalent grades

                const el = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId));
                const ma = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(s.category));

                if (!el) return { grossScore: Infinity, netScore: Infinity, details: "Missing English (G2 equiv. pass)", subjectsUsed: [] };
                if (!ma) return { grossScore: Infinity, netScore: Infinity, details: "Missing Maths (G2 equiv. pass)", subjectsUsed: [] };

                const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId && s.subjectId !== ma.subjectId)
                    .sort((a, b) => a.numericG2Grade - b.numericG2Grade);

                if (others.length < 3) return { grossScore: Infinity, netScore: Infinity, details: `Need 3 other subjects (G2 equiv. pass), found ${others.length}`, subjectsUsed: [] };

                const b3 = others.slice(0, 3);
                const grossScore = el.numericG2Grade + ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                const netScore = grossScore - currentBonusPoints;
                
                const subjectsUsedWithRoles = [
                    { ...el, role: 'EL' },
                    { ...ma, role: 'MA' },
                    { ...b3[0], role: 'B1' },
                    { ...b3[1], role: 'B2' },
                    { ...b3[2], role: 'B3' }
                ];

                return { grossScore, netScore, subjectsUsed: subjectsUsedWithRoles, details: `EL(G2 ${el.g2Grade}), MA(G2 ${ma.g2Grade}), B1(${getSubjectById(b3[0].subjectId)?.name} G2 ${b3[0].g2Grade}), B2(${getSubjectById(b3[1].subjectId)?.name} G2 ${b3[1].g2Grade}), B3(${getSubjectById(b3[2].subjectId)?.name} G2 ${b3[2].g2Grade})`};
            };

            const calculateELR2B2_G3_Mixed = (currentStudentSubjects, config, currentBonusPoints = 0) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));
                
                let usedSubjectIds = new Set();
                let scoreSubjects = [];
                let scoreDetailsParts = [];
                let subjectsUsedWithRoles = [];

                // Helper function to find the best available subject from a pool
                function findBestSubjectFromPool(pool, currentUsedIds, categoryIds = SUBJECT_CATEGORIES_DEF.ANY_BEST, role = '') {
                    let bestCandidate = null;
                    for (const subj of pool) {
                        if (!currentUsedIds.has(subj.subjectId) && categoryIds.includes(subj.category)) {
                            if (!bestCandidate || subj.numericGrade < bestCandidate.numericGrade) {
                                bestCandidate = subj;
                            }
                        }
                    }
                    if (bestCandidate) {
                        currentUsedIds.add(bestCandidate.subjectId);
                        return { ...bestCandidate, role: role };
                    }
                    return null;
                }

                // 1. Find EL (English Language) - Must be G3
                const el_g3 = findBestSubjectFromPool(g3Subjects, usedSubjectIds, config.EL, 'EL');
                if (!el_g3) return { grossScore: Infinity, netScore: Infinity, details: "Missing English (G3)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(el_g3);
                scoreDetailsParts.push(`EL(G3 ${el_g3.grade})`);

                // 2. Find R1 (Relevant Subject 1) - Must be G3
                const r1Candidate = findBestSubjectFromPool(g3Subjects, usedSubjectIds, config.R1_cat_ids, 'R1');
                if (!r1Candidate) return { grossScore: Infinity, netScore: Infinity, details: "Missing R1 (Relevant G3 subject)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r1Candidate);
                scoreDetailsParts.push(`R1(${getSubjectById(r1Candidate.subjectId)?.name} G3 ${r1Candidate.grade})`);

                // 3. Find R2 (Relevant Subject 2) - Must be G3
                const r2Candidate = findBestSubjectFromPool(g3Subjects, usedSubjectIds, config.R2_cat_ids, 'R2');
                if (!r2Candidate) return { grossScore: Infinity, netScore: Infinity, details: "Missing R2 (Relevant G3 subject)", subjectsUsed: [] };
                subjectsUsedWithRoles.push(r2Candidate);
                scoreDetailsParts.push(`R2(${getSubjectById(r2Candidate.subjectId)?.name} G3 ${r2Candidate.grade})`);

                // --- B1 and B2 logic: One B subject G3, one B subject G2 equivalent ---
                let b1Subj = null; // Will be the G3 subject for B
                let b2Subj = null; // Will be the G2 equivalent subject for B

                const remainingSubjectsForB = currentStudentSubjects.filter(s => !usedSubjectIds.has(s.subjectId));

                // Pool of native G3 subjects that haven't been used yet
                const nativeG3Remaining = remainingSubjectsForB
                    .filter(s => s.level === 'G3' && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, 'G3') }))
                    .sort((a, b) => a.numericGrade - b.numericGrade);

                // Pool of subjects that can provide a G2 equivalent grade (native G2 or converted G3)
                const g2EquivRemaining = remainingSubjectsForB
                    .map(s => ({
                        ...s,
                        g2Grade: getStudentSubjectG2Grade(s),
                        numericG2Equiv: getNumericGrade(getStudentSubjectG2Grade(s), 'G2')
                    }))
                    .filter(s => G2_GRADES_OPTIONS.includes(s.g2Grade))
                    .sort((a, b) => a.numericG2Equiv - b.numericG2Equiv);

                let candidateB1_G3 = null;
                let candidateB2_G2Equiv = null;

                if (nativeG3Remaining.length > 0) {
                    candidateB1_G3 = nativeG3Remaining[0];
                }

                if (g2EquivRemaining.length > 0) {
                    candidateB2_G2Equiv = g2EquivRemaining[0];
                }

                if (!candidateB1_G3 || !candidateB2_G2Equiv) {
                    return { grossScore: Infinity, netScore: Infinity, details: "Not enough distinct subjects for B1 (G3) and B2 (G2 equivalent).", subjectsUsed: [] };
                }

                // Ensure B1 and B2 are distinct subjects
                if (candidateB1_G3.subjectId === candidateB2_G2Equiv.subjectId) {
                    const nextBestG2Equiv = g2EquivRemaining.find(s => s.subjectId !== candidateB1_G3.subjectId);
                    if (nextBestG2Equiv) {
                        b1Subj = { ...candidateB1_G3, role: 'B1' };
                        b2Subj = { ...nextBestG2Equiv, role: 'B2' };
                    } else {
                        const nextBestG3 = nativeG3Remaining.find(s => s.subjectId !== candidateB2_G2Equiv.subjectId);
                        if (nextBestG3) {
                            b1Subj = { ...nextBestG3, role: 'B1' };
                            b2Subj = { ...candidateB2_G2Equiv, role: 'B2' };
                        } else {
                            return { grossScore: Infinity, netScore: Infinity, details: "Not enough distinct subjects to fulfill B1 (G3) and B2 (G2 equivalent) requirements.", subjectsUsed: [] };
                        }
                    }
                } else {
                    b1Subj = { ...candidateB1_G3, role: 'B1' };
                    b2Subj = { ...candidateB2_G2Equiv, role: 'B2' };
                }

                subjectsUsedWithRoles.push(b1Subj);
                usedSubjectIds.add(b1Subj.subjectId);
                scoreDetailsParts.push(`B1(${getSubjectById(b1Subj.subjectId)?.name} G3 ${b1Subj.grade})`);

                subjectsUsedWithRoles.push(b2Subj);
                usedSubjectIds.add(b2Subj.subjectId);
                scoreDetailsParts.push(`B2(${getSubjectById(b2Subj.subjectId)?.name} ${b2Subj.level} ${b2Subj.grade} (G2 equiv ${b2Subj.g2Grade}))`);

                let grossScore = 0;
                grossScore += el_g3.numericGrade;
                grossScore += r1Candidate.numericGrade;
                grossScore += r2Candidate.numericGrade;
                grossScore += b1Subj.numericGrade; // Use G3 numeric grade for B1
                grossScore += b2Subj.numericG2Equiv; // Use G2 equivalent numeric grade for B2

                const netScore = grossScore - currentBonusPoints;
                
                return { grossScore, netScore, subjectsUsed: subjectsUsedWithRoles, details: scoreDetailsParts.join(", ") };
            };

            const calculate5thYearSecondary = (currentStudentSubjects, currentBonusPoints = 0) => {
                const subjectsForCalc = currentStudentSubjects.map(s => ({
                    ...s, g2Grade: getStudentSubjectG2Grade(s), numericG2Grade: getNumericGrade(getStudentSubjectG2Grade(s), "G2"), category: getSubjectById(s.subjectId)?.category
                })).filter(s => G2_GRADES_OPTIONS.includes(s.g2Grade) && s.numericG2Grade <= 5); // G2 Grade 5 or better

                if (subjectsForCalc.length < 5) {
                    return { grossScore: Infinity, netScore: Infinity, details: "Need at least 5 subjects with G2 Grade 5 or better.", subjectsUsed: [] };
                }

                const el = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId));
                const ma = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(s.category));

                let elmab3Score = Infinity;
                let elb3Score = Infinity;
                let mab3Score = Infinity;
                let details = [];
                let subjectsUsedForBestScore = [];

                if (el && ma) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId && s.subjectId !== ma.subjectId)
                        .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        elmab3Score = el.numericG2Grade + ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`ELMAB3: ${elmab3Score} (EL: ${el.g2Grade}, MA: ${ma.g2Grade}, B1: ${b3[0].g2Grade}, B2: ${b3[1].g2Grade}, B3: ${b3[2].g2Grade})`);
                        // Store subjects for this score for later comparison
                        subjectsUsedForBestScore.push({ score: elmab3Score, subjects: [
                            {...el, role: 'EL'}, {...ma, role: 'MA'}, 
                            {...b3[0], role: 'B1'}, {...b3[1], role: 'B2'}, {...b3[2], role: 'B3'}
                        ] });
                    }
                }

                if (el) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId)
                        .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        elb3Score = el.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`ELB3: ${elb3Score} (EL: ${el.g2Grade}, B1: ${b3[0].g2Grade}, B2: ${b3[1].g2Grade}, B3: ${b3[2].g2Grade})`);
                        subjectsUsedForBestScore.push({ score: elb3Score, subjects: [
                            {...el, role: 'EL'}, 
                            {...b3[0], role: 'B1'}, {...b3[1], role: 'B2'}, {...b3[2], role: 'B3'}
                        ] });
                    }
                }

                if (ma) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== ma.subjectId)
                        .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        mab3Score = ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`MAB3: ${mab3Score} (MA: ${ma.g2Grade}, B1: ${b3[0].g2Grade}, B2: ${b3[1].g2Grade}, B3: ${b3[2].g2Grade})`);
                        subjectsUsedForBestScore.push({ score: mab3Score, subjects: [
                            {...ma, role: 'MA'}, 
                            {...b3[0], role: 'B1'}, {...b3[1], role: 'B2'}, {...b3[2], role: 'B3'}
                        ] });
                    }
                }
                
                const scoreMet = (elmab3Score <= 21) || (elb3Score <= 14) || (mab3Score <= 14);
                const finalScore = Math.min(elmab3Score, elb3Score, mab3Score);

                let actualSubjectsUsed = [];
                if (subjectsUsedForBestScore.length > 0) {
                    subjectsUsedForBestScore.sort((a, b) => a.score - b.score);
                    actualSubjectsUsed = subjectsUsedForBestScore[0].subjects;
                } else {
                    // Fallback: if no specific ELMAB3/ELB3/MAB3 combo is met, just take the best 5 G2-equivalent subjects
                    actualSubjectsUsed = subjectsForCalc.sort((a,b) => a.numericG2Grade - b.numericG2Grade).slice(0, 5).map((s, idx) => ({...s, role: `B${idx+1}`}));
                }


                return { grossScore: finalScore, netScore: finalScore - currentBonusPoints, details: details.join("; "), scoreMet: scoreMet, subjectsUsed: actualSubjectsUsed };
            };

            const calculateArtsInstitutions = (currentStudentSubjects) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level) }));

                const el = g3Subjects.find(s => s.subjectId === "EL");
                if (!el || getNumericGrade(el.grade, "G3") > G3_TO_NUMERIC_RAW["C6"]) {
                    return { grossScore: Infinity, netScore: Infinity, details: "English Language (G3) must be C6 or better.", subjectsUsed: [] };
                }

                const otherG3Subjects = g3Subjects.filter(s => s.subjectId !== "EL")
                    .sort((a, b) => a.numericGrade - b.numericGrade);

                if (otherG3Subjects.length < 4) {
                    return { grossScore: Infinity, netScore: Infinity, details: `Need 4 G3 subjects (excluding EL), found ${otherG3Subjects.length}.`, subjectsUsed: [] };
                }

                const best4Others = otherG3Subjects.slice(0, 4).map((s, index) => ({
                    ...s,
                    role: `B${index + 1}` // Assign roles like B1, B2, B3, B4
                }));
                const totalScore = best4Others.reduce((sum, s) => sum + s.numericGrade, 0);

                return { grossScore: totalScore, netScore: totalScore, subjectsUsed: [{...el, role: 'EL'}, ...best4Others], details: `Best 4 G3 (excl. EL): ${totalScore}` };
            };

            const calculateITEHnitecSpecific = (currentStudentSubjects, requirements, currentBonusPoints = 0) => {
                let metCriteria = true; // Start as true and set to false if any check fails
                let details = []; // This will be an array of strings
                
                // Initialize best4Score and best4Subjects here
                let best4Score = Infinity;
                let best4Subjects = [];

                const g1g2Passes = currentStudentSubjects.filter(s => {
                    const numericGrade = (s.level === "G1") ? getNumericGrade(s.grade, "G1") : getNumericGrade(s.grade, "G2");
                    const isG1Pass = (s.level === "G1" && G1_GRADES_OPTIONS.includes(s.grade) && numericGrade <= 5);
                    const isG2Pass = (s.level === "G2" && G2_GRADES_OPTIONS.includes(s.grade) && numericGrade <= 5);
                    const isG3ConvertedPass = (s.level === "G3" && G3_TO_G1_EQUIV_MAP[s.grade] && G1_TO_NUMERIC_RAW_ITE[G3_TO_G1_EQUIV_MAP[s.grade]] <= 5);
                    return isG1Pass || isG2Pass || isG3ConvertedPass;
                }).map(s => getG1Equivalent(s));

                const totalSubjectsCheck = currentStudentSubjects.length >= requirements.min_total_subjects;
                details.push({ text: `Minimum of ${requirements.min_total_subjects} subjects total (found ${currentStudentSubjects.length})`, met: totalSubjectsCheck });
                if (!totalSubjectsCheck) metCriteria = false;


                if (requirements.type === "3_G1G2_ONLY") {
                    if (requirements.req_g1g2_main_cats.includes(SUBJECT_CATEGORIES_DEF.EL[0]) &&
                        requirements.req_g1g2_main_cats.includes(SUBJECT_CATEGORIES_DEF.MATH_PURE[0])) {
                        // This branch is for EL & Math as main categories (e.g., ITE Year 1 Health Science 2)
                        const elPass = g1g2Passes.find(s => getSubjectById(s.subjectId)?.category === SUBJECT_CATEGORIES_DEF.EL[0]);
                        const mathPass = g1g2Passes.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(getSubjectById(s.subjectId)?.category));

                        const elCheck = !!elPass;
                        details.push({ text: `English (G1/G2 pass)`, met: elCheck });
                        if (!elCheck) metCriteria = false;

                        const mathCheck = !!mathPass;
                        details.push({ text: `Mathematics (G1/G2 pass)`, met: mathCheck });
                        if (!mathCheck) metCriteria = false;
                        
                        if (elPass && mathPass) {
                            const usedSubjectIds = new Set([elPass.subjectId, mathPass.subjectId]);
                            const remainingG1G2Passes = g1g2Passes.filter(s => !usedSubjectIds.has(s.subjectId));
                            const otherCountCheck = remainingG1G2Passes.length >= requirements.req_g1g2_other_count;
                            details.push({ text: `${requirements.req_g1g2_other_count} other G1/G2 pass(es)`, met: otherCountCheck });
                            if (!otherCountCheck) metCriteria = false;
                        } else {
                            metCriteria = false; // If EL or Math missing, this path is not met
                        }

                    } else {
                        // This branch is for single main category (e.g., Math or Science, or EL)
                        const potentialMainSubjects = g1g2Passes.filter(s => {
                            const subjectCategory = getSubjectById(s.subjectId)?.category;
                            const isMainCat = requirements.req_g1g2_main_cats.includes(subjectCategory);
                            const isScienceInLieu = requirements.allow_science_in_lieu && SUBJECT_CATEGORIES_DEF.SCIENCE_IN_LIEU.includes(subjectCategory);
                            return isMainCat || isScienceInLieu;
                        });

                        const mainSubjectCheck = potentialMainSubjects.length > 0;
                        // Change for ITE Year 1 MER
                        const mainSubjectText = requirements.req_g1g2_main_cats.includes(SUBJECT_CATEGORIES_DEF.MATH_SCIENCE[0]) ? "Math or Science (G1/G2 pass)" : "1 G1/G2 pass in required category";
                        details.push({ text: mainSubjectText, met: mainSubjectCheck });
                        if (!mainSubjectCheck) metCriteria = false;

                        if (mainSubjectCheck) {
                            potentialMainSubjects.sort((a, b) => a.numericG1EquivGrade - b.numericG1EquivGrade);
                            const bestMainSubject = potentialMainSubjects[0];
                            const remainingG1G2Passes = g1g2Passes.filter(s => s.subjectId !== bestMainSubject.subjectId);
                            const otherCountCheck = remainingG1G2Passes.length >= requirements.req_g1g2_other_count;
                            details.push({ text: `${requirements.req_g1g2_other_count} other distinct G1/G2 pass(es)`, met: otherCountCheck });
                            if (!otherCountCheck) metCriteria = false;
                        }
                    }
                } else if (requirements.type === "2_G3_ONLY") {
                    const g3Passes = currentStudentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade) && getNumericGrade(s.grade, "G3") <= requirements.req_g3_grade);
                    const g3CountCheck = g3Passes.length >= requirements.req_g3_count;
                    details.push({ text: `${requirements.req_g3_count} G3 passes (1-${requirements.req_g3_grade})`, met: g3CountCheck });
                    if (!g3CountCheck) metCriteria = false;
                }

                // Aggregate score is always calculated, but not always a primary MER requirement for ITE Year 1 specific
                const calculatedBest4 = calculateBest4G1Equivalent(currentStudentSubjects);
                best4Score = calculatedBest4.score;
                best4Subjects = calculatedBest4.subjects;
                // details.push({ text: `Aggregate score: ${best4Score} (Net: ${best4Score - currentBonusPoints})`, met: true }); // Removed as per user request

                // Final check for overall criteria
                const allSpecificChecksMet = details.every(d => d.met);
                metCriteria = metCriteria && allSpecificChecksMet;

                return {
                    grossScore: best4Score,
                    netScore: best4Score - currentBonusPoints,
                    details: details, // Return as array of objects
                    scoreMet: metCriteria,
                    subjectsUsed: best4Subjects,
                };
            };

            const calculateITEHnitecCompleted = (currentStudentSubjects, currentBonusPoints = 0) => {
                let metCriteria = false;
                let details = []; // This will be an array of objects

                // Initialize best4Score and best4Subjects here as well
                let best4Score = Infinity;
                let best4Subjects = [];

                const hasAnyValidGrade = currentStudentSubjects.some(s => {
                    if (s.level === "G3") return G3_GRADES_OPTIONS.includes(s.grade);
                    if (s.level === "G2") return G2_GRADES_OPTIONS.includes(s.grade);
                    if (s.level === "G1") return G1_GRADES_OPTIONS.includes(s.grade);
                    return false;
                });

                if (hasAnyValidGrade) {
                    metCriteria = true;
                    details.push({ text: "Completed Singapore-Cambridge Secondary Education Certificate.", met: true });
                } else {
                    metCriteria = false;
                    details.push({ text: "Requires completion of Singapore-Cambridge Secondary Education Certificate.", met: false });
                }

                // Do not include aggregate score in details for "Complete SEC"
                const calculatedBest4 = calculateBest4G1Equivalent(currentStudentSubjects);
                best4Score = calculatedBest4.score;
                best4Subjects = calculatedBest4.subjects;
                // details.push({ text: `Aggregate score: ${best4Score} (Net: ${best4Score - currentBonusPoints})`, met: true }); // Removed as per user request

                return {
                    grossScore: best4Score,
                    netScore: best4Score - currentBonusPoints,
                    details: details, // Return as array of objects
                    scoreMet: metCriteria,
                    subjectsUsed: best4Subjects,
                };
            };


            const checkMerRequirements = (pathway, studentSubjectsMap, bonusPoints) => {
                let merDetails = [];
                let overallMerMet = true; // Track overall MER status

                // Add aggregate score check for relevant pathways
                if (pathway.calcType === "L1R4_G3") {
                    const scoreCheck = pathway.grossScore <= pathway.requirements.grossL1R4;
                    merDetails.push({
                        text: `L1R4 (G3 subjects)  ${pathway.requirements.grossL1R4} (Your Gross: ${pathway.grossScore})`,
                        met: scoreCheck
                    });
                    if (!scoreCheck) overallMerMet = false;
                } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                    const scoreCheck = pathway.netScore <= pathway.requirements.netELR2B2;
                    merDetails.push({
                        text: `ELR2B2 (Net)  ${pathway.requirements.netELR2B2} (Your Net: ${pathway.netScore})`,
                        met: scoreCheck
                    });
                    if (!scoreCheck) overallMerMet = false;

                    // Specific ELR2B2 breakdown
                    const el = studentSubjectsMap.get("EL");
                    const elCheck = el && el.level === "G3" && getNumericGrade(el.grade, "G3") <= G3_TO_NUMERIC_RAW["C6"]; // English G3 C6 or better
                    merDetails.push({ text: `English (G3): ${el?.grade || 'N/A'} (Required G3  C6)`, met: elCheck });
                    if (!elCheck) overallMerMet = false;

                    const g3Subjects = studentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade))
                        .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));

                    // Split R1 and R2 checks
                    const r1HasOne = g3Subjects.some(s => pathway.elr2b2_config.R1_cat_ids.includes(s.category));
                    merDetails.push({ text: `1 Relevant subject (G3) (R1 Category)`, met: r1HasOne });
                    if (!r1HasOne) overallMerMet = false;

                    const r2HasOne = g3Subjects.some(s => pathway.elr2b2_config.R2_cat_ids.includes(s.category));
                    merDetails.push({ text: `1 Relevant subject (G3) (R2 Category)`, met: r2HasOne });
                    if (!r2HasOne) overallMerMet = false;
                    
                    // To check for distinct B1 (G3) and B2 (G2 equivalent), we need to re-run part of ELR2B2 calc
                    const remainingSubjectsForB = studentSubjects.filter(s => s.subjectId !== el?.subjectId);
                    const nativeG3Remaining = remainingSubjectsForB
                        .filter(s => s.level === 'G3' && G3_GRADES_OPTIONS.includes(s.grade));
                    const g2EquivRemaining = remainingSubjectsForB
                        .map(s => ({
                            ...s,
                            g2Grade: getStudentSubjectG2Grade(s),
                            numericG2Equiv: getNumericGrade(getStudentSubjectG2Grade(s), 'G2')
                        }))
                        .filter(s => G2_GRADES_OPTIONS.includes(s.g2Grade));
                    
                    let b1Met = false;
                    let b2Met = false;
                    
                    if (nativeG3Remaining.length > 0) {
                        b1Met = true;
                    }
                    merDetails.push({ text: `One B subject (G3)`, met: b1Met });
                    if (!b1Met) overallMerMet = false;

                    if (g2EquivRemaining.length > 0) {
                        b2Met = true;
                    }
                    merDetails.push({ text: `One B subject (G2 equivalent)`, met: b2Met });
                    if (!b2Met) overallMerMet = false;

                    // Add MOE CourseFinder link here for Poly Year 1 pathways
                    merDetails.push({ text: `Please confirm course-specific minimum entry requirements using <a href="https://www.moe.gov.sg/coursefinder" target="_blank" class="text-cyan-400 hover:underline">MOE CourseFinder</a>.`, met: true });

                } else if (pathway.calcType === "ELMAB3_G2") {
                    const scoreCheck = pathway.grossScore <= pathway.requirements.grossELMAB3;
                    merDetails.push({
                        text: `ELMAB3 (Gross)  ${pathway.requirements.grossELMAB3} (Your Gross: ${pathway.grossScore})`,
                        met: scoreCheck
                    });
                    if (!scoreCheck) overallMerMet = false;
                }

                // Common MER for JC/MI
                if (pathway.group === "JC/MI") {
                    const el = studentSubjectsMap.get("EL");
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");
                    let mtOptionMet = false;
                    let mtMetDetail = null;

                    // Check English
                    const elCheck = el && getNumericGrade(el.grade, "G3") <= pathway.mer.el_g3;
                    merDetails.push({ text: `English: ${el ? getSubjectGradeDisplay(el.subjectId, el.grade, el.level) : 'N/A'} (Required G3  ${G3_GRADES_OPTIONS[pathway.mer.el_g3 - 1]})`, met: elCheck });
                    if (!elCheck) overallMerMet = false;

                    // Check Math/Add Math
                    let mathGrade = getSubjectGradeForMer("MATH", "G3");
                    let amGrade = getSubjectGradeForMer("AM", "G3");
                    let effectiveMathGrade = Math.min(mathGrade, amGrade);
                    let mathDisplay = (effectiveMathGrade === mathGrade && math) ? getSubjectGradeDisplay("MATH", math.grade, "G3") : ((effectiveMathGrade === amGrade && am) ? getSubjectGradeDisplay("AM", am.grade, "G3") : 'N/A');
                    const mathCheck = effectiveMathGrade <= pathway.mer.math_am_g3;
                    merDetails.push({ text: `Math/Add Math: ${mathDisplay} (Required G3  ${G3_GRADES_OPTIONS[pathway.mer.math_am_g3 - 1]})`, met: mathCheck });
                    if (!mathCheck) overallMerMet = false;

                    // Check Mother Tongue options
                    for (const option of pathway.mer.mt_options) {
                        const mtSubjCandidate = studentSubjects.find(s => {
                            const subjectInfo = getSubjectById(s.subjectId);
                            return subjectInfo && subjectInfo.category === option.type;
                        });

                        if (mtSubjCandidate) {
                            let gradeToCompare = null;
                            let numericOptionGrade;

                            if (option.level === "G3") {
                                numericOptionGrade = getNumericGrade(option.grade, "G3");
                            } else if (option.level === "G2") {
                                numericOptionGrade = getNumericGrade(option.grade, "G2");
                            } else if (option.level === "G1") {
                                numericOptionGrade = getNumericGrade(option.grade, "G1");
                            }

                            if (mtSubjCandidate.level === option.level) {
                                if (option.level === "G3") {
                                    gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G3");
                                } else if (option.level === "G2") {
                                    gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G2");
                                } else if (option.level === "G1") {
                                    gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G1");
                                }
                            }
                            
                            if (gradeToCompare !== null && gradeToCompare <= numericOptionGrade) {
                                mtOptionMet = true;
                                mtMetDetail = { text: `${getSubjectById(mtSubjCandidate.subjectId)?.name} (${mtSubjCandidate.level} ${mtSubjCandidate.grade}) (Met ${option.level} ${option.grade} requirement)`, met: true };
                                break;
                            }
                        }
                    }
                    // Filter out "Mother Tongue: One option met." if a specific MT option is met
                    if (mtOptionMet) {
                        merDetails.push(mtMetDetail);
                    } else {
                        overallMerMet = false;
                        // Only add "No option met" if no MT option was met at all
                        merDetails.push({ text: `Mother Tongue: No option met.`, met: false });
                    }
                }
                
                // MER for PFP pathways
                if (pathway.group === "PFP") {
                    const el = studentSubjectsMap.get("EL");
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");

                    const elCheck = el && getNumericGrade(getStudentSubjectG2Grade(el), "G2") <= getNumericGrade(pathway.mer.el_g2, "G2");
                    merDetails.push({ text: `English (G2 equiv): ${el ? getStudentSubjectG2Grade(el) : 'N/A'} (Required G2  ${pathway.mer.el_g2})`, met: elCheck });
                    if (!elCheck) overallMerMet = false;

                    let mathGrade = getSubjectGradeForMer("MATH", "G2");
                    let amGrade = getSubjectGradeForMer("AM", "G2");
                    let effectiveMathGrade = Math.min(mathGrade, amGrade);
                    let mathDisplay = (effectiveMathGrade === mathGrade && math) ? getStudentSubjectG2Grade(math) : ((effectiveMathGrade === amGrade && am) ? getStudentSubjectG2Grade(am) : 'N/A');
                    const mathCheck = effectiveMathGrade <= getNumericGrade(pathway.mer.math_am_g2, "G2");
                    merDetails.push({ text: `Math/Add Math (G2 equiv): ${mathDisplay} (Required G2  ${pathway.mer.math_am_g2})`, met: mathCheck });
                    if (!mathCheck) overallMerMet = false;

                    const eligibleOtherSubjectsCount = studentSubjects.filter(subj =>
                        subj.subjectId !== (el?.subjectId || '') && 
                        subj.subjectId !== (math?.subjectId || '') && 
                        subj.subjectId !== (am?.subjectId || '') && 
                        G2_GRADES_OPTIONS.includes(getStudentSubjectG2Grade(subj)) &&
                        getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(pathway.mer.other_two_subj_g2, "G2")
                    ).length;
                    const otherTwoSubjCheck = eligibleOtherSubjectsCount >= 2;
                    merDetails.push({ text: `2 other subjects (G2 equiv): Need 2, found ${eligibleOtherSubjectsCount} at G2  ${pathway.mer.other_two_subj_g2}`, met: otherTwoSubjCheck });
                    if (!otherTwoSubjCheck) overallMerMet = false;
                }

                // MER for ITE Higher Nitec (Direct Yr 2 Entry) pathways
                if (pathway.group === "ITE Year 2 Higher Nitec") {
                    const el = studentSubjectsMap.get("EL");
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");

                    const elCheck = el && getNumericGrade(getStudentSubjectG2Grade(el), "G2") <= getNumericGrade(pathway.mer.el_g2, "G2");
                    merDetails.push({ text: `English (G2 equiv): ${el ? getStudentSubjectG2Grade(el) : 'N/A'} (Required G2  ${pathway.mer.el_g2})`, met: elCheck });
                    if (!elCheck) overallMerMet = false;

                    let mathGrade = getSubjectGradeForMer("MATH", "G2");
                    let amGrade = getSubjectGradeForMer("AM", "G2");
                    let effectiveMathGrade = Math.min(mathGrade, amGrade);
                    let mathDisplay = (effectiveMathGrade === mathGrade && math) ? getStudentSubjectG2Grade(math) : ((effectiveMathGrade === amGrade && am) ? getStudentSubjectG2Grade(am) : 'N/A');
                    const mathCheck = effectiveMathGrade <= getNumericGrade(pathway.mer.math_am_g2, "G2");
                    merDetails.push({ text: `Math/Add Math (G2 equiv): ${mathDisplay} (Required G2  ${pathway.mer.math_am_g2})`, met: mathCheck });
                    if (!mathCheck) overallMerMet = false;

                    const otherSubjectsCount = studentSubjects.filter(subj =>
                        subj.subjectId !== (el?.subjectId || '') && 
                        subj.subjectId !== (math?.subjectId || '') && 
                        subj.subjectId !== (am?.subjectId || '') && 
                        G2_GRADES_OPTIONS.includes(getStudentSubjectG2Grade(subj)) &&
                        getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(pathway.mer.any_three_other_subj_g2, "G2")
                    ).length;
                    const otherThreeSubjCheck = otherSubjectsCount >= 3;
                    merDetails.push({ text: `3 other subjects (G2 equiv): Need 3, found ${otherSubjectsCount} at G2  ${pathway.mer.any_three_other_subj_g2}`, met: otherThreeSubjCheck });
                    if (!otherThreeSubjCheck) overallMerMet = false;
                }

                // MER for 5th Year Secondary (Subgroup 1)
                if (pathway.id === "fifth_year_sec_subgroup1") {
                    const allSubjectsG2Pass = studentSubjects.every(s => {
                        const g2EquivGrade = getStudentSubjectG2Grade(s);
                        return G2_GRADES_OPTIONS.includes(g2EquivGrade) && getNumericGrade(g2EquivGrade, "G2") <= getNumericGrade(pathway.mer.all_subjects_g2, "G2");
                    });
                    merDetails.push({ text: `All subjects used (G2 equiv): Grade  ${pathway.mer.all_subjects_g2}`, met: allSubjectsG2Pass });
                    if (!allSubjectsG2Pass) overallMerMet = false;
                }

                // MER for Arts Institutions
                if (pathway.id === "arts_institutions") {
                    const el = studentSubjectsMap.get("EL");
                    const elCheck = el && G3_GRADES_OPTIONS.includes(el.grade) && getNumericGrade(el.grade, "G3") <= pathway.mer.el_g3;
                    merDetails.push({ text: `English Language (G3): ${el?.grade || 'N/A'} (Required G3  ${G3_GRADES_OPTIONS[pathway.mer.el_g3 - 1]})`, met: elCheck });
                    if (!elCheck) overallMerMet = false;
                    merDetails.push({ text: "Other requirements: Portfolio/Admissions Test/Personal Statement/Audition (not assessed here)", met: true }); // Always true as not assessed
                }

                // MER for ITE Higher Nitec (Year 1 Entry) - Specific pathways will call their own calc functions
                if (pathway.calcType === "ITE_Hnitec_Specific") {
                    const { scoreMet: iteSpecificMet, details: iteSpecificDetails, grossScore: iteGrossScore, netScore: iteNetScore, subjectsUsed: iteSubjectsUsed } = calculateITEHnitecSpecific(studentSubjects, pathway.requirements, bonusPoints);
                    pathway.grossScore = iteGrossScore;
                    pathway.netScore = iteNetScore;
                    pathway.subjectsUsed = iteSubjectsUsed;
                    // iteSpecificDetails is now an array of objects
                    iteSpecificDetails.forEach(detail => {
                        // Filter out aggregate score if it's for MER (Complete SEC)
                        if (!(pathway.id === "ite_hnitec_yr1_biz_services_2" && detail.text.includes("Aggregate score"))) {
                            merDetails.push(detail);
                        }
                    });
                    // Add the new "Check aggregate point" line as the last point, with a flag for special rendering
                    merDetails.push({ text: "Check the aggregate point for specific course.", met: true, isPlainBullet: true });
                    if (!iteSpecificMet) overallMerMet = false;
                } else if (pathway.calcType === "ITE_Hnitec_Completed") {
                    const { scoreMet: iteCompletedMet, details: iteCompletedDetails, grossScore: iteGrossScore, netScore: iteNetScore, subjectsUsed: iteSubjectsUsed } = calculateITEHnitecCompleted(studentSubjects, bonusPoints);
                    pathway.grossScore = iteGrossScore;
                    pathway.netScore = iteNetScore;
                    pathway.subjectsUsed = iteSubjectsUsed;
                    // iteCompletedDetails is now an array of objects
                    iteCompletedDetails.forEach(detail => {
                        // Filter out aggregate score for "Complete SEC"
                        if (!detail.text.includes("Aggregate score")) {
                            merDetails.push(detail);
                        }
                    });
                    // Add the new "Check aggregate point" line as the last point, with a flag for special rendering
                    merDetails.push({ text: "Check the aggregate point for specific course.", met: true, isPlainBullet: true });
                    if (!iteCompletedMet) overallMerMet = false;
                }

                // Remove duplicate "L1R4 (G3 subjects) <= 16" and "Mother Tongue: One option met."
                const uniqueMerDetails = [];
                const seenTexts = new Set();
                merDetails.forEach(detail => {
                    // For JC/MI, specifically handle the Mother Tongue display
                    if ((pathway.group === "JC/MI" || pathway.group === "Polytechnic Year 1") && detail.text.includes("Mother Tongue (G3 A1)")) {
                        // If a specific MT option is met, ensure only that one is shown and not the generic "One option met"
                        if (!seenTexts.has("Mother Tongue (G3 A1) (Met G3 D7 requirement)")) {
                            uniqueMerDetails.push(detail);
                            seenTexts.add("Mother Tongue (G3 A1) (Met G3 D7 requirement)");
                        }
                    } else if (detail.text.includes("Mother Tongue: One option met.")) {
                        // Skip the generic "One option met" if a specific one was already added
                        if (!seenTexts.has("Mother Tongue (G3 A1) (Met G3 D7 requirement)")) {
                             uniqueMerDetails.push(detail);
                             seenTexts.add(detail.text);
                        }
                    } else if (!seenTexts.has(detail.text)) {
                        uniqueMerDetails.push(detail);
                        seenTexts.add(detail.text);
                    }
                });


                return { merMet: overallMerMet, merDetails: uniqueMerDetails };
            };

            const checkEligibility = () => {
                if (studentSubjects.length < 1) {
                    renderEligibilityResults(PATHWAYS.map(p => ({
                        ...p,
                        grossScore: Infinity,
                        netScore: Infinity,
                        scoreDetails: "Add subjects to see eligibility.",
                        scoreMet: false,
                        merCheck: { merMet: false, merDetails: [{ text: "Add at least one subject to see eligibility for some pathways.", met: false }] },
                        subjectsUsed: []
                    })));
                    return;
                }

                const allPathwaysStatus = [];
                const studentSubjectsMap = new Map(studentSubjects.map(s => [s.subjectId, s]));

                let qualifiesForJCMIPoly = false;
                const jcMiPolyPathways = PATHWAYS.filter(p => p.group === "JC/MI" || p.group === "Polytechnic Year 1");

                jcMiPolyPathways.forEach(pathwa => { // Corrected pathwa to pathway
                    let result = { grossScore: Infinity, netScore: Infinity, details: "N/A", subjectsUsed: [] };
                    let scoreMet = false;

                    if (pathwa.calcType === "L1R4_G3") {
                        result = calculateL1R4(studentSubjects, pathwa.l1r4_config, bonusPoints);
                        scoreMet = result.grossScore <= pathwa.requirements.grossL1R4;
                    } else if (pathwa.calcType === "ELR2B2_G3_Mixed") {
                        result = calculateELR2B2_G3_Mixed(studentSubjects, pathwa.elr2b2_config, bonusPoints);
                        scoreMet = result.netScore <= pathwa.requirements.netELR2B2;
                    }
                    // Temporarily assign scores to pathway object for MER check
                    pathwa.grossScore = result.grossScore;
                    pathwa.netScore = result.netScore;

                    const merCheck = checkMerRequirements(pathwa, studentSubjectsMap, bonusPoints);
                    if (scoreMet && merCheck.merMet) {
                        qualifiesForJCMIPoly = true;
                    }
                });


                PATHWAYS.forEach(pathway => {
                    let result = { grossScore: Infinity, netScore: Infinity, details: "N/A", subjectsUsed: [] };
                    let scoreMet = false;
                    let merCheck = { merMet: true, merDetails: [] };

                    if (pathway.id === "fifth_year_sec_subgroup2") {
                        const g3Count = studentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade)).length;
                        const hasThreeOrMoreG3 = g3Count >= 3;
                        scoreMet = hasThreeOrMoreG3 && !qualifiesForJCMIPoly;
                        merCheck.merDetails.push({ text: `Has ${g3Count} G3 passes. (Required 3 or more G3 passes)`, met: hasThreeOrMoreG3 });
                        merCheck.merDetails.push({ text: qualifiesForJCMIPoly ? "Qualifies for JC/MI/Poly Year 1 (Not Eligible for this option)" : "Does NOT qualify for JC/MI/Poly Year 1 (Eligible for this option)", met: !qualifiesForJCMIPoly });
                        if (!hasThreeOrMoreG3 || qualifiesForJCMIPoly) merMet = false;
                    } else {
                        if (pathway.calcType === "L1R4_G3") {
                            result = calculateL1R4(studentSubjects, pathway.l1r4_config, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossL1R4;
                        } else if (pathway.calcType === "ELMAB3_G2") {
                            result = calculateELMAB3_G2(studentSubjects, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossELMAB3;
                        } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                            result = calculateELR2B2_G3_Mixed(studentSubjects, pathway.elr2b2_config, bonusPoints);
                            scoreMet = result.netScore <= pathway.requirements.netELR2B2;
                        } else if (pathway.calcType === "5th_Year_Sec_G2") {
                            const fifthYearResult = calculate5thYearSecondary(studentSubjects, bonusPoints);
                            result = fifthYearResult;
                            const g3Count = studentSubjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade)).length;
                            const hasTwoOrFewerG3 = g3Count <= 2;
                            scoreMet = fifthYearResult.scoreMet && hasTwoOrFewerG3;
                            merCheck.merDetails.push({ text: `G3 Passes: ${g3Count} (Required 2 or fewer for Option 1)`, met: hasTwoOrFewerG3 });
                        } else if (pathway.calcType === "Arts_Institutions_G3") {
                            result = calculateArtsInstitutions(studentSubjects);
                            scoreMet = result.grossScore !== Infinity;
                        } else if (pathway.calcType === "ITE_Hnitec_Specific") {
                            result = calculateITEHnitecSpecific(studentSubjects, pathway.requirements, bonusPoints);
                            scoreMet = result.scoreMet;
                        } else if (pathway.calcType === "ITE_Hnitec_Completed") {
                            result = calculateITEHnitecCompleted(studentSubjects, bonusPoints);
                            scoreMet = result.scoreMet;
                        } else if (pathway.calcType === "Pending") {
                            scoreMet = false;
                            merCheck.merMet = false;
                            merCheck.merDetails.push({ text: "This section is pending update and no pathways are currently available for eligibility check.", met: false });
                        }
                        // Assign scores to pathway object for MER check
                        pathway.grossScore = result.grossScore;
                        pathway.netScore = result.netScore;
                        merCheck = checkMerRequirements(pathway, studentSubjectsMap, bonusPoints);
                    }

                    allPathwaysStatus.push({
                        ...pathway,
                        grossScore: result.grossScore,
                        netScore: result.netScore,
                        scoreDetails: result.details,
                        merCheck: merCheck,
                        isEligible: scoreMet && merCheck.merMet,
                        subjectsUsed: result.subjectsUsed,
                    });
                });
                renderEligibilityResults(allPathwaysStatus);
            };
            
            // --- Rendering Functions ---
            function showMessage(message, title = "Notification") {
                messageBoxTitle.textContent = title;
                messageBoxText.textContent = message;
                customMessageBox.classList.remove('hidden');
            }
            
            messageBoxOkButton.addEventListener('click', () => {
                customMessageBox.classList.add('hidden');
            });


            function populateSubjectDropdown() {
                subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                let subjectsToDisplay = ALL_SUBJECTS_LIST;

                if (selectedSchool === "Yuhua Secondary School") {
                    subjectsToDisplay = ALL_SUBJECTS_LIST.filter(s => YUHUA_SECONDARY_SCHOOL_SUBJECT_IDS.includes(s.id));
                }
                // Subjects are already sorted alphabetically
                subjectsToDisplay.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    subjectSelect.appendChild(option);
                });
                // Reset level and grade dropdowns when subject list changes
                populateLevelDropdown(levelSelect.value, subjectSelect.value);
            }

            function populateLevelDropdown(currentLevel, selectedSubjectId) {
                levelSelect.innerHTML = '';
                let levelsToShow = GRADE_LEVELS; // Default to all levels

                if (selectedSchool === "Yuhua Secondary School" && selectedSubjectId && YUHUA_SECONDARY_SCHOOL_LEVEL_RESTRICTIONS[selectedSubjectId]) {
                    levelsToShow = YUHUA_SECONDARY_SCHOOL_LEVEL_RESTRICTIONS[selectedSubjectId];
                }

                levelsToShow.forEach(l => {
                    const option = document.createElement('option');
                    option.value = l;
                    option.textContent = l;
                    levelSelect.appendChild(option);
                });

                // Try to keep the current level if it's still available, otherwise select the first available level
                if (levelsToShow.includes(currentLevel)) {
                    levelSelect.value = currentLevel;
                } else if (levelsToShow.length > 0) {
                    levelSelect.value = levelsToShow[0];
                } else {
                    levelSelect.value = ''; // No levels available
                }
                
                // Also update the grade dropdown based on the new level
                populateGradeDropdown(levelSelect.value);
                levelSelect.disabled = levelsToShow.length === 0;
            }

            function populateGradeDropdown(level) {
                gradeSelect.innerHTML = '<option value="">Select Grade</option>';
                let grades = [];
                if (level === 'G3') grades = G3_GRADES_OPTIONS;
                else if (level === 'G2') grades = G2_GRADES_OPTIONS;
                else if (level === 'G1') grades = G1_GRADES_OPTIONS;

                grades.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    gradeSelect.appendChild(option);
                });
                if (grades.length > 0) gradeSelect.value = grades[0];
                gradeSelect.disabled = grades.length === 0;
            }

            const populateRowGradeDropdown = (selectElement, level, selectedGrade) => {
                selectElement.innerHTML = '';
                let grades = [];
                if (level === 'G3') grades = G3_GRADES_OPTIONS;
                else if (level === 'G2') grades = G2_GRADES_OPTIONS;
                else if (level === 'G1') grades = G1_GRADES_OPTIONS;

                grades.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    if (g === selectedGrade) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
                selectElement.disabled = grades.length === 0;
            };


            function renderStudentSubjectsTable() {
                studentSubjectsTableBody.innerHTML = '';
                if (studentSubjects.length === 0) {
                    studentSubjectsTableContainer.classList.add('hidden');
                    return;
                }
                studentSubjectsTableContainer.classList.remove('hidden');

                studentSubjects.forEach((s, index) => {
                    const row = studentSubjectsTableBody.insertRow();
                    row.className = 'hover:bg-slate-700/50 transition-colors';
                    
                    row.insertCell().outerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">${getSubjectById(s.subjectId)?.name || s.subjectId}</td>`;
                    
                    const levelCell = row.insertCell();
                    levelCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                    const levelSelectEl = document.createElement('select');
                    levelSelectEl.className = "w-full px-3 py-2 min-w-[70px] bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                    GRADE_LEVELS.forEach(levelOption => {
                        const option = document.createElement('option');
                        option.value = levelOption;
                        option.textContent = levelOption;
                        if (levelOption === s.level) {
                            option.selected = true;
                        }
                        levelSelectEl.appendChild(option);
                    });
                    levelSelectEl.onchange = (e) => {
                        const newLevel = e.target.value;
                        studentSubjects[index].level = newLevel;

                        let defaultNewGrade = "";
                        // Ensure the default new grade is valid for the new level
                        if (newLevel === 'G3' && G3_GRADES_OPTIONS.length > 0) defaultNewGrade = G3_GRADES_OPTIONS[0];
                        else if (newLevel === 'G2' && G2_GRADES_OPTIONS.length > 0) defaultNewGrade = G2_GRADES_OPTIONS[0];
                        else if (newLevel === 'G1' && G1_GRADES_OPTIONS.length > 0) defaultNewGrade = G1_GRADES_OPTIONS[0];
                        
                        studentSubjects[index].grade = defaultNewGrade;

                        const gradeSelectEl = row.querySelector('.grade-select');
                        populateRowGradeDropdown(gradeSelectEl, newLevel, defaultNewGrade);
                        
                        updateAllCalculationsAndRender();
                    };
                    levelCell.appendChild(levelSelectEl);

                    const gradeCell = row.insertCell();
                    gradeCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                    const gradeSelectEl = document.createElement('select');
                    gradeSelectEl.className = "grade-select w-full px-3 py-2 min-w-[70px] bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                    populateRowGradeDropdown(gradeSelectEl, s.level, s.grade);
                    gradeSelectEl.onchange = (e) => {
                        studentSubjects[index].grade = e.target.value;
                        updateAllCalculationsAndRender();
                    };
                    gradeCell.appendChild(gradeSelectEl);
                    
                    const actionsCell = row.insertCell();
                    actionsCell.className = "px-6 py-4 whitespace-nowrap text-sm font-medium text-right";
                    actionsCell.innerHTML = `
                        <button onclick="handleDeleteSubjectWrapper(${index})" class="text-red-400 hover:text-red-300 transition-colors" aria-label="Delete subject">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm"><path d="M6 7H18V20C18 20.552 17.552 21 17 21H7C6.448 21 6 20.552 6 20V7Z"></path><path d="M19 4H15V3C15 2.448 14.552 2 14 2H10C9.448 2 9 2.448 9 3V4H5V6H19V4Z"></path></svg>
                        </button>
                    `;
                });
            }
            
            function renderEligibilityResults(eligibilityResults) {
                eligibilityResultsContainer.innerHTML = '';
                if (studentSubjects.length === 0) {
                    eligibilityPlaceholder.classList.remove('hidden'); // Show if no subjects
                    eligibilityResultsContainer.innerHTML = '';
                    eligibilityResultsContainer.appendChild(eligibilityPlaceholder);
                    return;
                }
                eligibilityPlaceholder.classList.add('hidden'); // Hide if subjects exist

                const groupedPathways = {
                    "JC/MI": [],
                    "Polytechnic Year 1": [],
                    "PFP": [],
                    "ITE Year 2 Higher Nitec": [],
                    "ITE Year 1 Higher Nitec": [],
                    "5th Year Secondary": [],
                    "Arts & Foundation Programmes": []
                };

                eligibilityResults.forEach(p => {
                    if (groupedPathways[p.group]) {
                        groupedPathways[p.group].push(p);
                    }
                });

                for (const group in groupedPathways) {
                    if (groupedPathways[group].length > 0) {
                        const groupSection = document.createElement('div');
                        groupSection.className = 'col-span-full mb-6';
                        
                        const allNotEligibleInGroup = groupedPathways[group].every(p => !p.isEligible);
                        
                        let groupHeaderHtml = `<h3 class="text-xl font-semibold text-sky-300 mb-4 border-b border-slate-700 pb-2">${group}</h3>`;
                        
                        if (group === "JC/MI") {
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-1">Gross Aggregate is used to check eligibility.</p>`;
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-1">Net Aggregate will be used for posting.</p>`;
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-4">Net Aggregate is the sum of L1R4 minus bonus points.</p>`;
                        } else if (group === "Polytechnic Year 1") {
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-1">Pathways eligibility is derived based on net aggregate score.</p>`;
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-4">Net Aggregate is the sum of ELR2B2 minus bonus points.</p>`;
                        } else if (group === "PFP") { // Added PFP specific header text
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-1">Gross Aggregate is used to check eligibility.</p>`;
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-1">Net Aggregate will be used for posting.</p>`;
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-4">Net Aggregate is the sum of ELMAB3 minus bonus points.</p>`;
                        } else if (group === "ITE Year 1 Higher Nitec") {
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-1">MER refers to the Minimum Entry Requirements.</p>`;
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-1">Pass refers to Grade A-D for G1 Subject or Grade 1-5 for G2 Subject.</p>`;
                            groupHeaderHtml += `<p class="text-sm text-slate-400 mb-4">Aggregate score is the sum of 4 G1 subjects (including Pre-requisite subjects) minus bonus points.</p>`;
                        }

                        groupSection.innerHTML = groupHeaderHtml;
                        
                        const cardsContainer = document.createElement('div');
                        cardsContainer.className = 'grid md:grid-cols-2 lg:col-span-3 gap-6';

                        groupedPathways[group].forEach(pathway => {
                            const card = document.createElement('div');
                            const isEligible = pathway.isEligible;
                            card.className = `p-5 rounded-lg shadow-lg border ${isEligible ? 'bg-emerald-800/30 border-emerald-600' : 'bg-red-800/30 border-red-600'} transition-all hover:shadow-xl hover:scale-[1.02]`;
                            
                            let scoreText = '';
                            
                            // Display Scores based on pathway group
                            if (pathway.id === "ite_hnitec_yr1_biz_services_2") { // Specific case for MER (Complete SEC)
                                scoreText = `<p class="text-xs text-slate-400 mb-1">Aggregate score: <strong>-</strong></p>`;
                            } else if (pathway.grossScore !== Infinity) {
                                if (pathway.group === "ITE Year 1 Higher Nitec") {
                                    scoreText = `<p class="text-xs text-slate-400 mb-1">Aggregate score: <strong>${pathway.netScore}</strong></p>`;
                                } else {
                                    scoreText = `<p class="text-xs text-slate-400 mb-1">Gross Aggregate: <strong>${pathway.grossScore}</strong></p>`;
                                    scoreText += `<p class="text-xs text-slate-400 mb-1">Net Aggregate: <strong>${pathway.netScore}</strong></p>`;
                                }
                            } else {
                                scoreText = `<p class="text-xs text-slate-400 mb-1">Score: N/A (Missing prerequisite subjects or grades)</p>`;
                            }

                            const requirementsList = pathway.merCheck.merDetails.map(detail => {
                                // For Poly Year 1 MOE CourseFinder link, use bullet point
                                if (pathway.group === "Polytechnic Year 1" && detail.text.includes("MOE CourseFinder")) {
                                    return `<li class="mb-0.5 text-slate-400">${detail.text}</li>`;
                                }
                                // For ITE Year 1, render "Check the aggregate point" as a plain bullet
                                if (pathway.group === "ITE Year 1 Higher Nitec" && detail.isPlainBullet) {
                                    return `<li class="mb-0.5 text-slate-400">${detail.text}</li>`;
                                }
                                const icon = detail.met
                                    ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-emerald-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>`
                                    : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm inline-block mr-1 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>`;
                                return `<li class="mb-0.5 text-slate-400">${icon} ${detail.text}</li>`;
                            }).join('');

                            const descriptionItemHtml = pathway.description ? `<li class="mt-2 pt-2 text-slate-400 italic">${pathway.description}</li>` : '';

                            const subjectsUsedHtml = pathway.subjectsUsed && pathway.subjectsUsed.length > 0
                                ? `<h5 class="text-sm font-semibold text-sky-300 mt-3 mb-1">Subjects considered for calculation:</h5><ul class="list-disc list-inside mt-1 pl-2 text-slate-300 space-y-1">${(function() {
                                    let hasTaggedMathScience = false;
                                    let hasTaggedEL = false;
                                    let hasTaggedMath = false; // For specific Math requirement

                                    return pathway.subjectsUsed.map(s => {
                                        const subjectName = getSubjectById(s.subjectId)?.name || s.subjectId;
                                        let mappedGradeInfo = '';
                                        
                                        if (s.level === 'G3' && G3_TO_G2_CONVERSION_MAP[s.grade]) {
                                            if (pathway.calcType === 'ELMAB3_G2') {
                                                mappedGradeInfo = `(G3 ${s.grade} -> G2 ${convertG3toG2(s.grade)})`;
                                            } else if (pathway.calcType === 'ITE_Hnitec_Specific' || pathway.calcType === 'ITE_Hnitec_Completed') {
                                                const g1Equiv = getG1Equivalent(s);
                                                if (g1Equiv.g1EquivGrade && g1Equiv.g1EquivGrade !== s.grade) {
                                                    mappedGradeInfo = `(${s.level} ${s.grade} -> G1 ${g1Equiv.g1EquivGrade})`;
                                                }
                                            }
                                        } else if (s.level === 'G2' && G2_TO_G1_EQUIV_MAP[s.grade]) {
                                            if (pathway.calcType === 'ITE_Hnitec_Specific' || pathway.calcType === 'ITE_Hnitec_Completed') {
                                                const g1Equiv = getG1Equivalent(s);
                                                if (g1Equiv.g1EquivGrade && g1Equiv.g1EquivGrade !== s.grade) {
                                                    mappedGradeInfo = `(${s.level} ${s.grade} -> G1 ${g1Equiv.g1EquivGrade})`;
                                                }
                                            }
                                        }

                                        let roleDisplay = s.role;
                                        // Add category for B1/B2/B3/B4 in ITE Year 1 pathways, only if it's the main required category
                                        if (pathway.group === "ITE Year 1 Higher Nitec" && (s.role === 'B1' || s.role === 'B2' || s.role === 'B3' || s.role === 'B4')) {
                                            const subjectCategory = getSubjectById(s.subjectId)?.category;
                                            let categoryLabel = '';

                                            // Logic to ensure only ONE subject gets the category tag for ITE Year 1
                                            if (pathway.id === "ite_hnitec_yr1_health_sci_1") { // MER (Pass Math or Science)
                                                if (SUBJECT_CATEGORIES_DEF.MATH_SCIENCE.includes(subjectCategory) && !hasTaggedMathScience) {
                                                    categoryLabel = 'Math or Science';
                                                    hasTaggedMathScience = true;
                                                }
                                            } else if (pathway.id === "ite_hnitec_yr1_health_sci_2") { // MER (Pass EL & Math)
                                                if (SUBJECT_CATEGORIES_DEF.EL.includes(subjectCategory) && !hasTaggedEL) {
                                                    categoryLabel = 'English';
                                                    hasTaggedEL = true;
                                                } else if (SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(subjectCategory) && !hasTaggedMath) {
                                                    categoryLabel = 'Mathematics';
                                                    hasTaggedMath = true;
                                                }
                                            } else if (pathway.id === "ite_hnitec_yr1_biz_services_1") { // MER (Pass EL)
                                                if (SUBJECT_CATEGORIES_DEF.EL.includes(subjectCategory) && !hasTaggedEL) {
                                                    categoryLabel = 'English';
                                                    hasTaggedEL = true;
                                                }
                                            } else if (pathway.id === "ite_hnitec_yr1_engineering_1") { // MER (Pass Math)
                                                if (SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(subjectCategory) && !hasTaggedMath) {
                                                    categoryLabel = 'Mathematics';
                                                    hasTaggedMath = true;
                                                }
                                            }
                                            
                                            if (categoryLabel) {
                                                roleDisplay = `${s.role} (${categoryLabel})`;
                                            }
                                        }
                                        
                                        return `<li><strong>${roleDisplay}</strong>: <strong>${subjectName}</strong> ${s.level} ${s.grade} ${mappedGradeInfo}</li>`;
                                    });
                                })().join('')}</ul>`
                                : '';

                            let pathwayNameDisplay = pathway.name;
                            if (pathway.tooltipText) {
                                pathwayNameDisplay = `<span class="tooltip">${pathway.name}<span class="tooltiptext">${pathway.tooltipText}</span></span>`;
                            }

                            card.innerHTML = `
                                <h3 class="text-xl font-semibold mb-2 flex items-center">
                                    ${isEligible ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-emerald-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>'}
                                    ${pathwayNameDisplay}
                                </h3>
                                <p class="text-sm mb-1 font-medium ${isEligible ? 'text-emerald-300' : 'text-red-300'}">
                                    Status: ${isEligible ? 'Eligible' : 'Not Eligible'}
                                </p>
                                ${scoreText}
                                <details class="text-xs mt-2">
                                    <summary class="cursor-pointer text-sky-400 hover:text-sky-300">Details & Reasons</summary>
                                    <div class="mt-2">
                                        <h5 class="text-sm font-semibold text-sky-300 mb-1">Requirements:</h5>
                                        <ul class="list-disc list-inside mt-1 pl-2 text-slate-300 space-y-1">
                                            ${requirementsList}
                                            ${descriptionItemHtml}
                                        </ul>
                                    </div>
                                    ${subjectsUsedHtml}
                                </details>
                            `;
                            cardsContainer.appendChild(card);
                        });

                        if (allNotEligibleInGroup) {
                            const detailsWrapper = document.createElement('details');
                            detailsWrapper.className = 'col-span-full';
                            detailsWrapper.innerHTML = `
                                <summary class="cursor-pointer text-lg font-semibold text-red-400 hover:text-red-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 inline-block"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>
                                    ${group} - Not Eligible (Click to Expand)
                                </summary>
                            `;
                            detailsWrapper.appendChild(cardsContainer);
                            groupSection.appendChild(detailsWrapper);
                        } else {
                            groupSection.appendChild(cardsContainer);
                        }
                        eligibilityResultsContainer.appendChild(groupSection);
                    }
                }
            };

            const getNextBetterGrade = (currentGrade, level) => {
                let gradesList = [];
                let currentGradeIndex = -1;

                if (level === "G3") {
                    gradesList = G3_GRADES_OPTIONS;
                    currentGradeIndex = gradesList.indexOf(currentGrade);
                } else if (level === "G2") {
                    gradesList = G2_GRADES_OPTIONS;
                    currentGradeIndex = gradesList.indexOf(currentGrade);
                } else if (level === "G1") {
                    gradesList = G1_GRADES_OPTIONS;
                    currentGradeIndex = gradesList.indexOf(currentGrade);
                }

                if (currentGradeIndex === -1 || currentGradeIndex === 0) {
                    return null;
                }
                return gradesList[currentGradeIndex - 1];
            };

            const getEligiblePathwayCountAndNames = (subjects) => {
                let count = 0;
                const pathwayNames = [];
                const studentSubjectsMap = new Map(subjects.map(s => [s.subjectId, s]));
                const allPathwaysStatus = []; // Declare allPathwaysStatus here

                let qualifiesForJCMIPoly = false;
                const jcMiPolyPathways = PATHWAYS.filter(p => p.group === "JC/MI" || p.group === "Polytechnic Year 1");

                jcMiPolyPathways.forEach(pathwa => { 
                    let result = { grossScore: Infinity, netScore: Infinity };
                    let scoreMet = false;

                    if (pathwa.calcType === "L1R4_G3") {
                        result = calculateL1R4(subjects, pathwa.l1r4_config, bonusPoints);
                        scoreMet = result.grossScore <= pathwa.requirements.grossL1R4;
                    } else if (pathwa.calcType === "ELR2B2_G3_Mixed") {
                        result = calculateELR2B2_G3_Mixed(subjects, pathwa.elr2b2_config, bonusPoints);
                        scoreMet = result.netScore <= pathwa.requirements.netELR2B2;
                    }
                    // Temporarily assign scores to pathway object for MER check
                    pathwa.grossScore = result.grossScore;
                    pathwa.netScore = result.netScore;

                    const merCheck = checkMerRequirements(pathwa, studentSubjectsMap, bonusPoints);
                    if (scoreMet && merCheck.merMet) {
                        qualifiesForJCMIPoly = true;
                    }
                });


                PATHWAYS.forEach(pathway => {
                    let result = { grossScore: Infinity, netScore: Infinity };
                    let scoreMet = false;
                    let merCheck = { merMet: true, merDetails: [] };

                    if (pathway.id === "fifth_year_sec_subgroup2") {
                        const g3Count = subjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade)).length;
                        const hasThreeOrMoreG3 = g3Count >= 3;
                        scoreMet = hasThreeOrMoreG3 && !qualifiesForJCMIPoly;
                        merCheck.merDetails.push({ text: `Has ${g3Count} G3 passes. (Required 3 or more G3 passes)`, met: hasThreeOrMoreG3 });
                        merCheck.merDetails.push({ text: qualifiesForJCMIPoly ? "Qualifies for JC/MI/Poly Year 1 (Not Eligible for this option)" : "Does NOT qualify for JC/MI/Poly Year 1 (Eligible for this option)", met: !qualifiesForJCMIPoly });
                        if (!hasThreeOrMoreG3 || qualifiesForJCMIPoly) merMet = false;
                    } else {
                        if (pathway.calcType === "L1R4_G3") {
                            result = calculateL1R4(subjects, pathway.l1r4_config, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossL1R4;
                        } else if (pathway.calcType === "ELMAB3_G2") {
                            result = calculateELMAB3_G2(subjects, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossELMAB3;
                        } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                            result = calculateELR2B2_G3_Mixed(subjects, pathway.elr2b2_config, bonusPoints);
                            scoreMet = result.netScore <= pathway.requirements.netELR2B2;
                        } else if (pathway.calcType === "5th_Year_Sec_G2") {
                            const fifthYearResult = calculate5thYearSecondary(subjects, bonusPoints);
                            result = fifthYearResult;
                            const g3Count = subjects.filter(s => s.level === "G3" && G3_GRADES_OPTIONS.includes(s.grade)).length;
                            const hasTwoOrFewerG3 = g3Count <= 2;
                            scoreMet = fifthYearResult.scoreMet && hasTwoOrFewerG3;
                            merCheck.merDetails.push({ text: `G3 Passes: ${g3Count} (Required 2 or fewer for Option 1)`, met: hasTwoOrFewerG3 });
                        } else if (pathway.calcType === "Arts_Institutions_G3") {
                            result = calculateArtsInstitutions(subjects);
                            scoreMet = result.grossScore !== Infinity;
                        } else if (pathway.calcType === "ITE_Hnitec_Specific") {
                            result = calculateITEHnitecSpecific(subjects, pathway.requirements, bonusPoints);
                            scoreMet = result.scoreMet;
                        } else if (pathway.calcType === "ITE_Hnitec_Completed") {
                            result = calculateITEHnitecCompleted(subjects, bonusPoints);
                            scoreMet = result.scoreMet;
                        } else if (pathway.calcType === "Pending") {
                            scoreMet = false;
                            merCheck.merMet = false;
                            merCheck.merDetails.push({ text: "This section is pending update and no pathways are currently available for eligibility check.", met: false });
                        }
                        // Assign scores to pathway object for MER check
                        pathway.grossScore = result.grossScore;
                        pathway.netScore = result.netScore;
                        merCheck = checkMerRequirements(pathway, studentSubjectsMap, bonusPoints);
                    }

                    allPathwaysStatus.push({
                        ...pathway,
                        grossScore: result.grossScore,
                        netScore: result.netScore,
                        scoreDetails: result.details,
                        merCheck: merCheck,
                        isEligible: scoreMet && merCheck.merMet,
                        subjectsUsed: result.subjectsUsed,
                    });
                });

                allPathwaysStatus.forEach(p => {
                    if (p.isEligible) {
                        count++;
                        pathwayNames.push(p.name);
                    }
                });

                return { count, pathwayNames };
            };

            const generateImprovementSuggestions = () => {
                improvementSuggestionsContainer.innerHTML = '';
                if (studentSubjects.length === 0) {
                    improvementSuggestionsSection.classList.add('hidden');
                    return;
                }

                improvementSuggestionsSection.classList.remove('hidden');
                improvementPlaceholder.classList.add('hidden');

                const { count: currentEligiblePathwaysCount, pathwayNames: currentEligiblePathwayNames } = getEligiblePathwayCountAndNames(studentSubjects);
                const suggestions = [];

                studentSubjects.forEach((subject, index) => {
                    const originalGrade = subject.grade;
                    const originalLevel = subject.level;
                    const nextBetterGrade = getNextBetterGrade(originalGrade, originalLevel);

                    if (nextBetterGrade) {
                        const tempSubjects = [...studentSubjects];
                        tempSubjects[index] = { ...subject, grade: nextBetterGrade };
                        const { count: newEligiblePathwaysCount, pathwayNames: newEligiblePathwayNames } = getEligiblePathwayCountAndNames(tempSubjects);

                        if (newEligiblePathwaysCount > currentEligiblePathwaysCount) {
                            const unlockedPathwayNames = newEligiblePathwayNames.filter(name => !currentEligiblePathwayNames.includes(name));
                            suggestions.push({
                                subjectName: subject.subjectId,
                                originalGrade: originalGrade,
                                originalLevel: originalLevel,
                                improvedGrade: nextBetterGrade,
                                pathwaysUnlockedCount: newEligiblePathwaysCount - currentEligiblePathwaysCount,
                                unlockedPathwayNames: unlockedPathwayNames,
                            });
                        }
                    }
                });

                if (suggestions.length === 0) {
                    improvementPlaceholder.classList.remove('hidden');
                    improvementSuggestionsSection.classList.remove('hidden');
                } else {
                    renderImprovementSuggestions(suggestions);
                }
            };

            const renderImprovementSuggestions = (suggestions) => {
                improvementSuggestionsContainer.innerHTML = '';
                suggestions.sort((a, b) => b.pathwaysUnlockedCount - a.pathwaysUnlockedCount);

                suggestions.forEach(suggestion => {
                    const pathwayNamesText = suggestion.unlockedPathwayNames.length > 0
                        ? `This could unlock: <strong>${suggestion.unlockedPathwayNames.join(', ')}</strong>.`
                        : `This could unlock <strong>${suggestion.pathwaysUnlockedCount}</strong> additional pathway(s).`;

                    const suggestionCard = `
                        <div class="bg-slate-700 p-4 rounded-lg shadow-md mb-3 border border-slate-600 flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-3 text-emerald-400 flex-shrink-0 mt-1"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>
                            <div>
                                <h4 class="text-lg font-semibold text-sky-300 mb-1">${getSubjectById(suggestion.subjectName)?.name || suggestion.subjectName}</h4>
                                <p class="text-slate-200 text-sm mb-2">Improve from <strong>${suggestion.originalGrade} (${suggestion.originalLevel})</strong> to <strong>${suggestion.improvedGrade} (${suggestion.originalLevel})</strong>.</p>
                                <p class="text-xs text-slate-400">${pathwayNamesText}</p>
                            </div>
                        </div>
                    `;
                    improvementSuggestionsContainer.innerHTML += suggestionCard;
                });
            };


            // --- Event Handlers ---
            function handleAddOrUpdateSubject() {
                const currentSubjectVal = subjectSelect.value;
                const currentLevelVal = levelSelect.value;
                const currentGradeVal = gradeSelect.value;

                if (!currentSubjectVal || !currentLevelVal || !currentGradeVal) {
                    showMessage("Please select subject, level, and grade.");
                    return;
                }

                const isDuplicate = studentSubjects.some(s => s.subjectId === currentSubjectVal);
                if (isDuplicate) {
                    showMessage("Duplicate Subject", "This subject has already been added. Please edit the existing entry in the table below or choose a different subject.");
                    return;
                }
                studentSubjects.push({ subjectId: currentSubjectVal, level: currentLevelVal, grade: currentGradeVal });
                
                subjectSelect.value = '';
                levelSelect.value = 'G3';
                populateGradeDropdown('G3');
                gradeSelect.value = G3_GRADES_OPTIONS[0];

                updateAllCalculationsAndRender();
            }

            window.handleDeleteSubjectWrapper = (index) => {
                showMessage("Are you sure you want to delete this subject?", "Confirm Deletion");
                messageBoxOkButton.onclick = () => {
                    customMessageBox.classList.add('hidden');
                    studentSubjects.splice(index, 1);
                    updateAllCalculationsAndRender();
                    messageBoxOkButton.onclick = () => customMessageBox.classList.add('hidden');
                };
            };
            
            function updateAllCalculationsAndRender() {
                bonusPoints = parseInt(bonusInput.value) || 0;
                if (bonusPoints < 0) bonusPoints = 0;
                if (bonusPoints > 5) bonusPoints = 5;
                bonusInput.value = bonusPoints;

                checkEligibility();
                renderStudentSubjectsTable();
                generateImprovementSuggestions();
            }

            // --- Initial Setup ---
            document.addEventListener('DOMContentLoaded', () => {
                currentYearSpan.textContent = new Date().getFullYear();
                
                // Initial population based on default school
                selectedSchool = schoolSelect.value;
                populateSubjectDropdown();
                populateLevelDropdown(levelSelect.value, subjectSelect.value); // Pass initial subject and school

                // Event listeners for school and subject changes
                schoolSelect.addEventListener('change', (e) => {
                    selectedSchool = e.target.value;
                    populateSubjectDropdown(); // Re-populate subjects based on new school
                    populateLevelDropdown(levelSelect.value, subjectSelect.value); // Re-populate levels based on selected subject and new school
                });
                subjectSelect.addEventListener('change', (e) => {
                    populateLevelDropdown(levelSelect.value, e.target.value); // Re-populate levels based on selected subject
                });
                levelSelect.addEventListener('change', (e) => populateGradeDropdown(e.target.value));
                
                addUpdateSubjectBtn.addEventListener('click', handleAddOrUpdateSubject);
                bonusInput.addEventListener('change', updateAllCalculationsAndRender);
                bonusInput.addEventListener('keyup', (e) => {
                    if (e.key >= '0' && e.key === '9' || e.key === 'Backspace' || e.key === 'Delete') {
                        updateAllCalculationsAndRender();
                    }
                });
                
                renderEligibilityResults([]);
                generateImprovementSuggestions();
            });

        })();
    </script>
</body>
</html>
