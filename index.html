<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Pathway Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* For Lucide icons via CDN (alternative to npm) */
        /* We will use inline SVGs or simple text for icons to avoid external dependencies beyond Tailwind if possible */
        .icon-sm { width: 18px; height: 18px; display: inline-block; vertical-align: middle; }
        .icon-md { width: 20px; height: 20px; display: inline-block; vertical-align: middle; }
        .icon-lg { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }

        /* Custom Message Box */
        #customMessageBox {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #customMessageBox.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            height: 24px; /* Fixed height for alignment */
        }
        .bar-label {
            width: 150px; /* Adjust as needed */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
            font-size: 0.875rem; /* text-sm */
            color: #cbd5e1; /* slate-300 */
        }
        .bar {
            height: 100%;
            background-image: linear-gradient(to right, #22d3ee, #10b981);
            border-radius: 0.25rem; /* rounded-sm */
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding-right: 5px;
            color: white;
            font-size: 0.75rem; /* text-xs */
            line-height: 24px; /* Match height */
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content;
            max-width: 250px;
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the element */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            border: 1px solid #334155; /* slate-700 */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-sky-900 min-h-screen text-gray-100">

    <div id="customMessageBox" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-slate-700">
            <h3 id="messageBoxTitle" class="text-lg font-semibold text-cyan-400 mb-3">Notification</h3>
            <p id="messageBoxText" class="text-slate-300 mb-6"></p>
            <button id="messageBoxOkButton" class="w-full p-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg transition duration-150">
                OK
            </button>
        </div>
    </div>

    <div class="p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 via-cyan-400 to-sky-500">
                Student Pathway Dashboard
            </h1>
            <p class="text-sky-300 mt-2 text-lg">
                Explore your post-secondary options based on your subject grades.
            </p>
        </header>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M21 22L17.592 18.592C19.089 16.839 20 14.745 20 12.5C20 7.258 15.742 3 10.5 3S1 7.258 1 12.5C1 17.742 5.258 22 10.5 22C12.745 22 14.839 21.089 16.592 19.592L20 23L21 22ZM10.5 20C6.364 20 3 16.636 3 12.5C3 8.364 6.364 5 10.5 5C14.636 5 18 8.364 18 12.5C18 16.636 14.636 20 10.5 20Z"></path><path d="M11.5 8H9.5V12H11.5V8Z"></path><path d="M11.5 14H9.5V16H11.5V14Z"></path></svg> Enter Your Subjects & Grades
            </h2>
            
            <div class="grid md:grid-cols-5 gap-4 mb-4 items-end">
                <div>
                    <label for="subject" class="block text-sm font-medium text-sky-300 mb-1">Subject</label>
                    <select id="subject" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        <option value="">Select Subject</option>
                    </select>
                </div>
                <div>
                    <label for="level" class="block text-sm font-medium text-sky-300 mb-1">Level</label>
                    <select id="level" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="grade" class="block text-sm font-medium text-sky-300 mb-1">Grade</label>
                    <select id="grade" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="bonus" class="block text-sm font-medium text-sky-300 mb-1">Bonus Points (Max 5)</label>
                    <input type="number" id="bonus" value="0" min="0" max="5" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100" />
                </div>
                <button id="addUpdateSubjectBtn" class="w-full p-3 bg-gradient-to-r from-emerald-500 to-cyan-600 hover:from-emerald-600 hover:to-cyan-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out flex items-center justify-center text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2"><path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM17 13H13V17H11V13H7V11H11V7H13V11H17V13Z"></path></svg> <span id="addUpdateBtnText">Add Subject</span>
                </button>
            </div>

            <div id="studentSubjectsTableContainer" class="mt-8 hidden">
                <h3 class="text-xl font-semibold mb-3 text-sky-400">Your Subjects:</h3>
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Grade</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-sky-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentSubjectsTableBody" class="bg-slate-800 divide-y divide-slate-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M12 2C17.523 2 22 6.477 22 12C22 17.523 17.523 22 12 22C6.477 22 2 17.523 2 12C2 6.477 6.477 2 12 2ZM12 4C7.582 4 4 7.582 4 12C4 16.418 7.582 20 12 20C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4ZM12 11C11.448 11 11 11.448 11 12C11 12.552 11.448 13 12 13C12.552 13 13 12.552 13 12C13 11.448 12.552 11 12 11ZM12 6C9.791 6 8 7.791 8 10H10C10 8.896 10.896 8 12 8C13.104 8 14 8.896 14 10C14 12 11 11.75 11 15H13C13 12.75 16 12.5 16 10C16 7.791 14.209 6 12 6Z"></path></svg> Pathway Eligibility
            </h2>
            <div id="eligibilityResultsContainer" class="grid md:grid-cols-2 lg:col-span-3 gap-6">
                <div id="eligibilityPlaceholder" class="text-center py-8 text-slate-400 md:col-span-2 lg:col-span-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-sky-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM11 7H13V11H11V7ZM11 13H13V17H11V13Z"></path></svg> <p class="text-xl">Please add subjects to see your eligible pathways.</p>
                </div>
            </div>
        </section>

        <section id="improvementSuggestionsSection" class="p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700 hidden">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M3 17H5V19H3V17ZM7 5H9V19H7V5ZM11 13H13V19H11V13ZM15 9H17V19H15V9ZM19 12H21V19H19V12Z"></path></svg> Improvement Suggestions
            </h2>
            <div id="improvementSuggestionsContainer">
                </div>
            <div id="improvementPlaceholder" class="text-center py-8 text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">Add subjects to see improvement suggestions or you're doing great!</p>
            </div>
        </section>

        <footer class="text-center mt-12 text-sm text-slate-500">
            <p>&copy; <span id="currentYear"></span> Student Pathway Dashboard. For informational purposes only.</p>
            <p>Always verify eligibility criteria with official sources.</p>
            <p class="mt-1">Based on Full SBB Post-Sec Options w.e.f. 2027 S4/5 Cohort (Affecting: 2025 S1 & S2 Full SBB) document.</p>
        </footer>
    </div>

    <script>
        (function() { // Start IIFE
            // --- Constants and Configuration ---
            const G3_GRADES_OPTIONS = ["A1", "A2", "B3", "B4", "C5", "C6", "D7", "E8", "F9", "U"];
            const G2_GRADES_OPTIONS = ["1", "2", "3", "4", "5", "6", "U"];
            const G1_GRADES_OPTIONS = ["A", "B", "C", "D", "E", "U"]; // E for ITE, D for others
            const G3_TO_NUMERIC_RAW = { A1: 1, A2: 2, B3: 3, B4: 4, C5: 5, C6: 6, D7: 7, E8: 8, F9: 9, U: 10 };
            const G2_TO_NUMERIC_RAW = { "1": 1, "2": 2, "3": 3, "4": 4, "5": 5, "6": 6, U: 7 };
            const G1_TO_NUMERIC_RAW_ITE = { A: 1, B: 2, C: 3, D: 4, E: 5, U: 6 }; // ITE uses A-E
            const G1_TO_NUMERIC_RAW_OTHER = { A: 1, B: 2, C: 3, D: 4, U: 5 }; // Other pathways use A-D

            const G3_TO_G2_CONVERSION_MAP = {
                A1: "1", A2: "1", B3: "1", B4: "2", C5: "2", C6: "2", D7: "3", E8: "4", F9: "5", U: "6"
            };
            
            const G3_TO_G1_EQUIV_MAP = {
                A1: "A", A2: "A", B3: "A", B4: "A", C5: "A", C6: "A", D7: "A", E8: "B", F9: "C", "U": "D"
            };

            const G2_TO_G1_EQUIV_MAP = {
                "1": "A", "2": "A", "3": "A", "4": "B", "5": "C", "6": "D", "U": "U" // Corrected mapping for G2 to G1
            };

            const GRADE_LEVELS = ["G3", "G2", "G1"];

            const ALL_SUBJECTS_LIST = [
                { id: "EL", name: "English Language", category: "EL" },
                { id: "MATH", name: "Elementary Mathematics", category: "MATH_PURE" },
                { id: "AM", name: "Additional Mathematics", category: "MATH_PURE" },
                { id: "HMT", name: "Higher Mother Tongue", category: "HMT" }, // Consolidated Higher Mother Tongue
                { id: "MT", name: "Mother Tongue", category: "MT" }, // Consolidated Mother Tongue
                { id: "HIST", name: "History", category: "HUMANITIES_PURE" },
                { id: "GEOG", name: "Geography", category: "HUMANITIES_PURE" },
                { id: "LIT_ENG", name: "Literature in English", category: "HUMANITIES_PURE" },
                { id: "COMB_HUM", name: "Combined Humanities", category: "HUMANITIES_COMBINED" },
                { id: "PHY", name: "Physics", category: "SCIENCE_PURE" },
                { id: "CHEM", name: "Chemistry", category: "SCIENCE_PURE" },
                { id: "BIO", name: "Biology", category: "SCIENCE_PURE" },
                { id: "COMB_SCI", name: "Combined Science", category: "SCIENCE_COMBINED" },
                { id: "ART", name: "Art", category: "ART_MUSIC" },
                { id: "DT", name: "Design & Technology", category: "TECH_SUBJECTS" },
                { id: "NFS", name: "Nutrition and Food Science", category: "TECH_SUBJECTS" },
                { id: "POA", name: "Principles of Accounts", category: "BUSINESS_SUBJECTS" },
                { id: "MUSIC", name: "Music", category: "ART_MUSIC" },
                { id: "COMP", name: "Computing / Computer Studies", category: "TECH_SUBJECTS" },
                { id: "BS", name: "Business Studies", category: "BUSINESS_SUBJECTS" },
                { id: "COMMERCE", name: "Commerce", category: "BUSINESS_SUBJECTS" },
                { id: "ECON", name: "Economics", category: "BUSINESS_SUBJECTS" },
                { id: "IED", name: "Intro to Enterprise Development", category: "BUSINESS_SUBJECTS" },
                { id: "HA", name: "Higher Art", category: "ART_MUSIC" },
                { id: "HM", name: "Higher Music", category: "ART_MUSIC" },
                { id: "MS", name: "Media Studies (English/Chinese)", category: "MEDIA_COMM" },
                { id: "C3DA", name: "Creative 3D Animation", category: "TECH_SUBJECTS" },
                { id: "ESS", name: "Exercise & Sports Science", category: "EXERCISE_SPORTS" },
                { id: "FOE", name: "Electronics / Fundamentals of Electronics", category: "TECH_SUBJECTS" },
                { id: "BIOTECH", name: "Biotechnology", category: "BIOTECH" },
                { id: "MOB_ROBOTICS", name: "Mobile Robotics", category: "TECH_SUBJECTS" },
                { id: "SMART_ELEC_TECH", name: "Smart Electrical Technology", category: "TECH_SUBJECTS" },
                { id: "MECH_DESIGN_AUTO", name: "Mechanical Design & Automation", category: "TECH_SUBJECTS" },
                { id: "IOT_APP", name: "IoT Applications", category: "TECH_SUBJECTS" },
                { id: "MOB_WEB_APP", name: "Mobile Web Applications", category: "TECH_SUBJECTS" },
                { id: "OTHER", name: "Other Subject", category: "OTHER" },
            ];

            const SUBJECT_CATEGORIES_DEF = {
                EL: ["EL"],
                HMT: ["HMT"], // Category for Higher Mother Tongue subjects
                MT: ["MT"], // Category for regular Mother Tongue subjects
                MT_ALL: ["MT", "HMT"], // Combines all Mother Tongue types for checks that need any MT

                HUMANITIES_PURE: ["HUMANITIES_PURE"],
                HUMANITIES_COMBINED: ["HUMANITIES_COMBINED"],
                HUM: ["HUMANITIES_PURE", "HUMANITIES_COMBINED"], // General Humanities

                MATH_PURE: ["MATH_PURE"],
                SCIENCE_PURE: ["SCIENCE_PURE"],
                SCIENCE_COMBINED: ["SCIENCE_COMBINED"],
                MATH_SCIENCE: ["MATH_PURE", "SCIENCE_PURE", "SCIENCE_COMBINED"], // General Math/Science
                HUM_MATH_SCIENCE: ["HUMANITIES_PURE", "HUMANITIES_COMBINED", "MATH_PURE", "SCIENCE_PURE", "SCIENCE_COMBINED"], // General Hum/Math/Science
                
                // New category for Science in lieu subjects
                SCIENCE_IN_LIEU: ["SCIENCE_PURE", "SCIENCE_COMBINED", "MOB_ROBOTICS", "SMART_ELEC_TECH", "MECH_DESIGN_AUTO", "IOT_APP", "MOB_WEB_APP"],

                TECH_SUBJECTS: ["TECH_SUBJECTS"],
                BUSINESS_SUBJECTS: ["BUSINESS_SUBJECTS"],
                ART_MUSIC: ["ART_MUSIC"],
                MEDIA_COMM: ["MEDIA_COMM"],
                LANGUAGE_ELECTIVES: ["MT", "HMT"], // Language electives can be any MT/HMT
                EXERCISE_SPORTS: ["EXERCISE_SPORTS"],
                BIOTECH: ["BIOTECH"],
                OTHER: ["OTHER"],

                ANY_BEST: [] // Populated dynamically
            };

            SUBJECT_CATEGORIES_DEF.ANY_BEST = ALL_SUBJECTS_LIST.map(s => s.category).filter((value, index, self) => self.indexOf(value) === index);


            const PATHWAYS = [
                { id: "jc", name: "Junior College (JC)", group: "JC/MI", calcType: "L1R4_G3", requirements: { grossL1R4: 16 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: "E8" },{ type: "MT", level: "G3", grade: "D7" },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM_MATH_SCIENCE, R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "L1R4 (G3 subjects) ≤ 16. Must meet Minimum Subject Grade Requirements." },
                { id: "mi", name: "Millennia Institute (MI)", group: "JC/MI", calcType: "L1R4_G3", requirements: { grossL1R4: 20 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: "E8" },{ type: "MT", level: "G3", grade: "D7" },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM_MATH_SCIENCE, R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "L1R4 (G3 subjects) ≤ 20. Must meet Minimum Subject Grade Requirements." },

                { id: "poly_yr1_elr2b2_a", name: "Polytechnic Year 1 (ELR2B2-A) - Humanities, Media & Communications", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: SUBJECT_CATEGORIES_DEF.ART_MUSIC.concat(SUBJECT_CATEGORIES_DEF.BUSINESS_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_COMBINED).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_PURE).concat(SUBJECT_CATEGORIES_DEF.MEDIA_COMM), R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_PURE.concat(SUBJECT_CATEGORIES_DEF.ART_MUSIC).concat(SUBJECT_CATEGORIES_DEF.BUSINESS_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_COMBINED).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_PURE).concat(SUBJECT_CATEGORIES_DEF.MEDIA_COMM).concat(SUBJECT_CATEGORIES_DEF.TECH_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.SCIENCE_COMBINED).concat(SUBJECT_CATEGORIES_DEF.LANGUAGE_ELECTIVES), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "Net ELR2B2 ≤ 22. English G3. 2 Relevant G3 subjects. One B subject G3, one B subject G2 equivalent. Specific R1/R2 for this cluster." },
                { id: "poly_yr1_elr2b2_b", name: "Polytechnic Year 1 (ELR2B2-B) - Business & Management", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_PURE, R2_cat_ids: SUBJECT_CATEGORIES_DEF.ART_MUSIC.concat(SUBJECT_CATEGORIES_DEF.BUSINESS_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_COMBINED).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_PURE).concat(SUBJECT_CATEGORIES_DEF.MEDIA_COMM), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "Net ELR2B2 ≤ 22. English G3. 2 Relevant G3 subjects. One B subject G3, one B subject G2 equivalent. Specific R1/R2 for this cluster." },
                { id: "poly_yr1_elr2b2_c_general", name: "Polytechnic Year 1 (ELR2B2-C) - Applied/Health Sc, Engrg, Info & Digital Tech, Built Environment", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_PURE, R2_cat_ids: SUBJECT_CATEGORIES_DEF.SCIENCE_PURE.concat(SUBJECT_CATEGORIES_DEF.SCIENCE_COMBINED).concat(SUBJECT_CATEGORIES_DEF.TECH_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.EXERCISE_SPORTS).concat(SUBJECT_CATEGORIES_DEF.BIOTECH), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "Net ELR2B2 ≤ 22. English G3. 2 Relevant G3 subjects. One B subject G3, one B subject G2 equivalent. Specific R1/R2 for this cluster." },
                { id: "poly_yr1_elr2b2_c_nursing", name: "Polytechnic Year 1 (ELR2B2-C) - Nursing", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 24 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_PURE, R2_cat_ids: SUBJECT_CATEGORIES_DEF.SCIENCE_PURE.concat(SUBJECT_CATEGORIES_DEF.SCIENCE_COMBINED).concat(SUBJECT_CATEGORIES_DEF.TECH_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.EXERCISE_SPORTS).concat(SUBJECT_CATEGORIES_DEF.BIOTECH), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "Net ELR2B2 ≤ 24. English G3. 2 Relevant G3 subjects. One B subject G3, one B subject G2 equivalent. Specific R1/R2 for Nursing." },
                { id: "poly_yr1_elr2b2_d", name: "Polytechnic Year 1 (ELR2B2-D) - Design, Built Environment", group: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, mer: {}, elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R1_cat_ids: SUBJECT_CATEGORIES_DEF.MATH_PURE, R2_cat_ids: SUBJECT_CATEGORIES_DEF.ART_MUSIC.concat(SUBJECT_CATEGORIES_DEF.SCIENCE_PURE).concat(SUBJECT_CATEGORIES_DEF.SCIENCE_COMBINED).concat(SUBJECT_CATEGORIES_DEF.TECH_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.MEDIA_COMM).concat(SUBJECT_CATEGORIES_DEF.BIOTECH), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST }, description: "Net ELR2B2 ≤ 22. English G3. 2 Relevant G3 subjects. One B subject G3, one B subject G2 equivalent. Specific R1/R2 for this cluster." },

                { id: "pfp_science_tech", name: "Polytechnic Foundation Programme (PFP) - Science Cluster", group: "PFP", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 12 }, mer: { el_g2: "3", math_am_g2: "3", relevant_subj_g2: "3", relevant_subj_ids: SUBJECT_CATEGORIES_DEF.TECH_SUBJECTS.concat(SUBJECT_CATEGORIES_DEF.SCIENCE_COMBINED), other_two_subj_g2: "4" }, description: "Gross ELMAB3 (G2 equivalent grades) ≤ 12. Must meet MER for English, Math/Add Math, a relevant Science/Tech subject, and 2 other subjects." },
                { id: "pfp_hum_art_biz", name: "Polytechnic Foundation Programme (PFP) - Humanities, Art, Media, Business Cluster", group: "PFP", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 12 }, mer: { el_g2: "3", math_am_g2: "3", relevant_subj_g2: "3", relevant_subj_ids: SUBJECT_CATEGORIES_DEF.ART_MUSIC.concat(SUBJECT_CATEGORIES_DEF.BUSINESS_SUBJECTS).concat(SUBJECT_CATEGORIES_DEF.HUMANITIES_COMBINED).concat(SUBJECT_CATEGORIES_DEF.HUM), other_two_subj_g2: "4" }, description: "Gross ELMAB3 (G2 equivalent grades) ≤ 12. Must meet MER for English, Math/Add Math, a relevant Hum/Art/Biz subject, and 2 other subjects." },

                { id: "ite_hnitec_yr2_applied_eng_ict", name: "ITE Year 2 of 3-Yr Higher Nitec - Applied Science, Engineering, Info-Comms Tech", group: "ITE Year 2 Higher Nitec", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 19 }, mer: { el_g2: "4", math_am_g2: "4", any_three_other_subj_g2: "5" }, description: "Gross ELMAB3 (G2 equivalent grades) ≤ 19. Must meet MER for English (G2 ≤ 4), Math/Add Math (G2 ≤ 4), and 3 other subjects (G2 ≤ 5)." },
                { id: "ite_hnitec_yr2_biz_hosp", name: "ITE Year 2 of 3-Yr Higher Nitec - Business & Services, Hospitality", group: "ITE Year 2 Higher Nitec", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 19 }, mer: { el_g2: "3", math_am_g2: "4", any_three_other_subj_g2: "5" }, description: "Gross ELMAB3 (G2 equivalent grades) ≤ 19. Must meet MER for English (G2 ≤ 3), Math/Add Math (G2 ≤ 4), and 3 other subjects (G2 ≤ 5)." },

                // ITE Year 1 Higher Nitec Specific Pathways
                { id: "ite_hnitec_yr1_health_sci_1", name: "ITE Year 1 of 3-Yr Higher Nitec (Health Sciences 1)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_OR_2_G3", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, req_g1g2_other_count: 2, req_g3_count: 2, req_g3_grade: 8, allow_science_in_lieu: true }, mer: {}, description: "3 G1/G2 passes (A-D or 1-5) in Math or Science* and two other subjects, OR 2 G3 grades (1-8) in any two subjects. *Science includes Mobile Robotics etc." },
                { id: "ite_hnitec_yr1_health_sci_2", name: "ITE Year 1 of 3-Yr Higher Nitec (Health Sciences 2)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_OR_2_G3", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.MATH_PURE), req_g1g2_other_count: 1, req_g3_count: 2, req_g3_grade: 8 }, mer: {}, description: "3 G1/G2 passes (A-D or 1-5) in English Language, Mathematics, and one other subject, OR 2 G3 grades (1-8) in any two subjects." },
                { id: "ite_hnitec_yr1_biz_services_1", name: "ITE Year 1 of 3-Yr Higher Nitec (Business & Services 1)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_OR_2_G3", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.EL, req_g1g2_other_count: 2, req_g3_count: 2, req_g3_grade: 8 }, mer: {}, description: "3 G1/G2 passes (A-D or 1-5) in English Language and two other subjects, OR 2 G3 grades (1-8) in any two subjects." },
                { id: "ite_hnitec_yr1_biz_services_2", name: "ITE Year 1 of 3-Yr Higher Nitec (Business & Services 2)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Completed", requirements: {}, mer: {}, description: "Completed G1 or G2 OR Completed GCE 'O' Level." },
                { id: "ite_hnitec_yr1_electronics_ict_1", name: "ITE Year 1 of 3-Yr Higher Nitec (Electronics & Info-Comm Technology 1)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_OR_2_G3", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, req_g1g2_other_count: 2, req_g3_count: 2, req_g3_grade: 8, allow_science_in_lieu: true }, mer: {}, description: "3 G1/G2 passes (A-D or 1-5) in Math or Science* and two other subjects, OR 2 G3 grades (1-8) in any two subjects. *Science includes Mobile Robotics etc." },
                { id: "ite_hnitec_yr1_electronics_ict_2", name: "ITE Year 1 of 3-Yr Higher Nitec (Electronics & Info-Comm Technology 2)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Completed", requirements: {}, mer: {}, description: "Completed G1 or G2 OR Completed GCE 'O' Level." },
                { id: "ite_hnitec_yr1_design_media", name: "ITE Year 1 of 3-Yr Higher Nitec (Design & Media)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Completed", requirements: {}, mer: {}, description: "Completed G1 or G2 OR Completed GCE 'O' Level." },
                { id: "ite_hnitec_yr1_engineering_1", name: "ITE Year 1 of 3-Yr Higher Nitec (Engineering 1)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_OR_2_G3", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_PURE, req_g1g2_other_count: 2, req_g3_count: 2, req_g3_grade: 8 }, mer: {}, description: "3 G1/G2 passes (A-D or 1-5) in Mathematics and two other subjects, OR 2 G3 grades (1-8) in any two subjects." },
                { id: "ite_hnitec_yr1_engineering_2", name: "ITE Year 1 of 3-Yr Higher Nitec (Engineering 2)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_OR_2_G3", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.MATH_SCIENCE, req_g1g2_other_count: 2, req_g3_count: 2, req_g3_grade: 8, allow_science_in_lieu: true }, mer: {}, description: "3 G1/G2 passes (A-D or 1-5) in Math or Science* and two other subjects, OR 2 G3 grades (1-8) in any two subjects. *Science includes Mobile Robotics etc." },
                { id: "ite_hnitec_yr1_engineering_3", name: "ITE Year 1 of 3-Yr Higher Nitec (Engineering 3)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Completed", requirements: {}, mer: {}, description: "Completed G1 or G2 OR Completed GCE 'O' Level." },
                { id: "ite_hnitec_yr1_hospitality_1", name: "ITE Year 1 of 3-Yr Higher Nitec (Hospitality 1)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Specific", requirements: { type: "3_G1G2_OR_2_G3", req_g1g2_count: 3, req_g1g2_main_cats: SUBJECT_CATEGORIES_DEF.EL, req_g1g2_other_count: 2, req_g3_count: 2, req_g3_grade: 8 }, mer: {}, description: "3 G1/G2 passes (A-D or 1-5) in English Language and two other subjects, OR 2 G3 grades (1-8) in any two subjects." },
                { id: "ite_hnitec_yr1_hospitality_2", name: "ITE Year 1 of 3-Yr Higher Nitec (Hospitality 2)", group: "ITE Year 1 Higher Nitec", calcType: "ITE_Hnitec_Completed", requirements: {}, mer: {}, description: "Completed G1 or G2 OR Completed GCE 'O' Level." },


                { id: "fifth_year_sec_subgroup1", name: "5th Year Secondary - Option 1", group: "5th Year Secondary", calcType: "5th_Year_Sec_G2", requirements: { grossELMAB3: 21, grossELB3: 14, grossMAB3: 14 }, mer: { all_subjects_g2: "5" }, description: "For students with 2 or fewer G3 Passes. ELMABAB3 ≤ 21 OR ELB3 ≤ 14 OR MAB3 ≤ 14. All subjects used must be G2 equivalent Grade 5 or better." },
                { id: "fifth_year_sec_subgroup2", name: "5th Year Secondary - Option 2", group: "5th Year Secondary", calcType: "Conditional_Negative", requirements: { }, mer: { }, description: "For students with 3 or more G3 Passes. Must NOT qualify for JC/MI/Poly Y1." },
                
                { id: "nfp", name: "NAFA Foundation Programme (NFP)", group: "Arts & Foundation Programmes", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 15 }, mer: {}, description: "Gross ELMAB3 (G2 equivalent grades) ≤ 15. Requires other specific entry requirements (e.g., portfolio)." },
                { id: "arts_institutions", name: "Arts Institutions", group: "Arts & Foundation Programmes", calcType: "Arts_Institutions_G3", requirements: { best4G3ExclEL: 25 }, mer: { el_g3: 6 }, description: "Best 4 G3 subjects (excluding EL) ≤ 25. English Language (G3) must be C6 or better. Requires Portfolio/Admissions Test/Personal Statement/Audition." },
            ];

            // --- State Variables ---
            let studentSubjects = [];
            let bonusPoints = 0;
            let editingIndex = null; // null for add mode, index for edit mode

            // --- DOM Elements ---
            const subjectSelect = document.getElementById('subject');
            const levelSelect = document.getElementById('level');
            const gradeSelect = document.getElementById('grade');
            const bonusInput = document.getElementById('bonus');
            const addUpdateSubjectBtn = document.getElementById('addUpdateSubjectBtn');
            const addUpdateBtnText = addUpdateSubjectBtn.querySelector('span'); // For changing text
            const addUpdateBtnIcon = addUpdateSubjectBtn.querySelector('svg'); // For changing icon
            const studentSubjectsTableBody = document.getElementById('studentSubjectsTableBody');
            const studentSubjectsTableContainer = document.getElementById('studentSubjectsTableContainer');
            const eligibilityResultsContainer = document.getElementById('eligibilityResultsContainer');
            const eligibilityPlaceholder = document.getElementById('eligibilityPlaceholder');
            const improvementSuggestionsSection = document.getElementById('improvementSuggestionsSection');
            const improvementSuggestionsContainer = document.getElementById('improvementSuggestionsContainer');
            const improvementPlaceholder = document.getElementById('improvementPlaceholder');
            const currentYearSpan = document.getElementById('currentYear');

            const customMessageBox = document.getElementById('customMessageBox');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxOkButton = document.getElementById('messageBoxOkButton');

            // --- Utility Functions ---
            const getNumericGrade = (grade, level) => {
                if (level === "G3") return G3_TO_NUMERIC_RAW[grade] || 10;
                if (level === "G2") return G2_TO_NUMERIC_RAW[grade] || 7;
                // For G1, ITE uses A-E (1-5), others A-D (1-4)
                if (level === "G1") return G1_TO_NUMERIC_RAW_ITE[grade] || 6; // Default to ITE mapping for now
                return Infinity;
            };
            
            const getNumericGradeForOtherG1 = (grade) => {
                return G1_TO_NUMERIC_RAW_OTHER[grade] || 5; // For A-D grades, U=5
            };

            const convertG3toG2 = (g3Grade) => G3_TO_G2_CONVERSION_MAP[g3Grade] || "6";
            const getSubjectById = (id) => ALL_SUBJECTS_LIST.find(s => s.id === id);

            const getStudentSubjectG2Grade = (studentSubject) => {
                if (studentSubject.level === "G2") return studentSubject.grade;
                if (studentSubject.level === "G3") return convertG3toG2(studentSubject.grade);
                return "U"; // If G1 or unknown, return "U" for G2 equivalent
            };

            const getG1Equivalent = (subject) => {
                let g1EquivGrade = null;
                let numericG1EquivGrade = Infinity;

                if (subject.level === "G1") {
                    g1EquivGrade = subject.grade;
                    numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[subject.grade] || Infinity; // Use ITE mapping for G1
                } else if (subject.level === "G2") {
                    if (subject.grade !== "U") {
                        g1EquivGrade = G2_TO_G1_EQUIV_MAP[subject.grade];
                        numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[g1EquivGrade] || Infinity;
                    }
                } else if (subject.level === "G3") {
                    if (subject.grade !== "U") {
                        g1EquivGrade = G3_TO_G1_EQUIV_MAP[subject.grade];
                        numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[g1EquivGrade] || Infinity;
                    }
                }
                return { ...subject, g1EquivGrade, numericG1EquivGrade };
            };

            // New helper function to calculate the best 4 subjects' G1 equivalent score
            const calculateBest4G1Equivalent = (currentStudentSubjects) => {
                const g1EquivalentSubjects = currentStudentSubjects.map(s => getG1Equivalent(s));
                
                // Filter out subjects that are 'U' or couldn't be converted to a valid G1 numeric grade
                const validG1Subjects = g1EquivalentSubjects.filter(s => 
                    s.numericG1EquivGrade !== Infinity && s.g1EquivGrade !== "U"
                );

                // Sort subjects by their G1 equivalent numeric grade (lower is better)
                const sortedSubjects = validG1Subjects.sort((a, b) => a.numericG1EquivGrade - b.numericG1EquivGrade);

                // Select the top 4 best-scoring subjects
                const best4Subjects = sortedSubjects.slice(0, 4);

                // Sum their G1 equivalent numeric grades
                const totalScore = best4Subjects.reduce((sum, s) => sum + s.numericG1EquivGrade, 0);

                return { score: totalScore, subjects: best4Subjects };
            };
            
            // --- Calculation Functions ---
            const calculateL1R4 = (currentStudentSubjects, config, currentBonusPoints = 0) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && s.grade !== "U")
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));

                let l1Subj, r1Subj, r2Subj, r3Subj, r4Subj;
                let usedSubjectIds = new Set();

                const findBestSubject = (categoryNamesArray, currentUsedIds) => {
                    let bestCandidate = null;
                    for (const subj of g3Subjects) {
                        if (!currentUsedIds.has(subj.subjectId) && categoryNamesArray.includes(subj.category)) {
                            if (!bestCandidate || subj.numericGrade < bestCandidate.numericGrade) {
                                bestCandidate = subj;
                            }
                        }
                    }
                    if (bestCandidate) {
                        currentUsedIds.add(bestCandidate.subjectId);
                    }
                    return bestCandidate;
                };

                // L1: English or Higher Mother Tongue
                l1Subj = findBestSubject(config.L1, usedSubjectIds);
                if (!l1Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing L1 (EL/HMT G3)" };

                // R1: Best-scoring subject from Humanities
                r1Subj = findBestSubject(config.R1_cat_ids, usedSubjectIds);
                if (!r1Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R1 (Humanities G3)" };

                // R2: Best-scoring subject from Mathematics or Science
                r2Subj = findBestSubject(config.R2_cat_ids, usedSubjectIds);
                if (!r2Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R2 (Math/Science G3)" };

                // R3: Best-scoring subject from Humanities, Mathematics, or Science
                r3Subj = findBestSubject(config.R3_cat_ids, usedSubjectIds);
                if (!r3Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R3 (Hum/Math/Sci G3)" };
                
                // R4: Any best-scoring subject except Religious Knowledge (not in our list, so any best remaining)
                r4Subj = findBestSubject(config.R4_cat_ids, usedSubjectIds);
                if (!r4Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R4 (Any other G3, not enough distinct subjects)" };

                const grossScore = l1Subj.numericGrade + r1Subj.numericGrade + r2Subj.numericGrade + r3Subj.numericGrade + r4Subj.numericGrade;
                const netScore = grossScore - currentBonusPoints;
                
                return { grossScore, netScore, subjectsUsed: [l1Subj, r1Subj, r2Subj, r3Subj, r4Subj].map(s=>getSubjectById(s.subjectId)?.name || s.subjectId), details: `L1(${getSubjectById(l1Subj.subjectId)?.name}): ${l1Subj.grade}, R1(${getSubjectById(r1Subj.subjectId)?.name}): ${r1Subj.grade}, R2(${getSubjectById(r2Subj.subjectId)?.name}): ${r2Subj.grade}, R3(${getSubjectById(r3Subj.subjectId)?.name}): ${r3Subj.grade}, R4(${getSubjectById(r4Subj.subjectId)?.name}): ${r4Subj.grade}`};
            };

            const calculateELMAB3_G2 = (currentStudentSubjects, currentBonusPoints = 0) => {
                const subjectsForCalc = currentStudentSubjects.map(s => ({
                    ...s, g2Grade: getStudentSubjectG2Grade(s), numericG2Grade: getNumericGrade(getStudentSubjectG2Grade(s), "G2"), category: getSubjectById(s.subjectId)?.category
                })).filter(s => s.g2Grade !== "U" && s.numericG2Grade <= 6); // Only include passing G2 equivalent grades

                const el = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId));
                const ma = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(s.category));

                if (!el) return { grossScore: Infinity, netScore: Infinity, details: "Missing English (G2 equiv. pass)" };
                if (!ma) return { grossScore: Infinity, netScore: Infinity, details: "Missing Maths (G2 equiv. pass)" };

                const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId && s.subjectId !== ma.subjectId)
                    .sort((a, b) => a.numericG2Grade - b.numericG2Grade);

                if (others.length < 3) return { grossScore: Infinity, netScore: Infinity, details: `Need 3 other subjects (G2 equiv. pass), found ${others.length}` };

                const b3 = others.slice(0, 3);
                const grossScore = el.numericG2Grade + ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                const netScore = grossScore - currentBonusPoints;
                
                return { grossScore, netScore, subjectsUsed: [el, ma, ...b3].map(s=>getSubjectById(s.subjectId)?.name || s.subjectId), details: `EL(G2 ${el.g2Grade}), MA(G2 ${ma.g2Grade}), B1(${getSubjectById(b3[0].subjectId)?.name} G2 ${b3[0].g2Grade}), B2(${getSubjectById(b3[1].subjectId)?.name} G2 ${b3[1].g2Grade}), B3(${getSubjectById(b3[2].subjectId)?.name} G2 ${b3[2].g2Grade})`};
            };

            const calculateELR2B2_G3_Mixed = (currentStudentSubjects, config, currentBonusPoints = 0) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && s.grade !== "U")
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));
                const g2Subjects = currentStudentSubjects.filter(s => s.level === "G2" && s.grade !== "U")
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level), category: getSubjectById(s.subjectId)?.category }));

                let usedSubjectIds = new Set();
                let scoreSubjects = [];
                let scoreDetailsParts = [];

                function findBestSubjectForCategory(categoryIds, subjectList) {
                    let bestCandidate = null;
                    for (const subj of subjectList) {
                        if (categoryIds.includes(subj.category)) {
                            if (!bestCandidate || subj.numericGrade < bestCandidate.numericGrade) {
                                bestCandidate = subj;
                            }
                        }
                    }
                    return bestCandidate;
                }

                // 1. Find EL (English Language) - Must be G3
                const el_g3 = g3Subjects.find(s => config.EL.includes(s.subjectId));
                if (!el_g3) return { grossScore: Infinity, netScore: Infinity, details: "Missing English (G3)" };
                scoreSubjects.push(el_g3);
                usedSubjectIds.add(el_g3.subjectId);
                scoreDetailsParts.push(`EL(G3 ${el_g3.grade})`);

                // 2. Find R1 (Relevant Subject 1) - Must be G3
                const availableG3ForR1 = g3Subjects.filter(s => !usedSubjectIds.has(s.subjectId));
                const r1Candidate = findBestSubjectForCategory(config.R1_cat_ids, availableG3ForR1);
                if (!r1Candidate) return { grossScore: Infinity, netScore: Infinity, details: "Missing R1 (Relevant G3 subject)" };
                scoreSubjects.push(r1Candidate);
                usedSubjectIds.add(r1Candidate.subjectId);
                scoreDetailsParts.push(`R1(${getSubjectById(r1Candidate.subjectId)?.name} G3 ${r1Candidate.grade})`);

                // 3. Find R2 (Relevant Subject 2) - Must be G3
                const availableG3ForR2 = g3Subjects.filter(s => !usedSubjectIds.has(s.subjectId));
                const r2Candidate = findBestSubjectForCategory(config.R2_cat_ids, availableG3ForR2);
                if (!r2Candidate) return { grossScore: Infinity, netScore: Infinity, details: "Missing R2 (Relevant G3 subject)" };
                scoreSubjects.push(r2Candidate);
                usedSubjectIds.add(r2Candidate.subjectId);
                scoreDetailsParts.push(`R2(${getSubjectById(r2Candidate.subjectId)?.name} G3 ${r2Candidate.grade})`);

                // --- B1 and B2 logic: One G3, one G2 (original level or converted) ---
                let b1Subj = null;
                let b1CalculatedNumericGrade = Infinity;
                let b1SubjDisplayLevel = '';

                let b2Subj = null;
                let b2CalculatedNumericGrade = Infinity;
                let b2SubjDisplayLevel = '';

                const allRemainingSubjects = currentStudentSubjects.filter(s => !usedSubjectIds.has(s.subjectId))
                    .map(s => ({
                        ...s,
                        numericG3: s.level === 'G3' ? getNumericGrade(s.grade, 'G3') : Infinity,
                        numericG2equiv: getNumericGrade(getStudentSubjectG2Grade(s), 'G2'),
                    }));

                // Step A: Find the best G3 subject for B1
                const potentialB1G3s = allRemainingSubjects.filter(s => s.level === 'G3')
                                                            .sort((a, b) => a.numericG3 - b.numericG3);
                
                if (potentialB1G3s.length > 0) {
                    b1Subj = potentialB1G3s[0];
                    b1CalculatedNumericGrade = b1Subj.numericG3;
                    b1SubjDisplayLevel = `G3 ${b1Subj.grade}`;
                    usedSubjectIds.add(b1Subj.subjectId);
                } else {
                    // Step A fallback: If no G3 for B1, find the best G2 subject for B1
                    const potentialB1G2s = allRemainingSubjects.filter(s => s.level === 'G2')
                                                                .sort((a, b) => a.numericG2equiv - b.numericG2equiv);
                    if (potentialB1G2s.length > 0) {
                        b1Subj = potentialB1G2s[0];
                        b1CalculatedNumericGrade = b1Subj.numericG2equiv;
                        b1SubjDisplayLevel = `G2 ${b1Subj.grade}`;
                        usedSubjectIds.add(b1Subj.subjectId);
                    } else {
                        return { grossScore: Infinity, netScore: Infinity, details: "Not enough subjects for B1 (required G3 or G2)." };
                    }
                }
                scoreSubjects.push(b1Subj);
                scoreDetailsParts.push(`B1(${getSubjectById(b1Subj.subjectId)?.name} ${b1SubjDisplayLevel})`);


                // Step B: Find the best B2 subject (converted to G2) from remaining subjects
                const remainingForB2 = currentStudentSubjects.filter(s => !usedSubjectIds.has(s.subjectId))
                    .map(s => ({
                        ...s,
                        numericG2equiv: getNumericGrade(getStudentSubjectG2Grade(s), 'G2'),
                    }));
                
                if (remainingForB2.length > 0) {
                    remainingForB2.sort((a, b) => a.numericG2equiv - b.numericG2equiv);
                    b2Subj = remainingForB2[0];
                    b2CalculatedNumericGrade = b2Subj.numericG2equiv;
                    if (b2Subj.level === 'G3') {
                        b2SubjDisplayLevel = `G2 (converted from G3 ${b2Subj.grade})`;
                    } else {
                        b2SubjDisplayLevel = `G2 ${b2Subj.grade}`;
                    }
                    usedSubjectIds.add(b2Subj.subjectId);
                } else {
                    return { grossScore: Infinity, netScore: Infinity, details: "Not enough subjects for B2 (required G2 equivalent)." };
                }
                scoreSubjects.push(b2Subj);
                scoreDetailsParts.push(`B2(${getSubjectById(b2Subj.subjectId)?.name} ${b2SubjDisplayLevel})`);

                let grossScore = 0;
                grossScore += el_g3.numericGrade;
                grossScore += r1Candidate.numericGrade;
                grossScore += r2Candidate.numericGrade;
                grossScore += b1CalculatedNumericGrade;
                grossScore += b2CalculatedNumericGrade;

                const netScore = grossScore - currentBonusPoints;
                
                return { grossScore, netScore, subjectsUsed: scoreSubjects.map(s => getSubjectById(s.subjectId)?.name || s.subjectId), details: scoreDetailsParts.join(", ") };
            };

            const calculate5thYearSecondary = (currentStudentSubjects, currentBonusPoints = 0) => {
                const subjectsForCalc = currentStudentSubjects.map(s => ({
                    ...s, g2Grade: getStudentSubjectG2Grade(s), numericG2Grade: getNumericGrade(getStudentSubjectG2Grade(s), "G2"), category: getSubjectById(s.subjectId)?.category
                })).filter(s => s.g2Grade !== "U" && s.numericG2Grade <= 5);

                if (subjectsForCalc.length < 5) {
                    return { grossScore: Infinity, netScore: Infinity, details: "Need at least 5 subjects with G2 Grade 5 or better." };
                }

                const el = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId));
                const ma = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(s.category));

                let elmab3Score = Infinity;
                let elb3Score = Infinity;
                let mab3Score = Infinity;
                let details = [];

                if (el && ma) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId && s.subjectId !== ma.subjectId)
                        .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        elmab3Score = el.numericG2Grade + ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`ELMAB3: ${elmab3Score} (EL: ${el.g2Grade}, MA: ${ma.g2Grade}, B1: ${b3[0].g2Grade}, B2: ${b3[1].g2Grade}, B3: ${b3[2].g2Grade})`);
                    }
                }

                if (el) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId)
                        .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        elb3Score = el.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`ELB3: ${elb3Score} (EL: ${el.g2Grade}, B1: ${b3[0].g2Grade}, B2: ${b3[1].g2Grade}, B3: ${b3[2].g2Grade})`);
                    }
                }

                if (ma) {
                    const others = subjectsForCalc.filter(s => s.subjectId !== ma.subjectId)
                        .sort((a, b) => a.numericG2Grade - b.numericG2Grade);
                    if (others.length >= 3) {
                        const b3 = others.slice(0, 3);
                        mab3Score = ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
                        details.push(`MAB3: ${mab3Score} (MA: ${ma.g2Grade}, B1: ${b3[0].g2Grade}, B2: ${b3[1].g2Grade}, B3: ${b3[2].g2Grade})`);
                    }
                }
                
                const scoreMet = (elmab3Score <= 21) || (elb3Score <= 14) || (mab3Score <= 14);
                const finalScore = Math.min(elmab3Score, elb3Score, mab3Score);

                return { grossScore: finalScore, netScore: finalScore - currentBonusPoints, details: details.join("; "), scoreMet: scoreMet };
            };

            const calculateArtsInstitutions = (currentStudentSubjects) => {
                const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && s.grade !== "U")
                    .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level) }));

                const el = g3Subjects.find(s => s.subjectId === "EL");
                if (!el || getNumericGrade(el.grade, "G3") > G3_TO_NUMERIC_RAW["C6"]) {
                    return { grossScore: Infinity, netScore: Infinity, details: "English Language (G3) must be C6 or better." };
                }

                const otherG3Subjects = g3Subjects.filter(s => s.subjectId !== "EL")
                    .sort((a, b) => a.numericGrade - b.numericGrade);

                if (otherG3Subjects.length < 4) {
                    return { grossScore: Infinity, netScore: Infinity, details: `Need 4 G3 subjects (excluding EL), found ${otherG3Subjects.length}.` };
                }

                const best4Others = otherG3Subjects.slice(0, 4);
                const totalScore = best4Others.reduce((sum, s) => sum + s.numericGrade, 0);

                return { grossScore: totalScore, netScore: totalScore, subjectsUsed: best4Others.map(s=>getSubjectById(s.subjectId)?.name || s.subjectId), details: `Best 4 G3 (excl. EL): ${totalScore}` };
            };

            const calculateITEHnitecSpecific = (currentStudentSubjects, requirements, currentBonusPoints = 0) => {
                let metCriteria = false;
                let details = [];

                // Filter for G1 or G2 passes (numeric grade <= 5)
                const g1g2Passes = currentStudentSubjects.filter(s => {
                    const numericGrade = (s.level === "G1") ? getNumericGradeForOtherG1(s.grade) : getNumericGrade(s.grade, "G2");
                    return (s.level === "G1" || s.level === "G2") && numericGrade <= 5;
                }).map(s => getG1Equivalent(s)); // Map to G1 equivalent immediately

                let option1Met = false;
                // Specific handling for pathways requiring EL, Math, and one other G1/G2 pass (e.g., Health Sciences 2)
                if (requirements.req_g1g2_main_cats.includes(SUBJECT_CATEGORIES_DEF.EL[0]) &&
                    requirements.req_g1g2_main_cats.includes(SUBJECT_CATEGORIES_DEF.MATH_PURE[0])) {
                    
                    const elPass = g1g2Passes.find(s => getSubjectById(s.subjectId)?.category === SUBJECT_CATEGORIES_DEF.EL[0]);
                    const mathPass = g1g2Passes.find(s => SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(getSubjectById(s.subjectId)?.category));

                    if (elPass && mathPass) {
                        const usedSubjectIds = new Set([elPass.subjectId, mathPass.subjectId]);
                        const remainingG1G2Passes = g1g2Passes.filter(s => !usedSubjectIds.has(s.subjectId));

                        if (remainingG1G2Passes.length >= requirements.req_g1g2_other_count) {
                            option1Met = true;
                            details.push(`Met Option 1: G1/G2 English, Mathematics, and ${requirements.req_g1g2_other_count} other subject(s).`);
                        } else {
                            details.push(`Not Met Option 1: Need ${requirements.req_g1g2_other_count} additional G1/G2 pass after English and Mathematics.`);
                        }
                    } else {
                        details.push(`Not Met Option 1: Missing G1/G2 English or Mathematics pass.`);
                    }
                } else {
                    // General handling for pathways requiring one main subject and others (e.g., Health Sciences 1)
                    const potentialMainSubjects = g1g2Passes.filter(s => {
                        const subjectCategory = getSubjectById(s.subjectId)?.category;
                        return requirements.req_g1g2_main_cats.includes(subjectCategory) ||
                               (requirements.allow_science_in_lieu && SUBJECT_CATEGORIES_DEF.SCIENCE_IN_LIEU.includes(subjectCategory));
                    });

                    if (potentialMainSubjects.length > 0) {
                        potentialMainSubjects.sort((a, b) => a.numericG1EquivGrade - b.numericG1EquivGrade);
                        
                        const bestMainSubject = potentialMainSubjects[0];
                        const remainingG1G2Passes = g1g2Passes.filter(s => s.subjectId !== bestMainSubject.subjectId);

                        if (remainingG1G2Passes.length >= requirements.req_g1g2_other_count) {
                            option1Met = true;
                            details.push(`Met Option 1: 1 G1/G2 pass in required category and ${requirements.req_g1g2_other_count} other distinct G1/G2 passes.`);
                        } else {
                            details.push(`Not Met Option 1: Missing ${requirements.req_g1g2_other_count} additional G1/G2 passes after the main subject.`);
                        }
                    } else {
                        details.push(`Not Met Option 1: No G1/G2 pass in required main categories.`);
                    }
                }

                // Option 2: 2 G3 grades (1-8) in any two subjects
                const g3Passes = currentStudentSubjects.filter(s => s.level === "G3" && getNumericGrade(s.grade, "G3") <= requirements.req_g3_grade)
                                                        .map(s => getG1Equivalent(s)) // Map to G1 equivalent
                                                        .sort((a, b) => a.numericG1EquivGrade - b.numericG1EquivGrade);
                
                let option2Met = false;

                if (g3Passes.length >= requirements.req_g3_count) {
                    option2Met = true;
                    details.push(`Met Option 2: ${requirements.req_g3_count} subjects with G3 (1-${requirements.req_g3_grade}) passes.`);
                } else {
                    details.push(`Not Met Option 2: Need ${requirements.req_g3_count} G3 passes (1-${requirements.req_g3_grade}), found ${g3Passes.length}.`);
                }

                metCriteria = option1Met || option2Met;

                // Calculate Best 4 G1 Equivalent Score for display, regardless of MER outcome
                const { score: best4Score, subjects: best4Subjects } = calculateBest4G1Equivalent(currentStudentSubjects);

                return {
                    grossScore: best4Score, // This is the new aggregate
                    netScore: best4Score - currentBonusPoints,   // Net is gross minus bonus points
                    details: details.join(" "), // Details about MER fulfillment
                    scoreMet: metCriteria,      // Still indicates if specific MER is met
                    subjectsUsed: best4Subjects.map(s => `${getSubjectById(s.subjectId)?.name} (${s.level} ${s.grade} -> G1 ${s.g1EquivGrade})`),
                };
            };

            const calculateITEHnitecCompleted = (currentStudentSubjects, currentBonusPoints = 0) => {
                let metCriteria = false;
                let details = [];

                const passingSubjects = currentStudentSubjects.filter(s => {
                    const numericGrade = getNumericGrade(s.grade, s.level);
                    return (s.level === "G3" && numericGrade <= G3_TO_NUMERIC_RAW["E8"]) || // G3 (1-8)
                           (s.level === "G2" && numericGrade <= G2_TO_NUMERIC_RAW["5"]) || // G2 (1-5)
                           (s.level === "G1" && numericGrade <= G1_TO_NUMERIC_RAW_ITE["E"]); // G1 (A-E)
                }).map(s => getG1Equivalent(s)); // Map to G1 equivalent immediately

                if (passingSubjects.length > 0) {
                    metCriteria = true;
                    details.push("Met: Completed G1 or G2 OR Completed GCE 'O' Level (at least one non-U grade in G1, G2, or G3).");
                } else {
                    details.push("Not Met: Requires completion of G1, G2, or GCE 'O' Level (at least one non-U grade in G1, G2, or G3).");
                }

                // Calculate Best 4 G1 Equivalent Score for display, regardless of MER outcome
                const { score: best4Score, subjects: best4Subjects } = calculateBest4G1Equivalent(currentStudentSubjects);

                return {
                    grossScore: best4Score,
                    netScore: best4Score - currentBonusPoints, // Net is gross minus bonus points
                    details: details.join(" "),
                    scoreMet: metCriteria,
                    subjectsUsed: best4Subjects.map(s => `${getSubjectById(s.subjectId)?.name} (${s.level} ${s.grade} -> G1 ${s.g1EquivGrade})`),
                };
            };


            const checkMerRequirements = (pathway, studentSubjectsMap, bonusPoints) => {
                const mer = pathway.mer;
                let merMet = true;
                let merDetails = [];
                
                const getSubjectGradeForMer = (subjectId, requiredLevel) => {
                    const subject = studentSubjectsMap.get(subjectId);
                    if (!subject) return Infinity;
                    if (requiredLevel === "G3" && subject.level === "G3") return getNumericGrade(subject.grade, "G3");
                    if (requiredLevel === "G2") return getNumericGrade(getStudentSubjectG2Grade(subject), "G2");
                    if (requiredLevel === "G1") {
                        return getNumericGradeForOtherG1(getG1Equivalent(subject).g1EquivGrade);
                    }
                    return Infinity;
                };

                const getSubjectGradeDisplay = (subjectId, grade, level) => {
                    const subjectName = getSubjectById(subjectId)?.name || subjectId;
                    return `${subjectName}: ${grade} (${level})`;
                };

                // Common MER for JC/MI
                if (mer && (pathway.id === "jc" || pathway.id === "mi")) {
                    const el = studentSubjectsMap.get("EL");
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");
                    let mtOptionMet = false;
                    let mtDetails = [];

                    // Check English
                    if (el && getNumericGrade(el.grade, "G3") <= mer.el_g3) {
                        merDetails.push(`English: ${el.grade} (Met)`);
                    } else {
                        merMet = false;
                        merDetails.push(`English: ${el?.grade || 'N/A'} (Required G3 ≤ ${G3_GRADES_OPTIONS[mer.el_g3 - 1]})`);
                    }

                    // Check Math/Add Math
                    let mathGrade = getSubjectGradeForMer("MATH", "G3");
                    let amGrade = getSubjectGradeForMer("AM", "G3");
                    let effectiveMathGrade = Math.min(mathGrade, amGrade);
                    let mathDisplay = (effectiveMathGrade === mathGrade && math) ? getSubjectGradeDisplay("MATH", math.grade, "G3") : ((effectiveMathGrade === amGrade && am) ? getSubjectGradeDisplay("AM", am.grade, "G3") : 'N/A');

                    if (effectiveMathGrade <= mer.math_am_g3) {
                        merDetails.push(`${mathDisplay} (Met)`);
                    } else {
                        merMet = false;
                        merDetails.push(`Math/Add Math: ${mathDisplay} (Required G3 ≤ ${G3_GRADES_OPTIONS[mer.math_am_g3 - 1]})`);
                    }

                    // Check Mother Tongue options
                    for (const option of mer.mt_options) {
                        // Find a subject that matches the option's required category (HMT or MT)
                        const mtSubjCandidate = studentSubjects.find(s => {
                            const subjectInfo = getSubjectById(s.subjectId);
                            // Ensure subjectInfo exists and its category matches the option type
                            return subjectInfo && subjectInfo.category === option.type;
                        });

                        if (mtSubjCandidate) {
                            let gradeToCompare = null;
                            let numericOptionGrade;

                            // Determine numericOptionGrade based on option.level and grade
                            if (option.level === "G3") {
                                numericOptionGrade = getNumericGrade(option.grade, "G3");
                            } else if (option.level === "G2") {
                                numericOptionGrade = getNumericGrade(option.grade, "G2");
                            } else if (option.level === "G1") {
                                numericOptionGrade = getNumericGradeForOtherG1(option.grade);
                            }

                            // Get the student's subject grade ONLY if its level matches the option's required level
                            if (mtSubjCandidate.level === option.level) {
                                if (option.level === "G3") {
                                    gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G3");
                                } else if (option.level === "G2") {
                                    gradeToCompare = getNumericGrade(mtSubjCandidate.grade, "G2");
                                } else if (option.level === "G1") {
                                    gradeToCompare = getNumericGradeForOtherG1(mtSubjCandidate.grade);
                                }
                            }
                            
                            // Debugging logs for Mother Tongue MER
                            console.log(`--- MT MER Check for ${getSubjectById(mtSubjCandidate.subjectId)?.name} ---`);
                            console.log(`Option: Type=${option.type}, Level=${option.level}, Grade=${option.grade}`);
                            console.log(`Student Subject: ID=${mtSubjCandidate.subjectId}, Level=${mtSubjCandidate.level}, Grade=${mtSubjCandidate.grade}, Category=${getSubjectById(mtSubjCandidate.subjectId)?.category}`);
                            console.log(`Required Numeric Grade: ${numericOptionGrade}`);
                            console.log(`Student's Grade to Compare: ${gradeToCompare}`);
                            console.log(`Comparison Result (gradeToCompare <= numericOptionGrade): ${gradeToCompare <= numericOptionGrade}`);

                            if (gradeToCompare !== null && gradeToCompare <= numericOptionGrade) {
                                mtOptionMet = true;
                                mtDetails.push(`${getSubjectById(mtSubjCandidate.subjectId)?.name} (${mtSubjCandidate.level} ${mtSubjCandidate.grade}) (Met ${option.level} ${option.grade} requirement)`);
                                break;
                            } else {
                                mtDetails.push(`${getSubjectById(mtSubjCandidate.subjectId)?.name} (${mtSubjCandidate.level} ${mtSubjCandidate.grade}) (Did not meet ${option.level} ${option.grade} requirement)`);
                            }
                        }
                    }
                    if (!mtOptionMet) {
                        merMet = false;
                        merDetails.push(`Mother Tongue: No option met. Options considered: ${mtDetails.join("; ")}`);
                    } else {
                        merDetails.push(`Mother Tongue: One option met (${mtDetails.find(d => d.includes('(Met'))})`);
                    }
                }
                
                // MER for PFP pathways
                if (mer && (pathway.id === "pfp_science_tech" || pathway.id === "pfp_hum_art_biz")) {
                    const el = studentSubjectsMap.get("EL");
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");

                    // Check EL
                    if (el && getNumericGrade(getStudentSubjectG2Grade(el), "G2") <= getNumericGrade(mer.el_g2, "G2")) {
                        merDetails.push(`English (G2 equiv): ${getStudentSubjectG2Grade(el)} (Met)`);
                    } else {
                        merMet = false;
                        merDetails.push(`English (G2 equiv): ${el ? getStudentSubjectG2Grade(el) : 'N/A'} (Required G2 ≤ ${mer.el_g2})`);
                    }

                    // Check Math/Add Math
                    let mathGrade = getSubjectGradeForMer("MATH", "G2");
                    let amGrade = getSubjectGradeForMer("AM", "G2");
                    let effectiveMathGrade = Math.min(mathGrade, amGrade);
                    let mathDisplay = (effectiveMathGrade === mathGrade && math) ? getStudentSubjectG2Grade(math) : ((effectiveMathGrade === amGrade && am) ? getStudentSubjectG2Grade(am) : 'N/A');

                    if (effectiveMathGrade <= getNumericGrade(mer.math_am_g2, "G2")) {
                        merDetails.push(`Math/Add Math (G2 equiv): ${mathDisplay} (Met)`);
                    } else {
                        merMet = false;
                        merDetails.push(`Math/Add Math (G2 equiv): ${mathDisplay} (Required G2 ≤ ${mer.math_am_g2})`);
                    }

                    // Check relevant subject
                    const relevantSubjMet = studentSubjects.some(subj => {
                        const subjectInfo = getSubjectById(subj.subjectId);
                        return subjectInfo && mer.relevant_subj_ids.includes(subjectInfo.category) &&
                               getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(mer.relevant_subj_g2, "G2");
                    });

                    if (relevantSubjMet) {
                        merDetails.push(`Relevant Subject (G2 equiv): Met (Required G2 ≤ ${mer.relevant_subj_g2})`);
                    } else {
                        merMet = false;
                        merDetails.push(`Relevant Subject (G2 equiv): Not Met (Required G2 ≤ ${mer.relevant_subj_g2} from ${mer.relevant_subj_ids.map(cat => cat).join(', ')})`);
                    }

                    // Check other two subjects
                    const eligibleOtherSubjects = studentSubjects.filter(subj =>
                        subj.subjectId !== "EL" && !SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(subj.subjectId) &&
                        getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(mer.other_two_subj_g2, "G2")
                    ).length;
                    
                    if (eligibleOtherSubjects >= 2) {
                        merDetails.push(`2 other subjects (G2 equiv): Met (${eligibleOtherSubjects} subjects at G2 ≤ ${mer.other_two_subj_g2})`);
                    } else {
                        merMet = false;
                        merDetails.push(`2 other subjects (G2 equiv): Not Met (Need 2, found ${eligibleOtherSubjects} at G2 ≤ ${mer.other_two_subj_g2})`);
                    }
                }

                // MER for ITE Higher Nitec (Direct Yr 2 Entry) pathways
                if (mer && (pathway.id === "ite_hnitec_yr2_applied_eng_ict" || pathway.id === "ite_hnitec_yr2_biz_hosp")) {
                    const el = studentSubjectsMap.get("EL");
                    const math = studentSubjectsMap.get("MATH");
                    const am = studentSubjectsMap.get("AM");

                    // Check EL
                    if (el && getNumericGrade(getStudentSubjectG2Grade(el), "G2") <= getNumericGrade(mer.el_g2, "G2")) {
                        merDetails.push(`English (G2 equiv): ${getStudentSubjectG2Grade(el)} (Met)`);
                    } else {
                        merMet = false;
                        merDetails.push(`English (G2 equiv): ${el ? getStudentSubjectG2Grade(el) : 'N/A'} (Required G2 ≤ ${mer.el_g2})`);
                    }

                    // Check Math/Add Math
                    let mathGrade = getSubjectGradeForMer("MATH", "G2");
                    let amGrade = getSubjectGradeForMer("AM", "G2");
                    let effectiveMathGrade = Math.min(mathGrade, amGrade);
                    let mathDisplay = (effectiveMathGrade === mathGrade && math) ? getStudentSubjectG2Grade(math) : ((effectiveMathGrade === amGrade && am) ? getStudentSubjectG2Grade(am) : 'N/A');

                    if (effectiveMathGrade <= mer.math_am_g2) {
                        merDetails.push(`Math/Add Math (G2 equiv): ${mathDisplay} (Met)`);
                    } else {
                        merMet = false;
                        merDetails.push(`Math/Add Math (G2 equiv): ${mathDisplay} (Required G2 ≤ ${mer.math_am_g2})`);
                    }

                    // Check any three other subjects
                    const otherSubjectsCount = studentSubjects.filter(subj =>
                        subj.subjectId !== "EL" && !SUBJECT_CATEGORIES_DEF.MATH_PURE.includes(subj.subjectId) &&
                        getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(mer.any_three_other_subj_g2, "G2")
                    ).length;

                    if (otherSubjectsCount >= 3) {
                        merDetails.push(`3 other subjects (G2 equiv): Met (${otherSubjectsCount} subjects at G2 ≤ ${mer.any_three_other_subj_g2})`);
                    } else {
                        merMet = false;
                        merDetails.push(`3 other subjects (G2 equiv): Not Met (Need 3, found ${otherSubjectsCount} at G2 ≤ ${mer.any_three_other_subj_g2})`);
                    }
                }

                // MER for 5th Year Secondary (Subgroup 1)
                if (mer && pathway.id === "fifth_year_sec_subgroup1") {
                    const allSubjectsG2Pass = studentSubjects.every(s => {
                        const g2EquivGrade = getStudentSubjectG2Grade(s);
                        return g2EquivGrade !== "U" && getNumericGrade(g2EquivGrade, "G2") <= getNumericGrade(mer.all_subjects_g2, "G2");
                    });
                    if (allSubjectsG2Pass) {
                        merDetails.push(`All subjects used (G2 equiv): Met (Grade ≤ ${mer.all_subjects_g2})`);
                    } else {
                        merMet = false;
                        merDetails.push(`All subjects used (G2 equiv): Not Met (All subjects used must be G2 Grade ${mer.all_subjects_g2} or better)`);
                    }
                }

                // MER for Arts Institutions
                if (mer && pathway.id === "arts_institutions") {
                    const el = studentSubjectsMap.get("EL");
                    if (el && getNumericGrade(el.grade, "G3") <= mer.el_g3) {
                        merDetails.push(`English Language (G3): ${el.grade} (Met)`);
                    } else {
                        merMet = false;
                        merDetails.push(`English Language (G3): ${el?.grade || 'N/A'} (Required G3 ≤ ${G3_GRADES_OPTIONS[mer.el_g3 - 1]})`);
                    }
                    merDetails.push("Other requirements: Portfolio/Admissions Test/Personal Statement/Audition (not assessed here)");
                }

                // MER for ITE Higher Nitec (Year 1 Entry) - Specific pathways will call their own calc functions
                // These functions now return detailed score and subjects used.
                if (pathway.calcType === "ITE_Hnitec_Specific") {
                    const { scoreMet: iteSpecificMet, details: iteSpecificDetails, grossScore: iteGrossScore, netScore: iteNetScore, subjectsUsed: iteSubjectsUsed } = calculateITEHnitecSpecific(studentSubjects, pathway.requirements, bonusPoints);
                    pathway.grossScore = iteGrossScore; // Update pathway object with calculated score
                    pathway.netScore = iteNetScore; // Net is now gross minus bonus points
                    pathway.subjectsUsed = iteSubjectsUsed; // Update subjects used
                    if (iteSpecificMet) {
                        merDetails.push(`Entry Requirements: Met. ${iteSpecificDetails}`);
                    } else {
                        merMet = false;
                        merDetails.push(`Entry Requirements: Not Met. ${iteSpecificDetails}`);
                    }
                } else if (pathway.calcType === "ITE_Hnitec_Completed") {
                    const { scoreMet: iteCompletedMet, details: iteCompletedDetails, grossScore: iteGrossScore, netScore: iteNetScore, subjectsUsed: iteSubjectsUsed } = calculateITEHnitecCompleted(studentSubjects, bonusPoints);
                    pathway.grossScore = iteGrossScore; // Update pathway object with calculated score
                    pathway.netScore = iteNetScore; // Net is now gross minus bonus points
                    pathway.subjectsUsed = iteSubjectsUsed; // Update subjects used
                    if (iteCompletedMet) {
                        merDetails.push(`Entry Requirements: Met. ${iteCompletedDetails}`);
                    } else {
                        merMet = false;
                        merDetails.push(`Entry Requirements: Not Met. ${iteCompletedDetails}`);
                    }
                }

                return { merMet, merDetails };
            };

            const checkEligibility = () => {
                if (studentSubjects.length < 1) { // Changed to 1 for ITE general check
                    renderEligibilityResults(PATHWAYS.map(p => ({
                        ...p,
                        grossScore: Infinity,
                        netScore: Infinity,
                        scoreDetails: "Add subjects to see eligibility.",
                        scoreMet: false,
                        merCheck: { merMet: false, merDetails: ["Add at least one subject to see eligibility for some pathways."] },
                        subjectsUsed: []
                    })));
                    return;
                }

                const allPathwaysStatus = [];
                const studentSubjectsMap = new Map(studentSubjects.map(s => [s.subjectId, s]));

                let qualifiesForJCMIPoly = false;
                const jcMiPolyPathways = PATHWAYS.filter(p => p.group === "JC/MI" || p.group === "Polytechnic Year 1");

                jcMiPolyPathways.forEach(pathwa => { // Changed variable name to pathwa to avoid conflict
                    let result = { grossScore: Infinity, netScore: Infinity, details: "N/A", subjectsUsed: [] };
                    let scoreMet = false;

                    if (pathwa.calcType === "L1R4_G3") {
                        result = calculateL1R4(studentSubjects, pathwa.l1r4_config, bonusPoints);
                        scoreMet = result.grossScore <= pathwa.requirements.grossL1R4;
                    } else if (pathwa.calcType === "ELR2B2_G3_Mixed") {
                        result = calculateELR2B2_G3_Mixed(studentSubjects, pathwa.elr2b2_config, bonusPoints);
                        scoreMet = result.netScore <= pathwa.requirements.netELR2B2;
                    }
                    const merCheck = checkMerRequirements(pathwa, studentSubjectsMap, bonusPoints);
                    if (scoreMet && merCheck.merMet) {
                        qualifiesForJCMIPoly = true;
                    }
                });


                PATHWAYS.forEach(pathway => {
                    let result = { grossScore: Infinity, netScore: Infinity, details: "N/A", subjectsUsed: [] };
                    let scoreMet = false;
                    let merCheck = { merMet: true, merDetails: [] };

                    if (pathway.id === "fifth_year_sec_subgroup2") {
                        const g3Count = studentSubjects.filter(s => s.level === "G3" && s.grade !== "U").length;
                        if (g3Count >= 3) {
                            scoreMet = !qualifiesForJCMIPoly;
                            merCheck.merDetails.push(`Has ${g3Count} G3 passes.`);
                            merCheck.merDetails.push(qualifiesForJCMIPoly ? "Qualifies for JC/MI/Poly Year 1 (Not Eligible for this option)" : "Does NOT qualify for JC/MI/Poly Year 1 (Eligible for this option)");
                        } else {
                            scoreMet = false;
                            merCheck.merDetails.push(`Has ${g3Count} G3 passes (Required 3 or more G3 passes).`);
                        }
                    } else {
                        if (pathway.calcType === "L1R4_G3") {
                            result = calculateL1R4(studentSubjects, pathway.l1r4_config, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossL1R4;
                        } else if (pathway.calcType === "ELMAB3_G2") {
                            result = calculateELMAB3_G2(studentSubjects, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossELMAB3;
                        } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                            result = calculateELR2B2_G3_Mixed(studentSubjects, pathway.elr2b2_config, bonusPoints);
                            scoreMet = result.netScore <= pathway.requirements.netELR2B2;
                        } else if (pathway.calcType === "5th_Year_Sec_G2") {
                            const fifthYearResult = calculate5thYearSecondary(studentSubjects, bonusPoints);
                            result = fifthYearResult;
                            const g3Count = studentSubjects.filter(s => s.level === "G3" && s.grade !== "U").length;
                            const hasTwoOrFewerG3 = g3Count <= 2;
                            scoreMet = fifthYearResult.scoreMet && hasTwoOrFewerG3;
                            merCheck.merDetails.push(`G3 Passes: ${g3Count} (Required 2 or fewer for Option 1)`);
                        } else if (pathway.calcType === "Arts_Institutions_G3") {
                            result = calculateArtsInstitutions(studentSubjects);
                            scoreMet = result.grossScore <= pathway.requirements.best4G3ExclEL;
                        } else if (pathway.calcType === "ITE_Hnitec_Specific") { // Specific ITE Hnitec pathways
                            // Call the calculation function directly and use its results
                            const iteResult = calculateITEHnitecSpecific(studentSubjects, pathway.requirements, bonusPoints);
                            result = iteResult;
                            scoreMet = iteResult.scoreMet;
                        } else if (pathway.calcType === "ITE_Hnitec_Completed") { // Specific ITE Hnitec pathways
                            // Call the calculation function directly and use its results
                            const iteResult = calculateITEHnitecCompleted(studentSubjects, bonusPoints);
                            result = iteResult;
                            scoreMet = iteResult.scoreMet;
                        }
                        merCheck = checkMerRequirements(pathway, studentSubjectsMap, bonusPoints);
                    }

                    allPathwaysStatus.push({
                        ...pathway,
                        grossScore: result.grossScore,
                        netScore: result.netScore,
                        scoreDetails: result.details,
                        scoreMet: scoreMet,
                        merCheck: merCheck,
                        isEligible: scoreMet && merCheck.merMet,
                        subjectsUsed: result.subjectsUsed,
                    });

                    // Console logging for debugging
                    if (pathway.id === "jc" || pathway.id === "mi" || pathway.id.startsWith("pfp") || pathway.id.startsWith("ite_hnitec_yr2") || pathway.id.startsWith("ite_hnitec_yr1")) {
                        console.groupCollapsed(`Pathway: ${pathway.name}`);
                        console.log("Calculated Result:", result);
                        console.log("Score Met (Aggregate):", scoreMet);
                        console.log("MER Check Result:", merCheck);
                        console.log("Final Eligibility (scoreMet && merMet):", scoreMet && merCheck.merMet);
                        console.groupEnd();
                    }
                });
                renderEligibilityResults(allPathwaysStatus);
            };
            
            // --- Rendering Functions ---
            function showMessage(message, title = "Notification") {
                messageBoxTitle.textContent = title;
                messageBoxText.textContent = message;
                customMessageBox.classList.remove('hidden');
            }
            
            messageBoxOkButton.addEventListener('click', () => {
                customMessageBox.classList.add('hidden');
            });


            function populateSubjectDropdown() {
                subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                ALL_SUBJECTS_LIST.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    subjectSelect.appendChild(option);
                });
            }

            function populateLevelDropdown() {
                levelSelect.innerHTML = '';
                GRADE_LEVELS.forEach(l => {
                    const option = document.createElement('option');
                    option.value = l;
                    option.textContent = l;
                    levelSelect.appendChild(option);
                });
                levelSelect.value = 'G3';
            }

            function populateGradeDropdown(level) {
                gradeSelect.innerHTML = '<option value="">Select Grade</option>';
                let grades = [];
                if (level === 'G3') grades = G3_GRADES_OPTIONS;
                else if (level === 'G2') grades = G2_GRADES_OPTIONS;
                else if (level === 'G1') grades = G1_GRADES_OPTIONS;

                grades.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    gradeSelect.appendChild(option);
                });
                if (grades.length > 0) gradeSelect.value = grades[0];
                gradeSelect.disabled = grades.length === 0;
            }

            const populateRowGradeDropdown = (selectElement, level, selectedGrade) => {
                selectElement.innerHTML = '';
                let grades = [];
                if (level === 'G3') grades = G3_GRADES_OPTIONS;
                else if (level === 'G2') grades = G2_GRADES_OPTIONS;
                else if (level === 'G1') grades = G1_GRADES_OPTIONS;

                grades.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    if (g === selectedGrade) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
                selectElement.disabled = grades.length === 0;
            };


            function renderStudentSubjectsTable() {
                studentSubjectsTableBody.innerHTML = '';
                if (studentSubjects.length === 0) {
                    studentSubjectsTableContainer.classList.add('hidden');
                    return;
                }
                studentSubjectsTableContainer.classList.remove('hidden');

                studentSubjects.forEach((s, index) => {
                    const row = studentSubjectsTableBody.insertRow();
                    row.className = 'hover:bg-slate-700/50 transition-colors';
                    
                    row.insertCell().outerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">${getSubjectById(s.subjectId)?.name || s.subjectId}</td>`;
                    
                    const levelCell = row.insertCell();
                    levelCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                    const levelSelectEl = document.createElement('select');
                    levelSelectEl.className = "w-full px-3 py-2 min-w-[70px] bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                    GRADE_LEVELS.forEach(levelOption => {
                        const option = document.createElement('option');
                        option.value = levelOption;
                        option.textContent = levelOption;
                        if (levelOption === s.level) {
                            option.selected = true;
                        }
                        levelSelectEl.appendChild(option);
                    });
                    levelSelectEl.onchange = (e) => {
                        const newLevel = e.target.value;
                        studentSubjects[index].level = newLevel;

                        let defaultNewGrade = "";
                        if (newLevel === 'G3') defaultNewGrade = G3_GRADES_OPTIONS[0];
                        else if (newLevel === 'G2') defaultNewGrade = G2_GRADES_OPTIONS[0];
                        else if (newLevel === 'G1') defaultNewGrade = G1_GRADES_OPTIONS[0];
                        
                        studentSubjects[index].grade = defaultNewGrade;

                        const gradeSelectEl = row.querySelector('.grade-select');
                        populateRowGradeDropdown(gradeSelectEl, newLevel, defaultNewGrade);
                        
                        updateAllCalculationsAndRender();
                    };
                    levelCell.appendChild(levelSelectEl);

                    const gradeCell = row.insertCell();
                    gradeCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                    const gradeSelectEl = document.createElement('select');
                    gradeSelectEl.className = "grade-select w-full px-3 py-2 min-w-[70px] bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                    populateRowGradeDropdown(gradeSelectEl, s.level, s.grade);
                    gradeSelectEl.onchange = (e) => {
                        studentSubjects[index].grade = e.target.value;
                        updateAllCalculationsAndRender();
                    };
                    gradeCell.appendChild(gradeSelectEl);
                    
                    const actionsCell = row.insertCell();
                    actionsCell.className = "px-6 py-4 whitespace-nowrap text-sm font-medium text-right";
                    actionsCell.innerHTML = `
                        <button onclick="handleDeleteSubjectWrapper(${index})" class="text-red-400 hover:text-red-300 transition-colors" aria-label="Delete subject">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm"><path d="M6 7H18V20C18 20.552 17.552 21 17 21H7C6.448 21 6 20.552 6 20V7Z"></path><path d="M19 4H15V3C15 2.448 14.552 2 14 2H10C9.448 2 9 2.448 9 3V4H5V6H19V4Z"></path></svg>
                        </button>
                    `;
                });
            }
            
            function renderEligibilityResults(eligibilityResults) {
                eligibilityResultsContainer.innerHTML = '';
                if (studentSubjects.length === 0) {
                    eligibilityPlaceholder.classList.remove('hidden'); // Show if no subjects
                    eligibilityResultsContainer.innerHTML = '';
                    eligibilityResultsContainer.appendChild(eligibilityPlaceholder);
                    return;
                }
                eligibilityPlaceholder.classList.add('hidden'); // Hide if subjects exist

                const groupedPathways = {
                    "JC/MI": [],
                    "Polytechnic Year 1": [],
                    "PFP": [],
                    "ITE Year 2 Higher Nitec": [],
                    "ITE Year 1 Higher Nitec": [],
                    "5th Year Secondary": [],
                    "Arts & Foundation Programmes": []
                };

                eligibilityResults.forEach(p => {
                    if (groupedPathways[p.group]) {
                        groupedPathways[p.group].push(p);
                    }
                });

                for (const group in groupedPathways) {
                    if (groupedPathways[group].length > 0) {
                        const groupSection = document.createElement('div');
                        groupSection.className = 'col-span-full mb-6';
                        groupSection.innerHTML = `<h3 class="text-xl font-semibold text-sky-300 mb-4 border-b border-slate-700 pb-2">${group}</h3>`;
                        eligibilityResultsContainer.appendChild(groupSection);

                        groupedPathways[group].forEach(pathway => {
                            const card = document.createElement('div');
                            const isEligible = pathway.isEligible;
                            card.className = `p-5 rounded-lg shadow-lg border ${isEligible ? 'bg-emerald-800/30 border-emerald-600' : 'bg-red-800/30 border-red-600'} transition-all hover:shadow-xl hover:scale-[1.02]`;
                            
                            let scoreText = '';
                            let subjectsUsedList = '';

                            // Display Raw and Net scores for all pathways
                            if (pathway.grossScore !== Infinity) {
                                let scoreLabel = "Calculated Score";
                                if (pathway.group === "ITE Year 1 Higher Nitec") {
                                    scoreLabel = "G1 Equivalent Score";
                                }
                                scoreText = `<p class="text-xs text-slate-400 mb-1">Raw ${scoreLabel}: <strong>${pathway.grossScore}</strong></p>`;
                                scoreText += `<p class="text-xs text-slate-400 mb-1">Net ${scoreLabel}: <strong>${pathway.netScore}</strong></p>`;
                            } else {
                                scoreText = `<p class="text-xs text-slate-400 mb-1">Score: N/A (Missing prerequisite subjects or grades)</p>`;
                            }

                            if (pathway.subjectsUsed && pathway.subjectsUsed.length > 0) {
                                let subjectsUsedLabel = "Subjects used for aggregate";
                                if (pathway.group === "ITE Year 1 Higher Nitec") {
                                    subjectsUsedLabel = "Subjects considered for G1 Equivalent Score";
                                }
                                subjectsUsedList = `<p class="text-xs text-slate-400 mt-2">${subjectsUsedLabel}:</p><ul class="list-disc list-inside text-xs text-slate-400 ml-2">${pathway.subjectsUsed.map(s => `<li>${s}</li>`).join('')}</ul>`;
                            }


                            const reasonsList = pathway.merCheck.merDetails.map(detail => {
                                return `<li class="mb-0.5 text-slate-400">${detail}</li>`;
                            }).join('');

                            const descriptionItem = pathway.description ? `<li class="mt-2 pt-2 border-t border-slate-700 text-slate-400 italic">${pathway.description}</li>` : '';

                            card.innerHTML = `
                                <h3 class="text-xl font-semibold mb-2 flex items-center">
                                    ${isEligible ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-emerald-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>'}
                                    ${pathway.name}
                                </h3>
                                <p class="text-sm mb-1 font-medium ${isEligible ? 'text-emerald-300' : 'text-red-300'}">
                                    Status: ${isEligible ? 'Eligible' : 'Not Eligible'}
                                </p>
                                ${scoreText}
                                <details class="text-xs mt-2">
                                    <summary class="cursor-pointer text-sky-400 hover:text-sky-300">Details & Reasons</summary>
                                    <ul class="list-disc list-inside mt-1 pl-2 text-slate-300 space-y-1">
                                        ${reasonsList}
                                        ${descriptionItem}
                                    </ul>
                                    ${subjectsUsedList}
                                </details>
                            `;
                            eligibilityResultsContainer.appendChild(card);
                        });
                    }
                }
            };

            const getNextBetterGrade = (currentGrade, level) => {
                let gradesList = [];
                let currentGradeIndex = -1;

                if (level === "G3") {
                    gradesList = G3_GRADES_OPTIONS;
                    currentGradeIndex = gradesList.indexOf(currentGrade);
                } else if (level === "G2") {
                    gradesList = G2_GRADES_OPTIONS;
                    currentGradeIndex = gradesList.indexOf(currentGrade);
                } else if (level === "G1") {
                    gradesList = G1_GRADES_OPTIONS;
                    currentGradeIndex = gradesList.indexOf(currentGrade);
                }

                if (currentGradeIndex === -1 || currentGradeIndex === 0) {
                    return null;
                }
                return gradesList[currentGradeIndex - 1];
            };

            const getEligiblePathwayCountAndNames = (subjects) => {
                let count = 0;
                const pathwayNames = [];
                const studentSubjectsMap = new Map(subjects.map(s => [s.subjectId, s]));

                let qualifiesForJCMIPoly = false;
                const jcMiPolyPathways = PATHWAYS.filter(p => p.group === "JC/MI" || p.group === "Polytechnic Year 1");

                jcMiPolyPathways.forEach(pathwa => { // Changed variable name to pathwa to avoid conflict
                    let result = { grossScore: Infinity, netScore: Infinity };
                    let scoreMet = false;

                    if (pathwa.calcType === "L1R4_G3") {
                        result = calculateL1R4(subjects, pathwa.l1r4_config, bonusPoints);
                        scoreMet = result.grossScore <= pathwa.requirements.grossL1R4;
                    } else if (pathwa.calcType === "ELR2B2_G3_Mixed") {
                        result = calculateELR2B2_G3_Mixed(subjects, pathwa.elr2b2_config, bonusPoints);
                        scoreMet = result.netScore <= pathwa.requirements.netELR2B2;
                    }
                    const merCheck = checkMerRequirements(pathwa, studentSubjectsMap, bonusPoints);
                    if (scoreMet && merCheck.merMet) {
                        qualifiesForJCMIPoly = true;
                    }
                });


                PATHWAYS.forEach(pathway => {
                    let result = { grossScore: Infinity, netScore: Infinity };
                    let scoreMet = false;
                    let merCheck = { merMet: true, merDetails: [] };

                    if (pathway.id === "fifth_year_sec_subgroup2") {
                        const g3Count = subjects.filter(s => s.level === "G3" && s.grade !== "U").length;
                        if (g3Count >= 3) {
                            scoreMet = !qualifiesForJCMIPoly;
                            merCheck.merDetails.push(`Has ${g3Count} G3 passes.`);
                            merCheck.merDetails.push(qualifiesForJCMIPoly ? "Qualifies for JC/MI/Poly Year 1 (Not Eligible for this option)" : "Does NOT qualify for JC/MI/Poly Year 1 (Eligible for this option)");
                        } else {
                            scoreMet = false;
                            merCheck.merDetails.push(`Has ${g3Count} G3 passes (Required 3 or more G3 passes).`);
                        }
                    } else {
                        if (pathway.calcType === "L1R4_G3") {
                            result = calculateL1R4(subjects, pathway.l1r4_config, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossL1R4;
                        } else if (pathway.calcType === "ELMAB3_G2") {
                            result = calculateELMAB3_G2(subjects, bonusPoints);
                            scoreMet = result.grossScore <= pathway.requirements.grossELMAB3;
                        } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                            result = calculateELR2B2_G3_Mixed(subjects, pathway.elr2b2_config, bonusPoints);
                            scoreMet = result.netScore <= pathway.requirements.netELR2B2;
                        } else if (pathway.calcType === "5th_Year_Sec_G2") {
                            const fifthYearResult = calculate5thYearSecondary(subjects, bonusPoints);
                            result = fifthYearResult;
                            const g3Count = subjects.filter(s => s.level === "G3" && s.grade !== "U").length;
                            const hasTwoOrFewerG3 = g3Count <= 2;
                            scoreMet = fifthYearResult.scoreMet && hasTwoOrFewerG3;
                            merCheck.merDetails.push(`G3 Passes: ${g3Count} (Required 2 or fewer for Option 1)`);
                        } else if (pathway.calcType === "Arts_Institutions_G3") {
                            result = calculateArtsInstitutions(subjects);
                            scoreMet = result.grossScore <= pathway.requirements.best4G3ExclEL;
                        } else if (pathway.calcType === "ITE_Hnitec_Specific") {
                            result = calculateITEHnitecSpecific(subjects, pathway.requirements, bonusPoints);
                            scoreMet = result.scoreMet;
                        } else if (pathway.calcType === "ITE_Hnitec_Completed") {
                            result = calculateITEHnitecCompleted(subjects, bonusPoints);
                            scoreMet = result.scoreMet;
                        }
                        merCheck = checkMerRequirements(pathway, studentSubjectsMap, bonusPoints);
                    }

                    if (scoreMet && merCheck.merMet) {
                        count++;
                        pathwayNames.push(pathway.name);
                    }
                });
                return { count, pathwayNames };
            };

            const generateImprovementSuggestions = () => {
                improvementSuggestionsContainer.innerHTML = '';
                if (studentSubjects.length === 0) {
                    improvementSuggestionsSection.classList.add('hidden');
                    return;
                }

                improvementSuggestionsSection.classList.remove('hidden');
                improvementPlaceholder.classList.add('hidden');

                const { count: currentEligiblePathwaysCount, pathwayNames: currentEligiblePathwayNames } = getEligiblePathwayCountAndNames(studentSubjects);
                const suggestions = [];

                studentSubjects.forEach((subject, index) => {
                    const originalGrade = subject.grade;
                    const originalLevel = subject.level;
                    const nextBetterGrade = getNextBetterGrade(originalGrade, originalLevel);

                    if (nextBetterGrade) {
                        const tempSubjects = [...studentSubjects];
                        tempSubjects[index] = { ...subject, grade: nextBetterGrade };
                        const { count: newEligiblePathwaysCount, pathwayNames: newEligiblePathwayNames } = getEligiblePathwayCountAndNames(tempSubjects);

                        if (newEligiblePathwaysCount > currentEligiblePathwaysCount) {
                            const unlockedPathwayNames = newEligiblePathwayNames.filter(name => !currentEligiblePathwayNames.includes(name));
                            suggestions.push({
                                subjectName: subject.subjectId,
                                originalGrade: originalGrade,
                                originalLevel: originalLevel,
                                improvedGrade: nextBetterGrade,
                                pathwaysUnlockedCount: newEligiblePathwaysCount - currentEligiblePathwaysCount,
                                unlockedPathwayNames: unlockedPathwayNames,
                            });
                        }
                    }
                });

                if (suggestions.length === 0) {
                    improvementPlaceholder.classList.remove('hidden');
                    improvementSuggestionsSection.classList.remove('hidden');
                } else {
                    renderImprovementSuggestions(suggestions);
                }
            };

            const renderImprovementSuggestions = (suggestions) => {
                improvementSuggestionsContainer.innerHTML = '';
                suggestions.sort((a, b) => b.pathwaysUnlockedCount - a.pathwaysUnlockedCount);

                suggestions.forEach(suggestion => {
                    const pathwayNamesText = suggestion.unlockedPathwayNames.length > 0
                        ? `This could unlock: <strong>${suggestion.unlockedPathwayNames.join(', ')}</strong>.`
                        : `This could unlock <strong>${suggestion.pathwaysUnlockedCount}</strong> additional pathway(s).`;

                    const suggestionCard = `
                        <div class="bg-slate-700 p-4 rounded-lg shadow-md mb-3 border border-slate-600 flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-3 text-emerald-400 flex-shrink-0 mt-1"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>
                            <div>
                                <h4 class="text-lg font-semibold text-sky-300 mb-1">${getSubjectById(suggestion.subjectName)?.name || suggestion.subjectName}</h4>
                                <p class="text-slate-200 text-sm mb-2">Improve from <strong>${suggestion.originalGrade} (${suggestion.originalLevel})</strong> to <strong>${suggestion.improvedGrade} (${suggestion.originalLevel})</strong>.</p>
                                <p class="text-xs text-slate-400">${pathwayNamesText}</p>
                            </div>
                        </div>
                    `;
                    improvementSuggestionsContainer.innerHTML += suggestionCard;
                });
            };


            // --- Event Handlers ---
            function handleAddOrUpdateSubject() {
                const currentSubjectVal = subjectSelect.value;
                const currentLevelVal = levelSelect.value;
                const currentGradeVal = gradeSelect.value;

                if (!currentSubjectVal || !currentLevelVal || !currentGradeVal) {
                    showMessage("Please select subject, level, and grade.");
                    return;
                }

                const isDuplicate = studentSubjects.some(s => s.subjectId === currentSubjectVal);
                if (isDuplicate) {
                    showMessage("Duplicate Subject", "This subject has already been added. Please edit the existing entry in the table below or choose a different subject.");
                    return;
                }
                studentSubjects.push({ subjectId: currentSubjectVal, level: currentLevelVal, grade: currentGradeVal });
                
                subjectSelect.value = '';
                levelSelect.value = 'G3';
                populateGradeDropdown('G3');
                gradeSelect.value = G3_GRADES_OPTIONS[0];

                updateAllCalculationsAndRender();
            }

            window.handleDeleteSubjectWrapper = (index) => {
                showMessage("Are you sure you want to delete this subject?", "Confirm Deletion");
                messageBoxOkButton.onclick = () => {
                    customMessageBox.classList.add('hidden');
                    studentSubjects.splice(index, 1);
                    updateAllCalculationsAndRender();
                    messageBoxOkButton.onclick = () => customMessageBox.classList.add('hidden');
                };
            };
            
            function updateAllCalculationsAndRender() {
                bonusPoints = parseInt(bonusInput.value) || 0;
                if (bonusPoints < 0) bonusPoints = 0;
                if (bonusPoints > 5) bonusPoints = 5;
                bonusInput.value = bonusPoints;

                checkEligibility();
                renderStudentSubjectsTable();
                generateImprovementSuggestions();
            }

            // --- Initial Setup ---
            document.addEventListener('DOMContentLoaded', () => {
                currentYearSpan.textContent = new Date().getFullYear();
                populateSubjectDropdown();
                populateLevelDropdown();
                populateGradeDropdown(levelSelect.value);

                levelSelect.addEventListener('change', (e) => populateGradeDropdown(e.target.value));
                addUpdateSubjectBtn.addEventListener('click', handleAddOrUpdateSubject);
                bonusInput.addEventListener('change', updateAllCalculationsAndRender);
                bonusInput.addEventListener('keyup', (e) => {
                    if (e.key >= '0' && e.key === '9' || e.key === 'Backspace' || e.key === 'Delete') {
                        updateAllCalculationsAndRender();
                    }
                });
                
                renderEligibilityResults([]);
                generateImprovementSuggestions();
            });

        })();
    </script>
</body>
</html>
